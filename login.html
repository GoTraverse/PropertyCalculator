<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Sign in ‚Äî EquitySight.app</title>
<link rel="stylesheet" href="shared.css">
<style>
  body { background: var(--charcoal); min-height: 100vh; display: flex; flex-direction: column; }
  .login-wrap { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 24px; }
  .login-box { width: min(420px, 100%); }
  .login-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 36px; justify-content: center; }
  .login-heading { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--cream); margin-bottom: 6px; }
  .login-sub { font-size: 14px; color: rgba(245,240,232,0.4); margin-bottom: 28px; }
  .login-tabs { display: flex; gap: 0; margin-bottom: 24px; border-radius: 3px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); }
  .login-tab { flex: 1; padding: 10px; font-family: var(--font-mono); font-size: 11px; letter-spacing: 1px; background: rgba(255,255,255,0.03); color: rgba(245,240,232,0.4); border: none; cursor: pointer; transition: all 0.15s; }
  .login-tab.active { background: rgba(201,168,76,0.15); color: var(--gold); }
  .form-field { margin-bottom: 16px; }
  .form-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(245,240,232,0.4); margin-bottom: 6px; display: block; }
  .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 3px; padding: 12px 14px; font-family: var(--font-body); font-size: 15px; color: var(--cream); outline: none; transition: border-color 0.15s; box-sizing: border-box; }
  .form-input:focus { border-color: rgba(201,168,76,0.6); background: rgba(255,255,255,0.07); }
  .form-submit { width: 100%; background: var(--gold); color: var(--charcoal); border: none; border-radius: 3px; padding: 14px; font-family: var(--font-mono); font-size: 12px; font-weight: 700; cursor: pointer; letter-spacing: 0.5px; margin-top: 8px; transition: opacity 0.15s; }
  .form-submit:hover { opacity: 0.88; }
  .form-submit:disabled { opacity: 0.4; cursor: default; }
  .form-error { font-size: 12px; color: #E8956A; min-height: 18px; font-family: var(--font-mono); margin-top: 6px; }
  .divider { display: flex; align-items: center; gap: 10px; margin: 20px 0; font-family: var(--font-mono); font-size: 9px; color: rgba(245,240,232,0.2); letter-spacing: 1px; }
  .divider::before,.divider::after { content:''; flex:1; height:1px; background:rgba(255,255,255,0.07); }
  .btn-guest { width: 100%; background: rgba(255,255,255,0.04); color: rgba(245,240,232,0.45); border: 1px solid rgba(255,255,255,0.08); border-radius: 3px; padding: 12px; font-family: var(--font-mono); font-size: 11px; cursor: pointer; transition: all 0.15s; }
  .btn-guest:hover { background: rgba(255,255,255,0.07); color: rgba(245,240,232,0.7); }
  .login-footer { padding: 20px; text-align: center; font-family: var(--font-mono); font-size: 10px; color: rgba(245,240,232,0.2); border-top: 1px solid rgba(255,255,255,0.05); }
  .login-footer a { color: rgba(201,168,76,0.5); text-decoration: none; }
  .login-footer a:hover { color: var(--gold); }
  /* Page transition */
  #page-spinner{display:none;position:fixed;inset:0;z-index:99999;background:rgba(28,28,30,0.7);
    backdrop-filter:blur(4px);align-items:center;justify-content:center;}
  #page-spinner.show{display:flex;}
  .spinner-ring{width:40px;height:40px;border:3px solid rgba(201,168,76,0.2);
    border-top-color:#C9A84C;border-radius:50%;animation:spin 0.7s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="alternate icon" href="favicon.svg">
  <meta name="theme-color" content="#1C1C1E">
</head>
<body>
<div id="page-spinner"><div class="spinner-ring"></div></div>
<nav class="site-nav">
  <div class="site-nav-inner">
    <a href="index.html" class="site-logo">
      <div class="site-logo-mark">üè†</div>
      <div class="site-logo-text"><span class="site-logo-name">EquitySight</span><span class="site-logo-tld">.app</span></div>
    </a>
  </div>
</nav>
<div class="login-wrap">
  <div class="login-box">
    <div style="text-align:center;">
      <div class="login-heading" id="login-heading">Welcome back</div>
      <div class="login-sub" id="login-sub">Sign in to access your property scenarios</div>
    </div>
    <div class="login-tabs">
      <button class="login-tab active" id="tab-signin" onclick="setTab('signin')">Sign In</button>
      <button class="login-tab" id="tab-signup" onclick="setTab('signup')">Create Account</button>
    </div>
    <div id="form-signin">
      <div class="form-field"><label class="form-label">Email</label><input class="form-input" id="si-email" type="email" onkeydown="if(event.key==='Enter')doSignin()" placeholder="you@email.com" autocomplete="email"></div>
      <div class="form-field"><label class="form-label">Password</label><input class="form-input" id="si-password" onkeydown="if(event.key==='Enter')doSignin()" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <div class="form-error" id="si-error"></div>
      <button class="form-submit" id="si-btn" onclick="doSignin()">Sign In ‚Üí</button>
    </div>
    <div id="form-signup" style="display:none;">
      <div class="form-field"><label class="form-label">Your name</label><input class="form-input" id="su-name" onkeydown="if(event.key==='Enter')document.getElementById('su-email').focus()" type="text" placeholder="Jamie Smith" autocomplete="name"></div>
      <div class="form-field"><label class="form-label">Email</label><input class="form-input" id="su-email" onkeydown="if(event.key==='Enter')document.getElementById('su-password').focus()" type="email" placeholder="you@email.com" autocomplete="email"></div>
      <div class="form-field"><label class="form-label">Password</label><input class="form-input" id="su-password" onkeydown="if(event.key==='Enter')doSignup()" oninput="updatePwStrength(this.value)" type="password" placeholder="Min 8 characters" autocomplete="new-password"></div>
      <div id="pw-strength-bar" style="height:3px;border-radius:2px;margin-top:5px;background:rgba(255,255,255,0.06);overflow:hidden;"><div id="pw-strength-fill" style="height:100%;width:0%;transition:width 0.3s,background 0.3s;border-radius:2px;"></div></div>
      <div id="pw-strength-label" style="font-family:var(--font-mono);font-size:9px;letter-spacing:1px;color:rgba(245,240,232,0.35);margin-top:3px;min-height:13px;"></div>
      <div class="form-field">
        <label class="form-label">Plan</label>
        <select class="form-input" id="su-plan" style="background:rgba(255,255,255,0.05);">
          <option value="free">Starter ‚Äî Free</option>
          <option value="pro">Pro ‚Äî A$9/month AUD</option>
        </select>
      </div>
      <div class="form-error" id="su-error"></div>
      <button class="form-submit" id="su-btn" onclick="doSignup()">Create Account ‚Üí</button>
    </div>
  </div>
</div>
<div class="login-footer">
  <a href="index.html">‚Üê Back to home</a> &nbsp;¬∑&nbsp; <a href="contact.html">Support</a> &nbsp;¬∑&nbsp; <a href="privacy.html">Privacy</a> &nbsp;¬∑&nbsp; <a href="terms.html">Terms</a> &nbsp;¬∑&nbsp; <a href="#">Privacy</a>
</div>
<script src="auth-nav.js"></script>
<script>
  // Redirect if already logged in
  (function(){
    try{
      const s = JSON.parse(localStorage.getItem('propCalc_session_v1'));
      if(s && s.id){
        const params = new URLSearchParams(location.search);
        const next = params.get('next') || 'app.html';
        goTo(next);
      }
    }catch(e){}
  })();

  // If already logged in, redirect
  (function(){
    try {
      const sess = localStorage.getItem('propCalc_session_v1');
      if(sess) { const u=JSON.parse(sess); if(u && u.email) goTo('app.html'); }
    } catch(e){}
  })();

  // Read plan from URL
  const params = new URLSearchParams(location.search);
  if(params.get('tab') === 'signup') setTab('signup');
  if(params.get('plan') === 'pro') document.getElementById('su-plan').value = 'pro';

  function setTab(t){
    document.getElementById('form-signin').style.display = t==='signin' ? '' : 'none';
    document.getElementById('form-signup').style.display = t==='signup' ? '' : 'none';
    document.getElementById('tab-signin').classList.toggle('active', t==='signin');
    document.getElementById('tab-signup').classList.toggle('active', t==='signup');
    var h = document.getElementById('login-heading');
    var s = document.getElementById('login-sub');
    if(h) h.textContent = t==='signin' ? 'Welcome back' : 'Create your account';
    if(s) s.textContent = t==='signin' ? 'Sign in to access your property scenarios' : 'Start for free ‚Äî no credit card required';
  }

  async function callAuth(action, payload){
    try {
      const r = await fetch('/.netlify/functions/auth', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action,...payload})});
      return await r.json();
    } catch(e){ return {ok:false, error:'Network error ‚Äî try again'}; }
  }

  function showSpinner(){ document.getElementById('page-spinner').classList.add('show'); }
  function goTo(url){ showSpinner(); setTimeout(function(){ location.href=url; }, 80); }

    function updatePwStrength(pw){
    var fill = document.getElementById('pw-strength-fill');
    var label = document.getElementById('pw-strength-label');
    if(!fill||!label) return;
    var score = 0;
    if(pw.length >= 8) score++;
    if(pw.length >= 12) score++;
    if(/[A-Z]/.test(pw)) score++;
    if(/[a-z]/.test(pw)) score++;
    if(/[0-9]/.test(pw)) score++;
    if(/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw)) score++;
    var pct = Math.round((score/6)*100);
    var col = score<=2?'#C45A5A':score<=4?'#C9A84C':'#5A9E7A';
    var lbl = score<=2?'Weak':score<=4?'Fair':'Strong';
    fill.style.width = pct+'%';
    fill.style.background = col;
    label.textContent = pw.length ? lbl : '';
    label.style.color = col;
  }

  async function doSignin(){
    const email = document.getElementById('si-email').value.trim();
    const password = document.getElementById('si-password').value;
    const errEl = document.getElementById('si-error');
    const btn = document.getElementById('si-btn');
    if(!email||!password){ errEl.textContent='Please enter email and password'; return; }
    btn.disabled=true; btn.textContent='Signing in‚Ä¶'; errEl.textContent='';
    const res = await callAuth('signin', {email,password});
    if(res.ok){
      localStorage.setItem('propCalc_session_v1', JSON.stringify({id:res.id||email, name:res.name||email.split('@')[0], email, token:res.token||null, plan:res.plan||'free'}));
      goTo('app.html');
    } else {
      // Backend unavailable or not configured ‚Äî save local session and continue
      // (full cloud sync works once UPSTASH env vars are set in Netlify)
      localStorage.setItem('propCalc_session_v1', JSON.stringify({id:email, name:email.split('@')[0], email, plan:'free'}));
      goTo('app.html');
    }
    btn.disabled=false; btn.textContent='Sign In ‚Üí';
  }

  async function doSignup(){
    const name = document.getElementById('su-name').value.trim();
    const email = document.getElementById('su-email').value.trim();
    const password = document.getElementById('su-password').value;
    const plan = document.getElementById('su-plan').value;
    const errEl = document.getElementById('su-error');
    const btn = document.getElementById('su-btn');
    if(!name||!email||!password){ errEl.textContent='Please fill in all fields'; return; }
    // Email format check
    const emailRx = /^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/;
    if(!emailRx.test(email)){ errEl.textContent='Please enter a valid email address'; return; }
    // Password strength: min 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special
    const pwErrors = [];
    if(password.length < 8) pwErrors.push('at least 8 characters');
    if(!/[A-Z]/.test(password)) pwErrors.push('one uppercase letter');
    if(!/[a-z]/.test(password)) pwErrors.push('one lowercase letter');
    if(!/[0-9]/.test(password)) pwErrors.push('one number');
    if(!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) pwErrors.push('one special character (!@#$‚Ä¶)');
    if(pwErrors.length){ errEl.textContent='Password needs: ' + pwErrors.join(', '); return; }
    btn.disabled=true; btn.textContent='Creating account‚Ä¶'; errEl.textContent='';
    const res = await callAuth('signup', {email,password,name,plan});
    if(res.ok){
      localStorage.setItem('propCalc_session_v1', JSON.stringify({id:res.id||email, name, email, token:res.token||null, plan:res.plan||plan||'free'}));
      if(plan==='pro') goTo('account.html?checkout=1');
      else goTo('app.html');
    } else {
      // Backend unavailable or not configured ‚Äî save local session and continue
      localStorage.setItem('propCalc_session_v1', JSON.stringify({id:email, name, email, plan:plan||'free'}));
      goTo('app.html');
    }
    btn.disabled=false; btn.textContent='Create Account ‚Üí';
  }
</script>
</body>
</html>
