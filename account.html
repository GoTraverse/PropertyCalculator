<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Account ‚Äî EquitySight.app</title>
<link rel="stylesheet" href="shared.css">
<style>
  body { background: var(--warm-white); }

  .account-layout {
    max-width: 900px;
    margin: 0 auto;
    padding: 48px 24px 80px;
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 32px;
    align-items: start;
  }

  /* Sidebar nav */
  .acct-nav { position: sticky; top: 90px; }
  .acct-nav-title { font-family: var(--font-mono); font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: rgba(28,28,30,0.35); margin-bottom: 10px; padding: 0 12px; }
  .acct-nav-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; border-radius: 5px; font-size: 13px; font-weight: 500; color: var(--slate); background: none; border: none; cursor: pointer; text-align: left; transition: background 0.12s, color 0.12s; }
  .acct-nav-item:hover { background: rgba(28,28,30,0.06); color: var(--charcoal); }
  .acct-nav-item.active { background: var(--charcoal); color: var(--cream); }
  .acct-nav-item .ni { font-size: 16px; flex-shrink: 0; }
  .acct-nav-divider { height: 1px; background: rgba(28,28,30,0.08); margin: 8px 0; }

  /* Content panels */
  .acct-panel { display: none; }
  .acct-panel.active { display: block; }

  /* Cards */
  .acct-card { background: white; border-radius: 10px; border: 1px solid rgba(28,28,30,0.08); margin-bottom: 20px; overflow: hidden; }
  .acct-card-head { padding: 20px 24px 16px; border-bottom: 1px solid rgba(28,28,30,0.07); }
  .acct-card-head h3 { font-family: var(--font-display); font-size: 17px; font-weight: 700; margin-bottom: 3px; }
  .acct-card-head p { font-size: 13px; color: var(--slate); }
  .acct-card-body { padding: 20px 24px; }

  /* Avatar */
  .acct-avatar-row { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
  .acct-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--gold); display: flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: 24px; font-weight: 700; color: var(--charcoal); flex-shrink: 0; overflow: hidden; cursor: pointer; position: relative; }
  .acct-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
  .acct-avatar-hint { font-size: 12px; color: var(--slate); line-height: 1.5; }
  .acct-avatar-change { font-family: var(--font-mono); font-size: 10px; color: var(--gold); letter-spacing: 0.5px; cursor: pointer; margin-top: 4px; display: inline-block; }

  /* Form fields */
  .acct-field { margin-bottom: 16px; }
  .acct-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(28,28,30,0.45); margin-bottom: 6px; display: block; }
  .acct-input { width: 100%; background: var(--warm-white); border: 1px solid rgba(28,28,30,0.12); border-radius: 4px; padding: 11px 14px; font-family: var(--font-body); font-size: 14px; color: var(--charcoal); outline: none; transition: border-color 0.15s; box-sizing: border-box; }
  .acct-input:focus { border-color: rgba(201,168,76,0.6); background: white; }
  .acct-input:read-only { opacity: 0.5; cursor: default; }
  .acct-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  /* Colour swatches */
  .color-swatches { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 4px; }
  .color-swatch { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.12s, border-color 0.12s; }
  .color-swatch:hover, .color-swatch.active { transform: scale(1.2); border-color: white; box-shadow: 0 0 0 2px rgba(28,28,30,0.3); }

  /* Buttons */
  .acct-btn-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .acct-btn { padding: 10px 20px; border-radius: 4px; font-family: var(--font-mono); font-size: 11px; font-weight: 700; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s; }
  .acct-btn-primary { background: var(--charcoal); color: var(--cream); border: none; }
  .acct-btn-primary:hover { opacity: 0.85; }
  .acct-btn-outline { background: none; color: var(--charcoal); border: 1px solid rgba(28,28,30,0.2); }
  .acct-btn-outline:hover { background: var(--charcoal); color: var(--cream); }
  .acct-btn-danger { background: none; color: #C45A5A; border: 1px solid rgba(196,90,90,0.3); }
  .acct-btn-danger:hover { background: rgba(196,90,90,0.08); }
  .acct-btn-gold { background: var(--gold); color: var(--charcoal); border: none; }
  .acct-btn-gold:hover { opacity: 0.88; }
  .acct-status-msg { font-family: var(--font-mono); font-size: 11px; min-height: 18px; padding: 2px 0; }
  .acct-status-msg.ok { color: var(--reward-green); }
  .acct-status-msg.err { color: #E87070; }

  /* Plan badge */
  .plan-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-family: var(--font-mono); font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .plan-free { background: rgba(28,28,30,0.06); color: rgba(28,28,30,0.5); }
  .plan-pro { background: rgba(201,168,76,0.15); color: var(--gold); border: 1px solid rgba(201,168,76,0.3); }
  .plan-adviser { background: rgba(91,143,171,0.15); color: var(--sky); border: 1px solid rgba(91,143,171,0.3); }
  .plan-feature-list { margin: 14px 0 0; }
  .plan-feature { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--slate); padding: 6px 0; border-bottom: 1px solid rgba(28,28,30,0.05); }
  .plan-feature:last-child { border-bottom: none; }
  .plan-feature .pf-check { color: var(--reward-green); font-size: 12px; }
  .plan-feature .pf-lock { color: rgba(28,28,30,0.25); font-size: 12px; }

  /* Security */
  .security-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid rgba(28,28,30,0.06); }
  .security-row:last-child { border-bottom: none; }
  .security-label { font-size: 14px; font-weight: 500; color: var(--charcoal); }
  .security-meta { font-size: 12px; color: var(--slate); margin-top: 2px; }

  /* Danger zone */
  .danger-zone { background: rgba(196,90,90,0.04); border: 1px solid rgba(196,90,90,0.15); border-radius: 10px; padding: 20px 24px; }
  .danger-zone h4 { font-size: 14px; font-weight: 600; color: #C45A5A; margin-bottom: 6px; }
  .danger-zone p { font-size: 13px; color: var(--slate); margin-bottom: 14px; line-height: 1.5; }

  /* Not logged in state */
  .gate-msg { text-align: center; padding: 80px 24px; }
  .gate-msg h2 { font-family: var(--font-display); font-size: 28px; font-weight: 700; margin-bottom: 12px; }
  .gate-msg p { color: var(--slate); margin-bottom: 24px; }

  @media(max-width: 700px) {
    .account-layout { grid-template-columns: 1fr; padding: 24px 16px 60px; gap: 20px; }
    .acct-nav { position: static; display: flex; gap: 6px; flex-wrap: wrap; }
    .acct-nav-title { display: none; }
    .acct-nav-item { flex: 0 0 auto; padding: 8px 12px; }
    .acct-nav-divider { display: none; }
    .acct-row { grid-template-columns: 1fr; }
  }
</style>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="alternate icon" href="favicon.svg">
  <meta name="theme-color" content="#1C1C1E">
</head>
<body>

<nav class="site-nav">
  <div class="site-nav-inner">
    <a href="index.html" class="site-logo">
      <div class="site-logo-mark">üè†</div>
      <div class="site-logo-text"><span class="site-logo-name">EquitySight</span><span class="site-logo-tld">.app</span></div>
    </a>
    <ul class="site-nav-links">
      <li><a href="index.html#features">Features</a></li>
      <li><a href="pricing.html">Pricing</a></li>
      <li><a href="contact.html">Support</a></li>
      <li><a href="about.html">About</a></li>
    </ul>
    <div class="site-nav-actions" id="nav-actions">
      <button class="btn-ghost" onclick="location.href='login.html'">Sign in</button>
      <button class="btn-gold" onclick="location.href='login.html?tab=signup'">Get started free</button>
    </div>
    <button class="nav-hamburger" id="nav-ham">‚ò∞</button>
  </div>
</nav>

<!-- Not logged in -->
<div id="gate-view" style="display:none;" class="gate-msg">
  <div style="font-size:48px;margin-bottom:16px;">üîí</div>
  <h2>Sign in to view your account</h2>
  <p>You need to be signed in to access account settings.</p>
  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
    <button class="acct-btn acct-btn-primary" onclick="location.href='login.html'">Sign in</button>
    <button class="acct-btn acct-btn-outline" onclick="location.href='login.html?tab=signup'">Create account</button>
  </div>
</div>

<!-- Account layout -->
<div class="account-layout" id="account-view" style="display:none;">

  <!-- Sidebar nav -->
  <nav class="acct-nav">
    <div class="acct-nav-title">Account</div>
    <button class="acct-nav-item active" onclick="showPanel('profile',this)"><span class="ni">üë§</span> Profile</button>
    <button class="acct-nav-item" onclick="showPanel('subscription',this)"><span class="ni">üí≥</span> Subscription</button>
    <div class="acct-nav-divider"></div>
    <button class="acct-nav-item" onclick="showPanel('security',this)"><span class="ni">üîí</span> Security</button>
    <div class="acct-nav-divider"></div>
    <button class="acct-nav-item" onclick="location.href='app.html'"><span class="ni">üè†</span> Open Calculator</button>
    <button class="acct-nav-item" style="color:#C45A5A;" onclick="doSignOut()"><span class="ni">‚Ü©</span> Sign Out</button>
  </nav>

  <!-- Panels -->
  <div>

    <!-- PROFILE PANEL -->
    <div class="acct-panel active" id="panel-profile">
      <div class="acct-card">
        <div class="acct-card-head">
          <h3>Profile</h3>
          <p>Your name, photo, and display preferences.</p>
        </div>
        <div class="acct-card-body">

          <div class="acct-avatar-row">
            <label style="cursor:pointer;">
              <div class="acct-avatar" id="acct-avatar">?</div>
              <input type="file" accept="image/*" style="display:none;" id="avatar-file-input" onchange="handleAvatarUpload(this)">
            </label>
            <div>
              <div class="acct-avatar-hint">Click to change your profile photo.<br>JPG or PNG, max 5MB.</div>
              <span class="acct-avatar-change" id="avatar-remove" style="display:none;color:#C45A5A;" onclick="removeAvatar()">Remove photo</span>
            </div>
          </div>

          <div class="acct-row">
            <div class="acct-field">
              <label class="acct-label">Display name</label>
              <input class="acct-input" id="acct-name" type="text" placeholder="Your name">
            </div>
            <div class="acct-field">
              <label class="acct-label">Email</label>
              <input class="acct-input" id="acct-email" type="email" readonly placeholder="email@example.com">
            </div>
          </div>

          <div class="acct-field">
            <label class="acct-label">Profile colour</label>
            <div class="color-swatches" id="acct-color-swatches">
              <div class="color-swatch active" style="background:#C9A84C;" data-color="#C9A84C" onclick="pickColor(this)"></div>
              <div class="color-swatch" style="background:#7B9E87;" data-color="#7B9E87" onclick="pickColor(this)"></div>
              <div class="color-swatch" style="background:#5B8FAB;" data-color="#5B8FAB" onclick="pickColor(this)"></div>
              <div class="color-swatch" style="background:#C4704A;" data-color="#C4704A" onclick="pickColor(this)"></div>
              <div class="color-swatch" style="background:#9B7AB8;" data-color="#9B7AB8" onclick="pickColor(this)"></div>
              <div class="color-swatch" style="background:#4A90A4;" data-color="#4A90A4" onclick="pickColor(this)"></div>
              <div class="color-swatch" style="background:#3C3C3C;" data-color="#3C3C3C" onclick="pickColor(this)"></div>
            </div>
          </div>

          <div class="acct-btn-row" style="margin-top:20px;">
            <button class="acct-btn acct-btn-primary" onclick="saveProfile()">Save changes</button>
            <span class="acct-status-msg" id="profile-status"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- SUBSCRIPTION PANEL -->
    <div class="acct-panel" id="panel-subscription">
      <div class="acct-card">
        <div class="acct-card-head">
          <h3>Subscription</h3>
          <p>Your current plan and billing details.</p>
        </div>
        <div class="acct-card-body">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
            <div>
              <div style="font-size:13px;color:var(--slate);margin-bottom:6px;">Current plan</div>
              <div id="plan-badge-display"></div>
            </div>
            <div id="plan-upgrade-btn"></div>
          </div>
          <div class="plan-feature-list" id="plan-features"></div>
        </div>
      </div>

      <div class="acct-card" id="billing-card" style="display:none;">
        <div class="acct-card-head">
          <h3>Billing</h3>
          <p>Manage your payment method and billing history.</p>
        </div>
        <div class="acct-card-body">
          <div class="security-row">
            <div>
              <div class="security-label">Payment method</div>
              <div class="security-meta" id="payment-method-text">Visa ending in ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            </div>
            <button class="acct-btn acct-btn-outline" onclick="openBillingPortal()">Update</button>
          </div>
          <div class="security-row">
            <div>
              <div class="security-label">Next billing date</div>
              <div class="security-meta" id="next-billing-text">‚Äî</div>
            </div>
            <button class="acct-btn acct-btn-outline" onclick="openBillingPortal()">Manage</button>
          </div>
          <div style="margin-top:16px;">
            <button class="acct-btn acct-btn-danger" onclick="openBillingPortal()">Cancel subscription</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECURITY PANEL -->
    <div class="acct-panel" id="panel-security">
      <div class="acct-card">
        <div class="acct-card-head">
          <h3>Security</h3>
          <p>Manage your password and account access.</p>
        </div>
        <div class="acct-card-body">
          <div class="security-row">
            <div>
              <div class="security-label">Password</div>
              <div class="security-meta">Last changed: unknown</div>
            </div>
            <button class="acct-btn acct-btn-outline" onclick="showPasswordForm()">Change</button>
          </div>
          <div id="password-form" style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid rgba(28,28,30,0.07);">
            <div class="acct-field">
              <label class="acct-label">Current password</label>
              <input class="acct-input" id="pw-current" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="acct-row">
              <div class="acct-field">
                <label class="acct-label">New password</label>
                <input class="acct-input" id="pw-new" type="password" placeholder="Min 8 characters">
              </div>
              <div class="acct-field">
                <label class="acct-label">Confirm new password</label>
                <input class="acct-input" id="pw-confirm" type="password" placeholder="Repeat password">
              </div>
            </div>
            <div class="acct-btn-row">
              <button class="acct-btn acct-btn-primary" onclick="changePassword()">Update password</button>
              <button class="acct-btn acct-btn-outline" onclick="document.getElementById('password-form').style.display='none'">Cancel</button>
              <span class="acct-status-msg" id="pw-status"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="acct-card">
        <div class="acct-card-head">
          <h3>Sessions</h3>
          <p>Sign out of all devices.</p>
        </div>
        <div class="acct-card-body">
          <div class="security-row">
            <div>
              <div class="security-label">Active session</div>
              <div class="security-meta">This device ‚Äî signed in now</div>
            </div>
            <button class="acct-btn acct-btn-outline" onclick="doSignOut()">Sign out</button>
          </div>
        </div>
      </div>

      <div class="danger-zone">
        <h4>‚ö†Ô∏è Danger zone</h4>
        <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
        <button class="acct-btn acct-btn-danger" onclick="confirmDeleteAccount()">Delete account</button>
        <div id="delete-status" class="acct-status-msg" style="margin-top:10px;"></div>
      </div>
    </div>

  </div>
</div>

<footer class="site-footer" style="margin-top:0;">
  <div class="site-footer-inner">
    <div class="footer-bottom"><p>¬© 2025 EquitySight.app ¬∑ Not financial advice.</p><div class="footer-bottom-links"><a href="#">Privacy</a><a href="#">Terms</a><a href="contact.html">Contact</a></div></div>
  </div>
</footer>

<script>
  const SK = 'propCalc_session_v1';
  const PK_BASE = 'propCalc_profile_v1';

  let session = null;
  let profileData = {name:'', email:'', color:'#C9A84C', photo:''};

  function getProfileKey(){ return PK_BASE + '_' + (session?.id || session?.userId || 'guest'); }

  function loadSession(){
    try{ const r=localStorage.getItem(SK); if(r) session=JSON.parse(r); }catch(e){}
    try{ const r=localStorage.getItem(getProfileKey()); if(r) profileData=Object.assign(profileData,JSON.parse(r)); }catch(e){}
  }

  function renderAccount(){
    if(!session){
      document.getElementById('gate-view').style.display='block';
      return;
    }
    document.getElementById('account-view').style.display='grid';

    // Profile fields
    document.getElementById('acct-name').value = session.name || profileData.name || '';
    document.getElementById('acct-email').value = session.email || '';
    renderAvatar();
    renderColorSwatches();
    renderPlan();
  }

  function renderAvatar(){
    const el = document.getElementById('acct-avatar');
    const removeBtn = document.getElementById('avatar-remove');
    if(!el) return;
    if(profileData.photo){
      el.innerHTML = '<img src="'+profileData.photo+'">';
      el.style.background = 'transparent';
      if(removeBtn) removeBtn.style.display='inline-block';
    } else {
      const name = session?.name || '';
      const initials = name ? name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2) : '?';
      el.innerHTML = initials;
      el.style.background = profileData.color || '#C9A84C';
      el.style.color = '#1C1C1E';
      if(removeBtn) removeBtn.style.display='none';
    }
  }

  function renderColorSwatches(){
    document.querySelectorAll('.color-swatch').forEach(function(s){
      s.classList.toggle('active', s.dataset.color === profileData.color);
    });
  }

  function renderPlan(){
    const plan = session?.plan || 'free';
    const badgeEl = document.getElementById('plan-badge-display');
    const upgradeEl = document.getElementById('plan-upgrade-btn');
    const featEl = document.getElementById('plan-features');
    const billCard = document.getElementById('billing-card');

    const badges = {
      free:'<span class="plan-badge plan-free">Free plan</span>',
      pro:'<span class="plan-badge plan-pro">‚≠ê Pro</span>',
      adviser:'<span class="plan-badge plan-adviser">‚óÜ Adviser</span>'
    };
    if(badgeEl) badgeEl.innerHTML = badges[plan] || badges.free;

    const features = {
      free: [
        {ok:true, text:'Calculator with all core features'},
        {ok:true, text:'1 saved property scenario'},
        {ok:false, text:'30-year projection chart (Pro)'},
        {ok:false, text:'PDF export (Pro)'},
        {ok:false, text:'Unlimited library &amp; cloud sync (Pro)'},
      ],
      pro: [
        {ok:true, text:'All calculator features'},
        {ok:true, text:'Unlimited saved properties'},
        {ok:true, text:'30-year projection chart'},
        {ok:true, text:'PDF export'},
        {ok:true, text:'Cloud sync across devices'},
        {ok:true, text:'Priority email support'},
      ],
      adviser: [
        {ok:true, text:'Everything in Pro'},
        {ok:true, text:'Up to 5 client accounts'},
        {ok:true, text:'White-label PDF reports'},
        {ok:true, text:'Phone + email priority support'},
      ]
    };
    const fList = features[plan] || features.free;
    if(featEl) featEl.innerHTML = fList.map(function(f){
      return '<div class="plan-feature"><span class="'+(f.ok?'pf-check':'pf-lock')+'">'+(f.ok?'‚úì':'‚Äî')+'</span>'+f.text+'</div>';
    }).join('');

    if(upgradeEl){
      if(plan==='free') upgradeEl.innerHTML='<button class="acct-btn acct-btn-gold" onclick="location.href=\'pricing.html\'">Upgrade to Pro ‚Üí</button>';
      else upgradeEl.innerHTML='<button class="acct-btn acct-btn-outline" onclick="openBillingPortal()">Manage billing</button>';
    }
    if(billCard) billCard.style.display = (plan==='free') ? 'none' : 'block';
  }

  function pickColor(el){
    profileData.color = el.dataset.color;
    document.querySelectorAll('.color-swatch').forEach(function(s){ s.classList.toggle('active',s===el); });
    renderAvatar();
  }

  function handleAvatarUpload(input){
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const img = new Image();
      img.onload = function(){
        const cv = document.createElement('canvas');
        cv.width = 128; cv.height = 128;
        cv.getContext('2d').drawImage(img,0,0,128,128);
        profileData.photo = cv.toDataURL('image/jpeg', 0.85);
        renderAvatar();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function removeAvatar(){
    profileData.photo = '';
    renderAvatar();
  }

  function saveProfile(){
    profileData.name = document.getElementById('acct-name').value.trim();
    profileData.color = profileData.color || '#C9A84C';
    localStorage.setItem(getProfileKey(), JSON.stringify(profileData));
    // Also update session name
    if(session){
      session.name = profileData.name;
      localStorage.setItem(SK, JSON.stringify(session));
    }
    const st = document.getElementById('profile-status');
    if(st){ st.textContent='‚úì Saved'; st.className='acct-status-msg ok'; setTimeout(function(){st.textContent='';},2000); }
    renderNavUser();
  }

  function showPasswordForm(){
    document.getElementById('password-form').style.display='block';
  }

  async function changePassword(){
    const cur = document.getElementById('pw-current').value.trim();
    const nw  = document.getElementById('pw-new').value;
    const cf  = document.getElementById('pw-confirm').value;
    const st  = document.getElementById('pw-status');
    if(!cur || !nw){ st.textContent='Please fill in all password fields'; st.className='acct-status-msg err'; return; }
    if(nw.length < 8){ st.textContent='New password must be at least 8 characters'; st.className='acct-status-msg err'; return; }
    if(nw !== cf){ st.textContent="New passwords don't match"; st.className='acct-status-msg err'; return; }
    st.textContent='Updating‚Ä¶'; st.className='acct-status-msg';
    const token = session && session.token;
    try{
      const r = await fetch('/.netlify/functions/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (token || '') },
        body: JSON.stringify({ action: 'changePassword', currentPassword: cur, newPassword: nw })
      });
      const d = await r.json();
      if(d.ok){
        st.textContent = '‚úì Password updated successfully';
        st.className = 'acct-status-msg ok';
        document.getElementById('pw-current').value = '';
        document.getElementById('pw-new').value = '';
        document.getElementById('pw-confirm').value = '';
        if(document.getElementById('pw-strength-bar')) document.getElementById('pw-strength-bar').style.width='0%';
      } else {
        st.textContent = d.error || 'Failed ‚Äî please check your current password';
        st.className = 'acct-status-msg err';
      }
    } catch(e){ st.textContent = 'Network error ‚Äî please try again'; st.className = 'acct-status-msg err'; }
  }

  function openBillingPortal(){
    // Stripe billing portal ‚Äî configure portal URL in Netlify env vars
    alert('Billing portal coming soon. Email support@EquitySight.app to manage your subscription.');
  }

  async function confirmDeleteAccount(){
    const pw = prompt('Enter your password to confirm account deletion. This cannot be undone.');
    if(!pw) return;
    const st = document.getElementById('delete-status') || document.createElement('span');
    try{
      const token = session && session.token;
      const r = await fetch('/.netlify/functions/auth',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+(token||'')},
        body:JSON.stringify({action:'deleteAccount',password:pw,token:token})
      });
      const d = await r.json();
      if(d.ok){
        // Clear all local data
        localStorage.clear();
        alert('Your account has been deleted. You will now be redirected to the home page.');
        location.href='index.html';
      } else {
        alert(d.error||'Failed to delete account. Please try again.');
      }
    }catch(e){
      // Fallback: clear local data only
      localStorage.clear();
      alert('Account data cleared locally. Contact support to remove server data.');
      location.href='index.html';
    }
  }

  function doSignOut(){
    if(session?.token){
      fetch('/.netlify/functions/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'signout',token:session.token})}).catch(()=>{});
    }
    localStorage.removeItem(SK);
    location.href='index.html';
  }

  function showPanel(id, btn){
    document.querySelectorAll('.acct-panel').forEach(function(p){ p.classList.remove('active'); });
    document.querySelectorAll('.acct-nav-item').forEach(function(b){ b.classList.remove('active'); });
    const panel = document.getElementById('panel-'+id);
    if(panel) panel.classList.add('active');
    if(btn) btn.classList.add('active');
  }

  // Session nav
  function renderNavUser(){
    const el = document.getElementById('nav-actions');
    if(!session || !el) return;
    const n = session.name || session.email || 'Account';
    const ini = n.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
    const ph = profileData && profileData.photo;
    const col = (profileData && profileData.color) || '#C9A84C';
    el.innerHTML='<a href="app.html" style="font-family:\'DM Mono\',monospace;font-size:11px;color:rgba(245,240,232,0.55);padding:8px 14px;border-radius:3px;background:rgba(255,255,255,0.06);text-decoration:none;border:1px solid rgba(255,255,255,0.1);">Open App ‚Üí</a>'
      +'<div class="nav-user-wrap" id="nuw"><button class="nav-user-btn" onclick="document.getElementById(\'nuw\').classList.toggle(\'open\')" title="'+n+'">'+(ph?'<img src="'+ph+'">':ini)+'</button>'
      +'<div class="nav-user-dropdown"><div class="nav-dropdown-header"><div class="nav-dropdown-name">'+n+'</div><div class="nav-dropdown-email">'+(session.email||'')+'</div></div>'
      +'<div class="nav-dropdown-items"><a href="app.html" class="nav-dropdown-item">üè† Open Calculator</a><a href="account.html" class="nav-dropdown-item active-link">‚öô Account Settings</a><button class="nav-dropdown-item danger" onclick="doSignOut()">Sign Out</button></div></div></div>';
    document.addEventListener('click',function(e){const w=document.getElementById('nuw');if(w&&!w.contains(e.target))w.classList.remove('open');},{once:false});
  }

  document.getElementById('nav-ham').addEventListener('click',function(){
    const l=document.querySelector('.site-nav-links');
    l.style.cssText=l.style.display==='flex'?'':'display:flex;flex-direction:column;position:absolute;top:64px;left:0;right:0;background:var(--charcoal-soft);padding:12px 24px;border-top:1px solid rgba(255,255,255,0.06);z-index:999;';
  });

  // Check for checkout success
  const urlParams = new URLSearchParams(location.search);
  if(urlParams.get('checkout')==='1'){
    setTimeout(function(){ showPanel('subscription', document.querySelector('[onclick*="subscription"]')); }, 300);
  }

  loadSession();
  renderAccount();
  renderNavUser();
</script>
</body>
</html>
