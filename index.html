<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PropCalc">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1C1C1E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231C1C1E'/><text y='68' x='50' text-anchor='middle' font-size='54' font-family='serif'>üè†</text></svg>">
  <link rel="manifest" href="/manifest.json">
<title>Property Finance Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream:#F5F0E8;--warm-white:#FAF7F2;--charcoal:#1C1C1E;--charcoal-soft:#2C2C2E;
    --slate:#4A4A52;--sage:#7B9E87;--sage-light:#A8C4B0;--terracotta:#C4704A;
    --terracotta-light:#E8A882;--gold:#C9A84C;--sky:#5B8FAB;--risk-red:#C45A5A;--reward-green:#5A9E7B;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--cream);font-family:'DM Sans',sans-serif;color:var(--charcoal);min-height:100vh;overflow-x:hidden;font-size:17px;}

  header{background:var(--charcoal);color:var(--cream);padding:0;position:relative;overflow:hidden;}
  header::before{content:'';position:absolute;top:-60px;left:-40px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(201,168,76,0.12) 0%,transparent 70%);pointer-events:none;}
  .header-inner{display:flex;align-items:stretch;min-height:150px;}
  .header-text{flex:1;padding:28px 36px;display:flex;flex-direction:column;justify-content:center;position:relative;z-index:1;}
  .header-tag{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:6px;}
  h1{font-family:'Playfair Display',serif;font-size:clamp(24px,3.5vw,40px);font-weight:900;line-height:1.1;margin-bottom:4px;}
  .header-sub{font-size:13px;color:rgba(245,240,232,0.45);font-weight:300;margin-bottom:14px;}
  .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .header-badge{background:var(--gold);color:var(--charcoal);font-family:'DM Mono',monospace;font-size:12px;font-weight:500;letter-spacing:1px;padding:5px 12px;border-radius:2px;}
  .export-btn{display:flex;align-items:center;gap:6px;padding:6px 13px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.18);border-radius:2px;font-family:'DM Mono',monospace;font-size:12px;color:var(--cream);cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
  .export-btn:hover{background:rgba(255,255,255,0.18);border-color:rgba(255,255,255,0.35);}
  .header-photo-wrap{width:280px;flex-shrink:0;position:relative;overflow:hidden;}
  .header-photo{width:100%;height:100%;object-fit:cover;display:block;opacity:0.88;}
  .photo-caption{position:absolute;bottom:0;left:0;right:0;padding:6px 10px;background:linear-gradient(transparent,rgba(0,0,0,0.65));font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.7);}
  .upload-zone{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04);border-left:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:background 0.2s;text-align:center;}
  .upload-zone:hover,.upload-zone.drag-over{background:rgba(201,168,76,0.13);border-left-color:rgba(201,168,76,0.5);}
  .upload-inner{padding:16px;}
  /* ‚îÄ‚îÄ PROPERTY DETAILS TAB ‚îÄ‚îÄ */
  .pd-field{display:flex;flex-direction:column;gap:4px;}
  .pd-label{font-size:12px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:0.5px;text-transform:uppercase;}
  .pd-field input[type="text"],.pd-field input[type="number"]{background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);color:var(--charcoal);padding:9px 11px;font-size:14px;}
  .pd-field input[type="text"]:focus,.pd-field input[type="number"]:focus{border-color:var(--gold);background:white;}
  .pd-stepper{display:flex;align-items:center;gap:0;}
  .pd-stepper button{width:34px;height:36px;background:rgba(28,28,30,0.07);border:1px solid rgba(28,28,30,0.12);color:var(--charcoal);font-size:17px;cursor:pointer;transition:background 0.15s;flex-shrink:0;}
  .pd-stepper button:first-child{border-radius:3px 0 0 3px;}
  .pd-stepper button:last-child{border-radius:0 3px 3px 0;}
  .pd-stepper button:hover{background:rgba(201,168,76,0.15);}
  .pd-stepper input{flex:1;text-align:center;border-left:none;border-right:none;border-radius:0;padding:8px 4px;}
  .prop-type-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px;}
  .prop-type-btn{padding:11px 8px;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.1);border-radius:3px;font-size:13px;cursor:pointer;transition:all 0.2s;color:var(--slate);}
  .prop-type-btn:hover{background:rgba(201,168,76,0.1);border-color:var(--gold);color:var(--charcoal);}
  .prop-type-btn.active{background:rgba(201,168,76,0.15);border-color:var(--gold);color:var(--charcoal);font-weight:500;}
  .pd-stat-chip{display:inline-flex;align-items:center;gap:5px;font-family:'DM Mono',monospace;font-size:12px;color:rgba(245,240,232,0.6);background:rgba(255,255,255,0.08);padding:4px 10px;border-radius:12px;}
  #prop-photo-big-wrap.pd-drag{outline:2px dashed var(--gold);}
  @media print{
    *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
    @page{margin:8mm 10mm;size:A4;}

    body{background:#fff!important;font-size:10px!important;line-height:1.4!important;}

    /* Hide chrome */
    .sidebar{display:none!important;}
    .export-btn,.header-badge,.header-actions button,#saved-btn,nav,#scenarios-modal,#confirm-modal{display:none!important;}

    /* Compact header */
    header{min-height:auto!important;break-inside:avoid;}
    .header-inner{min-height:60px!important;}
    .header-text{padding:10px 16px!important;}
    h1{font-size:18px!important;margin-bottom:2px!important;}
    .header-sub{font-size:10px!important;margin-bottom:6px!important;}
    .header-photo-wrap{width:140px!important;}
    .header-actions{margin-top:0!important;}

    /* Layout */
    .app-body{display:block!important;height:auto!important;overflow:visible!important;}
    .content{overflow:visible!important;height:auto!important;display:block!important;}
    main{padding:8px 12px!important;overflow:visible!important;}

    /* Show all tabs at once, each starting on new page except property tab */
    .section{display:block!important;animation:none!important;}
    #property{page-break-after:avoid;}
    #costs,#reno,#repay,#overlap,#time,#risks{page-break-before:always;}

    /* Cards: tight, no breaks inside */
    .card{break-inside:avoid!important;page-break-inside:avoid!important;margin-bottom:6px!important;padding:10px 12px!important;border:1px solid #ddd!important;}
    h3{font-size:12px!important;margin-bottom:6px!important;}
    .sl{margin-bottom:8px!important;font-size:9px!important;}
    .section-label{margin-bottom:8px!important;}

    /* Grids: use 2-col side by side */
    .g2{grid-template-columns:1fr 1fr!important;gap:6px!important;}
    .g2 > .card{margin-bottom:0!important;}

    /* Summary tiles: 4 across */
    .tiles{grid-template-columns:repeat(4,1fr)!important;gap:5px!important;margin-bottom:6px!important;}
    .tile{padding:8px 10px!important;}
    .tile-val{font-size:13px!important;}
    .tile-lbl{font-size:9px!important;}
    .tile-dot{margin-bottom:5px!important;width:12px!important;height:2px!important;}

    /* Cash banner */
    .cb{padding:8px 12px!important;margin-bottom:6px!important;flex-wrap:nowrap!important;}
    .cv{font-size:13px!important;}
    .clbl{font-size:8px!important;}

    /* Repayment grid */
    .rg{grid-template-columns:repeat(3,1fr)!important;gap:5px!important;margin-top:6px!important;}
    .rc{padding:7px 8px!important;}
    .rv{font-size:13px!important;}
    .rl,.rs{font-size:8px!important;}

    /* Overlap tiles */
    .overlap-tiles{grid-template-columns:repeat(3,1fr)!important;gap:5px!important;margin-bottom:6px!important;}

    /* Hide heavy visuals that don't print well */
    #cal-grid{display:none!important;}
    #overlap-scenarios{font-size:9px!important;}

    /* Reno notes: show them */
    .reno-note-wrap{padding:2px 0 4px 24px!important;}
    .reno-note{border:none!important;background:none!important;resize:none!important;font-size:9px!important;color:#555!important;padding:0!important;min-height:auto!important;}

    /* Risk/reward */
    .rr-grid{grid-template-columns:1fr 1fr!important;gap:10px!important;}
    .mt{height:6px!important;margin-bottom:6px!important;}

    /* Stress table */
    #stress-table{font-size:9px!important;}

    /* Donut */
    .dw{flex-wrap:nowrap!important;}

    /* Timeline compact */
    .tl-item,.tli{margin-bottom:10px!important;}
    .tl-desc,.tldesc{font-size:9px!important;}

    /* Property tab: show 2-col */
    #property .g2{grid-template-columns:200px 1fr!important;}
    #prop-photo-big-wrap{min-height:160px!important;}
    .prop-type-grid{grid-template-columns:repeat(4,1fr)!important;}
    #pd-notes{height:50px!important;font-size:9px!important;}
    #pd-preview-stats{display:none!important;}

    /* Bar charts */
    .bi{margin-bottom:5px!important;}
    .bm{font-size:9px!important;}
    .bt{height:4px!important;}

    /* Donut SVG */
    .dw svg{width:80px!important;height:80px!important;}
  }



  .app-body{display:grid;grid-template-columns:340px 1fr;overflow:hidden;height:calc(100vh - 150px - 44px);}

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar{background:var(--charcoal-soft);color:var(--cream);padding:24px 20px;overflow-y:auto;border-right:1px solid rgba(255,255,255,0.05);height:100%;}
  
  .sidebar-title{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.08);}
  .s-head{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(245,240,232,0.28);margin-bottom:10px;}
  .ig{margin-bottom:12px;}
  .il{font-size:14px;color:rgba(245,240,232,0.48);margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;}
  .il span{font-family:'DM Mono',monospace;color:var(--gold);font-size:14px;}
  .iw{position:relative;}
  .ipfx{position:absolute;left:9px;top:50%;transform:translateY(-50%);font-family:'DM Mono',monospace;font-size:13px;color:rgba(245,240,232,0.3);pointer-events:none;}
  .isfx{position:absolute;right:9px;top:50%;transform:translateY(-50%);font-family:'DM Mono',monospace;font-size:12px;color:rgba(245,240,232,0.3);pointer-events:none;}
  input[type="number"],input[type="text"]{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:10px 8px 10px 26px;font-family:'DM Mono',monospace;font-size:15px;color:var(--cream);outline:none;transition:border-color 0.2s;-moz-appearance:textfield;}
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;}
  input[type="number"]:focus,input[type="text"]:focus{border-color:var(--gold);}
  input.pct{padding-left:8px;padding-right:24px;}
  input[type="range"]{width:100%;accent-color:var(--gold);cursor:pointer;margin-top:4px;}
  hr.div{border:none;border-top:1px solid rgba(255,255,255,0.07);margin:14px 0;}

  .preset-bar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:14px;}
  .preset-btn{padding:6px 10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:2px;font-family:'DM Mono',monospace;font-size:11px;color:rgba(245,240,232,0.5);cursor:pointer;transition:all 0.2s;white-space:nowrap;}
  .preset-btn:hover{background:rgba(201,168,76,0.15);border-color:var(--gold);color:var(--gold);}

  /* dynamic cost items */
  .cost-items-list{margin-bottom:8px;}
  .dyn-cost-row{display:flex;gap:5px;align-items:center;margin-bottom:6px;}
  .dyn-cost-row input[type="text"]{flex:1.4;padding:7px 7px;}
  .dyn-cost-row input[type="number"]{flex:1;padding:7px 7px 7px 20px;}
  .dyn-del{width:24px;height:24px;border-radius:2px;background:rgba(196,90,90,0.2);border:1px solid rgba(196,90,90,0.3);color:var(--terracotta-light);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;}
  .dyn-del:hover{background:rgba(196,90,90,0.4);}
  .add-cost-btn{display:flex;align-items:center;gap:6px;padding:7px 10px;background:rgba(201,168,76,0.1);border:1px dashed rgba(201,168,76,0.3);border-radius:3px;font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);cursor:pointer;transition:all 0.2s;width:100%;}
  .add-cost-btn:hover{background:rgba(201,168,76,0.2);}

  .alert{padding:10px 12px;border-radius:3px;font-size:14px;line-height:1.5;margin-top:12px;}
  .alert-warn{background:rgba(196,112,74,0.15);border:1px solid rgba(196,112,74,0.3);color:var(--terracotta-light);}
  .alert-ok{background:rgba(90,158,123,0.15);border:1px solid rgba(90,158,123,0.3);color:var(--sage-light);}

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .content{overflow:hidden;display:flex;flex-direction:column;height:100%;}
  nav{background:var(--charcoal);display:flex;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;}
  nav::-webkit-scrollbar{display:none;}
  .tab{flex:1;min-width:110px;padding:14px 10px;font-family:'DM Mono',monospace;font-size:14px;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;color:rgba(245,240,232,0.4);cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s;text-align:center;white-space:nowrap;border:none;background:none;}
  .tab:hover{color:rgba(245,240,232,0.85);}
  .tab.active{color:var(--gold);border-bottom:3px solid var(--gold);}

  main{padding:26px 32px;flex:1;overflow-y:auto;}
  .section{display:none;animation:fadeUp 0.3s ease;}
  .section.active{display:block;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .spinner{display:inline-block;flex-shrink:0;width:18px;height:18px;border-radius:50%;border:2.5px solid rgba(201,168,76,0.25);border-top-color:var(--gold);-webkit-animation:spin 0.75s linear infinite;animation:spin 0.75s linear infinite;}
  .spinner-sm{display:inline-block;vertical-align:middle;width:13px;height:13px;border-radius:50%;border:2px solid rgba(255,255,255,0.25);border-top-color:#fff;-webkit-animation:spin 0.75s linear infinite;animation:spin 0.75s linear infinite;}

  .sl{font-family:'DM Mono',monospace;font-size:13px;letter-spacing:3px;text-transform:uppercase;color:var(--slate);margin-bottom:20px;display:flex;align-items:center;gap:12px;}
  .sl::after{content:'';flex:1;height:1px;background:rgba(28,28,30,0.12);}
  .card{background:var(--warm-white);border-radius:4px;padding:26px;border:1px solid rgba(28,28,30,0.08);position:relative;margin-bottom:18px;font-size:15px;}
  .ca{position:absolute;top:0;left:0;width:4px;height:100%;border-radius:4px 0 0 4px;}
  .g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  h3{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;margin-bottom:16px;}

  .tiles{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
  .tile{background:var(--charcoal);color:var(--cream);border-radius:4px;padding:18px;position:relative;overflow:hidden;}
  .tile::after{content:'';position:absolute;bottom:-14px;right:-14px;width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.04);}
  .tile-val{font-family:'DM Mono',monospace;font-size:26px;font-weight:500;margin-bottom:3px;}
  .tile-lbl{font-size:13px;color:rgba(245,240,232,0.38);}
  .tile-dot{width:16px;height:3px;border-radius:2px;margin-bottom:9px;}

  .cr{display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid rgba(28,28,30,0.07);font-size:16px;}
  .cr .nm{color:var(--slate);}
  .cr .am{font-family:'DM Mono',monospace;font-size:16px;}
  .cr.tot{border-top:2px solid var(--charcoal);border-bottom:none;margin-top:4px;padding-top:10px;}
  .cr.tot .nm{color:var(--charcoal);font-weight:500;}

  .bi{margin-bottom:10px;}
  .bm{display:flex;justify-content:space-between;font-size:15px;margin-bottom:4px;color:var(--slate);}
  .bm span:last-child{font-family:'DM Mono',monospace;color:var(--charcoal);}
  .bt{height:6px;background:rgba(28,28,30,0.08);border-radius:3px;overflow:hidden;}
  .bf{height:100%;border-radius:3px;transition:width 0.6s cubic-bezier(0.16,1,0.3,1);}

  .dw{display:flex;align-items:center;gap:18px;flex-wrap:wrap;}
  .li{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:16px;}
  .ld{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .lv{font-family:'DM Mono',monospace;font-size:15px;margin-left:auto;padding-left:12px;color:var(--slate);}

  .cb{background:var(--charcoal);color:var(--cream);border-radius:4px;padding:18px 22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:14px;}
  .cs{text-align:center;}
  .cv{font-family:'DM Mono',monospace;font-size:30px;}
  .clbl{font-size:13px;color:rgba(245,240,232,0.38);margin-top:2px;}

  .rg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;}
  .rc{background:var(--charcoal);color:var(--cream);border-radius:3px;padding:13px;text-align:center;}
  .rv{font-family:'DM Mono',monospace;font-size:22px;margin-bottom:2px;}
  .rl{font-size:12px;color:rgba(245,240,232,0.38);}
  .rs{font-size:12px;color:var(--gold);margin-top:1px;font-family:'DM Mono',monospace;}

  .reno-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid rgba(28,28,30,0.06);gap:10px;font-size:16px;}
  .ri{font-size:15px;width:20px;text-align:center;}
  .rn{flex:1;color:var(--slate);}
  .ra{font-family:'DM Mono',monospace;font-size:13px;min-width:52px;text-align:right;}
  .rbt{flex:1;max-width:66px;height:4px;background:rgba(28,28,30,0.08);border-radius:2px;overflow:hidden;}
  .rbf{height:100%;border-radius:2px;background:var(--sage);transition:width 0.5s;}
  .reno-note-wrap{padding:0 0 8px 27px;border-bottom:1px dashed rgba(28,28,30,0.1);}
  .reno-note{width:100%;background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.08);border-radius:3px;padding:6px 8px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--slate);resize:none;outline:none;line-height:1.5;min-height:28px;max-height:80px;overflow-y:auto;transition:border-color 0.2s,min-height 0.2s;}
  .reno-note:focus{border-color:var(--sage);background:white;min-height:48px;}
  .reno-note::placeholder{color:rgba(74,74,82,0.4);font-style:italic;}

  .tl{position:relative;padding-left:24px;}
  .tl::before{content:'';position:absolute;left:6px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,var(--gold),var(--sage));}
  .tli{position:relative;margin-bottom:20px;}
  .tld{position:absolute;left:-20px;top:4px;width:9px;height:9px;border-radius:50%;border:2px solid var(--warm-white);box-shadow:0 0 0 2px currentColor;}
  .tlp{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;}
  .tlt{font-size:17px;font-weight:500;margin-bottom:2px;}
  .tldesc{font-size:12px;color:var(--slate);line-height:1.6;}
  .tldr{display:inline-block;background:var(--charcoal);color:var(--cream);font-family:'DM Mono',monospace;font-size:10px;padding:2px 7px;border-radius:2px;margin-top:4px;}

  .rr-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
  .rri{display:flex;align-items:flex-start;gap:9px;padding:10px 0;border-bottom:1px solid rgba(28,28,30,0.07);font-size:12px;line-height:1.6;}
  .rric{width:25px;height:25px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
  .risk .rric{background:rgba(196,90,90,0.1);}
  .reward .rric{background:rgba(90,158,123,0.1);}
  .rrt{font-weight:500;margin-bottom:1px;font-size:13px;}
  .rrb{color:var(--slate);}
  .mt{height:8px;background:rgba(28,28,30,0.08);border-radius:4px;overflow:hidden;margin-bottom:9px;}
  .mf{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1);}

  /* ‚îÄ‚îÄ RENT OVERLAP TAB ‚îÄ‚îÄ */
  .overlap-tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
  .week-slider-wrap{margin:16px 0;}
  .week-slider-wrap label{font-family:'DM Mono',monospace;font-size:11px;color:var(--slate);display:flex;justify-content:space-between;margin-bottom:6px;}
  .week-slider-wrap label span{color:var(--gold);font-weight:500;}
  .dual-breakdown{display:flex;flex-direction:column;gap:0;}
  .dual-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(28,28,30,0.07);font-size:12px;}
  .dual-row .dnm{color:var(--slate);}
  .dual-row .dam{font-family:'DM Mono',monospace;font-size:12px;}
  .dual-row.dtot{border-top:2px solid var(--charcoal);border-bottom:none;margin-top:4px;padding-top:10px;}
  .dual-row.dtot .dnm{font-weight:600;color:var(--charcoal);}
  .overlap-visual{display:flex;gap:0;border-radius:4px;overflow:hidden;height:36px;margin:16px 0;}
  .ov-seg{display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;transition:flex 0.5s;}
  .calendar-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;margin-top:12px;}
  .cal-cell{border-radius:2px;padding:6px 4px;text-align:center;font-family:'DM Mono',monospace;font-size:9px;font-weight:500;}
  .cal-header{font-size:9px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;text-align:center;padding:4px;}
  .cal-both{background:var(--terracotta);color:white;}
  .cal-mortgage{background:var(--sky);color:white;}
  .cal-free{background:rgba(28,28,30,0.06);color:var(--slate);}

  /* ‚îÄ‚îÄ LIBRARY FILTER BUTTONS ‚îÄ‚îÄ */
  .lib-filter{padding:4px 10px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);border-radius:12px;font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.5);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
  .lib-filter:hover{background:rgba(255,255,255,0.12);color:rgba(245,240,232,0.8);}
  .lib-filter.active{background:rgba(201,168,76,0.2);border-color:var(--gold);color:var(--gold);}
  /* ‚îÄ‚îÄ LIBRARY LIST ROW ‚îÄ‚îÄ */
  .lib-row{display:flex;align-items:center;gap:14px;padding:13px 14px;background:white;border:1px solid rgba(28,28,30,0.08);border-radius:5px;margin-bottom:8px;cursor:pointer;transition:all 0.15s;}
  .lib-row:hover{box-shadow:0 3px 14px rgba(0,0,0,0.1);border-color:rgba(28,28,30,0.16);transform:translateY(-1px);}
  .lib-thumb{width:62px;height:62px;border-radius:4px;flex-shrink:0;background:var(--charcoal-soft);display:flex;align-items:center;justify-content:center;font-size:26px;overflow:hidden;}
  .lib-thumb img{width:100%;height:100%;object-fit:cover;}
  .lib-info{flex:1;min-width:0;}
  .lib-info{flex:1;min-width:0;}
  .lib-addr{font-family:'Playfair Display',serif;font-size:15px;font-weight:700;color:var(--charcoal);margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .lib-meta{font-size:12px;color:var(--slate);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .lib-price{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--sage);flex-shrink:0;}
  .lib-meta{font-size:12px;color:var(--slate);}
  .lib-price{font-family:'DM Mono',monospace;font-size:16px;font-weight:600;color:var(--sage);flex-shrink:0;}
  .lib-ts{font-family:'DM Mono',monospace;font-size:10px;color:rgba(28,28,30,0.3);flex-shrink:0;}
  .lib-del{background:none;border:none;color:rgba(196,90,90,0.4);cursor:pointer;font-size:16px;padding:4px 6px;flex-shrink:0;line-height:1;border-radius:3px;transition:all 0.15s;}
  .lib-del:hover{color:var(--risk-red);background:rgba(196,90,90,0.1);}
  .lib-badge{font-family:'DM Mono',monospace;font-size:10px;padding:3px 9px;border-radius:10px;flex-shrink:0;white-space:nowrap;}
  .lib-del{background:none;border:none;color:rgba(196,90,90,0.4);cursor:pointer;font-size:16px;padding:4px;flex-shrink:0;}
  .lib-del:hover{color:var(--risk-red);}
  .lib-ts{font-family:'DM Mono',monospace;font-size:10px;color:rgba(28,28,30,0.3);flex-shrink:0;white-space:nowrap;}

  /* ‚îÄ‚îÄ STATUS BADGES (item 2) ‚îÄ‚îÄ */
  .status-btn{padding:7px 12px;border-radius:20px;border:2px solid rgba(28,28,30,0.12);background:rgba(28,28,30,0.04);font-size:12px;cursor:pointer;transition:all 0.2s;color:var(--slate);font-family:'DM Sans',sans-serif;}
  .status-btn:hover{border-color:var(--gold);color:var(--charcoal);}
  .status-btn.active[data-status="browsing"]{background:rgba(91,143,171,0.15);border-color:var(--sky);color:var(--sky);}
  .status-btn.active[data-status="auction"]{background:rgba(196,112,74,0.15);border-color:var(--terracotta);color:var(--terracotta);}
  .status-btn.active[data-status="for-sale"]{background:rgba(201,168,76,0.15);border-color:var(--gold);color:var(--gold);}
  .status-btn.active[data-status="offered"]{background:rgba(123,158,135,0.2);border-color:var(--sage);color:var(--sage);}
  .status-btn.active[data-status="under-offer"]{background:rgba(232,168,130,0.2);border-color:var(--terracotta-light);color:var(--terracotta);}
  .status-btn.active[data-status="unconditional"]{background:rgba(90,158,123,0.2);border-color:var(--reward-green);color:var(--reward-green);}
  .status-btn.active[data-status="sold"]{background:rgba(196,90,90,0.12);border-color:var(--risk-red);color:var(--risk-red);}

  /* ‚îÄ‚îÄ KEY DATES (item 3) ‚îÄ‚îÄ */
  .kd-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px dashed rgba(28,28,30,0.1);}
  .kd-row input[type="date"]{background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.1);border-radius:3px;padding:5px 8px;font-family:'DM Mono',monospace;font-size:11px;color:var(--charcoal);}
  .kd-row input[type="text"]{flex:1;background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.1);border-radius:3px;padding:5px 8px;font-size:12px;color:var(--charcoal);}
  .kd-row input[type="date"]:focus,.kd-row input[type="text"]:focus{border-color:var(--sky);outline:none;background:white;}
  .kd-del{background:none;border:none;color:rgba(196,90,90,0.5);cursor:pointer;font-size:15px;padding:0 4px;flex-shrink:0;}
  .kd-del:hover{color:var(--risk-red);}

  /* ‚îÄ‚îÄ COMMS LOG (item 1) ‚îÄ‚îÄ */
  .comms-entry{padding:10px 0;border-bottom:1px solid rgba(28,28,30,0.07);}
  .comms-entry:last-child{border-bottom:none;}
  .comms-meta{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
  .comms-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--slate);}
  .comms-type{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;background:rgba(28,28,30,0.08);padding:2px 7px;border-radius:10px;color:var(--slate);}
  .comms-del{background:none;border:none;color:rgba(196,90,90,0.4);cursor:pointer;font-size:13px;margin-left:auto;padding:0 2px;}
  .comms-text{font-size:12px;color:var(--charcoal);line-height:1.6;}

  /* ‚îÄ‚îÄ COMMS ADD FORM ‚îÄ‚îÄ */
  #comms-add-form{background:rgba(28,28,30,0.04);border-radius:4px;padding:12px;border:1px solid rgba(28,28,30,0.1);margin-top:10px;}

  /* ‚îÄ‚îÄ ADDRESS AUTOCOMPLETE ‚îÄ‚îÄ */
  .addr-wrap{position:relative;}
  .addr-suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid rgba(28,28,30,0.15);border-radius:0 0 4px 4px;box-shadow:0 4px 16px rgba(0,0,0,0.1);z-index:500;max-height:220px;overflow-y:auto;display:none;}
  .addr-suggestion{padding:9px 12px;font-size:13px;color:var(--charcoal);cursor:pointer;border-bottom:1px solid rgba(28,28,30,0.06);line-height:1.4;}
  .addr-suggestion:last-child{border-bottom:none;}
  .addr-suggestion:hover{background:rgba(201,168,76,0.08);}
  .addr-suggestion strong{color:var(--charcoal);font-weight:600;}
  .addr-suggestion span{font-size:11px;color:var(--slate);}

  /* ‚îÄ‚îÄ MOBILE OVERHAUL ‚îÄ‚îÄ */
  @media(max-width:600px){
    /* Sidebar */
    #sidebar-close-btn{display:block!important;}
    .sidebar{display:none;position:fixed;inset:0;z-index:200;overflow-y:auto;border-radius:0;}
    .sidebar.mobile-open{display:block!important;}
    #mobile-sidebar-btn{display:flex!important;}

    /* Header ‚Äî compact but clear */
    header{position:sticky;top:0;z-index:100;}
    .header-inner{min-height:auto!important;flex-wrap:wrap;}
    .header-text{padding:10px 14px!important;flex:1 1 100%;}
    h1{font-size:17px!important;line-height:1.2!important;}
    #header-status-badge{font-size:10px!important;}
    .header-sub{font-size:11px!important;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100vw - 28px);}
    .header-actions{gap:5px!important;flex-wrap:nowrap!important;overflow-x:auto;}
    .export-btn{padding:5px 8px!important;font-size:10px!important;white-space:nowrap;flex-shrink:0;}
    .header-badge{font-size:10px!important;padding:4px 8px!important;}
    .header-photo-wrap{display:none!important;}

    /* Layout */
    .app-body{grid-template-columns:1fr!important;height:auto!important;overflow:visible!important;}
    .content{height:auto!important;overflow:visible!important;display:flex;flex-direction:column;}
    body{overflow-x:hidden;}

    /* Tabs ‚Äî scrollable row */
    nav{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap!important;padding-bottom:1px;}
    .tab{padding:12px 14px!important;font-size:12px!important;white-space:nowrap!important;flex-shrink:0!important;min-width:auto!important;}

    /* Main content */
    main{padding:14px 12px!important;overflow:visible!important;flex:1;}
    .g2{grid-template-columns:1fr!important;gap:10px!important;}
    .rr-grid{grid-template-columns:1fr!important;}
    .tiles{grid-template-columns:1fr 1fr!important;gap:8px!important;}
    .rg{grid-template-columns:1fr 1fr!important;}
    .overlap-tiles{grid-template-columns:1fr 1fr!important;}
    .prop-type-grid{grid-template-columns:1fr 1fr!important;}
    .proj-controls{flex-direction:column!important;gap:10px!important;}
    .card{padding:14px 12px!important;margin-bottom:10px!important;}
    h3{font-size:17px!important;}
    .sl{font-size:11px!important;letter-spacing:2px!important;}

    /* Inputs ‚Äî 16px prevents iOS zoom-in on focus */
    input[type="number"],input[type="text"],input[type="date"],textarea,select{font-size:16px!important;}
    input[type="number"],input[type="text"]{padding:12px 8px 12px 26px!important;}
    input[type="range"]{height:28px!important;margin-top:6px!important;}
    .il{font-size:15px!important;}
    .il span{font-size:15px!important;}
    .dyn-cost-row input{font-size:14px!important;}

    /* Status buttons ‚Äî wrap nicely */
    .status-btn{font-size:11px!important;padding:6px 10px!important;}

    /* Tiles */
    .tile{padding:14px 12px!important;}
    .tile-val{font-size:22px!important;}
    .tile-lbl{font-size:12px!important;}

    /* Cost/list rows */
    .cr{font-size:14px!important;padding:10px 0!important;}
    .cr .am{font-size:14px!important;}
    .li{font-size:14px!important;}
    .bm{font-size:13px!important;}

    /* Library modal full screen */
    #scenarios-modal > div{width:100%!important;max-height:100%!important;top:0!important;left:0!important;transform:none!important;border-radius:0!important;height:100%!important;}
    .lib-row{padding:14px 12px!important;}
    .lib-addr{font-size:15px!important;line-height:1.3!important;}
    .lib-meta{font-size:12px!important;}
    .lib-ts{display:none!important;}
    .lib-price{font-size:15px!important;}

    /* Address suggestions */
    .addr-suggestion{padding:12px!important;font-size:15px!important;}
    .addr-suggestions{z-index:600;}

    /* Timeline */
    .tlt{font-size:15px!important;}
    .tl-date,.tldesc{font-size:13px!important;}

    /* Charts ‚Äî allow horizontal scroll */
    .chart-wrap{overflow-x:auto!important;-webkit-overflow-scrolling:touch!important;}
    #proj-svg-wrap,#projection-chart{min-width:320px;}
  }
  #mobile-sidebar-btn{display:none;align-items:center;justify-content:center;width:36px;height:36px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.18);border-radius:3px;color:var(--cream);cursor:pointer;font-size:16px;flex-shrink:0;}
  #mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:190;}
  #mobile-overlay.open{display:block;}

  @media(max-width:820px){
    .app-body{grid-template-columns:1fr;height:auto!important;}
    .sidebar{height:auto;overflow-y:auto;}
    .header-photo-wrap{width:120px;}
    h1{font-size:20px;}
    main{padding:18px 14px;}
    .g2{grid-template-columns:1fr;}
    .rr-grid{grid-template-columns:1fr;}
    .rg{grid-template-columns:1fr 1fr;}
    .overlap-tiles{grid-template-columns:1fr 1fr;}
  }


  /* ‚îÄ‚îÄ WELCOME SPLASH ‚îÄ‚îÄ */
  #welcome-splash{position:fixed;inset:0;z-index:8000;background:var(--charcoal);display:flex;align-items:center;justify-content:center;opacity:1;transition:opacity 0.4s;}
  #welcome-splash.hiding{opacity:0;pointer-events:none;}
  .splash-inner{text-align:center;padding:40px 24px;max-width:480px;}
  .splash-logo{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--gold);margin-bottom:20px;opacity:0.7;}
  .splash-title{font-family:'Playfair Display',serif;font-size:36px;font-weight:700;color:var(--cream);line-height:1.2;margin-bottom:10px;}
  .splash-sub{font-size:15px;color:rgba(245,240,232,0.45);margin-bottom:40px;line-height:1.6;}
  .splash-btns{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}
  .splash-btn{padding:14px 28px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;cursor:pointer;transition:transform 0.15s,opacity 0.15s;border:none;}
  .splash-btn:hover{transform:translateY(-2px);opacity:0.9;}
  .splash-btn-primary{background:var(--gold);color:var(--charcoal);font-weight:600;}
  .splash-btn-secondary{background:rgba(255,255,255,0.07);color:var(--cream);border:1px solid rgba(255,255,255,0.18)!important;}
  .splash-deco{width:60px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:0 auto 28px;}

  /* ‚îÄ‚îÄ PROFILE BUTTON ‚îÄ‚îÄ */
  #profile-btn{width:36px;height:36px;border-radius:50%;background:var(--gold);border:2px solid rgba(201,168,76,0.5);cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--charcoal);flex-shrink:0;overflow:hidden;transition:transform 0.15s,box-shadow 0.15s;}
  #profile-btn:hover{transform:scale(1.1);box-shadow:0 0 0 3px rgba(201,168,76,0.25);}
  #profile-btn img{width:100%;height:100%;object-fit:cover;border-radius:50%;}

  /* ‚îÄ‚îÄ PROFILE PANEL ‚îÄ‚îÄ */
  #profile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:4999;backdrop-filter:blur(3px);}
  #profile-overlay.open{display:block;}
  #profile-panel{position:fixed;top:0;right:-360px;width:340px;height:100vh;background:var(--charcoal);z-index:5000;box-shadow:-10px 0 50px rgba(0,0,0,0.6);transition:right 0.32s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;overflow-y:auto;}
  #profile-panel.open{right:0;}
  .pp-close{position:sticky;top:0;right:0;margin-left:auto;display:block;width:32px;height:32px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:3px;color:var(--cream);font-size:16px;cursor:pointer;flex-shrink:0;z-index:1;}
  .pp-header{background:linear-gradient(135deg,rgba(201,168,76,0.18),rgba(201,168,76,0.04));padding:12px 22px 22px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;flex-direction:column;gap:0;}
  .pp-avatar-wrap{position:relative;width:68px;height:68px;margin-bottom:12px;}
  .pp-avatar{width:68px;height:68px;border-radius:50%;background:var(--gold);display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:var(--charcoal);overflow:hidden;border:3px solid rgba(201,168,76,0.45);}
  .pp-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
  .pp-avatar-edit{position:absolute;bottom:0;right:0;width:22px;height:22px;border-radius:50%;background:rgba(28,28,30,0.9);border:1.5px solid rgba(201,168,76,0.5);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px;}
  .pp-name{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--cream);margin-bottom:2px;}
  .pp-email-display{font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.35);letter-spacing:0.5px;}
  .pp-section{padding:14px 22px;border-bottom:1px solid rgba(255,255,255,0.05);}
  .pp-section-title{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:rgba(245,240,232,0.3);margin-bottom:10px;}
  .pp-field{margin-bottom:10px;}
  .pp-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(245,240,232,0.4);margin-bottom:5px;display:block;}
  .pp-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:9px 12px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--cream);outline:none;transition:border-color 0.15s;box-sizing:border-box;}
  .pp-input:focus{border-color:rgba(201,168,76,0.6);background:rgba(255,255,255,0.07);}
  .pp-stat{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
  .pp-stat:last-child{border-bottom:none;}
  .pp-stat-lbl{font-size:13px;color:rgba(245,240,232,0.45);}
  .pp-stat-val{font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);}
  .pp-color-swatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform 0.1s;}
  .pp-color-swatch:hover,.pp-color-swatch.active{border-color:var(--cream);transform:scale(1.15);}
  .pp-save-btn{margin:14px 22px 6px;background:var(--gold);color:var(--charcoal);border:none;border-radius:3px;padding:12px;font-family:'DM Mono',monospace;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.5px;transition:opacity 0.15s;}
  .pp-save-btn:hover{opacity:0.88;}
  .pp-login-note{margin:0 22px 18px;padding:11px 13px;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.18);border-radius:3px;font-size:11px;color:rgba(245,240,232,0.45);line-height:1.7;}
  .pp-login-note strong{color:rgba(201,168,76,0.8);}
  .pp-signout-btn{margin:0 22px 22px;background:rgba(255,255,255,0.04);color:rgba(245,240,232,0.4);border:1px solid rgba(255,255,255,0.08);border-radius:3px;padding:9px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;width:calc(100% - 44px);}
  .pp-signout-btn:hover{background:rgba(255,255,255,0.07);color:rgba(245,240,232,0.6);}

  /* ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ */
  #login-modal{display:none;position:fixed;inset:0;z-index:6000;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
  #login-modal.open{display:flex;}
  .lm-box{background:var(--charcoal);border-radius:6px;width:min(400px,94vw);overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.6);}
  .lm-header{background:linear-gradient(135deg,rgba(201,168,76,0.2),rgba(201,168,76,0.05));padding:26px 26px 20px;border-bottom:1px solid rgba(255,255,255,0.07);}
  .lm-tag{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);opacity:0.7;margin-bottom:6px;}
  .lm-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--cream);}
  .lm-body{padding:22px 26px;}
  .lm-tabs{display:flex;gap:0;margin-bottom:20px;border-radius:3px;overflow:hidden;border:1px solid rgba(255,255,255,0.08);}
  .lm-tab{flex:1;padding:9px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;background:rgba(255,255,255,0.03);color:rgba(245,240,232,0.45);border:none;cursor:pointer;transition:all 0.15s;}
  .lm-tab.active{background:rgba(201,168,76,0.15);color:var(--gold);}
  .lm-field{margin-bottom:14px;}
  .lm-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(245,240,232,0.4);margin-bottom:5px;display:block;}
  .lm-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:11px 14px;font-family:'DM Sans',sans-serif;font-size:15px;color:var(--cream);outline:none;transition:border-color 0.15s;box-sizing:border-box;}
  .lm-input:focus{border-color:rgba(201,168,76,0.6);}
  .lm-submit{width:100%;background:var(--gold);color:var(--charcoal);border:none;border-radius:3px;padding:13px;font-family:'DM Mono',monospace;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.5px;margin-top:6px;transition:opacity 0.15s;}
  .lm-submit:hover{opacity:0.88;}
  .lm-submit:disabled{opacity:0.4;cursor:default;}
  .lm-error{font-size:12px;color:#E8956A;margin-top:8px;min-height:18px;font-family:'DM Mono',monospace;}
  .lm-divider{display:flex;align-items:center;gap:10px;margin:16px 0;font-family:'DM Mono',monospace;font-size:9px;color:rgba(245,240,232,0.25);letter-spacing:1px;}
  .lm-divider::before,.lm-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.07);}
  .lm-guest{width:100%;background:rgba(255,255,255,0.04);color:rgba(245,240,232,0.45);border:1px solid rgba(255,255,255,0.08);border-radius:3px;padding:11px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;transition:all 0.15s;}
  .lm-guest:hover{background:rgba(255,255,255,0.07);color:rgba(245,240,232,0.6);}

</style>
</head>
<body>
<div id="mobile-overlay" onclick="toggleMobileSidebar()"></div>

<header>
  <div class="header-inner">
    <div class="header-text">
      <div class="header-tag">Property Finance Calculator</div>
      <h1 id="page-title">New Property</h1>
      <p class="header-sub" id="header-sub-text">Add property details in the Property tab to get started</p>
      <div class="header-actions">
        <button id="mobile-sidebar-btn" onclick="toggleMobileSidebar()" title="Open calculator">‚öô</button>
        <button id="profile-btn" onclick="openProfile()" title="User Profile"></button>
        <div id="unsaved-badge" style="display:none;align-items:center;gap:5px;background:rgba(196,112,74,0.25);border:1px solid rgba(196,112,74,0.5);border-radius:10px;padding:3px 9px;font-family:'DM Mono',monospace;font-size:10px;color:#E8956A;white-space:nowrap;cursor:default;" title="Unsaved changes">‚óè Unsaved</div>
        <button class="export-btn" onclick="saveScenario()" title="Save scenario to library">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save
        </button>
        <button class="export-btn" onclick="newScenario()" title="Start fresh new scenario" style="background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.2);">
          Ôºã New
        </button>
        <button class="export-btn" id="open-saved-btn" onclick="openScenariosModal()" title="Browse saved scenarios">
          üìÅ Library <span id="saved-count" style="display:none;background:var(--gold);color:var(--charcoal);border-radius:10px;padding:1px 6px;font-size:9px;margin-left:3px;vertical-align:middle;">0</span>
        </button>
        <button class="export-btn" onclick="exportPDF()" title="Export to PDF">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export PDF
        </button>
      </div>
    </div>
    <div class="header-photo-wrap" id="photo-wrap">
      <img id="prop-img" src="" alt="" class="header-photo" style="display:none;">
      <div id="upload-zone" class="upload-zone"
           onclick="document.getElementById('pd-file-input').click()"
           ondragover="event.preventDefault();this.classList.add('drag-over')"
           ondragleave="this.classList.remove('drag-over')"
           ondrop="handlePhotoDrop(event)">
        <input type="file" id="photo-file-input" accept="image/*" style="display:none" onchange="handlePhotoFile(this.files[0])">
        <div class="upload-inner">
          <div style="font-size:22px;margin-bottom:6px;">üì∑</div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:rgba(245,240,232,0.7);">ADD PHOTO</div>
          <div style="font-size:10px;color:rgba(245,240,232,0.4);margin-top:3px;">Click or drag & drop</div>
        </div>
      </div>
      <div class="photo-caption" id="photo-caption"></div>
    </div>
  </div>
</header>

  <nav>
    <button class="tab active" onclick="showTab('property',this)">00 ¬∑ Property</button>
    <button class="tab" onclick="showTab('costs',this)">01 ¬∑ Costs</button>
    <button class="tab" id="tab-reno-btn" onclick="showTab('reno',this)">02 ¬∑ Reno</button>
    <button class="tab" onclick="showTab('repay',this)">03 ¬∑ Repayments</button>
    <button class="tab" onclick="showTab('overlap',this)">04 ¬∑ Rent Overlap</button>
    <button class="tab" onclick="showTab('time',this)">05 ¬∑ Timeline</button>
    <button class="tab" id="tab-risks-btn" onclick="showTab('risks',this)">06 ¬∑ Risks</button>
    <button class="tab" onclick="showTab('projection',this)">07 ¬∑ Projection</button>
  </nav>
<div class="app-body">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sidebar">
  <div class="sidebar-title" style="display:flex;align-items:center;justify-content:space-between;">
    <span>‚öô Scenario Calculator</span>
    <button onclick="toggleMobileSidebar()" style="display:none;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:3px;color:var(--cream);font-size:18px;cursor:pointer;padding:2px 8px;line-height:1;" id="sidebar-close-btn">‚úï</button>
  </div>

  <hr class="div">
  <div class="s-head">Purchase Price & Savings</div>
  <input type="hidden" id="inp-address" value="">

  <div class="ig">
    <div class="il">Purchase Price <span id="lbl-price">‚Äî</span></div>
    <div class="iw"><span class="ipfx">$</span><input type="number" id="inp-price" value="650000" min="100000" max="700000" step="1000" placeholder="650000" oninput="syncRange('price');recalc()"></div>
    <input type="range" id="rng-price" min="300000" max="700000" step="5000" value="650000" oninput="syncInput('price');recalc()">
  </div>
  <div class="ig">
    <div class="il">Your Savings <span id="lbl-savings">‚Äî</span></div>
    <div class="iw"><span class="ipfx">$</span><input type="number" id="inp-savings" value="40000" min="0" step="1000" placeholder="40000" oninput="syncRange('savings');recalc()"></div>
    <input type="range" id="rng-savings" min="0" max="200000" step="1000" value="40000" oninput="syncInput('savings');recalc()">
  </div>

  <hr class="div">
  <div class="s-head">Loan & Scheme</div>

  <div class="ig">
    <div class="il">Deposit % <span id="lbl-depp">2.0%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-depp" value="2" min="2" max="20" step="0.5" oninput="syncRange('depp');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-depp" min="2" max="20" step="0.5" value="2" oninput="syncInput('depp');recalc()">
  </div>
  <div class="ig">
    <div class="il">Govt Scheme % <span id="lbl-govt">28.7%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-govt" value="28.7" min="0" max="40" step="0.1" oninput="syncRange('govt');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-govt" min="0" max="40" step="0.1" value="28.7" oninput="syncInput('govt');recalc()">
  </div>
  <div class="ig">
    <div class="il">Interest Rate <span id="lbl-rate">6.2%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-rate" value="6.2" min="1" max="15" step="0.1" oninput="syncRange('rate');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-rate" min="1" max="15" step="0.1" value="6.2" oninput="syncInput('rate');recalc()">
  </div>
  <div class="ig">
    <div class="il">Loan Term <span id="lbl-term">30 yrs</span></div>
    <div class="iw"><input type="number" id="inp-term" value="30" min="5" max="30" step="1" oninput="syncRange('term');recalc()"></div>
    <input type="range" id="rng-term" min="5" max="30" step="1" value="30" oninput="syncInput('term');recalc()">
  </div>

  <hr class="div">
  <!-- PURCHASE COSTS ‚Äî dynamic -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <div class="s-head" style="margin-bottom:0">Purchase Costs</div>
    <button class="add-cost-btn" style="width:auto;padding:4px 9px;font-size:9px;" onclick="addCostItem()">Ôºã Add Item</button>
  </div>

  <div class="cost-items-list" id="cost-items-list">
    <!-- All costs are now fully dynamic (item 14) ‚Äî seeded in JS initPage() -->
  </div>

  <div id="reno-sidebar-section" style="display:none;">
  <div class="ig" style="pointer-events:none;opacity:0.7;display:none;">
    <div class="il">Reno Total <span id="lbl-reno-total">$21,000</span></div>
  </div>
  <div class="ig" style="display:none;">
    <div class="il">Contingency % <span id="lbl-cont">15%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-cont" value="15" min="0" max="50" step="1" oninput="syncRange('cont');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-cont" min="0" max="50" step="1" value="15" oninput="syncInput('cont');recalc()">
  </div>
  </div>

  <div id="rent-sidebar-section">
  <div class="ig">
    <div class="il">Current Rent/wk <span id="lbl-rent">$450</span></div>
    <div class="iw"><span class="ipfx">$</span><input type="number" id="inp-rent" value="450" min="0" step="10" oninput="syncRange('rent');recalc()"></div>
    <input type="range" id="rng-rent" min="0" max="2000" step="10" value="450" oninput="syncInput('rent');recalc()">
  </div>
  <div class="ig">
    <div class="il">Overlap Weeks <span id="lbl-weeks">4</span></div>
    <div class="iw"><input type="number" id="inp-weeks" value="4" min="0" max="26" step="1" oninput="syncRange('weeks');recalc()"></div>
    <input type="range" id="rng-weeks" min="0" max="26" step="1" value="4" oninput="syncInput('weeks');recalc()">
  </div>
  </div>

  <hr class="div">
  <div style="display:flex;flex-direction:column;gap:10px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="s-head" style="margin-bottom:0;">üî® Reno Tab</div>
      <div style="display:flex;align-items:center;gap:7px;">
        <div id="reno-toggle" onclick="toggleReno()" style="width:38px;height:20px;background:var(--sage);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;">
          <div id="reno-toggle-knob" style="position:absolute;top:2px;left:20px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="s-head" style="margin-bottom:0;">üè† Rent Overlap Tab</div>
      <div id="rent-toggle" onclick="toggleRent()" style="width:38px;height:20px;background:var(--sky);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;">
        <div id="rent-toggle-knob" style="position:absolute;top:2px;left:20px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="s-head" style="margin-bottom:0;">‚ö†Ô∏è Risk Tab</div>
      <div id="risk-toggle" onclick="toggleRisk()" style="width:38px;height:20px;background:var(--terracotta);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;">
        <div id="risk-toggle-knob" style="position:absolute;top:2px;left:20px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>
      </div>
    </div>
  </div>
  <div id="sidebar-alert"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="content">

  <!-- ‚ïê‚ïê SCENARIOS MODAL ‚ïê‚ïê -->
  <div id="scenarios-modal" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);" onclick="if(event.target===this)closeScenariosModal()">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(760px,96vw);max-height:90vh;background:var(--warm-white);border-radius:6px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.5);">

      <!-- Header -->
      <div style="background:var(--charcoal);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:12px;">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:2px;">SAVED SCENARIOS</div>
          <div style="font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:var(--cream);">Property Library <span id="lib-count" style="font-family:'DM Mono',monospace;font-size:12px;font-weight:400;color:rgba(245,240,232,0.4);margin-left:6px;"></span></div>
        </div>
        <button onclick="closeScenariosModal()" style="width:32px;height:32px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:3px;color:var(--cream);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">‚úï</button>
      </div>

      <!-- Filter bar -->
      <div style="background:var(--charcoal-soft);padding:10px 20px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,0.06);">
        <span style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.4);letter-spacing:1px;margin-right:2px;">FILTER:</span>
        <button class="lib-filter active" data-filter="all" onclick="setLibFilter('all',this)">All</button>
        <button class="lib-filter" data-filter="browsing" onclick="setLibFilter('browsing',this)">üëÄ Browsing</button>
        <button class="lib-filter" data-filter="for-sale" onclick="setLibFilter('for-sale',this)">üè∑ For Sale</button>
        <button class="lib-filter" data-filter="auction" onclick="setLibFilter('auction',this)">üî® Auction</button>
        <button class="lib-filter" data-filter="offered" onclick="setLibFilter('offered',this)">üìù Offered</button>
        <button class="lib-filter" data-filter="under-offer" onclick="setLibFilter('under-offer',this)">‚è≥ Under Offer</button>
        <button class="lib-filter" data-filter="unconditional" onclick="setLibFilter('unconditional',this)">‚úÖ Unconditional</button>
        <button class="lib-filter" data-filter="sold" onclick="setLibFilter('sold',this)">üî¥ Sold</button>
      </div>

      <!-- List -->
      <div id="scenarios-list" style="overflow-y:auto;flex:1;padding:12px 20px;">
        <div id="scenarios-empty" style="display:none;text-align:center;padding:48px 20px;color:var(--slate);">
          <div style="font-size:40px;margin-bottom:10px;">üè†</div>
          <div style="font-family:'Playfair Display',serif;font-size:17px;margin-bottom:6px;">No saved scenarios yet</div>
          <div style="font-size:13px;line-height:1.6;">Fill in your property details and click <strong>Save</strong> to save your first property.</div>
        </div>
        <div id="scenarios-grid"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CONFIRM LOAD MODAL ‚ïê‚ïê -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.7);">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(420px,90vw);background:var(--warm-white);border-radius:6px;overflow:hidden;box-shadow:0 16px 60px rgba(0,0,0,0.4);">
      <div style="background:var(--terracotta);padding:16px 20px;">
        <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:rgba(255,255,255,0.7);margin-bottom:3px;">CONFIRM LOAD</div>
        <div style="font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:white;">Replace current scenario?</div>
      </div>
      <div style="padding:20px;">
        <p style="font-size:13px;color:var(--slate);line-height:1.7;margin-bottom:16px;">Loading <strong id="confirm-name" style="color:var(--charcoal);">this scenario</strong> will replace all your current values. Any unsaved changes will be lost.</p>
        <div style="display:flex;gap:10px;">
          <button onclick="confirmLoad()" style="flex:1;padding:10px;background:var(--charcoal);color:var(--cream);border:none;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;font-weight:500;cursor:pointer;letter-spacing:0.5px;">‚úì Yes, Load It</button>
          <button onclick="closeConfirmModal()" style="flex:1;padding:10px;background:rgba(28,28,30,0.07);color:var(--slate);border:1px solid rgba(28,28,30,0.12);border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <main>

    <!-- TAB 0: PROPERTY DETAILS -->
    <div class="section active" id="property">
      <div class="sl">Property Details</div>

      <!-- Photo upload + address card -->
      <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:20px;margin-bottom:14px;align-items:start;">

        <!-- Photo upload big zone -->
        <div class="card" style="padding:0;overflow:hidden;">
          <div class="ca" style="background:var(--terracotta)"></div>
          <div id="prop-photo-big-wrap" style="position:relative;aspect-ratio:4/3;background:var(--charcoal);cursor:pointer;"
               onclick="document.getElementById('pd-file-input').click()"
               ondragover="event.preventDefault();this.classList.add('pd-drag')"
               ondragleave="this.classList.remove('pd-drag')"
               ondrop="handlePropPhotoDrop(event)">
            <input type="file" id="pd-file-input" accept="image/*" style="display:none" onchange="handlePropPhotoFile(this.files[0])">
            <img id="pd-photo-big" src="" alt="" style="width:100%;height:100%;object-fit:cover;display:none;position:absolute;top:0;left:0;">
            <div id="pd-upload-prompt" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:rgba(245,240,232,0.5);transition:background 0.2s;">
              <div style="font-size:36px;">üì∑</div>
              <div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--gold)">Upload Photo</div>
              <div style="font-size:11px;">Click or drag & drop your property image</div>
              <div style="font-size:10px;opacity:0.5;">JPG, PNG, WEBP supported</div>
            </div>
            <div id="pd-photo-overlay" style="display:none;position:absolute;bottom:0;left:0;right:0;padding:8px 12px;background:linear-gradient(transparent,rgba(0,0,0,0.7));font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.7);display:flex;justify-content:space-between;align-items:center;">
              <span id="pd-photo-label"></span>
              <button onclick="event.stopPropagation();clearPropPhoto()" style="background:rgba(255,255,255,0.15);border:none;color:white;font-size:11px;padding:3px 8px;border-radius:2px;cursor:pointer;font-family:'DM Mono',monospace;">‚úï Remove</button>
            </div>
          </div>
          <div style="padding:10px 14px 12px;background:var(--warm-white);">
            <div style="font-size:10px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin-bottom:7px;">Property Photo</div>
            <div style="display:flex;gap:6px;align-items:center;">
              <input type="text" id="pd-photo-url" placeholder="Or paste image URL here‚Ä¶" style="flex:1;font-size:11px;padding:5px 8px;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);border-radius:3px;color:var(--charcoal);font-family:'DM Sans',sans-serif;outline:none;" oninput="handlePhotoUrlInput(this.value)">
              <button onclick="applyPhotoUrl()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:5px 10px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;white-space:nowrap;">Use URL</button>
            </div>
          </div>
        </div>

        <!-- Property details form -->
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div class="card">
            <div class="ca" style="background:var(--gold)"></div>
            <h3>Address & Listing</h3>
            <div class="pd-field">
              <label class="pd-label">Street Address</label>
              <div class="addr-wrap">
                <input type="text" id="pd-address" value="" autocomplete="off" oninput="updatePropertyDetails();addrAutocomplete(this.value)" onblur="setTimeout(()=>hideAddrSuggestions(),200)" placeholder="e.g. 54 Southampton St">
                <div id="addr-suggestions" class="addr-suggestions"></div>
              </div>
            </div>
            <div class="g2" style="gap:10px;margin-top:10px;">
              <div class="pd-field">
                <label class="pd-label">Suburb</label>
                <input type="text" id="pd-suburb" value="" oninput="updatePropertyDetails()" placeholder="e.g. Kedron">
              </div>
              <div class="pd-field">
                <label class="pd-label">State</label>
                <input type="text" id="pd-state" value="" oninput="updatePropertyDetails()" placeholder="QLD">
              </div>
            </div>
            <div class="pd-field" style="margin-top:10px;">
              <label class="pd-label">Listing URL (for your reference)</label>
              <input type="text" id="pd-url" value="" oninput="updatePropertyDetails()" placeholder="https://www.realestate.com.au/...">
            </div>
            <div id="pd-url-link" style="display:none;margin-top:6px;">
              <a id="pd-url-anchor" href="#" target="_blank" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--sky);text-decoration:none;">üîó Open listing ‚Üí</a>
            </div>
          </div>

          <div class="card">
            <div class="ca" style="background:var(--sky)"></div>
            <h3>Property Stats</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="pd-field">
                <label class="pd-label">Bedrooms</label>
                <div class="pd-stepper">
                  <button onclick="stepStat('pd-bed',-1)">‚àí</button>
                  <input type="number" id="pd-bed" value="0" min="0" max="10" oninput="updatePropertyDetails()">
                  <button onclick="stepStat('pd-bed',1)">Ôºã</button>
                </div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Bathrooms</label>
                <div class="pd-stepper">
                  <button onclick="stepStat('pd-bath',-1)">‚àí</button>
                  <input type="number" id="pd-bath" value="0" min="0" max="10" oninput="updatePropertyDetails()">
                  <button onclick="stepStat('pd-bath',1)">Ôºã</button>
                </div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Car Spaces</label>
                <div class="pd-stepper">
                  <button onclick="stepStat('pd-car',-1)">‚àí</button>
                  <input type="number" id="pd-car" value="0" min="0" max="10" oninput="updatePropertyDetails()">
                  <button onclick="stepStat('pd-car',1)">Ôºã</button>
                </div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Land Size (m¬≤)</label>
                <div class="iw" style="position:relative;"><input type="number" id="pd-land" value="" oninput="updatePropertyDetails()" placeholder="e.g. 405" style="padding-left:8px;"></div>
              </div>
              <div class="pd-field">
                <label class="pd-label">House Size (m¬≤)</label>
                <div class="iw" style="position:relative;"><input type="number" id="pd-house" value="" oninput="updatePropertyDetails()" placeholder="e.g. 120" style="padding-left:8px;"></div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Year Built</label>
                <div class="iw" style="position:relative;"><input type="number" id="pd-year" value="" oninput="updatePropertyDetails()" placeholder="e.g. 1985" style="padding-left:8px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Property type & notes -->
      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--sage)"></div>
          <h3>Property Type</h3>
          <div class="prop-type-grid">
            <button class="prop-type-btn active" onclick="setPropType(this,'House')">üè† House</button>
            <button class="prop-type-btn" onclick="setPropType(this,'Townhouse')">üèò Townhouse</button>
            <button class="prop-type-btn" onclick="setPropType(this,'Unit/Apt')">üè¢ Unit/Apt</button>
            <button class="prop-type-btn" onclick="setPropType(this,'Duplex')">üèó Duplex</button>
          </div>
          <input type="hidden" id="pd-type" value="House">
        </div>
        <div class="card">
          <div class="ca" style="background:var(--slate)"></div>
          <h3>Notes</h3>
          <textarea id="pd-notes" oninput="updatePropertyDetails()" placeholder="Key observations, things to check, deal-breakers, pros/cons..." style="width:100%;height:120px;background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.1);border-radius:3px;padding:10px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--charcoal);resize:vertical;outline:none;line-height:1.6;"></textarea>
        </div>
      </div>

      <!-- Property Status + Agent + Key Dates (items 1,2,3) -->
      <div class="g2" style="margin-bottom:14px;">

        <!-- Property Status Card (item 2) -->
        <div class="card">
          <div class="ca" style="background:var(--terracotta-light)"></div>
          <h3>Property Status</h3>
          <div id="status-badges" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;">
            <button class="status-btn active" data-status="browsing" onclick="setStatus('browsing',this)">üëÄ Browsing</button>
            <button class="status-btn" data-status="auction" onclick="setStatus('auction',this)">üî® Auction</button>
            <button class="status-btn" data-status="for-sale" onclick="setStatus('for-sale',this)">üè∑ For Sale</button>
            <button class="status-btn" data-status="offered" onclick="setStatus('offered',this)">üìù Offer Sent</button>
            <button class="status-btn" data-status="under-offer" onclick="setStatus('under-offer',this)">‚è≥ Under Offer</button>
            <button class="status-btn" data-status="unconditional" onclick="setStatus('unconditional',this)">‚úÖ Unconditional</button>
            <button class="status-btn" data-status="sold" onclick="setStatus('sold',this)">üî¥ Sold/Passed</button>
          </div>
          <input type="hidden" id="pd-status" value="browsing">
          <div id="status-note-wrap" style="display:none;">
            <div class="pd-field">
              <label class="pd-label">Auction / Offer date</label>
              <input type="date" id="pd-status-date" style="background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);padding:8px 10px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;" oninput="syncKeyDatesFromStatus();document.getElementById('pd-status-date-display').textContent=this.value?formatDate(this.value):'';"><span id="pd-status-date-display" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--slate);margin-left:6px;"></span>
            </div>
          </div>
        </div>

        <!-- Key Dates Card (item 3) -->
        <div class="card">
          <div class="ca" style="background:var(--sky)"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin-bottom:0;">Key Dates</h3>
            <button onclick="addKeyDate()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:5px 11px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;">Ôºã Add Event</button>
          </div>
          <div id="key-dates-list" style="display:flex;flex-direction:column;gap:8px;"></div>
          <div id="key-dates-empty" style="font-size:12px;color:var(--slate);font-style:italic;padding:8px 0;">No key dates yet ‚Äî add inspections, auction dates, settlement, etc.</div>
        </div>
      </div>

      <!-- Agent Details + Comms (item 1) -->
      <div class="g2" style="margin-bottom:14px;">
        <div class="card">
          <div class="ca" style="background:var(--sage)"></div>
          <h3>Real Estate Agent</h3>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div class="pd-field">
              <label class="pd-label">Agency Name</label>
              <input type="text" id="ag-agency" placeholder="e.g. Ray White Kedron" oninput="markAgentDirty()">
            </div>
            <div class="pd-field">
              <label class="pd-label">Agent Name</label>
              <input type="text" id="ag-name" placeholder="e.g. Jane Smith" oninput="markAgentDirty()">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="pd-field">
                <label class="pd-label">Phone</label>
                <input type="tel" id="ag-phone" placeholder="04xx xxx xxx" oninput="markAgentDirty()">
              </div>
              <div class="pd-field">
                <label class="pd-label">Email</label>
                <input type="email" id="ag-email" placeholder="agent@agency.com" oninput="markAgentDirty()">
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <a id="ag-call-link" href="#" style="display:none;background:var(--sage);color:white;padding:6px 12px;border-radius:3px;font-family:'DM Mono',monospace;font-size:10px;text-decoration:none;letter-spacing:0.5px;">üìû Call</a>
              <a id="ag-email-link" href="#" style="display:none;background:var(--sky);color:white;padding:6px 12px;border-radius:3px;font-family:'DM Mono',monospace;font-size:10px;text-decoration:none;letter-spacing:0.5px;">‚úâ Email</a>
            </div>
          </div>
        </div>

        <!-- Comms history -->
        <div class="card">
          <div class="ca" style="background:var(--gold)"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin-bottom:0;">Communication Log</h3>
            <button onclick="addCommsEntry()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:5px 11px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;">Ôºã Log Entry</button>
          </div>
          <div id="comms-list" style="display:flex;flex-direction:column;gap:0;max-height:260px;overflow-y:auto;"></div>
          <div id="comms-empty" style="font-size:12px;color:var(--slate);font-style:italic;padding:8px 0;">No communications logged yet.</div>
        </div>
      </div>

      <!-- Live preview of header -->
      <div class="card" style="background:var(--charcoal);color:var(--cream);">
        <div class="ca" style="background:var(--gold)"></div>
        <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:12px;">HEADER PREVIEW ‚Äî updates live as you type</div>
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
          <div id="pd-preview-photo" style="width:80px;height:56px;border-radius:3px;background:rgba(255,255,255,0.06);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;">üì∑</div>
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:rgba(245,240,232,0.4);text-transform:uppercase;margin-bottom:4px;">Property Finance Calculator</div>
            <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:900;" id="pd-preview-title">New Property</div>
            <div style="display:flex;gap:12px;margin-top:6px;flex-wrap:wrap;" id="pd-preview-stats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 1: COSTS -->
    <div class="section" id="costs">
      <div class="sl">Financial Snapshot</div>
      <div class="tiles">
        <div class="tile"><div class="tile-dot" style="background:var(--gold)"></div><div class="tile-val" id="t-price">$650,000</div><div class="tile-lbl">Purchase Price</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--terracotta)"></div><div class="tile-val" id="t-deposit">$13,000</div><div class="tile-lbl">Your Deposit</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sage)"></div><div class="tile-val" id="t-govt">$187,000</div><div class="tile-lbl">Govt. Contribution</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sky)"></div><div class="tile-val" id="t-remaining">$24,000</div><div class="tile-lbl">Remaining Cash</div></div>
      </div>

      <div class="cb">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:5px">YOUR CASH PICTURE</div>
          <p style="font-size:12px;color:rgba(245,240,232,0.48);line-height:1.6;max-width:280px">Cash after deposit + all fees. Remainder available for renovation or emergency buffer.</p>
        </div>
        <div style="display:flex;gap:18px;flex-wrap:wrap">
          <div class="cs"><div class="cv" id="cb-savings">$40,000</div><div class="clbl">Your Savings</div></div>
          <div class="cs"><div class="cv" style="color:var(--terracotta-light)" id="cb-out">‚àí$16,100</div><div class="clbl">Out-of-Pocket</div></div>
          <div class="cs"><div class="cv" id="cb-remaining" style="color:var(--sage-light)">$23,900</div><div class="clbl">Remaining Cash</div></div>
        </div>
      </div>

      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--gold)"></div>
          <h3>Upfront Cost Breakdown</h3>
          <div class="cr"><span class="nm">Deposit</span><span class="am" id="cr-deposit">$13,000</span></div>
          <div id="cost-rows-display"></div>
          <div class="cr tot"><span class="nm">Total Required</span><span class="am" id="cr-total">$16,100</span></div>
          <div id="cost-note" style="margin-top:10px;padding:8px 10px;border-radius:3px;font-size:11px;line-height:1.6;"></div>
        </div>
        <div class="card">
          <div class="ca" style="background:var(--sky)"></div>
          <h3>Funding Structure</h3>
          <div class="dw">
            <svg width="116" height="116" viewBox="0 0 116 116">
              <circle cx="58" cy="58" r="42" fill="none" stroke="#E8E3D8" stroke-width="17"/>
              <circle id="d-bank" cx="58" cy="58" r="42" fill="none" stroke="#5B8FAB" stroke-width="17" stroke-dasharray="0 263.9" stroke-dashoffset="0" transform="rotate(-90 58 58)"/>
              <circle id="d-govt" cx="58" cy="58" r="42" fill="none" stroke="#7B9E87" stroke-width="17" stroke-dasharray="0 263.9" stroke-dashoffset="0" transform="rotate(-90 58 58)"/>
              <circle id="d-you"  cx="58" cy="58" r="42" fill="none" stroke="#C9A84C" stroke-width="17" stroke-dasharray="0 263.9" stroke-dashoffset="0" transform="rotate(-90 58 58)"/>
              <text id="d-centre" x="58" y="55" text-anchor="middle" font-family="Playfair Display" font-size="11" fill="#1C1C1E" font-weight="700">$650k</text>
              <text x="58" y="68" text-anchor="middle" font-family="DM Mono" font-size="7" fill="#6B6B72">PURCHASE</text>
            </svg>
            <div style="flex:1">
              <div class="li"><div class="ld" style="background:var(--sky)"></div><span>Bank Loan</span><span class="lv" id="leg-bank">$450k</span></div>
              <div class="li"><div class="ld" style="background:var(--sage)"></div><span>Government</span><span class="lv" id="leg-govt">$187k</span></div>
              <div class="li"><div class="ld" style="background:var(--gold)"></div><span>Your Deposit</span><span class="lv" id="leg-you">$13k</span></div>
            </div>
          </div>
          <div style="margin-top:16px">
            <div class="bi"><div class="bm"><span>Bank Loan</span><span id="bp-bank">69.2%</span></div><div class="bt"><div class="bf" id="bf-bank" style="background:var(--sky)"></div></div></div>
            <div class="bi"><div class="bm"><span>Government</span><span id="bp-govt">28.7%</span></div><div class="bt"><div class="bf" id="bf-govt" style="background:var(--sage)"></div></div></div>
            <div class="bi"><div class="bm"><span>Your Deposit</span><span id="bp-dep">2.0%</span></div><div class="bt"><div class="bf" id="bf-dep" style="background:var(--gold)"></div></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 2: RENO -->
    <div class="section" id="reno">
      <div class="sl">Renovation Budget</div>
      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--sage)"></div>
          <h3>Available Pool</h3>
          <div style="text-align:center;padding:10px 0 4px">
            <div style="font-size:10px;font-family:'DM Mono',monospace;letter-spacing:2px;color:var(--slate);margin-bottom:2px;">CASH AVAILABLE</div>
            <div style="font-family:'DM Mono',monospace;font-size:36px;font-weight:500;" id="reno-pool-val">$24k</div>
            <div style="font-size:11px;color:var(--slate);margin-bottom:14px;">After deposit &amp; all upfront costs</div>
            <div style="border-top:1px solid rgba(28,28,30,0.08);padding-top:12px;">
              <div style="font-size:10px;font-family:'DM Mono',monospace;letter-spacing:2px;color:var(--slate);margin-bottom:2px;">UNSPENT BUDGET</div>
              <div style="font-family:'DM Mono',monospace;font-size:36px;font-weight:500;color:var(--reward-green);" id="reno-unspent-val">$0k</div>
              <div style="font-size:11px;color:var(--slate);">Remaining after planned reno</div>
            </div>
          </div>
          <div id="reno-pool-alert"></div>
        </div>
        <div class="card">
          <div class="ca" style="background:var(--terracotta)"></div>
          <h3>Spend vs Budget</h3>
          <div style="margin-bottom:8px">
            <div class="bm"><span>Reno Spend</span><span id="reno-spend-pct">100%</span></div>
            <div class="bt" style="height:10px"><div class="bf" id="reno-spend-bar" style="background:var(--sage)"></div></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--slate);margin-bottom:12px">
            <span>Planned: <strong id="reno-planned" style="color:var(--charcoal)">$0</strong></span>
            <span>Pool: <strong id="reno-pool-cap" style="color:var(--charcoal)">$0</strong></span>
          </div>
          <!-- Dynamic reno items list -->
          <div id="reno-items-list"></div>
          <div style="display:flex;justify-content:space-between;padding-top:9px;border-top:2px solid var(--charcoal);margin-top:5px;font-family:'DM Mono',monospace;font-size:12px">
            <span>Total</span><strong id="reno-total">$0</strong>
          </div>
        </div>
      </div>
      <!-- Add item button -->
      <div style="text-align:center;margin-top:4px;">
        <button onclick="addRenoItem()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:9px 22px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:0.5px;">Ôºã Add Reno Item</button>
      </div>
    </div>

    <!-- TAB 3: REPAYMENTS -->
    <div class="section" id="repay">
      <div class="sl">Loan Repayments</div>
      <div class="card">
        <div class="ca" style="background:var(--sky)"></div>
        <h3>Monthly Repayment</h3>
        <p style="font-size:12px;color:var(--slate);line-height:1.6;margin-bottom:2px">Principal & Interest on bank loan. Adjust rate and term in the sidebar.</p>
        <div class="rg">
          <div class="rc"><div class="rv" id="rp-monthly">$2,741</div><div class="rl">Monthly</div><div class="rs" id="rp-rate-lbl">@ 6.2%</div></div>
          <div class="rc"><div class="rv" id="rp-weekly">$633</div><div class="rl">Weekly</div><div class="rs" id="rp-term-lbl">30yr term</div></div>
          <div class="rc"><div class="rv" id="rp-annual">$32,892</div><div class="rl">Annual</div><div class="rs" id="rp-loan-lbl">$450k loan</div></div>
        </div>
      </div>
      <div class="card">
        <div class="ca" style="background:var(--terracotta)"></div>
        <h3>Rate Stress Test</h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:12px;line-height:1.6">How does your repayment change if rates rise?</p>
        <div id="stress-table"></div>
      </div>
      <div class="card">
        <div class="ca" style="background:var(--sage)"></div>
        <h3>Total Loan Cost</h3>
        <div style="display:flex;gap:22px;flex-wrap:wrap;margin-top:4px">
          <div><div style="font-family:'DM Mono',monospace;font-size:24px;color:var(--risk-red)" id="rp-interest">$536k</div><div style="font-size:11px;color:var(--slate);margin-top:2px">Total Interest Paid</div></div>
          <div><div style="font-family:'DM Mono',monospace;font-size:24px" id="rp-total-paid">$987k</div><div style="font-size:11px;color:var(--slate);margin-top:2px">Total Amount Paid</div></div>
          <div><div style="font-family:'DM Mono',monospace;font-size:24px;color:var(--sage)" id="rp-loan-show">$450k</div><div style="font-size:11px;color:var(--slate);margin-top:2px">Principal</div></div>
        </div>
      </div>
    </div>

    <!-- TAB 4: RENT OVERLAP -->
    <div class="section" id="overlap">
      <div class="sl">Rent + Mortgage Overlap Period</div>

      <div style="background:var(--charcoal);color:var(--cream);border-radius:4px;padding:18px 22px;margin-bottom:14px;font-size:12px;line-height:1.7;color:rgba(245,240,232,0.65)">
        <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:8px">WHAT IS THIS?</div>
        After settlement you may continue renting your current place for a few weeks while renovating before you move in. During this period you're paying <strong style="color:var(--cream)">both</strong> rent and your mortgage ‚Äî this calculator shows the exact cost of that overlap and how it affects your remaining cash buffer.
      </div>

      <div class="overlap-tiles">
        <div class="tile"><div class="tile-dot" style="background:var(--terracotta)"></div><div class="tile-val" id="ov-weekly-total">$1,083</div><div class="tile-lbl">Weekly (both costs)</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--gold)"></div><div class="tile-val" id="ov-total-cost">$4,332</div><div class="tile-lbl">Total Overlap Cost</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sage)"></div><div class="tile-val" id="ov-remaining-after">$19,568</div><div class="tile-lbl">Cash Left After</div></div>
      </div>

      <!-- Visual week bar -->
      <div class="card">
        <div class="ca" style="background:var(--terracotta)"></div>
        <h3>Weekly Cost Breakdown During Overlap</h3>

        <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:6px;font-size:12px"><div style="width:12px;height:12px;border-radius:2px;background:var(--terracotta)"></div>Rent/wk: <strong id="ov-rent-wk">$450</strong></div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px"><div style="width:12px;height:12px;border-radius:2px;background:var(--sky)"></div>Mortgage/wk: <strong id="ov-mort-wk">$633</strong></div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px"><div style="width:12px;height:12px;border-radius:2px;background:rgba(28,28,30,0.12)"></div>After overlap: mortgage only</div>
        </div>

        <!-- Calendar view -->
        <div id="cal-grid"></div>

        <!-- Bar chart of overlap -->
        <div style="margin-top:20px">
          <div class="bm"><span>Rent portion</span><span id="ov-rent-pct">41%</span></div>
          <div class="bt" style="height:8px;margin-bottom:10px"><div class="bf" id="ov-rent-bar" style="background:var(--terracotta)"></div></div>
          <div class="bm"><span>Mortgage portion</span><span id="ov-mort-pct">59%</span></div>
          <div class="bt" style="height:8px"><div class="bf" id="ov-mort-bar" style="background:var(--sky)"></div></div>
        </div>
      </div>

      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--gold)"></div>
          <h3>Overlap Cost Summary</h3>
          <div class="dual-breakdown">
            <div class="dual-row"><span class="dnm">Rent per week</span><span class="dam" id="ov-s-rent">$450</span></div>
            <div class="dual-row"><span class="dnm">Mortgage per week</span><span class="dam" id="ov-s-mort">$633</span></div>
            <div class="dual-row"><span class="dnm">Combined per week</span><span class="dam" id="ov-s-combined">$1,083</span></div>
            <div class="dual-row"><span class="dnm">Number of weeks</span><span class="dam" id="ov-s-weeks">4</span></div>
            <div class="dual-row dtot"><span class="dnm">Total Overlap Cost</span><span class="dam" id="ov-s-total">$4,332</span></div>
          </div>
        </div>

        <div class="card">
          <div class="ca" style="background:var(--sky)"></div>
          <h3>Impact on Cash Buffer</h3>
          <div class="dual-breakdown">
            <div class="dual-row"><span class="dnm">Cash after settlement</span><span class="dam" id="ov-buf-start">$23,900</span></div>
            <div class="dual-row"><span class="dnm">Overlap cost</span><span class="dam" style="color:var(--risk-red)" id="ov-buf-overlap">‚àí$4,332</span></div>
            <div class="dual-row dtot"><span class="dnm">Cash remaining for reno</span><span class="dam" id="ov-buf-final">$19,568</span></div>
          </div>
          <div id="ov-advice" style="margin-top:12px;padding:9px 11px;border-radius:3px;font-size:11px;line-height:1.6;"></div>
        </div>
      </div>

      <!-- Scenarios -->
      <div class="card">
        <div class="ca" style="background:var(--sage)"></div>
        <h3>Overlap Scenarios ‚Äî Cash Remaining for Reno</h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:14px;line-height:1.6">How much renovation budget you'd have left depending on how long the overlap lasts.</p>
        <div id="overlap-scenarios"></div>
      </div>
    </div>

    <!-- TAB 5: TIMELINE -->
    <div class="section" id="time">
      <div class="sl">Time Commitment</div>

      <!-- Key dates from property tab (item 5) -->
      <div class="card" id="tl-key-dates-card" style="display:none;">
        <div class="ca" style="background:var(--sky)"></div>
        <h3>üìÖ Your Key Dates</h3>
        <div class="tl" id="tl-key-dates-list" style="margin-top:12px;"></div>
      </div>

      <div class="card">
        <div class="ca" style="background:var(--gold)"></div>
        <h3>Purchase to Move-In ‚Äî <span id="tl-address">your property</span></h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:22px;line-height:1.6">Estimated timeframes from offer accepted through to settled and living in your new home.</p>
        <div class="tl">
          <div class="tli"><div class="tld" style="color:var(--gold)"></div><div class="tlp" style="color:var(--gold)">Phase 01</div><div class="tlt">Offer Accepted & Contracts Exchanged</div><div class="tldesc">You sign contracts, pay your deposit, and the property is taken off market. Cooling-off period applies (typically 5 business days in QLD).</div><div class="tldr">Week 1‚Äì2</div></div>
          <div class="tli"><div class="tld" style="color:var(--terracotta)"></div><div class="tlp" style="color:var(--terracotta)">Phase 02</div><div class="tlt">Building & Pest Inspection</div><div class="tldesc">Book a licensed inspector within the first week. Results typically returned within 24‚Äì48 hours. Address any findings before settlement.</div><div class="tldr">Week 1‚Äì3</div></div>
          <div class="tli"><div class="tld" style="color:var(--sky)"></div><div class="tlp" style="color:var(--sky)">Phase 03</div><div class="tlt">Finance & Loan Finalisation</div><div class="tldesc">Your bank formally approves the loan. Government scheme contribution confirmed. Solicitor prepares for settlement.</div><div class="tldr">Week 2‚Äì5</div></div>
          <div class="tli"><div class="tld" style="color:var(--sage)"></div><div class="tlp" style="color:var(--sage)">Phase 04</div><div class="tlt">Settlement Day</div><div class="tldesc">Title transfers to your name. Final balance paid. Keys handed over. You are now a homeowner.</div><div class="tldr">Week 4‚Äì12</div></div>
          <div class="tli"><div class="tld" style="color:var(--terracotta-light)"></div><div class="tlp" style="color:var(--terracotta-light)">Phase 05</div><div class="tlt">Overlap Period <span id="tl-overlap-badge" style="font-family:'DM Mono',monospace;font-size:10px;background:var(--terracotta);color:white;padding:2px 7px;border-radius:2px;margin-left:6px;vertical-align:middle;"></span></div><div class="tldesc" id="tl-overlap-desc">You continue renting while renovations begin. Both rent and mortgage repayments are active during this window.</div><div class="tldr" id="tl-overlap-dur">Weeks 1‚Äì4 post-settlement</div></div>
          <div class="tli"><div class="tld" style="color:var(--terracotta-light)"></div><div class="tlp" style="color:var(--terracotta-light)">Phase 06</div><div class="tlt">Renovations Complete</div><div class="tldesc">Tradies finish, final inspections done. Property ready to move in.</div><div class="tldr">Month 3‚Äì5</div></div>
          <div class="tli"><div class="tld" style="color:var(--reward-green)"></div><div class="tlp" style="color:var(--reward-green)">Phase 07</div><div class="tlt">Move In & Rent Ends üéâ</div><div class="tldesc">You move in, give notice to your landlord, and your rent obligation ends. Single housing cost from here.</div><div class="tldr">Month 4‚Äì6</div></div>
        </div>
      </div>
    </div>

    <!-- TAB 6: RISKS -->
    <div class="section" id="risks">
      <div class="sl">Risk & Reward Assessment</div>
      <div class="g2" style="margin-bottom:14px">
        <div class="card"><div class="ca" style="background:var(--risk-red)"></div><h3>Risk Level</h3><div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--slate);margin-bottom:5px">OVERALL RISK</div><div class="mt"><div class="mf" id="risk-meter" style="background:linear-gradient(to right,var(--gold),var(--terracotta))"></div></div><p style="font-size:11px;color:var(--slate);line-height:1.6" id="risk-desc"></p></div>
        <div class="card"><div class="ca" style="background:var(--reward-green)"></div><h3>Reward Potential</h3><div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--slate);margin-bottom:5px">UPSIDE SCORE</div><div class="mt"><div class="mf" id="reward-meter" style="background:linear-gradient(to right,var(--sage),var(--reward-green))"></div></div><p style="font-size:11px;color:var(--slate);line-height:1.6" id="reward-desc"></p></div>
      </div>
      <div class="rr-grid">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--risk-red);margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--risk-red)">‚ö† Risks</div>
          <div class="rri risk"><div class="rric">üí∏</div><div><div class="rrt">Interest Rate Sensitivity</div><div class="rrb">A 2% rate rise would add <strong id="rr-rate-delta">$xxx</strong>/month to repayments.</div></div></div>
          <div class="rri risk"><div class="rric">üèö</div><div><div class="rrt">Hidden Structural Issues</div><div class="rrb">Unforeseen defects can blow the renovation budget. B&P inspection is essential.</div></div></div>
          <div class="rri risk"><div class="rric">üìâ</div><div><div class="rrt">Low Equity Buffer</div><div class="rrb">With <span id="rr-dep-pct">2%</span> personal deposit, any market correction leaves little buffer.</div></div></div>
          <div class="rri risk"><div class="rric">üî®</div><div><div class="rrt">Reno Cost Blowouts</div><div class="rrb">Reno pool is <span id="rr-pool-val">$24k</span>. Scope creep and tradie delays can rapidly eat through this.</div></div></div>
          <div class="rri risk"><div class="rric">üè†</div><div><div class="rrt">Dual Housing Costs</div><div class="rrb">Paying <span id="rr-overlap-cost">$4k</span> in combined rent + mortgage during your <span id="rr-overlap-weeks">4</span>-week overlap reduces your reno buffer.</div></div></div>
        </div>
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--reward-green);margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--reward-green)">‚ú¶ Rewards</div>
          <div class="rri reward"><div class="rric">üè†</div><div><div class="rrt">Into the Market Now</div><div class="rrb">With <span id="rr-dep-show">$13k</span> deposit you stop rent leakage and start building equity immediately.</div></div></div>
          <div class="rri reward"><div class="rric">üìà</div><div><div class="rrt">Renovation-Driven Equity</div><div class="rrb">A targeted <span id="rr-reno-show">$24k</span> reno on a <span id="rr-price-show">$650k</span> property can unlock $40k‚Äì$80k+ in uplift.</div></div></div>
          <div class="rri reward"><div class="rric">ü§ù</div><div><div class="rrt">Government Co-Invests</div><div class="rrb">The scheme absorbs <span id="rr-govt-show">28.7%</span> of the purchase, reducing your LVR and preserving cash.</div></div></div>
          <div class="rri reward"><div class="rric">üõ°</div><div><div class="rrt">No LMI Required</div><div class="rrb">Avoiding Lenders Mortgage Insurance saves thousands in sunk costs.</div></div></div>
          <div class="rri reward"><div class="rric">üí∞</div><div><div class="rrt">Long-Term Capital Growth</div><div class="rrb">Your <span id="rr-dep-ltg">$13k</span> deposit on a <span id="rr-price-ltg">$650k</span> asset gives leveraged exposure to property appreciation.</div></div></div>
        </div>
      </div>
    </div>

    <!-- TAB 7: PROJECTION -->
    <div class="section" id="projection">
      <div class="sl">Long-Term Projection</div>

      <!-- Controls (item 8: removed years slider, item 7: suburb growth) -->
      <div class="card proj-controls" style="padding:16px 22px;margin-bottom:14px;display:flex;gap:22px;flex-wrap:wrap;align-items:flex-end;">
        <div class="ca" style="background:var(--gold)"></div>
        <div>
          <div style="font-size:11px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">Annual Growth Rate</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <input type="range" id="proj-growth" min="1" max="12" step="0.5" value="5" oninput="document.getElementById('proj-growth-lbl').textContent=parseFloat(this.value).toFixed(1)+'%';drawProjection()" style="width:110px;accent-color:var(--gold);">
            <span id="proj-growth-lbl" style="font-family:'DM Mono',monospace;font-size:13px;color:var(--gold);min-width:38px;">5.0%</span>
          </div>
          <div id="suburb-growth-hint" style="font-size:10px;color:var(--slate);margin-top:4px;font-style:italic;max-width:200px;"></div>
        </div>
<!-- reno uplift removed (item 9) -->
        <div>
          <button id="fetch-growth-btn" onclick="fetchSuburbGrowth()" style="background:var(--charcoal);color:var(--gold);border:1px solid rgba(201,168,76,0.4);padding:7px 14px;border-radius:3px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;">üîç Look Up Suburb Growth</button>
          <div style="font-size:10px;color:var(--slate);margin-top:4px;font-style:italic;">Uses suburb from Property tab</div>
        </div>
      </div>

      <!-- Milestone tiles (item 9) -->
      <div class="tiles" style="grid-template-columns:repeat(2,1fr);margin-bottom:14px;" id="proj-tiles">
        <div class="tile"><div class="tile-dot" style="background:var(--sky)"></div><div class="tile-val" id="proj-payoff-yr">‚Äî</div><div class="tile-lbl">Loan Paid Off</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sage)"></div><div class="tile-val" id="proj-buyout-yr">‚Äî</div><div class="tile-lbl">Can Buy Out Govt</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--gold)"></div><div class="tile-val" id="proj-val-5">‚Äî</div><div class="tile-lbl">Property Value @ Yr 5</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--terracotta)"></div><div class="tile-val" id="proj-govt-5">‚Äî</div><div class="tile-lbl">Govt Equity Owed @ Yr 5</div></div>
      </div>

      <!-- SVG Chart with click tooltip (items 6, 9) -->
      <div class="card">
        <div class="ca" style="background:var(--sky)"></div>
        <h3>30-Year Property Projection</h3>
        <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:14px;font-size:11px;">
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:#C9A84C;display:inline-block;border-radius:2px;"></span>Property Value</span>
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;border-top:3px dashed #5B8FAB;display:inline-block;"></span>Loan Balance</span>
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:#C4704A;display:inline-block;border-radius:2px;"></span>Govt Equity Owed</span>
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:#5A9E7B;display:inline-block;border-radius:2px;opacity:0.4;"></span>Your Equity</span>
        </div>
        <div style="font-size:11px;color:var(--slate);margin-bottom:8px;font-style:italic;">Click on chart to see values at that year</div>
        <div style="overflow-x:auto;position:relative;">
          <svg id="proj-chart" width="100%" height="320" viewBox="0 0 800 320" style="display:block;min-width:440px;cursor:crosshair;"></svg>
          <!-- Click tooltip (item 6) -->
          <div id="proj-tooltip" style="display:none;position:absolute;background:var(--charcoal);color:var(--cream);border-radius:4px;padding:10px 14px;font-family:'DM Mono',monospace;font-size:11px;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,0.35);border:1px solid rgba(201,168,76,0.3);min-width:180px;z-index:10;"></div>
        </div>
      </div>

      <!-- Milestones card (item 9) -->
      <div class="card">
        <div class="ca" style="background:var(--reward-green)"></div>
        <h3>Key Milestones</h3>
        <div id="proj-milestones" class="tl" style="margin-top:10px;"></div>
      </div>

      <!-- Year-by-year table -->
      <div class="card">
        <div class="ca" style="background:var(--terracotta)"></div>
        <h3>Year-by-Year Breakdown</h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:14px;line-height:1.6;">Govt equity owed = their % share of the property value at that year. Pay this amount to exit the scheme.</p>
        <div style="overflow-x:auto;"><div id="proj-table"></div></div>
      </div>
    </div>

  </main>
</div>
</div>

<script>
  const CIRC = 263.89; // 2*pi*42

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
  function fmt(n){const a=Math.abs(n),s=n<0?'-':'';if(a>=1e6)return s+'$'+(a/1e6).toFixed(2)+'M';if(a>=1000)return s+'$'+Math.round(a).toLocaleString();return s+'$'+Math.round(a);}
  function fmtK(n){const a=Math.abs(n),s=n<0?'-':'';if(a>=1e6)return s+'$'+(a/1e6).toFixed(1)+'M';if(a>=1000)return s+'$'+Math.round(a/1000)+'k';return s+'$'+Math.round(a);}
  function pctS(n){return n.toFixed(1)+'%';}
  function v(id){return parseFloat(document.getElementById(id).value)||0;}
  function set(id,val){const el=document.getElementById(id);if(el)el.textContent=val;}
  function css(id,prop,val){const el=document.getElementById(id);if(el)el.style[prop]=val;}
  function attr(id,a,val){const el=document.getElementById(id);if(el)el.setAttribute(a,val);}

  function syncRange(key){const i=document.getElementById('inp-'+key),r=document.getElementById('rng-'+key);if(r)r.value=i.value;rl(key,parseFloat(i.value));}
  function syncInput(key){const i=document.getElementById('inp-'+key),r=document.getElementById('rng-'+key);if(i)i.value=r.value;rl(key,parseFloat(r.value));}
  function rl(key,val){
    const el=document.getElementById('lbl-'+key);if(!el)return;
    if(['price','savings','bank','conv','pest','r1','r2','r3','r4','r5','r6','rent'].includes(key))el.textContent=fmt(val);
    else if(key==='term')el.textContent=val+' yrs';
    else if(key==='weeks')el.textContent=val;
    else el.textContent=val.toFixed(key==='cont'?0:1)+'%';
  }

  function calcMonthly(principal,annualRate,years){
    if(principal<=0)return 0;if(annualRate===0)return principal/(years*12);
    const r=annualRate/100/12,n=years*12;
    return principal*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
  }

  // ‚îÄ‚îÄ DYNAMIC COST ITEMS ‚îÄ‚îÄ
  let dynCosts=[];
  let dynId=0;

  // ‚îÄ‚îÄ ALL PURCHASE COSTS ARE NOW DYNAMIC (item 14) ‚îÄ‚îÄ
  // Seeded with defaults in initPage()
  function addCostItem(){
    const id='dyn-'+dynId++;
    dynCosts.push({id,name:'New Item',amount:0});
    renderDynCosts();
    recalc();
  }

  function removeCostItem(id){
    dynCosts=dynCosts.filter(c=>c.id!==id);
    renderDynCosts();
    recalc();
  }

  function renderDynCosts(){
    const list=document.getElementById('cost-items-list');
    if(!list) return;
    list.innerHTML='';
    dynCosts.forEach(cost=>{
      const row=document.createElement('div');
      row.className='dyn-cost-row';
      row.innerHTML=`
        <input type="text" value="${(cost.name||'').replace(/"/g,'&quot;')}" placeholder="Item name" style="flex:1.4" oninput="updateDynCost('${cost.id}','name',this.value)">
        <div class="iw" style="flex:1;position:relative;"><span class="ipfx">$</span><input type="number" value="${cost.amount||0}" min="0" step="50" oninput="updateDynCost('${cost.id}','amount',parseFloat(this.value)||0);recalc()"></div>
        <button class="dyn-del" onclick="removeCostItem('${cost.id}')" title="Remove">‚àí</button>
      `;
      list.appendChild(row);
    });
  }

  function updateDynCost(id,field,val){
    const c=dynCosts.find(x=>x.id===id);
    if(c){c[field]=val;if(field==='amount')recalc();}
  }

  function getExtraCosts(){
    return dynCosts.reduce((s,c)=>s+(parseFloat(c.amount)||0),0);
  }

  // ‚îÄ‚îÄ RENO ITEMS ‚Äî dynamic custom items (item 13) ‚îÄ‚îÄ
  let renoItems=[]; // [{id, emoji, name, amount, note}]
  let renoItemId=0;

  const RENO_EMOJIS=['üé®','üç≥','üöø','ü™µ','üí°','üåø','ü™ü','üö™','üß±','üõÅ','‚ùÑÔ∏è','üîß','üèó','üè†','‚ö°','üíß','üî®','ü™¥','‚ú®','‚ö†Ô∏è'];

  function addRenoItem(name='New Item', amount=0, emoji='üî®', note=''){
    const id='ri-'+renoItemId++;
    renoItems.push({id, emoji, name, amount, note});
    renderRenoItems();
    recalc();
    // Scroll to the new item
    setTimeout(()=>{
      const el=document.querySelector(`[data-reno="${id}"]`);
      if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
    },100);
  }

  function removeRenoItem(id){
    renoItems=renoItems.filter(r=>r.id!==id);
    renderRenoItems();
    recalc();
  }

  function updateRenoItem(id,field,val){
    const r=renoItems.find(x=>x.id===id);
    if(r){r[field]=val;if(field==='amount')recalc();}
  }

  function getRenoTotal(){
    return renoItems.reduce((s,r)=>s+(parseFloat(r.amount)||0),0);
  }

  function renderRenoItems(){
    const list=document.getElementById('reno-items-list');
    if(!list) return;
    const total = getRenoTotal();
    const maxAmt = Math.max(...renoItems.map(r=>parseFloat(r.amount)||0), 1);
    list.innerHTML = renoItems.map(r=>{
      const pct = maxAmt>0 ? Math.min((parseFloat(r.amount)||0)/maxAmt*100,100) : 0;
      const emojiOpts = RENO_EMOJIS.map(e=>`<option value="${e}" ${e===r.emoji?'selected':''}>${e}</option>`).join('');
      return `<div data-reno="${r.id}" style="border-bottom:1px solid rgba(28,28,30,0.07);padding-bottom:10px;margin-bottom:10px;">
        <div class="reno-row">
          <select style="width:38px;flex-shrink:0;background:none;border:none;font-size:16px;cursor:pointer;padding:0;" onchange="updateRenoItem('${r.id}','emoji',this.value);renderRenoItems()">${emojiOpts}</select>
          <input type="text" value="${(r.name||'').replace(/"/g,'&quot;')}" placeholder="Item name" style="flex:1;background:none;border:none;border-bottom:1px solid rgba(28,28,30,0.1);padding:3px 4px;font-size:13px;font-weight:500;color:var(--charcoal);outline:none;" oninput="updateRenoItem('${r.id}','name',this.value)" onfocus="this.style.borderColor='var(--sage)'" onblur="this.style.borderColor='rgba(28,28,30,0.1)'">
          <div class="rbt" style="max-width:60px;"><div class="rbf" style="width:${pct}%"></div></div>
          <div style="display:flex;align-items:center;gap:2px;min-width:90px;">
            <span style="font-size:14px;color:var(--slate);">$</span><input type="number" value="${r.amount||0}" min="0" step="100" style="width:90px;background:none;border:none;border-bottom:1px solid rgba(28,28,30,0.1);padding:4px 2px;font-family:'DM Mono',monospace;font-size:16px;color:var(--charcoal);outline:none;text-align:right;font-weight:500;" oninput="updateRenoItem('${r.id}','amount',parseFloat(this.value)||0);recalc();renderRenoItems()" onfocus="this.style.borderColor='var(--sage)'" onblur="this.style.borderColor='rgba(28,28,30,0.1)'">
          </div>
          <button class="kd-del" onclick="removeRenoItem('${r.id}')" title="Remove" style="flex-shrink:0;">‚úï</button>
        </div>
        <div class="reno-note-wrap" style="padding-left:44px;">
          <textarea class="reno-note" placeholder="Notes, quotes, scope of work‚Ä¶" rows="1" oninput="updateRenoItem('${r.id}','note',this.value);this.style.height='auto';this.style.height=this.scrollHeight+'px'">${r.note||''}</textarea>
        </div>
      </div>`;
    }).join('');
    // sidebar total
    const stEl=document.getElementById('lbl-reno-total');
    if(stEl){ const ct=v('inp-cont'); stEl.textContent=fmtK(total*(1+ct/100)); }
  }

  // ‚îÄ‚îÄ MAIN RECALC ‚îÄ‚îÄ
  const DRAFT_KEY = 'propCalc_draft_v1';
  let _draftTimer = null;
  function autosaveDraft(){
    if(_restoringDraft) return;
    clearTimeout(_draftTimer);
    _draftTimer = setTimeout(()=>{
      try{
        const state = collectCurrentState();
        lsSet(DRAFT_KEY, JSON.stringify({state, photo: propPhotoDataUrl||'', thumb: propThumbDataUrl||'', savedId: _lastSavedAddr||''}));
        _isDirty = true;
        updateUnsavedBadge();
      }catch(e){}
    }, 800);
  }
  function restoreDraft(){
    try{
      const raw = lsGet(DRAFT_KEY);
      if(!raw) return false;
      const draft = JSON.parse(raw);
      if(!draft || !draft.state) return false;
      _restoringDraft = true;
      // Restore photo ‚Äî only if it fits (skip silently if corrupt)
      if(draft.photo && draft.photo.startsWith('data:')){
        try{ propPhotoDataUrl = draft.photo; propThumbDataUrl = draft.thumb||''; applyPropPhoto(draft.photo); }catch(pe){}
      } else if(draft.photo && draft.photo.startsWith('http')){
        try{ propPhotoDataUrl = draft.photo; propThumbDataUrl = draft.photo; applyPropPhoto(draft.photo); }catch(pe){}
      }
      applyScenarioState(draft.state, null);
      // Always land on property tab after restore
      const propTabBtn = document.querySelector('.tab[onclick*="property"]');
      if(propTabBtn) showTab('property', propTabBtn);
      // Restore saved address so unsaved badge doesn't fire
      if(draft.savedId) _lastSavedAddr = draft.savedId;
      _restoringDraft = false;
      _isDirty = false;
      return true;
    }catch(e){ console.warn('restoreDraft failed:', e); _restoringDraft = false; return false; }
  }
  function recalc(){
    autosaveDraft();
    const price   = v('inp-price');
    const savings = v('inp-savings');
    const depPct  = v('inp-depp');
    const govtPct = v('inp-govt');
    const rate    = v('inp-rate');
    const term    = v('inp-term');
    const contPct = v('inp-cont');
    const address = document.getElementById('inp-address').value||'your property';

    const deposit  = price*depPct/100;
    const govtAmt  = price*govtPct/100;
    const loanAmt  = Math.max(0,price-deposit-govtAmt);
    const extraCosts = getExtraCosts();
    const upfront  = deposit+extraCosts;
    const remaining = savings-upfront;

    const monthly = calcMonthly(loanAmt,rate,term);
    const weekly  = monthly*12/52;
    const totalPaid = monthly*term*12;
    const totalInterest = totalPaid-loanAmt;

    // Use dynamic reno items system (item 13)
    const renoBase=getRenoTotal();
    const contingency=renoBase*contPct/100;
    const renoTotal=renoBase+contingency;

    // overlap (may be disabled by item 12 rent toggle)
    const rentEnabled = document.getElementById('rent-sidebar-section')?.style.display !== 'none';
    const rent  = rentEnabled ? v('inp-rent') : 0;
    const weeks = rentEnabled ? v('inp-weeks') : 0;
    const overlapCost = (rent+weekly)*weeks;
    const cashAfterOverlap = remaining-overlapCost;

    // ‚îÄ‚îÄ‚îÄ sidebar labels ‚îÄ‚îÄ‚îÄ
    ['price','savings','depp','govt','rate','term','cont','rent','weeks'].forEach(k=>{
      const el=document.getElementById('inp-'+k);if(el)rl(k,parseFloat(el.value)||0);
    });
    // sidebar reno total
    const stEl2=document.getElementById('lbl-reno-total');
    if(stEl2) stEl2.textContent=fmtK(renoTotal);

    document.getElementById('page-title').textContent=address;

    // ‚îÄ‚îÄ‚îÄ TAB 1: COSTS ‚îÄ‚îÄ‚îÄ
    set('t-price',fmtK(price));
    set('t-deposit',fmtK(deposit));
    set('t-govt',fmtK(govtAmt));
    const remEl=document.getElementById('t-remaining');if(remEl){remEl.textContent=fmtK(remaining);remEl.style.color=remaining<0?'var(--risk-red)':'';}

    set('cb-savings',fmt(savings));
    set('cb-out','‚àí'+fmt(upfront));
    const cbR=document.getElementById('cb-remaining');
    if(cbR){cbR.textContent=fmt(remaining);cbR.style.color=remaining<0?'var(--risk-red)':'var(--sage-light)';}

    set('cr-deposit',fmt(deposit));

    // dynamic cost rows display (all costs now dynamic, item 14)
    const display=document.getElementById('cost-rows-display');
    if(display){
      let html='';
      dynCosts.forEach(c=>{
        html+=`<div class="cr"><span class="nm">${(c.name||'Item').replace(/</g,'&lt;')}</span><span class="am">${fmt(parseFloat(c.amount)||0)}</span></div>`;
      });
      display.innerHTML=html;
    }
    set('cr-total',fmt(upfront));

    const noteEl=document.getElementById('cost-note');
    if(noteEl){
      if(remaining<0){noteEl.textContent=`‚ö†Ô∏è Shortfall of ${fmt(Math.abs(remaining))} ‚Äî increase savings or reduce costs.`;noteEl.style.cssText='margin-top:10px;padding:8px 10px;border-radius:3px;font-size:11px;line-height:1.6;background:rgba(196,90,90,0.1);color:var(--risk-red)';}
      else{noteEl.textContent=`üí° ${fmt(remaining)} remaining after settlement ‚Äî available for renovations or emergency buffer.`;noteEl.style.cssText='margin-top:10px;padding:8px 10px;border-radius:3px;font-size:11px;line-height:1.6;background:rgba(201,168,76,0.1);color:var(--slate)';}
    }

    // donut
    const tp=price,bP=tp>0?loanAmt/tp:0,gP=tp>0?govtAmt/tp:0,dP=tp>0?deposit/tp:0;
    const bD=bP*CIRC,gD=gP*CIRC,dD=dP*CIRC;
    attr('d-bank','stroke-dasharray',`${bD} ${CIRC}`);
    attr('d-govt','stroke-dasharray',`${gD} ${CIRC}`);attr('d-govt','stroke-dashoffset',`-${bD}`);
    attr('d-you','stroke-dasharray',`${dD} ${CIRC}`);attr('d-you','stroke-dashoffset',`-${bD+gD}`);
    set('d-centre',fmtK(price));
    set('leg-bank',fmtK(loanAmt));set('leg-govt',fmtK(govtAmt));set('leg-you',fmtK(deposit));
    set('bp-bank',pctS(bP*100));css('bf-bank','width',pctS(bP*100));
    set('bp-govt',pctS(gP*100));css('bf-govt','width',pctS(gP*100));
    set('bp-dep',pctS(dP*100));css('bf-dep','width',pctS(dP*100));

    // sidebar alert
    const sa=document.getElementById('sidebar-alert');
    if(sa){
      if(remaining<0)sa.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è Savings shortfall of ${fmt(Math.abs(remaining))}.</div>`;
      else if(cashAfterOverlap<5000&&weeks>0)sa.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è After overlap, only ${fmt(cashAfterOverlap)} left for reno.</div>`;
      else sa.innerHTML=`<div class="alert alert-ok">‚úì Cash position viable. ${fmt(remaining)} after settlement.</div>`;
    }

    // ‚îÄ‚îÄ‚îÄ TAB 2: RENO ‚îÄ‚îÄ‚îÄ
    const rpEl=document.getElementById('reno-pool-val');
    if(rpEl){rpEl.textContent=fmtK(remaining);rpEl.style.color=remaining<0?'var(--risk-red)':'var(--sage)';}
    const unspent = remaining - renoTotal;
    const ruEl=document.getElementById('reno-unspent-val');
    if(ruEl){ruEl.textContent=fmtK(unspent);ruEl.style.color=unspent<0?'var(--risk-red)':unspent<5000?'var(--terracotta)':'var(--reward-green)';}
    set('reno-planned',fmt(renoTotal));set('reno-pool-cap',fmt(remaining));set('reno-total',fmt(renoTotal));
    const rpct=remaining>0?Math.min(renoTotal/remaining*100,200):100;
    css('reno-spend-bar','width',Math.min(rpct,100)+'%');
    css('reno-spend-bar','background',rpct>100?'var(--risk-red)':'var(--sage)');
    set('reno-spend-pct',Math.round(rpct)+'%');
    const rpaEl=document.getElementById('reno-pool-alert');
    if(rpaEl){
      if(!renoEnabled){rpaEl.innerHTML='';}
      else if(remaining<0)rpaEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è No reno budget ‚Äî savings don't cover upfront costs.</div>`;
      else if(renoTotal>remaining)rpaEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è Reno plan (${fmt(renoTotal)}) exceeds pool (${fmt(remaining)}). Trim items or increase savings.</div>`;
      else rpaEl.innerHTML=`<div class="alert alert-ok">‚úì Fits budget ‚Äî ${fmt(remaining-renoTotal)} to spare after reno.</div>`;
    }

    // ‚îÄ‚îÄ‚îÄ TAB 3: REPAYMENTS ‚îÄ‚îÄ‚îÄ
    set('rp-monthly',fmt(monthly));set('rp-weekly',fmt(weekly));set('rp-annual',fmt(monthly*12));
    set('rp-rate-lbl','@ '+rate+'%');set('rp-term-lbl',term+'yr term');set('rp-loan-lbl',fmtK(loanAmt)+' loan');
    set('rp-interest',fmt(totalInterest));set('rp-total-paid',fmt(totalPaid));set('rp-loan-show',fmt(loanAmt));

    const stEl=document.getElementById('stress-table');
    if(stEl){
      const rates=[rate,rate+0.5,rate+1,rate+2,rate+3];
      let html=`<div style="font-family:'DM Mono',monospace;font-size:11px"><div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;margin-bottom:6px;color:var(--slate);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding-bottom:5px;border-bottom:1px solid rgba(28,28,30,0.1)"><span>Rate</span><span>Monthly</span><span>Annual</span><span>Change</span></div>`;
      rates.forEach((r,i)=>{
        const m=calcMonthly(loanAmt,r,term),d=m-monthly,cur=i===0;
        html+=`<div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;padding:6px 0;border-top:1px solid rgba(28,28,30,0.06)${cur?';background:rgba(201,168,76,0.06);border-radius:2px':''}"><span style="color:${cur?'var(--gold)':'var(--slate)'}">${r.toFixed(1)}%${cur?' ‚Üê':''}</span><span>${fmt(m)}</span><span>${fmt(m*12)}</span><span style="color:${i===0?'var(--slate)':d>600?'var(--risk-red)':'var(--terracotta)'}">${i===0?'current':'+'+fmt(d)+'/mo'}</span></div>`;
      });
      stEl.innerHTML=html+'</div>';
    }

    // ‚îÄ‚îÄ‚îÄ TAB 4: RENT OVERLAP ‚îÄ‚îÄ‚îÄ
    const weeklyMort=weekly;
    const combinedWeekly=rent+weeklyMort;
    const totalOverlap=combinedWeekly*weeks;
    const cashAfter=remaining-totalOverlap;

    set('ov-weekly-total',fmt(combinedWeekly));
    set('ov-total-cost',fmt(totalOverlap));
    const ovR=document.getElementById('ov-remaining-after');
    if(ovR){ovR.textContent=fmt(cashAfter);ovR.style.color=cashAfter<0?'var(--risk-red)':'';}

    set('ov-rent-wk',fmt(rent));set('ov-mort-wk',fmt(weeklyMort));
    set('ov-rent-pct',combinedWeekly>0?Math.round(rent/combinedWeekly*100)+'%':'0%');
    set('ov-mort-pct',combinedWeekly>0?Math.round(weeklyMort/combinedWeekly*100)+'%':'0%');
    css('ov-rent-bar','width',combinedWeekly>0?(rent/combinedWeekly*100)+'%':'0%');
    css('ov-mort-bar','width',combinedWeekly>0?(weeklyMort/combinedWeekly*100)+'%':'0%');

    set('ov-s-rent',fmt(rent));set('ov-s-mort',fmt(weeklyMort));
    set('ov-s-combined',fmt(combinedWeekly));
    set('ov-s-weeks',weeks);set('ov-s-total',fmt(totalOverlap));
    set('ov-buf-start',fmt(remaining));
    set('ov-buf-overlap','‚àí'+fmt(totalOverlap));
    const ovFinal=document.getElementById('ov-buf-final');
    if(ovFinal){ovFinal.textContent=fmt(cashAfter);ovFinal.style.color=cashAfter<0?'var(--risk-red)':cashAfter<10000?'var(--terracotta)':'var(--reward-green)';}

    const advEl=document.getElementById('ov-advice');
    if(advEl){
      if(weeks===0)advEl.innerHTML=`<div class="alert alert-ok">‚úì No overlap period ‚Äî you move in straight after renovation. Maximum cash preserved.</div>`;
      else if(cashAfter<0)advEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è The overlap cost (${fmt(totalOverlap)}) exceeds your remaining cash. You'll need extra funds or to reduce the overlap period.</div>`;
      else if(cashAfter<8000)advEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è Tight ‚Äî only ${fmt(cashAfter)} left for reno. Consider reducing overlap weeks or the reno scope.</div>`;
      else advEl.innerHTML=`<div class="alert alert-ok">‚úì Manageable ‚Äî ${fmt(cashAfter)} still available for renovations after the ${weeks}-week overlap.</div>`;
    }

    // calendar grid
    const calEl=document.getElementById('cal-grid');
    if(calEl&&weeks>=0){
      const totalW=Math.max(8,weeks+4);
      let html=`<div style="display:grid;grid-template-columns:repeat(${Math.min(totalW,12)},1fr);gap:3px;margin-bottom:4px">`;
      for(let i=0;i<Math.min(totalW,12);i++){
        const label='Wk '+(i+1);
        const cls=i<weeks?'cal-both':'cal-mortgage';
        html+=`<div class="cal-cell ${cls}" title="${i<weeks?'Rent + Mortgage':'Mortgage only'}">${i+1}</div>`;
      }
      html+='</div>';
      html+=`<div style="font-size:11px;color:var(--slate);margin-top:6px">`;
      html+=`<span style="display:inline-flex;align-items:center;gap:5px;margin-right:12px"><span style="width:10px;height:10px;border-radius:2px;background:var(--terracotta);display:inline-block"></span>Paying rent + mortgage</span>`;
      html+=`<span style="display:inline-flex;align-items:center;gap:5px"><span style="width:10px;height:10px;border-radius:2px;background:var(--sky);display:inline-block"></span>Mortgage only</span>`;
      html+='</div>';
      calEl.innerHTML=html;
    }

    // overlap scenarios
    const scEl=document.getElementById('overlap-scenarios');
    if(scEl){
      const scenWeeks=[0,2,4,6,8,12];
      let html=`<div style="font-family:'DM Mono',monospace;font-size:11px"><div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;margin-bottom:6px;color:var(--slate);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding-bottom:5px;border-bottom:1px solid rgba(28,28,30,0.1)"><span>Weeks</span><span>Overlap Cost</span><span>Reno Budget Left</span><span>Status</span></div>`;
      scenWeeks.forEach(w=>{
        const cost=combinedWeekly*w;
        const left=remaining-cost;
        const isCur=w===weeks;
        const status=left<0?'‚ö† Shortfall':left<8000?'‚ö° Tight':'‚úì OK';
        const sc=left<0?'var(--risk-red)':left<8000?'var(--terracotta)':'var(--reward-green)';
        html+=`<div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;padding:6px 0;border-top:1px solid rgba(28,28,30,0.06)${isCur?';background:rgba(201,168,76,0.06);border-radius:2px':''}">
          <span style="color:${isCur?'var(--gold)':'var(--slate)'}">${w}wk${isCur?' ‚Üê':''}</span>
          <span>${fmt(cost)}</span>
          <span style="color:${sc}">${fmt(left)}</span>
          <span style="color:${sc}">${status}</span>
        </div>`;
      });
      scEl.innerHTML=html+'</div>';
    }

    // ‚îÄ‚îÄ‚îÄ TAB 5: TIMELINE ‚îÄ‚îÄ‚îÄ
    set('tl-address',address);
    const ob=document.getElementById('tl-overlap-badge');
    if(ob)ob.textContent=weeks>0?weeks+' wks':'Optional';
    const od=document.getElementById('tl-overlap-desc');
    if(od)od.textContent=weeks>0?`You continue renting for ${weeks} weeks while renovations begin ‚Äî paying ${fmt(combinedWeekly)}/wk (rent + mortgage) for a total of ${fmt(totalOverlap)}.`:'No overlap planned ‚Äî you move in immediately after renovations.';
    const olDur=document.getElementById('tl-overlap-dur');
    if(olDur)olDur.textContent=weeks>0?`Weeks 1‚Äì${weeks} post-settlement`:'Immediate move-in';

    // ‚îÄ‚îÄ‚îÄ TAB 6: RISKS ‚îÄ‚îÄ‚îÄ
    const riskScore=Math.min(90,Math.max(15,
      20+(depPct<5?20:depPct<10?10:0)+(rate>7?15:rate>6?5:0)+(govtPct>20?-8:0)
        +(remaining<5000?25:remaining<15000?10:0)+(weeks>8?10:weeks>4?5:0)
    ));
    const rewardScore=Math.min(95,Math.max(25,
      35+(govtPct>0?20:0)+(remaining>20000?15:remaining>10000?8:0)+(renoTotal>10000?10:5)+(price<650000?5:0)
    ));
    css('risk-meter','width',riskScore+'%');css('reward-meter','width',rewardScore+'%');
    set('risk-desc',riskScore<30?'Low risk ‚Äî strong equity and healthy cash buffer.':riskScore<50?'Moderate risk ‚Äî manageable with the government scheme reducing LVR.':riskScore<70?'Medium-high risk ‚Äî consider increasing deposit or savings buffer.':'Higher risk ‚Äî savings are tight. Build a larger buffer before proceeding.');
    set('reward-desc',rewardScore>70?'High reward potential ‚Äî strong equity uplift through renovation and capital growth.':rewardScore>50?'Good reward potential ‚Äî renovation and scheme create solid upside.':'Modest reward potential ‚Äî consider a higher reno budget or larger govt scheme.');
    const m2=calcMonthly(loanAmt,rate+2,term);
    set('rr-rate-delta',fmt(m2-monthly));
    set('rr-dep-pct',pctS(depPct));set('rr-pool-val',fmtK(remaining));
    set('rr-overlap-cost',fmt(totalOverlap));set('rr-overlap-weeks',weeks);
    set('rr-dep-show',fmtK(deposit));set('rr-reno-show',fmtK(renoTotal));
    set('rr-price-show',fmtK(price));set('rr-govt-show',pctS(govtPct));
    set('rr-dep-ltg',fmtK(deposit));set('rr-price-ltg',fmtK(price));
  }

  function showTab(id,btn){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
  }

  const PRESETS={
    base:        {price:650000,savings:40000,depp:2,  govt:28.7,rate:6.2,term:30,bank:800,conv:1600,pest:700,r1:3500,r2:5000,r3:4500,r4:4000,r5:2000,r6:2000,cont:15,rent:450,weeks:4},
    max:         {price:700000,savings:60000,depp:5,  govt:28.7,rate:6.2,term:30,bank:800,conv:1800,pest:700,r1:5000,r2:8000,r3:6000,r4:5000,r5:3000,r6:3000,cont:15,rent:450,weeks:4},
    conservative:{price:600000,savings:50000,depp:10, govt:28.7,rate:7.0,term:25,bank:800,conv:1600,pest:700,r1:2000,r2:3000,r3:2500,r4:2000,r5:1000,r6:1000,cont:20,rent:400,weeks:6},
    nodep:       {price:650000,savings:40000,depp:20, govt:0,   rate:6.5,term:30,bank:800,conv:1600,pest:700,r1:2000,r2:3000,r3:2000,r4:2000,r5:1000,r6:500, cont:10,rent:450,weeks:2},
  };

  function loadPreset(key){
    const p=PRESETS[key];
    Object.entries(p).forEach(([k,val])=>{
      const inp=document.getElementById('inp-'+k),rng=document.getElementById('rng-'+k);
      if(inp)inp.value=val;if(rng)rng.value=val;rl(k,val);
    });
    dynCosts=[];renderDynCosts();
    recalc();
  }

  function handlePhotoDrop(e){
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const file=e.dataTransfer.files[0];
    if(file&&file.type.startsWith('image/'))handlePropPhotoFile(file);
  }

  function handlePhotoFile(file){
    if(!file)return;
    handlePropPhotoFile(file);
  }

  // ‚îÄ‚îÄ PROPERTY DETAILS ‚îÄ‚îÄ
  let propPhotoDataUrl = '';
  let _lastSavedAddr = null;
  let _isDirty = false;
  let _restoringDraft = false; // suppresses autosaveDraft during restore
  let propThumbDataUrl = ''; // small thumbnail for library

  function handlePropPhotoDrop(e){
    e.preventDefault();
    e.currentTarget.classList.remove('pd-drag');
    const file = e.dataTransfer.files[0];
    if(file && file.type.startsWith('image/')) handlePropPhotoFile(file);
  }

  function handlePropPhotoFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const img = new Image();
      img.onload = function(){
        // Resize to max 900px wide for storage (reduces from ~3MB to ~80-150KB)
        const MAX = 900;
        const ratio = Math.min(1, MAX / Math.max(img.width, img.height));
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        propPhotoDataUrl = c.toDataURL('image/jpeg', 0.82);
        // Also store a small thumbnail (200px) for the library grid
        const THUMB = 200;
        const tr = Math.min(1, THUMB / Math.max(img.width, img.height));
        const tw = Math.round(img.width * tr);
        const th = Math.round(img.height * tr);
        const tc = document.createElement('canvas');
        tc.width = tw; tc.height = th;
        tc.getContext('2d').drawImage(img, 0, 0, tw, th);
        propThumbDataUrl = tc.toDataURL('image/jpeg', 0.72);
        applyPropPhoto(propPhotoDataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function applyPropPhoto(src){
    // big preview in details tab
    const big = document.getElementById('pd-photo-big');
    const prompt = document.getElementById('pd-upload-prompt');
    const overlay = document.getElementById('pd-photo-overlay');
    if(big){ big.src = src; big.style.display = 'block'; }
    if(prompt) prompt.style.display = 'none';
    if(overlay) overlay.style.display = 'flex';
    // header thumbnail
    const hImg = document.getElementById('prop-img');
    const hZone = document.getElementById('upload-zone');
    if(hImg){ hImg.src = src; hImg.style.display = 'block'; }
    if(hZone) hZone.style.display = 'none';
    // preview thumb in details tab
    const prevPhoto = document.getElementById('pd-preview-photo');
    if(prevPhoto) prevPhoto.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover;">`;
    updatePropertyDetails();
  }

  function clearPropPhoto(){
    propPhotoDataUrl = '';
    propThumbDataUrl = '';
    const big = document.getElementById('pd-photo-big');
    const prompt = document.getElementById('pd-upload-prompt');
    const overlay = document.getElementById('pd-photo-overlay');
    if(big){ big.src=''; big.style.display='none'; }
    if(prompt) prompt.style.display = 'flex';
    if(overlay) overlay.style.display = 'none';
    const hImg = document.getElementById('prop-img');
    const hZone = document.getElementById('upload-zone');
    if(hImg){ hImg.src=''; hImg.style.display='none'; }
    if(hZone) hZone.style.display = 'flex';
    const prevPhoto = document.getElementById('pd-preview-photo');
    if(prevPhoto) prevPhoto.innerHTML = 'üì∑';
    updatePropertyDetails();
  }

  // ‚îÄ‚îÄ PHOTO URL PASTE (item 11) ‚îÄ‚îÄ
  function handlePhotoUrlInput(val){
    // Real-time preview while typing a URL (debounced via existing input handler)
  }
  function applyPhotoUrl(){
    const urlEl = document.getElementById('pd-photo-url');
    const url   = urlEl?.value?.trim();
    if(!url){ showToast('‚ö†Ô∏è Paste an image URL first'); return; }
    propPhotoDataUrl = url;
    applyPropPhoto(url);
    showToast('üñºÔ∏è Photo loaded from URL');
  }

  function stepStat(id, delta){
    const el = document.getElementById(id);
    if(!el) return;
    const val = (parseInt(el.value) || 0) + delta;
    el.value = Math.max(0, val);
    updatePropertyDetails();
  }

  function setPropType(btn, type){
    document.querySelectorAll('.prop-type-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('pd-type').value = type;
    updatePropertyDetails();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ADDRESS AUTOCOMPLETE ‚Äî QLD Open Data CKAN API
  // Free, no sign-up, no API key required.
  // Falls back gracefully if unavailable.
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let _addrTimer = null;
  let _lastAddrQuery = '';

  async function addrAutocomplete(val){
    val = val.trim();
    if(val.length < 4){ hideAddrSuggestions(); return; }
    if(val === _lastAddrQuery) return;
    _lastAddrQuery = val;
    clearTimeout(_addrTimer);
    _addrTimer = setTimeout(async () => {
      try {
        // Nominatim (OpenStreetMap) ‚Äî free, no auth, covers all of Australia
        const url = 'https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=au&limit=6&q=' + encodeURIComponent(val);
        const r = await fetch(url, {
          headers: {'Accept-Language':'en', 'User-Agent':'PropertyCalc/1.0'},
          signal: AbortSignal.timeout(4000)
        });
        if(!r.ok) throw new Error('no response');
        const j = await r.json();
        if(!j.length){ hideAddrSuggestions(); return; }
        const results = j.map(item => {
          const a = item.address || {};
          const road    = a.road || a.pedestrian || a.path || '';
          const houseNo = a.house_number || '';
          const street  = houseNo ? houseNo + ' ' + road : road;
          const suburb  = a.suburb || a.neighbourhood || a.city_district || a.town || a.village || a.hamlet || '';
          const state   = a.state_code || a.state || '';
          const postcode = a.postcode || '';
          // Use display_name if we couldn't parse well
          const display = street || item.display_name.split(',')[0];
          return { address: display, suburb, state: ({'queensland':'QLD','new south wales':'NSW','victoria':'VIC','western australia':'WA','south australia':'SA','tasmania':'TAS','northern territory':'NT','australian capital territory':'ACT'}[((a.state_code||a.state||'')).toLowerCase().replace(/^state of /,'')] || 'QLD'), postcode };
        }).filter(r => r.address);
        if(!results.length){ hideAddrSuggestions(); return; }
        showAddrSuggestions(results);
      } catch(e) {
        hideAddrSuggestions();
      }
    }, 400);
  }

  function showAddrSuggestions(results){
    const box = document.getElementById('addr-suggestions');
    if(!box || !results.length){ hideAddrSuggestions(); return; }
    box.innerHTML = results.map(r =>
      `<div class="addr-suggestion" onmousedown="selectAddress(${JSON.stringify(r).replace(/"/g,'&quot;')})">
        <strong>${r.address}</strong><br><span>${r.suburb}${r.postcode ? ', '+r.postcode : ''} ${r.state}</span>
      </div>`
    ).join('');
    box.style.display = 'block';
  }

  function hideAddrSuggestions(){
    const box = document.getElementById('addr-suggestions');
    if(box) box.style.display = 'none';
  }

  function selectAddress(r){
    const addrEl   = document.getElementById('pd-address');
    const suburbEl = document.getElementById('pd-suburb');
    const stateEl  = document.getElementById('pd-state');
    if(addrEl)   addrEl.value   = r.address || '';
    if(suburbEl) suburbEl.value = r.suburb  || '';
    if(stateEl)  stateEl.value  = r.state   || 'QLD';
    hideAddrSuggestions();
    updatePropertyDetails();
  }

  function updatePropertyDetails(){
    autosaveDraft();
    const address = document.getElementById('pd-address').value;
    const suburb  = document.getElementById('pd-suburb').value;
    const state   = document.getElementById('pd-state').value;
    const bed     = parseInt(document.getElementById('pd-bed').value) || 0;
    const bath    = parseInt(document.getElementById('pd-bath').value) || 0;
    const car     = parseInt(document.getElementById('pd-car').value) || 0;
    const land    = document.getElementById('pd-land').value;
    const house   = document.getElementById('pd-house').value;
    const year    = document.getElementById('pd-year').value;
    const type    = document.getElementById('pd-type').value;
    const url     = document.getElementById('pd-url').value;

    const fullAddr = [address, suburb, state].filter(Boolean).join(', ') || 'New Property';

    // update header title
    const pageTitle = document.getElementById('page-title');
    if(pageTitle) pageTitle.textContent = fullAddr;

    // update header subtitle with stats or fallback
    const statParts = [
      type && type !== 'House' ? type : (address ? 'House' : null),
      bed  ? bed+' bed'  : null,
      bath ? bath+' bath': null,
      car  ? car+' car'  : null,
      land ? land+'m¬≤ land' : null
    ].filter(Boolean);
    const headerSubEl = document.getElementById('header-sub-text');
    if(headerSubEl) headerSubEl.textContent = statParts.length ? statParts.join('  ¬∑  ') : (address ? 'Edit values on the left ‚Äî everything updates live' : 'Add property details in the Property tab to get started');
    // Status badge in header
    const statusVal = document.getElementById('pd-status')?.value || 'browsing';
    const STATUS_BADGE_COLORS = {'browsing':'#5B8FAB','auction':'#C4704A','for-sale':'#C9A84C','offered':'#7B9E87','under-offer':'#E8A882','unconditional':'#5A9E7B','sold':'#C45A5A'};
    const STATUS_BADGE_LABELS = {'browsing':'üëÄ Browsing','auction':'üî® Auction','for-sale':'üè∑ For Sale','offered':'üìù Offer Sent','under-offer':'‚è≥ Under Offer','unconditional':'‚úÖ Unconditional','sold':'üî¥ Sold'};
    let statusBadge = document.getElementById('header-status-badge');
    if(!statusBadge){ statusBadge = document.createElement('div'); statusBadge.id='header-status-badge'; statusBadge.style.cssText='display:inline-block;padding:2px 10px;border-radius:10px;font-family:\'DM Mono\',monospace;font-size:10px;letter-spacing:0.5px;font-weight:500;white-space:nowrap;width:auto;max-width:none;align-self:flex-start;margin-top:4px;'; const h1=document.getElementById('page-title'); if(h1&&h1.parentNode) h1.parentNode.insertBefore(statusBadge, h1.nextSibling); }
    statusBadge.textContent = STATUS_BADGE_LABELS[statusVal] || statusVal;
    statusBadge.style.background = (STATUS_BADGE_COLORS[statusVal]||'#888') + '33';
    statusBadge.style.color = STATUS_BADGE_COLORS[statusVal] || '#888';
    statusBadge.style.border = '1px solid ' + (STATUS_BADGE_COLORS[statusVal]||'#888') + '66';

    const photoCap = document.getElementById('photo-caption');
    if(photoCap) photoCap.textContent = fullAddr;

    // sync address to sidebar
    const sideAddr = document.getElementById('inp-address');
    if(sideAddr && sideAddr.value !== address) sideAddr.value = address;

    // listing URL link
    const urlLink = document.getElementById('pd-url-link');
    const urlAnchor = document.getElementById('pd-url-anchor');
    if(url && url.startsWith('http')){ urlLink.style.display='block'; urlAnchor.href=url; }
    else if(urlLink) urlLink.style.display='none';

    // photo label
    const photoLabel = document.getElementById('pd-photo-label');
    if(photoLabel) photoLabel.textContent = fullAddr;

    // live preview
    const prevTitle = document.getElementById('pd-preview-title');
    if(prevTitle) prevTitle.textContent = fullAddr;

    const statsEl = document.getElementById('pd-preview-stats');
    if(statsEl){
      const chips = [];
      if(type) chips.push(`üè† ${type}`);
      if(bed)  chips.push(`üõè ${bed} bed`);
      if(bath) chips.push(`üöø ${bath} bath`);
      if(car)  chips.push(`üöó ${car} car`);
      if(land) chips.push(`üìê ${land}m¬≤`);
      if(house)chips.push(`üèó ${house}m¬≤ house`);
      if(year) chips.push(`üìÖ Built ${year}`);
      statsEl.innerHTML = chips.map(c=>`<span class="pd-stat-chip">${c}</span>`).join('') || '<span style="font-size:11px;color:rgba(245,240,232,0.3);font-family:\'DM Mono\',monospace;">Fill in details above to see preview</span>';
    }

    recalc();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENO NOTES ‚Äî legacy placeholder (reno items now fully dynamic, item 13)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const renoNotes = {}; // kept for backward compat during load
  function saveRenoNote(i, val){ renoNotes[i] = val; }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHARED STORAGE ‚Äî Netlify Functions + Blobs
  // All visitors to the site share the same data.
  // Falls back to localStorage when running locally.
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const STORAGE_KEY = 'propCalc_v5_index';
  const PHOTO_PFX   = 'propCalc_v5_ph_';
  let scenariosView = 'grid';
  let pendingLoadId = null;
  let _scenariosCache = null;

  function lsGet(k){ try{return localStorage.getItem(k);}catch(e){return null;} }
  function lsSet(k,v){ try{localStorage.setItem(k,v);}catch(e){} }
  function lsDel(k){ try{localStorage.removeItem(k);}catch(e){} }

  // Are we running on Netlify (not a local file)?
  const ON_NETLIFY = window.location.protocol !== 'file:';

  async function getAllScenarios(){
    if(ON_NETLIFY){
      try{
        const r = await fetch('/.netlify/functions/scenarios');
        if(r.ok){
          const data = await r.json();
          // Mirror to localStorage ‚Äî survives Netlify rebuilds as a fallback
          if(data.length) lsSet(STORAGE_KEY, JSON.stringify(data));
          return data;
        }
        console.error('[storage] GET failed:', r.status, await r.text());
      }catch(e){ console.error('[storage] GET exception:', e.message); }
    }
    // Fallback: localStorage (browser-side, survives all rebuilds)
    try{ return JSON.parse(lsGet(STORAGE_KEY)||'[]'); }catch(e){ return []; }
  }

  async function saveScenarioToBackend(record, photoSrc){
    if(ON_NETLIFY){
      try{
        // Send record first (fast ‚Äî no photo payload). Photo uploads in background.
        const r = await fetch('/.netlify/functions/scenarios', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ record, photoSrc: null }) // no photo in main call
        });
        console.log('[storage] POST scenarios status:', r.status);
        if(r.ok){
          // Mirror updated list to localStorage immediately (belt-and-suspenders)
          getAllScenarios().then(latest => { if(latest.length) lsSet(STORAGE_KEY, JSON.stringify(latest)); }).catch(()=>{});
          // Upload full photo separately in background (don't await ‚Äî user sees success immediately)
          if(photoSrc){
            fetch('/.netlify/functions/scenarios', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ record: {id: record.id}, photoSrc })
            }).then(pr => console.log('[storage] photo upload:', pr.status))
              .catch(e => console.warn('[storage] photo upload failed:', e.message));
          }
          return true;
        }
        const txt = await r.text();
        console.error('[storage] POST failed:', r.status, txt);
      }catch(e){ console.error('[storage] POST exception:', e.message); }
    }
    if(photoSrc) lsSet(PHOTO_PFX+record.id, photoSrc);
    let arr=[]; try{ arr=JSON.parse(lsGet(STORAGE_KEY)||'[]'); }catch(e){}
    const i=arr.findIndex(s=>s.id===record.id);
    if(i>=0) arr[i]=record; else arr.unshift(record);
    lsSet(STORAGE_KEY, JSON.stringify(arr));
    return false;
  }

  async function deleteScenarioFromBackend(id){
    if(ON_NETLIFY){
      try{ await fetch('/.netlify/functions/scenarios?id='+id, {method:'DELETE'}); }catch(e){}
    }
    lsDel(PHOTO_PFX+id);
    try{
      const arr=JSON.parse(lsGet(STORAGE_KEY)||'[]').filter(s=>s.id!==id);
      lsSet(STORAGE_KEY, JSON.stringify(arr));
    }catch(e){}
  }

  const _photoCache = {};
  async function getPhoto(id){
    if(_photoCache[id]) return _photoCache[id];
    if(ON_NETLIFY){
      try{
        const r = await fetch('/.netlify/functions/photo?id='+id);
        if(r.ok){ const d=await r.json(); if(d.photoSrc){ _photoCache[id]=d.photoSrc; return d.photoSrc; } return null; }
      }catch(e){}
    }
    const local = lsGet(PHOTO_PFX+id);
    if(local) _photoCache[id] = local;
    return local;
  }

  function showStorageStatus(){
    const el = document.getElementById('storage-status');
    if(!el) return;
    if(ON_NETLIFY){
      el.innerHTML = '<span style="color:var(--sage-light)">‚òÅ shared</span>';
      el.title = 'Netlify shared storage ‚Äî all visitors see the same properties';
    }
  }

  function collectCurrentState(){
    const fields = [
      'inp-price','inp-savings','inp-depp','inp-govt','inp-rate','inp-term',
      'inp-cont','inp-rent','inp-weeks',
      'pd-address','pd-suburb','pd-state','pd-bed','pd-bath','pd-car',
      'pd-land','pd-house','pd-year','pd-type','pd-url','pd-notes',
      'pd-status','pd-status-date','ag-agency','ag-name','ag-phone','ag-email'
    ];
    const values = {};
    fields.forEach(id => { const el=document.getElementById(id); if(el) values[id]=el.value||''; });
    const activePropType = document.querySelector('.prop-type-btn.active');
    values['pd-type-label'] = activePropType ? activePropType.textContent.trim() : 'üè† House';
    values['renoEnabled'] = renoEnabled;
    values['rentEnabled'] = document.getElementById('rent-sidebar-section')?.style.display !== 'none';
    return {
      values,
      dynCostData: dynCosts.map(c=>({name:c.name,amount:c.amount})),
      renoItemData: renoItems.map(r=>({emoji:r.emoji,name:r.name,amount:r.amount,note:r.note})),
      keyDates: typeof keyDates !== 'undefined' ? [...keyDates] : [],
      commsLog:  typeof commsLog  !== 'undefined' ? [...commsLog]  : []
    };
  }

  async function saveScenario(){
    const state    = collectCurrentState();
    const addr     = state.values['pd-address'] || '';
    if(!addr.trim()){
      showToast('‚ö†Ô∏è Please enter a property address before saving');
      const addrEl = document.getElementById('pd-address');
      if(addrEl){ addrEl.focus(); addrEl.style.borderColor='var(--terracotta)'; setTimeout(()=>addrEl.style.borderColor='',2500); }
      showTab('property', document.querySelector('.tab'));
      return;
    }
    const suburb   = state.values['pd-suburb']  || '';
    const stateV   = state.values['pd-state']   || '';
    const fullAddr = [addr, suburb, stateV].filter(Boolean).join(', ') || 'Unnamed Property';
    const now      = new Date();
    const dd = String(now.getDate()).padStart(2,'0');
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const yyyy = now.getFullYear();
    const hh = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const timestamp = `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    const scenarios = await getAllScenarios();
    const addrKey  = fullAddr.toLowerCase().trim();
    const existIdx = scenarios.findIndex(s => (s.addrKey||'') === addrKey);
    const id       = existIdx >= 0 ? scenarios[existIdx].id : ('sc_' + Date.now());
    const status   = state.values['pd-status'] || 'browsing';
    const record   = {
      id, addrKey, fullAddr, timestamp, status,
      bed:  state.values['pd-bed']  || '',
      bath: state.values['pd-bath'] || '',
      car:  state.values['pd-car']  || '',
      type: state.values['pd-type'] || 'House',
      price: state.values['inp-price'] || '',
      hasPhoto: !!propPhotoDataUrl,
      thumb: propThumbDataUrl || null,
      state,
    };
    const saveBtns = document.querySelectorAll('button[onclick*="saveScenario"]');
    saveBtns.forEach(b=>{b._ot=b.innerHTML;b.innerHTML='<div class="spinner-sm"></div>';b.disabled=true;});
    _scenariosCache = null;
    const usedCloud = await saveScenarioToBackend(record, propPhotoDataUrl||null);
    saveBtns.forEach(b=>{if(b._ot)b.innerHTML=b._ot;b.disabled=false;});
    _lastSavedAddr = fullAddr; _isDirty = false; updateUnsavedBadge();
    const action = existIdx>=0 ? 'Updated' : 'Saved';
    if(usedCloud){
      showToast(`‚òÅÔ∏è ${action} to cloud ‚Äî visible on all devices`);
    } else if(ON_NETLIFY){
      showToast(`‚ö†Ô∏è Cloud save failed ‚Äî saved locally only. Check Netlify Functions.`);
    } else {
      showToast(`üíæ ${action} locally (open via Netlify for shared sync)`);
    }
    updateSavedCount();
  }

  async function updateSavedCount(){
    // Warm the scenarios cache in the background so library opens instantly
    const arr = await getAllScenarios();
    if(arr.length) _scenariosCache = arr; // cache so library opens without re-fetching
    const ct = document.getElementById('saved-count');
    if(!ct) return;
    if(arr.length > 0){ ct.textContent = arr.length; ct.style.display='inline'; }
    else ct.style.display='none';
  }

  function setScenariosView(mode){ /* grid view removed ‚Äî list only */ }

  function openScenariosModal(){
    document.getElementById('scenarios-modal').style.display='block';
    document.body.style.overflow='hidden';
    renderScenariosList();
  }
  function closeScenariosModal(){
    document.getElementById('scenarios-modal').style.display='none';
    document.body.style.overflow='';
  }
  function closeConfirmModal(){
    document.getElementById('confirm-modal').style.display='none';
    pendingLoadId = null;
  }

  const STATUS_COLORS = {
    'browsing':'#5B8FAB','auction':'#C4704A','for-sale':'#C9A84C',
    'offered':'#7B9E87','under-offer':'#E8A882','unconditional':'#5A9E7B','sold':'#C45A5A'
  };
  const STATUS_LABELS = {
    'browsing':'üëÄ Browsing','auction':'üî® Auction','for-sale':'üè∑ For Sale',
    'offered':'üìù Offer Sent','under-offer':'‚è≥ Under Offer',
    'unconditional':'‚úÖ Unconditional','sold':'üî¥ Sold/Passed'
  };

  let _libFilter = 'all';

  function setLibFilter(f, btn){
    _libFilter = f;
    document.querySelectorAll('.lib-filter').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    _renderScenariosToDOM(_scenariosCache || []);
  }

  async function renderScenariosList(){
    const grid = document.getElementById('scenarios-grid');
    if(!grid) return;
    grid.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:40px 20px;color:var(--slate);font-family:\'DM Mono\',monospace;font-size:12px;"><div class="spinner"></div>Loading properties‚Ä¶</div>';
    _scenariosCache = await getAllScenarios();
    _renderScenariosToDOM(_scenariosCache);
  }

  async function _renderScenariosToDOM(all){
    const grid  = document.getElementById('scenarios-grid');
    const empty = document.getElementById('scenarios-empty');
    if(!grid) return;

    const scenarios = _libFilter === 'all' ? all : all.filter(s => (s.status||'browsing') === _libFilter);

    if(!all || all.length === 0){
      if(empty) empty.style.display = 'block';
      grid.innerHTML = ''; return;
    }
    if(empty) empty.style.display = 'none';
    const libCount = document.getElementById('lib-count');
    if(libCount) libCount.textContent = all.length > 0 ? `(${all.length})` : '';

    if(scenarios.length === 0){
      grid.innerHTML = '<div style="text-align:center;padding:32px;color:var(--slate);font-size:13px;">No properties match this filter.</div>';
      return;
    }

    // Render rows immediately without waiting for photos
    const rows = scenarios.map(s => {
      const price  = s.price ? '$' + parseInt(s.price).toLocaleString() : '‚Äî';
      const stats  = [s.type||'House', s.bed?s.bed+' bed':null, s.bath?s.bath+' bath':null, s.car?s.car+' car':null].filter(Boolean).join(' ¬∑ ');
      const status = s.status || 'browsing';
      const sColor = STATUS_COLORS[status] || '#999';
      const sLabel = STATUS_LABELS[status] || 'üëÄ';
      return `
        <div class="lib-row" onclick="promptLoadScenario('${s.id}')">
          <div class="lib-thumb" id="thumb-${s.id}"><span style="font-size:24px;">üè†</span></div>
          <div class="lib-info">
            <div class="lib-addr">${s.fullAddr}</div>
            <div class="lib-meta">${stats}</div>
          </div>
          <div class="lib-price">${price}</div>
          <div class="lib-badge" style="background:${sColor}22;color:${sColor};border:1px solid ${sColor}55;">${sLabel}</div>
          <div class="lib-ts">${(s.timestamp||'').replace(/(\d+)\s([A-Za-z]+)\s(\d{4})/,(_,d,mo,y)=>{const mn={Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};return String(d).padStart(2,'0')+'/'+(mn[mo]||'01')+'/'+y;})}</div>
          <button class="lib-del" onclick="event.stopPropagation();deleteScenario('${s.id}')" title="Delete">‚úï</button>
        </div>`;
    });
    grid.innerHTML = rows.join('');

    // Load photos lazily ‚Äî use thumb from record if available, else fetch
    scenarios.forEach(async s => {
      if(!s.hasPhoto) return;
      const thumb = document.getElementById('thumb-'+s.id);
      if(!thumb) return;
      // Use embedded thumb if we have it (no network call needed)
      if(s.thumb){ thumb.innerHTML = `<img src="${s.thumb}" style="width:100%;height:100%;object-fit:cover;border-radius:3px;" loading="lazy">`; return; }
      const photo = await getPhoto(s.id);
      if(photo && thumb) thumb.innerHTML = `<img src="${photo}" style="width:100%;height:100%;object-fit:cover;border-radius:3px;" loading="lazy">`;
    });
  }

  async function promptLoadScenario(id){
    const scenarios = _scenariosCache || await getAllScenarios();
    const sc = scenarios.find(s => s.id === id);
    if(!sc) return;
    pendingLoadId = id;
    document.getElementById('confirm-name').textContent = sc.fullAddr;
    document.getElementById('confirm-modal').style.display='block';
  }

  async function confirmLoad(){
    if(!pendingLoadId) return;
    const scenarios = _scenariosCache || await getAllScenarios();
    const sc = scenarios.find(s => s.id === pendingLoadId);
    if(!sc || !sc.state){ pendingLoadId=null; closeConfirmModal(); return; }
    closeConfirmModal();
    closeScenariosModal();
    const photo = sc.hasPhoto ? await getPhoto(sc.id) : null;
    applyScenarioState(sc.state, photo);
    _lastSavedAddr = sc.fullAddr; _isDirty = false; updateUnsavedBadge();
    showToast('‚úì Loaded: ' + sc.fullAddr);
    pendingLoadId = null;
  }

  function applyScenarioState(state, photoSrc){
    const {values, dynCostData, renoItemData, keyDates:kd, commsLog:cl} = state;
    const skipFields = new Set(['pd-type','pd-type-label','renoEnabled','rentEnabled']);
    Object.entries(values||{}).forEach(([id, val]) => {
      if(skipFields.has(id) || id.startsWith('rn-')) return;
      const el = document.getElementById(id);
      if(el) el.value = val;
    });
    if(values?.['pd-type-label']){
      document.querySelectorAll('.prop-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.trim() === values['pd-type-label']);
      });
    }
    // Restore status
    if(values?.['pd-status']) setStatus(values['pd-status'], null, true);
    // Agent links
    updateAgentLinks();
    // Key dates
    if(typeof keyDates !== 'undefined'){ keyDates = Array.isArray(kd)?[...kd]:[]; renderKeyDates(); }
    // Comms log
    if(typeof commsLog !== 'undefined'){ commsLog = Array.isArray(cl)?[...cl]:[]; renderCommsLog(); }
    // Reno items (item 13)
    renoItems = [];
    if(renoItemData && renoItemData.length>0){
      renoItemData.forEach(r=>renoItems.push({id:'ri-'+renoItemId++, emoji:r.emoji||'üî®', name:r.name||'', amount:r.amount||0, note:r.note||''}));
    } else if(dynCostData && !renoItemData) {
      // legacy: old saved data had reno in dynCostData ‚Äî skip (can't distinguish)
    }
    renderRenoItems();
    // Purchase costs (item 14) ‚Äî all dynamic now
    dynCosts = [];
    if(dynCostData) dynCostData.forEach(c => dynCosts.push({id:'dyn-'+dynId++, name:c.name||'', amount:c.amount||0}));
    renderDynCosts();
    // Reno/rent toggles
    if(typeof renoEnabled !== 'undefined'){
      const newReno = values?.['renoEnabled'] !== false;
      if(newReno !== renoEnabled){ renoEnabled=newReno; applyRenoToggle(); }
    }
    const newRent = values?.['rentEnabled'] !== false;
    applyRentToggle(newRent);

    if(photoSrc) applyPropPhoto(photoSrc); else clearPropPhoto();
    ['price','savings','depp','govt','rate','term','cont','rent','weeks'].forEach(k => {
      const inp = document.getElementById('inp-'+k), rng = document.getElementById('rng-'+k);
      if(inp && rng) rng.value = inp.value;
    });
    updatePropertyDetails();
    recalc();
  }

  async function deleteScenario(id){
    if(!confirm('Delete this scenario? This cannot be undone.')) return;
    _scenariosCache = null;
    await deleteScenarioFromBackend(id);
    updateSavedCount();
    renderScenariosList();
  }

  function updateUnsavedBadge(){
    const badge = document.getElementById('unsaved-badge');
    if(!badge) return;
    const price = v('inp-price');
    const addr  = document.getElementById('pd-address')?.value?.trim() || '';
    const hasContent = price > 0 || addr.length > 0;
    if(hasContent && _isDirty){
      badge.style.display = 'inline-flex';
      badge.title = 'You have unsaved changes ‚Äî click Save to preserve them';
    } else {
      badge.style.display = 'none';
    }
  }

  // Warn before closing/refreshing with unsaved address data
  window.addEventListener('beforeunload', function(e){
    const price = v('inp-price');
    const addr  = document.getElementById('pd-address')?.value?.trim() || '';
    if((price > 0 || addr) && _isDirty){
      e.preventDefault();
      e.returnValue = 'You have unsaved changes. Refresh anyway?';
    }
  });

  function showToast(msg){
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--charcoal);color:var(--gold);font-family:"DM Mono",monospace;font-size:11px;padding:10px 16px;border-radius:3px;border:1px solid rgba(201,168,76,0.3);z-index:9999;letter-spacing:0.5px;box-shadow:0 4px 20px rgba(0,0,0,0.3);transition:opacity 0.8s;';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 800); }, 3500);
  }

  // ‚îÄ‚îÄ RENO TOGGLE ‚îÄ‚îÄ
  let renoEnabled = true;
  function toggleReno(){
    renoEnabled = !renoEnabled;
    applyRenoToggle();
    recalc();
  }
  function applyRenoToggle(){
    const knob = document.getElementById('reno-toggle-knob');
    const track = document.getElementById('reno-toggle');
    const section = document.getElementById('reno-sidebar-section');
    const tab = document.getElementById('tab-reno-btn');
    if(renoEnabled){
      if(knob) knob.style.left = '20px';
      if(track) track.style.background = 'var(--sage)';
      if(section) section.style.display = '';
      if(tab) tab.style.display = '';
    } else {
      if(knob) knob.style.left = '2px';
      if(track) track.style.background = 'rgba(255,255,255,0.15)';
      if(section) section.style.display = 'none';
      if(tab){ tab.style.display = 'none'; showTab('costs', document.querySelector('.tab')); }
    }
  }

  // ‚îÄ‚îÄ RENT OVERLAP TOGGLE (item 12) ‚îÄ‚îÄ
  let rentEnabled = true;
  let riskEnabled = true;
  function toggleRisk(){
    riskEnabled = !riskEnabled;
    const tog = document.getElementById('risk-toggle');
    const knob = document.getElementById('risk-toggle-knob');
    const tabBtn = document.getElementById('tab-risks-btn');
    if(tog) tog.style.background = riskEnabled ? 'var(--terracotta)' : 'rgba(255,255,255,0.15)';
    if(knob) knob.style.left = riskEnabled ? '20px' : '2px';
    if(tabBtn) tabBtn.style.display = riskEnabled ? '' : 'none';
    if(!riskEnabled){ const active = document.querySelector('.tab.active'); if(active && active.id==='tab-risks-btn') showTab('property', document.querySelector('.tab')); }
  }
  function toggleRent(){
    rentEnabled = !rentEnabled;
    applyRentToggle(rentEnabled);
    recalc();
  }
  function applyRentToggle(enabled){
    rentEnabled = enabled;
    const knob = document.getElementById('rent-toggle-knob');
    const track = document.getElementById('rent-toggle');
    const section = document.getElementById('rent-sidebar-section');
    const tab = document.querySelector('.tab[onclick*="overlap"]');
    if(enabled){
      if(knob) knob.style.left = '20px';
      if(track) track.style.background = 'var(--sky)';
      if(section) section.style.display = '';
      if(tab) tab.style.display = '';
    } else {
      if(knob) knob.style.left = '2px';
      if(track) track.style.background = 'rgba(255,255,255,0.15)';
      if(section) section.style.display = 'none';
      if(tab){ tab.style.display = 'none'; }
    }
  }

  // ‚îÄ‚îÄ PROJECTION (items 6,7,8,9) ‚îÄ‚îÄ
  let projData = []; // shared so tooltip can read it

  function drawProjection(){
    const price   = v('inp-price'); if(!price) return;
    const loanAmt = Math.max(0, price - price*v('inp-depp')/100 - price*v('inp-govt')/100);
    const rate    = v('inp-rate');
    const term    = v('inp-term');
    const govtPct = v('inp-govt') / 100;
    const growthPct = parseFloat(document.getElementById('proj-growth').value) / 100;
    const upliftPct = parseFloat(document.getElementById('proj-uplift')?.value || '0') / 100;
    const years   = 30; // item 8: fixed at 30
    const monthly = calcMonthly(loanAmt, rate, term);

    // Build year-by-year data
    projData = [];
    let loanBal = loanAmt;
    const mRate = rate/100/12;
    for(let yr=0; yr<=years; yr++){
      const baseVal   = price * Math.pow(1+growthPct, yr);
      const renoVal   = yr===0 ? price : price * Math.pow(1+growthPct, yr); // reno uplift removed
      const govtOwed  = baseVal * govtPct;
      if(yr>0){
        for(let m=0;m<12;m++){
          const interest = loanBal * mRate;
          loanBal = Math.max(0, loanBal - (monthly - interest));
        }
      }
      projData.push({ yr, baseVal, renoVal, loanBal:Math.max(0,loanBal), govtOwed, yourEquity:baseVal-loanBal-govtOwed });
    }

    // ‚îÄ‚îÄ MILESTONE TILES (item 9) ‚îÄ‚îÄ
    const payoffYr = projData.find(d=>d.loanBal<=0.01)?.yr;
    // "can buy out govt" = your equity >= govtOwed (i.e. net equity without govt ‚â• 0, i.e. property value ‚â• loan + 2*govtOwed roughly)
    const buyoutYr = projData.find(d=>d.yourEquity>=d.govtOwed && d.yr>0)?.yr;

    const payEl = document.getElementById('proj-payoff-yr');
    if(payEl) payEl.textContent = payoffYr ? 'Year '+payoffYr : (term<30?'Year '+term:'30+ yrs');
    const buyEl = document.getElementById('proj-buyout-yr');
    if(buyEl) buyEl.textContent = buyoutYr ? 'Year '+buyoutYr : '30+ yrs';

    const d5 = projData.find(d=>d.yr===5) || projData[projData.length-1];
    set('proj-val-5', fmtK(d5.baseVal));
    set('proj-govt-5', fmtK(d5.govtOwed));

    // ‚îÄ‚îÄ MILESTONES TIMELINE ‚îÄ‚îÄ
    const msEl = document.getElementById('proj-milestones');
    if(msEl){
      const ms = [];
      ms.push({yr:0,color:'var(--gold)',label:'Settlement',desc:`Purchase price ${fmtK(price)} ¬∑ Loan ${fmtK(loanAmt)} ¬∑ Govt equity ${fmtK(price*govtPct)}`});
      if(buyoutYr) ms.push({yr:buyoutYr,color:'var(--sage)',label:'Can Refinance/Buy Out Govt',desc:`Property ~${fmtK(projData[buyoutYr]?.baseVal||0)} ¬∑ Govt owed ~${fmtK(projData[buyoutYr]?.govtOwed||0)} ¬∑ Your equity ~${fmtK(projData[buyoutYr]?.yourEquity||0)}`});
      const halfYr = projData.find(d=>d.loanBal<=loanAmt*0.5 && d.yr>0)?.yr;
      if(halfYr) ms.push({yr:halfYr,color:'var(--sky)',label:'Loan 50% Paid Off',desc:`Loan balance ~${fmtK(projData[halfYr]?.loanBal||0)} ¬∑ Property ~${fmtK(projData[halfYr]?.baseVal||0)}`});
      if(payoffYr&&payoffYr<=30) ms.push({yr:payoffYr,color:'var(--reward-green)',label:'Loan Fully Paid Off üéâ',desc:`Property ~${fmtK(projData[payoffYr]?.baseVal||0)} ¬∑ Full equity achieved`});
      ms.push({yr:30,color:'var(--terracotta)',label:'Year 30 ‚Äî End of Projection',desc:`Est. value ${fmtK(projData[29]?.baseVal||0)} ¬∑ Est. govt equity owed ${fmtK(projData[29]?.govtOwed||0)}`});
      msEl.innerHTML = ms.sort((a,b)=>a.yr-b.yr).map(m=>`
        <div class="tli">
          <div class="tld" style="color:${m.color}"></div>
          <div class="tlp" style="color:${m.color}">Year ${m.yr}</div>
          <div class="tlt">${m.label}</div>
          <div class="tldesc">${m.desc}</div>
        </div>`).join('');
    }

    // ‚îÄ‚îÄ SVG CHART ‚îÄ‚îÄ
    const svg = document.getElementById('proj-chart');
    if(!svg) return;
    const W=800, H=300, padL=72, padR=24, padT=20, padB=40;
    const cW=W-padL-padR, cH=H-padT-padB;
    const maxVal = Math.max(...projData.map(d=>d.renoVal))*1.08;
    const scaleX = yr => padL + (yr/years)*cW;
    const scaleY = val => padT + cH - (val/maxVal)*cH;

    let html = '';
    // Y grid lines
    for(let p=0;p<=4;p++){
      const val=maxVal*p/4, y=scaleY(val);
      html+=`<line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="rgba(28,28,30,0.07)" stroke-width="1"/>`;
      html+=`<text x="${padL-6}" y="${y+4}" text-anchor="end" font-family="DM Mono" font-size="9" fill="#999">${fmtK(val)}</text>`;
    }
    // X axis labels
    [0,5,10,15,20,25,30].forEach(yr=>{
      html+=`<text x="${scaleX(yr)}" y="${H-padB+16}" text-anchor="middle" font-family="DM Mono" font-size="9" fill="#999">Yr ${yr}</text>`;
    });

    // Shaded equity area
    const topPts = projData.map(d=>`${scaleX(d.yr).toFixed(1)},${scaleY(d.baseVal).toFixed(1)}`).join(' ');
    const botPts = [...projData].reverse().map(d=>`${scaleX(d.yr).toFixed(1)},${scaleY(Math.max(d.loanBal+d.govtOwed,0)).toFixed(1)}`).join(' ');
    html+=`<polygon points="${topPts} ${botPts}" fill="rgba(90,158,123,0.09)"/>`;

    const mkPath=(key,color,dash='')=>{
      const pts=projData.map((d,i)=>`${i===0?'M':'L'}${scaleX(d.yr).toFixed(1)},${scaleY(d[key]).toFixed(1)}`).join(' ');
      return `<path d="${pts}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"${dash?` stroke-dasharray="${dash}"`:''}/>`;
    };
    html += mkPath('baseVal','#C9A84C');
    html += mkPath('renoVal','#7B9E87');
    html += mkPath('loanBal','#5B8FAB','6 3');
    html += mkPath('govtOwed','#C4704A');

    // Milestone markers on chart
    if(payoffYr && payoffYr<=30){ const d=projData[payoffYr]; html+=`<circle cx="${scaleX(payoffYr)}" cy="${scaleY(d.loanBal)}" r="5" fill="#5A9E7B" stroke="white" stroke-width="2"/><text x="${scaleX(payoffYr)}" y="${scaleY(d.loanBal)-9}" text-anchor="middle" font-family="DM Mono" font-size="8" fill="#5A9E7B">PAID OFF</text>`; }
    if(buyoutYr && buyoutYr<=30){ const d=projData[buyoutYr]; html+=`<circle cx="${scaleX(buyoutYr)}" cy="${scaleY(d.baseVal)}" r="5" fill="#7B9E87" stroke="white" stroke-width="2"/><text x="${scaleX(buyoutYr)}" y="${scaleY(d.baseVal)-9}" text-anchor="middle" font-family="DM Mono" font-size="8" fill="#7B9E87">BUY OUT</text>`; }

    // Invisible hit overlay for click/hover (item 6)
    html += `<rect id="proj-hit" x="${padL}" y="${padT}" width="${cW}" height="${cH}" fill="transparent" style="cursor:crosshair;" onmousemove="projHover(event,${padL},${padR},${cW},${years})" onmouseleave="document.getElementById('proj-tooltip').style.display='none'" onclick="projHover(event,${padL},${padR},${cW},${years})"/>`;

    // Crosshair line (hidden until hover)
    html += `<line id="proj-crosshair" x1="0" y1="${padT}" x2="0" y2="${H-padB}" stroke="rgba(201,168,76,0.5)" stroke-width="1" stroke-dasharray="3 2" style="display:none;pointer-events:none;"/>`;

    svg.innerHTML = html;

    // ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ
    const tblEl = document.getElementById('proj-table');
    if(tblEl){
      const rows = [1,2,3,5,7,10,15,20,25,30].map(y=>{
        const d=projData[Math.min(y,projData.length-1)];
        const eq=d.yourEquity;
        const isMilestone = y===payoffYr||y===buyoutYr;
        return `<div style="display:grid;grid-template-columns:60px repeat(5,1fr);gap:6px;padding:7px 0;border-top:1px solid rgba(28,28,30,0.06);font-size:10px;font-family:'DM Mono',monospace;${isMilestone?'background:rgba(201,168,76,0.06);border-radius:2px;':''}">`
          +`<span style="color:var(--gold);">Yr ${y}${isMilestone?' ‚òÖ':''}</span>`
          +`<span>${fmtK(d.baseVal)}</span><span style="color:var(--sage)">${fmtK(d.renoVal)}</span>`
          +`<span style="color:var(--sky)">${fmtK(d.loanBal)}</span>`
          +`<span style="color:var(--terracotta)">${fmtK(d.govtOwed)}</span>`
          +`<span style="color:${eq>0?'var(--reward-green)':'var(--risk-red)'};font-weight:600;">${fmtK(eq)}</span></div>`;
      });
      tblEl.innerHTML=`<div style="font-family:'DM Mono',monospace;font-size:10px;"><div style="display:grid;grid-template-columns:60px repeat(5,1fr);gap:6px;padding-bottom:6px;border-bottom:1px solid rgba(28,28,30,0.1);color:var(--slate);font-size:9px;letter-spacing:1px;text-transform:uppercase;"><span>Year</span><span>Value</span><span>+Reno</span><span>Loan Bal</span><span>Govt Owed</span><span>Your Equity</span></div>${rows.join('')}</div>`;
    }
  }

  function projHover(e, padL, padR, cW, years){
    const svg   = document.getElementById('proj-chart');
    const tip   = document.getElementById('proj-tooltip');
    const cross = document.getElementById('proj-crosshair');
    if(!svg||!tip||!projData.length) return;
    const rect  = svg.getBoundingClientRect();
    const svgW  = svg.viewBox.baseVal.width || 800;
    const scale = svgW / rect.width;
    const mx    = (e.clientX - rect.left) * scale;
    const relX  = mx - padL;
    if(relX<0||relX>cW) return;
    const yr    = Math.round((relX/cW)*years);
    const d     = projData[Math.min(yr, projData.length-1)];
    if(!d) return;
    // crosshair
    const cx = padL+(yr/years)*cW;
    if(cross){ cross.setAttribute('x1',cx);cross.setAttribute('x2',cx);cross.style.display=''; }
    // tooltip
    tip.innerHTML=`<div style="font-size:10px;letter-spacing:2px;color:var(--gold);margin-bottom:8px;">YEAR ${d.yr}</div>`
      +`<div style="display:flex;flex-direction:column;gap:4px;font-size:11px;">`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">Value</span><span style="color:#C9A84C;">${fmtK(d.baseVal)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">+Reno</span><span style="color:#7B9E87;">${fmtK(d.renoVal)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">Loan Bal</span><span style="color:#5B8FAB;">${fmtK(d.loanBal)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">Govt Owed</span><span style="color:#C4704A;">${fmtK(d.govtOwed)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;border-top:1px solid rgba(255,255,255,0.1);padding-top:4px;"><span style="color:rgba(245,240,232,0.5);">Your Equity</span><span style="color:${d.yourEquity>0?'#5A9E7B':'#C45A5A'};font-weight:600;">${fmtK(d.yourEquity)}</span></div>`
      +'</div>';
    // position tooltip
    const px = e.clientX - rect.left;
    const py = e.clientY - rect.top;
    tip.style.display='block';
    tip.style.left = (px > rect.width/2 ? (px-tip.offsetWidth-12)+'px' : (px+12)+'px');
    tip.style.top  = Math.max(0,py-tip.offsetHeight/2)+'px';
  }

  // ‚îÄ‚îÄ SUBURB GROWTH LOOKUP (item 7) ‚îÄ‚îÄ
  async function fetchSuburbGrowth(){
    const suburb = document.getElementById('pd-suburb')?.value?.trim();
    const state  = document.getElementById('pd-state')?.value?.trim() || 'QLD';
    if(!suburb){ showToast('‚ö†Ô∏è Enter a suburb in the Property tab first'); return; }
    const btn = document.getElementById('fetch-growth-btn');
    const hint = document.getElementById('suburb-growth-hint');
    btn.textContent = '‚è≥ Looking up...';
    btn.disabled = true;

    // Brisbane/QLD suburb growth rate lookup table (5-yr average % p.a.)
    // Based on CoreLogic/PropTrack historical data for common QLD suburbs
    const qldGrowthTable = {
      'kedron':6.8,'stafford':6.5,'stafford heights':6.2,'chermside':6.0,
      'chermside west':5.8,'everton park':6.3,'nundah':7.1,'wavell heights':6.9,
      'aspley':6.0,'zillmere':5.5,'geebung':5.8,'virginia':5.6,'northgate':6.4,
      'nudgee':5.2,'banyo':5.0,'hendra':7.5,'eagle farm':5.8,'hamilton':7.2,
      'ascot':7.8,'clayfield':7.3,'wooloowin':7.0,'gordon park':6.8,'grange':7.2,
      'newmarket':6.9,'alderley':7.0,'enoggera':5.8,'keperra':5.5,'mitchelton':6.2,
      'gaythorne':6.5,'oxley':5.5,'rocklea':5.0,'moorooka':5.8,'salisbury':5.5,
      'nathan':5.8,'sunnybank':5.5,'sunnybank hills':5.2,'macgregor':5.0,'eight mile plains':5.3,
      'mansfield':5.8,'wishart':5.5,'belmont':5.3,'tingalpa':5.0,'cannon hill':6.5,
      'morningside':6.8,'murarrie':5.8,'hawthorne':7.5,'balmoral':8.0,'bulimba':8.2,
      'new farm':9.0,'newstead':8.5,'teneriffe':9.2,'bowen hills':7.0,'fortitude valley':7.5,
      'spring hill':7.8,'paddington':7.5,'red hill':7.8,'kelvin grove':7.0,'herston':7.5,
      'taringa':7.0,'toowong':7.5,'auchenflower':7.8,'west end':8.5,'south brisbane':8.0,
      'woolloongabba':8.0,'east brisbane':8.2,'coorparoo':7.5,'greenslopes':7.0,'dutton park':7.8,
      'annerley':7.0,'yeronga':6.8,'graceville':7.5,'sherwood':7.0,'corinda':6.5,
      'indooroopilly':7.0,'st lucia':7.5,'fig tree pocket':7.0,'kenmore':6.5,'pullenvale':6.0,
      'chapel hill':6.5,'tarragindi':6.5,'holland park':6.8,'mount gravatt':6.0,'upper mount gravatt':5.8,
      'carindale':5.5,'mount ommaney':6.0,'jindalee':5.8,'westlake':5.5,'seventeen mile rocks':5.5,
      'sinnamon park':6.0,'riverhills':5.3,'middle park':5.5,'darra':4.8,'richlands':4.5,
      'inala':4.2,'durack':4.5,'forest lake':4.8,'ellen grove':4.5,'heathwood':4.8,
      'algester':5.0,'parkinson':5.2,'calamvale':5.5,'drewvale':5.0,'kuraby':5.0,
      'coopers plains':5.5,'acacia ridge':4.5,'pallara':5.2,'willawong':4.8,'larapinta':5.0,
      'springwood':5.0,'slacks creek':4.5,'woodridge':4.0,'logan central':3.8,'loganlea':4.0,
      'meadowbrook':4.5,'marsden':4.5,'kingston':4.0,'waterford west':4.5,'logan reserve':4.8,
      'crestmead':4.5,'berrinba':4.5,'browns plains':4.5,'heritage park':5.0,'regents park':4.8,
      'boronia heights':4.5,'park ridge':5.0,'hillcrest':4.8,'forestdale':4.5,'greenbank':4.8,
      'jimboomba':5.5,'august':5.8,'dakabin':5.0,'mango hill':5.5,'kippa-ring':5.2,
      'redcliffe':5.5,'margate':5.8,'clontarf':5.5,'scarborough':6.0,'woody point':5.8,
      'kallangur':5.0,'murrumba downs':5.2,'griffin':5.5,'narangba':5.2,'caboolture':4.5,
      'morayfield':4.8,'burpengary':4.5,'deception bay':4.5,'north lakes':5.5,'rothwell':5.2,
      'ormiston':6.5,'cleveland':6.8,'thornlands':6.0,'victoria point':6.2,'redland bay':6.0,
      'capalaba':5.8,'alexandra hills':5.5,'wynnum':7.0,'manly':7.5,'lota':6.8,
      'ipswich':5.2,'redbank plains':5.8,'redbank':5.5,'goodna':5.0,'springfield':5.8,
      'springfield lakes':6.0,'collingwood park':5.5,'bellbird park':5.5,'camira':5.8,
      'silkstone':5.2,'leichhardt':5.0,'booval':5.2,'bundamba':5.0,'east ipswich':5.2,
      'north ipswich':5.0,'west ipswich':5.0,'brassall':5.5,'ripley':6.2,'deebing heights':5.8,
      'flinders view':5.5,'brookwater':6.0,'augustine heights':5.8,'raceview':5.2,
      'one mile':5.0,'pine mountain':5.5,'karalee':5.8,'moores pocket':5.0,
      'riverview':5.2,'dinmore':4.8,'gailes':5.0,'blackstone':5.0,'sadliers crossing':5.2,
      'woodend':5.0,'tivoli':5.2,'newtown':5.0,'coalfalls':5.0,'churchill':5.2,
    };

    const key = suburb.toLowerCase().trim();
    const rate = qldGrowthTable[key];

    if(rate){
      document.getElementById('proj-growth').value = rate;
      document.getElementById('proj-growth-lbl').textContent = rate.toFixed(1)+'%';
      if(hint) hint.textContent = `üìç ${suburb} ${state}: ~${rate}% p.a. avg (historical estimate)`;
      drawProjection();
      showToast(`üìà Set growth to ${rate}% for ${suburb}`);
    } else {
      // Try Claude API for unknown suburbs (item 7)
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            model:'claude-sonnet-4-20250514',
            max_tokens:200,
            messages:[{role:'user',content:`What is the typical 5-year average annual capital growth rate (as a single number like 5.2) for residential property in ${suburb}, ${state}, Australia? Reply with only a JSON object like {"rate":5.2,"note":"brief context"} and nothing else.`}]
          })
        });
        const data = await response.json();
        const text = data.content?.find(c=>c.type==='text')?.text||'';
        const match = text.match(/\{[^}]+\}/);
        if(match){
          const parsed = JSON.parse(match[0]);
          const r = Math.min(12, Math.max(1, parseFloat(parsed.rate)||5));
          document.getElementById('proj-growth').value = r;
          document.getElementById('proj-growth-lbl').textContent = r.toFixed(1)+'%';
          if(hint) hint.textContent = `üìç ${suburb}: ~${r}% p.a. ‚Äî ${parsed.note||'AI estimate'}`;
          drawProjection();
          showToast(`üìà Set growth to ${r}% for ${suburb}`);
        } else {
          throw new Error('No rate found');
        }
      } catch(e){
        if(hint) hint.textContent = `No data found for ${suburb}. Try manual entry.`;
        showToast(`‚ö†Ô∏è Could not find data for ${suburb} ‚Äî adjust manually`);
      }
    }
    btn.textContent = 'üîç Look Up Suburb Growth';
    btn.disabled = false;
  }

  // ‚îÄ‚îÄ EXPORT PDF (Fix 2) ‚Äî opens a clean read-only print-optimised view ‚îÄ‚îÄ
  function exportPDF(){
    const addr = document.getElementById('pd-address')?.value || 'Property';
    const suburb = document.getElementById('pd-suburb')?.value || '';
    const stateVal = document.getElementById('pd-state')?.value || '';
    const fullAddr = [addr,suburb,stateVal].filter(Boolean).join(', ') || 'Property Scenario';

    // Gather all display values from current DOM
    const snap = {
      renoOn: renoEnabled,
      rentOn: document.getElementById('rent-sidebar-section')?.style.display !== 'none',
      addr: fullAddr,
      photo: propPhotoDataUrl,
      sub: document.getElementById('header-sub-text')?.textContent || '',
      price: document.getElementById('t-price')?.textContent || '‚Äî',
      deposit: document.getElementById('t-deposit')?.textContent || '‚Äî',
      govt: document.getElementById('t-govt')?.textContent || '‚Äî',
      remaining: document.getElementById('t-remaining')?.textContent || '‚Äî',
      remainingColor: document.getElementById('t-remaining')?.style.color || '',
      savings: document.getElementById('cb-savings')?.textContent || '‚Äî',
      outOfPocket: document.getElementById('cb-out')?.textContent || '‚Äî',
      cashLeft: document.getElementById('cb-remaining')?.textContent || '‚Äî',
      monthly: document.getElementById('rp-monthly')?.textContent || '‚Äî',
      weekly: document.getElementById('rp-weekly')?.textContent || '‚Äî',
      annual: document.getElementById('rp-annual')?.textContent || '‚Äî',
      rateLabel: document.getElementById('rp-rate-lbl')?.textContent || '',
      termLabel: document.getElementById('rp-term-lbl')?.textContent || '',
      loanLabel: document.getElementById('rp-loan-lbl')?.textContent || '',
      totalInterest: document.getElementById('rp-interest')?.textContent || '‚Äî',
      totalPaid: document.getElementById('rp-total-paid')?.textContent || '‚Äî',
      poolVal: document.getElementById('reno-pool-val')?.textContent || '‚Äî',
      unspent: document.getElementById('reno-unspent-val')?.textContent || '‚Äî',
      unspentColor: document.getElementById('reno-unspent-val')?.style.color || 'green',
      renoTotal: document.getElementById('reno-total')?.textContent || '‚Äî',
      renoItems: renoItems.map(r=>({
        icon: r.emoji||'üî®',
        name: r.name||'',
        amt:  fmt(r.amount||0),
        note: r.note||''
      })),
      contingency: fmt(getRenoTotal()*(v('inp-cont')/100)),
      overlapWeekly: document.getElementById('ov-weekly-total')?.textContent || '‚Äî',
      overlapTotal: document.getElementById('ov-total-cost')?.textContent || '‚Äî',
      overlapAfter: document.getElementById('ov-remaining-after')?.textContent || '‚Äî',
      riskScore: document.getElementById('risk-meter')?.style.width || '50%',
      rewardScore: document.getElementById('reward-meter')?.style.width || '50%',
      riskDesc: document.getElementById('risk-desc')?.textContent || '',
      rewardDesc: document.getElementById('reward-desc')?.textContent || '',
      notes: document.getElementById('pd-notes')?.value || '',
      costRows: document.getElementById('cost-rows-display')?.innerHTML || '',
      crDeposit: document.getElementById('cr-deposit')?.textContent || '‚Äî',
      crTotal: document.getElementById('cr-total')?.textContent || '‚Äî',
    };

    const photoHTML = snap.photo
      ? `<img src="${snap.photo}" style="width:100%;height:100%;object-fit:cover;display:block;">`
      : `<div style="width:100%;height:100%;background:#2C2C2E;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.2);font-size:32px;">üè†</div>`;

    const renoRowsHTML = snap.renoItems.map(it=>`
      <tr><td style="padding:7px 10px;border-bottom:1px solid #eee;">${it.icon} ${it.name}</td>
      <td style="padding:7px 10px;border-bottom:1px solid #eee;text-align:right;font-family:monospace;">${it.amt}</td>
      <td style="padding:7px 10px;border-bottom:1px solid #eee;font-size:10px;color:#666;">${it.note}</td></tr>`).join('');

    const html = `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<title>${snap.addr} ‚Äî Finance Scenario</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:#fff;font-family:'DM Sans',sans-serif;color:#1C1C1E;font-size:12px;}
  @page{margin:10mm 12mm;size:A4;}
  @media print{body{font-size:11px;}}
  .page{max-width:900px;margin:0 auto;padding:20px 24px;}
  header{background:#1C1C1E;color:#F5F0E8;padding:0;display:flex;margin-bottom:20px;border-radius:4px;overflow:hidden;}
  .htext{flex:1;padding:20px 24px;}
  .htag{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:#C9A84C;margin-bottom:4px;}
  h1{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;margin-bottom:3px;}
  .hsub{font-size:11px;color:rgba(245,240,232,0.45);margin-bottom:12px;}
  .hstamp{font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.3);}
  .hphoto{width:200px;flex-shrink:0;}
  .section-title{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#888;margin:18px 0 10px;padding-bottom:6px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;}
  .section-title::after{content:'';flex:1;height:1px;background:#eee;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;}
  .card{background:#FAF7F2;border-radius:4px;padding:14px 16px;border:1px solid #eee;}
  .card-accent{width:4px;height:100%;position:absolute;top:0;left:0;border-radius:4px 0 0 4px;}
  .card-rel{position:relative;}
  .kv{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f0f0f0;font-size:11px;}
  .kv:last-child{border-bottom:none;}
  .kv .lbl{color:#666;}
  .kv .val{font-family:'DM Mono',monospace;font-weight:500;}
  .tile{background:#1C1C1E;color:#F5F0E8;border-radius:3px;padding:12px;}
  .tile-val{font-family:'DM Mono',monospace;font-size:22px;margin-bottom:2px;}
  .tile-lbl{font-size:9px;color:rgba(245,240,232,0.5);letter-spacing:1px;text-transform:uppercase;}
  .big-num{font-family:'DM Mono',monospace;font-size:28px;font-weight:500;}
  .meter-wrap{height:8px;background:#eee;border-radius:4px;overflow:hidden;margin:6px 0 4px;}
  .meter-fill{height:100%;border-radius:4px;}
  table{width:100%;border-collapse:collapse;font-size:11px;}
  th{background:#F5F0E8;padding:7px 10px;text-align:left;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#888;}
  th:last-child,td:last-child{text-align:right;}
  .print-btn{position:fixed;top:16px;right:16px;background:#1C1C1E;color:#C9A84C;border:1px solid rgba(201,168,76,0.4);padding:8px 16px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;z-index:100;}
  @media print{.print-btn{display:none;}}


  /* ‚îÄ‚îÄ WELCOME SPLASH ‚îÄ‚îÄ */
  #welcome-splash{position:fixed;inset:0;z-index:8000;background:var(--charcoal);display:flex;align-items:center;justify-content:center;opacity:1;transition:opacity 0.4s;}
  #welcome-splash.hiding{opacity:0;pointer-events:none;}
  .splash-inner{text-align:center;padding:40px 24px;max-width:480px;}
  .splash-logo{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--gold);margin-bottom:20px;opacity:0.7;}
  .splash-title{font-family:'Playfair Display',serif;font-size:36px;font-weight:700;color:var(--cream);line-height:1.2;margin-bottom:10px;}
  .splash-sub{font-size:15px;color:rgba(245,240,232,0.45);margin-bottom:40px;line-height:1.6;}
  .splash-btns{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}
  .splash-btn{padding:14px 28px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;cursor:pointer;transition:transform 0.15s,opacity 0.15s;border:none;}
  .splash-btn:hover{transform:translateY(-2px);opacity:0.9;}
  .splash-btn-primary{background:var(--gold);color:var(--charcoal);font-weight:600;}
  .splash-btn-secondary{background:rgba(255,255,255,0.07);color:var(--cream);border:1px solid rgba(255,255,255,0.18)!important;}
  .splash-deco{width:60px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:0 auto 28px;}
</style>
</head>
<body>
<button class="print-btn" onclick="window.print()">üñ® Print / Save PDF</button>
<div class="page">
  <header>
    <div class="htext">
      <div class="htag">Property Finance Calculator</div>
      <h1>${snap.addr}</h1>
      <div class="hsub">${snap.sub}</div>
      <div class="hstamp">Exported ${(()=>{const n=new Date();return String(n.getDate()).padStart(2,'0')+'/'+String(n.getMonth()+1).padStart(2,'0')+'/'+n.getFullYear();})()}</div>
      ${snap.notes ? `<div style="margin-top:10px;font-size:11px;color:rgba(245,240,232,0.5);font-style:italic;max-width:360px;">"${snap.notes}"</div>` : ''}
    </div>
    <div class="hphoto">${photoHTML}</div>
  </header>

  <div class="section-title">01 ¬∑ Financial Snapshot</div>
  <div class="grid4">
    <div class="tile"><div class="tile-val">${snap.price}</div><div class="tile-lbl">Purchase Price</div></div>
    <div class="tile"><div class="tile-val">${snap.deposit}</div><div class="tile-lbl">Your Deposit</div></div>
    <div class="tile"><div class="tile-val">${snap.govt}</div><div class="tile-lbl">Govt Contribution</div></div>
    <div class="tile"><div class="tile-val" style="color:${snap.remainingColor||'#A8C4B0'}">${snap.remaining}</div><div class="tile-lbl">Remaining Cash</div></div>
  </div>
  <div class="grid2">
    <div class="card card-rel"><div class="card-accent" style="background:#C9A84C;position:absolute;"></div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#C9A84C;margin-bottom:8px;padding-left:10px;">CASH PICTURE</div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Your Savings</span><span class="val">${snap.savings}</span></div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Total Out-of-Pocket</span><span class="val" style="color:#C4704A;">${snap.outOfPocket}</span></div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Remaining Cash</span><span class="val" style="color:#7B9E87;">${snap.cashLeft}</span></div>
    </div>
    <div class="card card-rel"><div class="card-accent" style="background:#5B8FAB;position:absolute;"></div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#5B8FAB;margin-bottom:8px;padding-left:10px;">UPFRONT COSTS</div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Deposit</span><span class="val">${snap.crDeposit}</span></div>
      ${snap.costRows.replace(/<div class="cr">/g,'<div class="kv" style="padding-left:10px;">').replace(/<span class="nm">/g,'<span class="lbl">').replace(/<span class="am">/g,'<span class="val">').replace(/<\/div>/g,'</div>')}
      <div class="kv" style="padding-left:10px;border-top:2px solid #1C1C1E;padding-top:7px;margin-top:5px;"><span class="lbl" style="font-weight:600;">Total Required</span><span class="val" style="font-weight:600;">${snap.crTotal}</span></div>
    </div>
  </div>

  ${snap.renoOn ? `  <div class="section-title">02 ¬∑ Renovation Budget</div>
  <div class="grid2" style="margin-bottom:12px;">
    <div class="card" style="text-align:center;">
      <div style="font-size:9px;font-family:'DM Mono',monospace;letter-spacing:2px;color:#888;margin-bottom:4px;">POOL</div>
      <div class="big-num" style="color:#7B9E87;">${snap.poolVal}</div>
      <div style="font-size:10px;color:#888;margin-top:2px;">Available for reno</div>
      <div style="border-top:1px solid #eee;margin-top:12px;padding-top:12px;">
      <div style="font-size:9px;font-family:'DM Mono',monospace;letter-spacing:2px;color:#888;margin-bottom:4px;">UNSPENT</div>
      <div class="big-num" style="color:${snap.unspentColor};">${snap.unspent}</div>
      <div style="font-size:10px;color:#888;margin-top:2px;">After planned reno</div>
      </div>
    </div>
    <div class="card">
      <table>
        <tr><th>Item</th><th>Cost</th><th style="text-align:left;">Note</th></tr>
        ${renoRowsHTML}
        <tr><td style="padding:7px 10px;border-bottom:1px solid #eee;">‚ö†Ô∏è Contingency</td><td style="padding:7px 10px;border-bottom:1px solid #eee;text-align:right;font-family:monospace;">${snap.contingency}</td><td></td></tr>
        <tr><td style="padding:7px 10px;font-weight:700;">Total</td><td style="padding:7px 10px;text-align:right;font-family:monospace;font-weight:700;">${snap.renoTotal}</td><td></td></tr>
      </table>
    </div>
  </div>
` : ''}
  <div class="section-title">03 ¬∑ Loan Repayments</div>
  <div class="grid2">
    <div class="card">
      <div style="display:flex;gap:16px;">
        <div style="text-align:center;flex:1;"><div class="big-num">${snap.monthly}</div><div style="font-size:10px;color:#888;margin-top:2px;">Monthly</div><div style="font-size:9px;color:#aaa;">${snap.rateLabel}</div></div>
        <div style="text-align:center;flex:1;"><div class="big-num">${snap.weekly}</div><div style="font-size:10px;color:#888;margin-top:2px;">Weekly</div><div style="font-size:9px;color:#aaa;">${snap.termLabel}</div></div>
        <div style="text-align:center;flex:1;"><div class="big-num">${snap.annual}</div><div style="font-size:10px;color:#888;margin-top:2px;">Annual</div><div style="font-size:9px;color:#aaa;">${snap.loanLabel}</div></div>
      </div>
    </div>
    <div class="card">
      <div class="kv"><span class="lbl">Total Interest Paid</span><span class="val" style="color:#C45A5A;">${snap.totalInterest}</span></div>
      <div class="kv"><span class="lbl">Total Amount Paid</span><span class="val">${snap.totalPaid}</span></div>
    </div>
  </div>
  ${snap.rentOn ? `
  <div class="section-title">04 ¬∑ Rent Overlap</div>
  <div class="grid2">
    <div class="card">
      <div class="kv"><span class="lbl">Weekly Combined Cost</span><span class="val">${snap.overlapWeekly}</span></div>
      <div class="kv"><span class="lbl">Total Overlap Cost</span><span class="val" style="color:#C4704A;">${snap.overlapTotal}</span></div>
      <div class="kv"><span class="lbl">Cash Left After Overlap</span><span class="val" style="color:#5A9E7B;">${snap.overlapAfter}</span></div>
    </div>
    <div class="card">
      <div style="font-size:9px;font-family:'DM Mono',monospace;letter-spacing:2px;color:#888;margin-bottom:10px;">RISK ¬∑ REWARD</div>
      <div style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px;"><span>Risk Level</span><span style="font-family:monospace;">${snap.riskScore}</span></div><div class="meter-wrap"><div class="meter-fill" style="width:${snap.riskScore};background:linear-gradient(to right,#C9A84C,#C4704A);"></div></div><div style="font-size:10px;color:#666;">${snap.riskDesc}</div></div>
      <div><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px;"><span>Reward Potential</span><span style="font-family:monospace;">${snap.rewardScore}</span></div><div class="meter-wrap"><div class="meter-fill" style="width:${snap.rewardScore};background:linear-gradient(to right,#7B9E87,#5A9E7B);"></div></div><div style="font-size:10px;color:#666;">${snap.rewardDesc}</div></div>
    </div>
  ` : ''}</div>
</div>
<script>setTimeout(()=>{if(window.matchMedia&&window.matchMedia('print').matches||navigator.userAgent.match(/print/i))window.print();},300);<\/script>
</body></html>`;

    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const win = window.open(url, '_blank');
    if(!win) showToast('‚ö†Ô∏è Popup blocked ‚Äî allow popups for this site');
    setTimeout(()=>URL.revokeObjectURL(url), 60000);
  }

  function setAppHeight(){
    const header = document.querySelector('header');
    const appBody = document.querySelector('.app-body');
    if(header && appBody){
      appBody.style.height = (window.innerHeight - header.offsetHeight) + 'px';
    }
  }
  window.addEventListener('resize', setAppHeight);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROPERTY STATUS (item 2)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function setStatus(status, btn, silent){
    document.getElementById('pd-status').value = status;
    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else{
      const found = document.querySelector(`.status-btn[data-status="${status}"]`);
      if(found) found.classList.add('active');
    }
    const dateWrap = document.getElementById('status-note-wrap');
    if(dateWrap) dateWrap.style.display = ['auction','offered','under-offer','unconditional'].includes(status) ? '' : 'none';
    if(!silent) syncKeyDatesFromStatus();
  }

  function syncKeyDatesFromStatus(){
    const status = document.getElementById('pd-status')?.value;
    const date   = document.getElementById('pd-status-date')?.value;
    if(!date) return;
    const labels = {
      'auction':'üî® Auction Date','offered':'üìù Offer Date',
      'under-offer':'‚è≥ Under Offer Date','unconditional':'‚úÖ Unconditional Date'
    };
    const label = labels[status]; if(!label) return;
    const existing = keyDates.findIndex(d=>d.label===label);
    if(existing>=0) keyDates[existing].date = date;
    else keyDates.push({id:'kd-status-'+Date.now(), date, label});
    renderKeyDates();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // KEY DATES (items 3 & 5)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let keyDates = [];

  function addKeyDate(date='', label=''){
    keyDates.push({id:'kd-'+Date.now(), date, label});
    renderKeyDates();
  }

  function removeKeyDate(id){
    keyDates = keyDates.filter(d=>d.id!==id);
    renderKeyDates();
  }

  function updateKeyDate(id, field, val){
    const d = keyDates.find(x=>x.id===id);
    if(d){ d[field]=val; syncKeyDatesToTimeline(); }
  }

  function formatDate(iso){
    if(!iso) return '';
    const [y,m,d] = iso.split('-');
    if(!d || !m || !y) return iso;
    return `${d}/${m}/${y.slice(-2)}`; // DD/MM/YY
  }
  function fmtDateFull(iso){ // DD/MM/YYYY for timestamps
    if(!iso) return '';
    const [y,m,d] = iso.split('-');
    if(!d || !m || !y) return iso;
    return `${d}/${m}/${y}`;
  }
  function renderKeyDates(){
    const list  = document.getElementById('key-dates-list');
    const empty = document.getElementById('key-dates-empty');
    if(!list) return;
    if(keyDates.length===0){
      list.innerHTML='';
      if(empty) empty.style.display='block';
    } else {
      if(empty) empty.style.display='none';
      list.innerHTML = [...keyDates].sort((a,b)=>(a.date||'').localeCompare(b.date||'')).map(d=>`
        <div class="kd-row">
          <input type="date" value="${d.date||''}" oninput="updateKeyDate('${d.id}','date',this.value)">
          <input type="text" value="${(d.label||'').replace(/"/g,'&quot;')}" placeholder="Event (e.g. Inspection, Auction)" oninput="updateKeyDate('${d.id}','label',this.value)">
          <button class="kd-del" onclick="removeKeyDate('${d.id}')">‚úï</button>
        </div>`).join('');
    }
    syncKeyDatesToTimeline();
  }

  function syncKeyDatesToTimeline(){
    const card = document.getElementById('tl-key-dates-card');
    const list = document.getElementById('tl-key-dates-list');
    if(!card||!list) return;
    const sorted = [...keyDates].filter(d=>d.date||d.label).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
    card.style.display = sorted.length ? '' : 'none';
    const today = new Date().toISOString().split('T')[0];
    const colors = ['var(--sky)','var(--gold)','var(--sage)','var(--terracotta)','var(--terracotta-light)','var(--reward-green)'];
    list.innerHTML = sorted.map((d,i)=>{
      const isPast  = d.date && d.date < today;
      const isToday = d.date === today;
      const fmt = d.date ? formatDate(d.date) : 'No date';
      return `<div class="tli">
        <div class="tld" style="color:${colors[i%colors.length]}"></div>
        <div class="tlp" style="color:${colors[i%colors.length]}">${fmt}${isPast?' ¬∑ past':isToday?' ¬∑ TODAY':''}</div>
        <div class="tlt">${d.label||'Unnamed Event'}</div>
      </div>`;
    }).join('');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // AGENT DETAILS (item 1)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function markAgentDirty(){ updateAgentLinks(); }

  function updateAgentLinks(){
    const phone = document.getElementById('ag-phone')?.value?.trim();
    const email = document.getElementById('ag-email')?.value?.trim();
    const callLink  = document.getElementById('ag-call-link');
    const emailLink = document.getElementById('ag-email-link');
    if(callLink)  { callLink.href  = phone ? `tel:${phone}` : '#';       callLink.style.display  = phone ? '' : 'none'; }
    if(emailLink) { emailLink.href = email ? `mailto:${email}` : '#';    emailLink.style.display = email ? '' : 'none'; }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // COMMUNICATIONS LOG (item 1)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let commsLog = [];
  let commsFormVisible = false;

  function addCommsEntry(){
    if(commsFormVisible){ closeCommsForm(); return; }
    commsFormVisible = true;
    const list = document.getElementById('comms-list');
    const today = new Date().toISOString().split('T')[0];
    const formDiv = document.createElement('div');
    formDiv.id = 'comms-add-form';
    formDiv.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div><div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--slate);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Date</div>
          <input type="date" id="cf-date" value="${today}" style="width:100%;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);padding:7px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;color:var(--charcoal);"></div>
        <div><div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--slate);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Type</div>
          <select id="cf-type" style="width:100%;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);padding:7px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;color:var(--charcoal);">
            <option>üìû Phone call</option><option>‚úâ Email</option><option>üí¨ Text / SMS</option>
            <option>ü§ù In person</option><option>üìã Inspection note</option><option>üìù Other</option>
          </select></div>
      </div>
      <div style="margin-bottom:8px;"><div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--slate);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Note</div>
        <textarea id="cf-text" rows="3" placeholder="What was discussed? Any key info from the agent?" style="width:100%;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);border-radius:3px;padding:8px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--charcoal);resize:vertical;outline:none;line-height:1.5;"></textarea></div>
      <div style="display:flex;gap:8px;">
        <button onclick="submitCommsEntry()" style="flex:1;background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:8px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:0.5px;">Ôºã Add Entry</button>
        <button onclick="closeCommsForm()" style="padding:8px 14px;background:rgba(28,28,30,0.06);border:1px solid rgba(28,28,30,0.12);border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;color:var(--slate);">Cancel</button>
      </div>`;
    if(list) list.insertBefore(formDiv, list.firstChild);
  }

  function closeCommsForm(){
    commsFormVisible = false;
    const f = document.getElementById('comms-add-form');
    if(f) f.remove();
  }

  function submitCommsEntry(){
    const date = document.getElementById('cf-date')?.value||'';
    const type = document.getElementById('cf-type')?.value||'';
    const text = document.getElementById('cf-text')?.value?.trim()||'';
    if(!text){ showToast('‚ö†Ô∏è Add a note before submitting'); return; }
    commsLog.unshift({id:'cm-'+Date.now(), date, type, text});
    closeCommsForm();
    renderCommsLog();
  }

  function deleteCommsEntry(id){
    commsLog = commsLog.filter(c=>c.id!==id);
    renderCommsLog();
  }

  function renderCommsLog(){
    const list  = document.getElementById('comms-list');
    const empty = document.getElementById('comms-empty');
    if(!list) return;
    list.querySelectorAll('.comms-entry').forEach(e=>e.remove());
    if(commsLog.length===0){
      if(empty) empty.style.display='block';
    } else {
      if(empty) empty.style.display='none';
      commsLog.forEach(c=>{
        const fmtDate = c.date ? formatDate(c.date) : '';
        const div = document.createElement('div');
        div.className = 'comms-entry';
        div.innerHTML = `
          <div class="comms-meta">
            <span class="comms-date">${fmtDate}</span>
            <span class="comms-type">${c.type||'Note'}</span>
            <button class="comms-del" onclick="deleteCommsEntry('${c.id}')" title="Delete">‚úï</button>
          </div>
          <div class="comms-text">${c.text.replace(/</g,'&lt;')}</div>`;
        list.appendChild(div);
      });
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MOBILE SIDEBAR TOGGLE (item 4)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function toggleMobileSidebar(){
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('mobile-overlay');
    const isOpen  = sidebar?.classList.contains('mobile-open');
    if(isOpen){
      sidebar?.classList.remove('mobile-open');
      overlay?.classList.remove('open');
    } else {
      sidebar?.classList.add('mobile-open');
      overlay?.classList.add('open');
    }
  }

  // ‚îÄ‚îÄ SEED DEFAULT PURCHASE COSTS (item 14 ‚Äî all costs now dynamic) ‚îÄ‚îÄ
  dynCosts = [
    {id:'dyn-'+dynId++, name:'Bank Fees',      amount:800},
    {id:'dyn-'+dynId++, name:'Conveyancing',   amount:1600},
    {id:'dyn-'+dynId++, name:'Building & Pest',amount:700},
  ];
  renderDynCosts();

  // ‚îÄ‚îÄ SEED DEFAULT RENO ITEMS (item 13 ‚Äî now fully dynamic) ‚îÄ‚îÄ
  const defaultReno = [
    {emoji:'üé®', name:'Paint',       amount:3500, note:''},
    {emoji:'üç≥', name:'Kitchen',     amount:5000, note:''},
    {emoji:'üöø', name:'Bathroom',    amount:4500, note:''},
    {emoji:'ü™µ', name:'Flooring',    amount:4000, note:''},
    {emoji:'üí°', name:'Electrical',  amount:2000, note:''},
    {emoji:'üåø', name:'Landscaping', amount:2000, note:''},
  ];
  defaultReno.forEach(r => renoItems.push({id:'ri-'+renoItemId++, ...r}));
  renderRenoItems();

  var SPLASH_SEEN_KEY = 'propCalc_splash_seen';
  const _hadDraft = restoreDraft();
  recalc();
  updatePropertyDetails();
  updateSavedCount();
  setAppHeight();
  drawProjection();
  loadProfile();
  if(_hadDraft){
    setTimeout(function(){
      var addr = (document.getElementById('pd-address') && document.getElementById('pd-address').value.trim()) || '';
      showToast(addr ? '‚Ü©Ô∏è Restored: ' + addr : '‚Ü©Ô∏è Draft restored');
    }, 600);
  } else if(!lsGet(SPLASH_SEEN_KEY)) {
    setTimeout(showWelcomeSplash, 200);
  } else {
    setTimeout(function(){ showToast('üëã Fill in your property details to get started'); }, 900);
  }


  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // AUTH + PROFILE SYSTEM
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const PROFILE_KEY = 'propCalc_profile_v1';
  const SESSION_KEY = 'propCalc_session_v1';
  let _profileData  = {name:'',email:'',color:'#C9A84C',photo:''};
  let _currentUser  = null; // null=guest, {name,email,id}=logged in

  async function callAuthFn(action, payload){
    try{
      const r = await fetch('/.netlify/functions/auth', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action, ...payload})
      });
      return await r.json();
    } catch(e){ return {ok:false, error:'Network error'}; }
  }

  function loadProfile(){
    try{
      const raw = lsGet(PROFILE_KEY);
      if(raw) _profileData = Object.assign({name:'',email:'',color:'#C9A84C',photo:''}, JSON.parse(raw));
      const sess = lsGet(SESSION_KEY);
      if(sess) _currentUser = JSON.parse(sess);
    } catch(e){}
    renderProfileBtn();
    renderProfilePanel();
  }

  function renderProfileBtn(){
    const btn = document.getElementById('profile-btn');
    if(!btn) return;
    const name  = (_currentUser && _currentUser.name) || _profileData.name || '';
    const color = _profileData.color || '#C9A84C';
    if(_profileData.photo){
      btn.style.background = 'transparent';
      btn.style.padding = '0';
      btn.innerHTML = '<img src="' + _profileData.photo + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    } else {
      const initials = name ? name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2) : 'üë§';
      btn.style.background = color;
      btn.style.padding = '';
      btn.innerHTML = initials;
    }
  }

  function renderProfilePanel(){
    const name  = (_currentUser && _currentUser.name)  || _profileData.name  || '';
    const email = (_currentUser && _currentUser.email) || _profileData.email || '';
    const color = _profileData.color || '#C9A84C';
    const nameD  = document.getElementById('pp-name-display');
    const emailD = document.getElementById('pp-email-display');
    const nameI  = document.getElementById('pp-name-input');
    const emailI = document.getElementById('pp-email-input');
    const avd    = document.getElementById('pp-avatar-display');
    if(nameD)  nameD.textContent  = name  || 'Your Name';
    if(emailD) emailD.textContent = email || (_currentUser ? '' : 'Guest ‚Äî not signed in');
    if(nameI)  nameI.value  = name;
    if(emailI) emailI.value = email;
    if(avd){
      if(_profileData.photo){
        avd.innerHTML = '<img src="' + _profileData.photo + '">';
        avd.style.background = 'transparent';
      } else {
        avd.innerHTML = name ? name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2) : '?';
        avd.style.background = color;
      }
    }
    const signBtn = document.getElementById('pp-signout-btn');
    if(signBtn){
      if(_currentUser){
        signBtn.textContent = 'Sign Out';
        signBtn.onclick = signOut;
      } else {
        signBtn.textContent = 'üîë Sign In / Create Account';
        signBtn.onclick = function(){ closeProfile(); openLoginModal(); };
      }
    }
    const ct   = document.getElementById('saved-count');
    const ppS  = document.getElementById('pp-stat-saved');
    if(ppS) ppS.textContent = (ct && ct.textContent !== '0') ? ct.textContent : '‚Äî';
    const ppL  = document.getElementById('pp-stat-last');
    if(ppL){
      const n = new Date();
      ppL.textContent = String(n.getDate()).padStart(2,'0')+'/'+String(n.getMonth()+1).padStart(2,'0')+'/'+String(n.getFullYear()).slice(-2);
    }
    const ppSt = document.getElementById('pp-stat-storage');
    if(ppSt) ppSt.textContent = _currentUser ? '‚òÅ Cloud account' : (typeof ON_NETLIFY !== 'undefined' && ON_NETLIFY ? '‚òÅ Cloud (guest)' : 'üíæ Local');
    document.querySelectorAll('.pp-color-swatch').forEach(function(el){
      el.classList.toggle('active', el.dataset.color === color);
    });
  }

  function previewProfileName(val){
    const d = document.getElementById('pp-name-display');
    if(d) d.textContent = val || 'Your Name';
    const avd = document.getElementById('pp-avatar-display');
    if(avd && !_profileData.photo){
      avd.innerHTML = val ? val.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2) : '?';
    }
  }

  function setProfileColor(color){
    _profileData.color = color;
    const avd = document.getElementById('pp-avatar-display');
    if(avd && !_profileData.photo) avd.style.background = color;
    document.querySelectorAll('.pp-color-swatch').forEach(function(el){
      el.classList.toggle('active', el.dataset.color === color);
    });
    renderProfileBtn();
  }

  function handleProfilePhoto(input){
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const img = new Image();
      img.onload = function(){
        const c = document.createElement('canvas');
        c.width = 128; c.height = 128;
        c.getContext('2d').drawImage(img,0,0,128,128);
        _profileData.photo = c.toDataURL('image/jpeg',0.85);
        renderProfileBtn(); renderProfilePanel();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function saveProfile(){
    _profileData.name  = (document.getElementById('pp-name-input')  && document.getElementById('pp-name-input').value.trim())  || '';
    _profileData.email = (document.getElementById('pp-email-input') && document.getElementById('pp-email-input').value.trim()) || '';
    lsSet(PROFILE_KEY, JSON.stringify(_profileData));
    renderProfileBtn(); renderProfilePanel();
    closeProfile();
    showToast('‚úì Profile saved');
  }

  function openProfile(){
    renderProfilePanel();
    const panel   = document.getElementById('profile-panel');
    const overlay = document.getElementById('profile-overlay');
    if(panel)   panel.classList.add('open');
    if(overlay) overlay.classList.add('open');
  }
  function closeProfile(){
    const panel   = document.getElementById('profile-panel');
    const overlay = document.getElementById('profile-overlay');
    if(panel)   panel.classList.remove('open');
    if(overlay) overlay.classList.remove('open');
  }

  // ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ
  function openLoginModal(){
    const m = document.getElementById('login-modal');
    if(m) m.classList.add('open');
    const errEls = document.querySelectorAll('.lm-error');
    errEls.forEach(function(e){ e.textContent=''; });
  }
  function closeLoginModal(){
    const m = document.getElementById('login-modal');
    if(m) m.classList.remove('open');
  }

  function setLoginTab(tab){
    document.getElementById('lm-signin-form').style.display = tab==='signin' ? '' : 'none';
    document.getElementById('lm-signup-form').style.display = tab==='signup' ? '' : 'none';
    document.getElementById('lm-tab-signin').classList.toggle('active', tab==='signin');
    document.getElementById('lm-tab-signup').classList.toggle('active', tab==='signup');
  }

  async function handleLogin(){
    const email    = (document.getElementById('lm-email')    && document.getElementById('lm-email').value.trim())    || '';
    const password = (document.getElementById('lm-password') && document.getElementById('lm-password').value)        || '';
    const errEl    = document.getElementById('lm-error');
    const btn      = document.getElementById('lm-submit-btn');
    if(!email || !password){ if(errEl) errEl.textContent='Please enter email and password'; return; }
    if(btn){ btn.disabled=true; btn.textContent='Signing in‚Ä¶'; }
    if(errEl) errEl.textContent='';
    const res = await callAuthFn('signin', {email:email, password:password});
    if(res.ok){
      _currentUser = {id:res.id||email, name:res.name||email.split('@')[0], email:email};
      lsSet(SESSION_KEY, JSON.stringify(_currentUser));
      _profileData.name  = _currentUser.name;
      _profileData.email = email;
      lsSet(PROFILE_KEY, JSON.stringify(_profileData));
      closeLoginModal(); renderProfileBtn(); renderProfilePanel();
      showToast('‚úì Welcome back, ' + _currentUser.name + '!');
    } else {
      // Backend not deployed yet ‚Äî save as local guest profile
      if(res.error && res.error.indexOf('Network') >= 0){
        _profileData.name  = email.split('@')[0];
        _profileData.email = email;
        lsSet(PROFILE_KEY, JSON.stringify(_profileData));
        if(errEl) errEl.textContent = 'Auth backend not configured yet ‚Äî saved locally';
        setTimeout(function(){ closeLoginModal(); renderProfileBtn(); renderProfilePanel(); }, 1400);
      } else {
        if(errEl) errEl.textContent = res.error || 'Sign in failed ‚Äî check your details';
      }
    }
    if(btn){ btn.disabled=false; btn.textContent='Sign In ‚Üí'; }
  }

  async function handleSignup(){
    const name     = (document.getElementById('lm-name')      && document.getElementById('lm-name').value.trim())      || '';
    const email    = (document.getElementById('lm-email2')    && document.getElementById('lm-email2').value.trim())    || '';
    const password = (document.getElementById('lm-password2') && document.getElementById('lm-password2').value)        || '';
    const errEl    = document.getElementById('lm-error2');
    const btn      = document.getElementById('lm-submit-btn2');
    if(!name||!email||!password){ if(errEl) errEl.textContent='Please fill in all fields'; return; }
    if(password.length < 8){ if(errEl) errEl.textContent='Password must be at least 8 characters'; return; }
    if(btn){ btn.disabled=true; btn.textContent='Creating account‚Ä¶'; }
    if(errEl) errEl.textContent='';
    const res = await callAuthFn('signup', {email:email, password:password, name:name});
    if(res.ok){
      _currentUser = {id:res.id||email, name:name, email:email};
      lsSet(SESSION_KEY, JSON.stringify(_currentUser));
      _profileData.name = name; _profileData.email = email;
      lsSet(PROFILE_KEY, JSON.stringify(_profileData));
      closeLoginModal(); renderProfileBtn(); renderProfilePanel();
      showToast('‚úì Account created! Welcome, ' + name);
    } else {
      if(res.error && res.error.indexOf('Network') >= 0){
        _profileData.name = name; _profileData.email = email;
        lsSet(PROFILE_KEY, JSON.stringify(_profileData));
        if(errEl) errEl.textContent = 'Auth backend not deployed yet ‚Äî saved locally';
        setTimeout(function(){ closeLoginModal(); renderProfileBtn(); renderProfilePanel(); }, 1500);
      } else {
        if(errEl) errEl.textContent = res.error || 'Could not create account';
      }
    }
    if(btn){ btn.disabled=false; btn.textContent='Create Account ‚Üí'; }
  }

  function continueAsGuest(){
    closeLoginModal();
    showToast('üëã Continuing as guest ‚Äî data saved locally');
  }

  function signOut(){
    _currentUser = null;
    lsDel(SESSION_KEY);
    closeProfile();
    renderProfileBtn();
    renderProfilePanel();
    showToast('Signed out');
  }

  // ‚îÄ‚îÄ NEW SCENARIO ‚îÄ‚îÄ
  function newScenario(){
    if(_isDirty && !confirm('Start a new scenario? Unsaved changes will be lost.')) return;
    var defaults = {
      'inp-price':'650000','inp-savings':'40000','inp-depp':'2',
      'inp-govt':'28.7','inp-rate':'6.2','inp-term':'30',
      'inp-cont':'15','inp-rent':'450','inp-weeks':'4'
    };
    Object.keys(defaults).forEach(function(id){
      var val = defaults[id];
      var inp = document.getElementById(id);
      var rng = document.getElementById(id.replace('inp-','rng-'));
      if(inp) inp.value = val;
      if(rng) rng.value = val;
      rl(id.replace('inp-',''), parseFloat(val)||0);
    });
    ['pd-address','pd-suburb','pd-state','pd-url','pd-notes','pd-photo-url',
     'ag-agency','ag-name','ag-phone','ag-email','inp-address'].forEach(function(id){
      var el = document.getElementById(id); if(el) el.value='';
    });
    ['pd-bed','pd-bath','pd-car'].forEach(function(id){
      var el = document.getElementById(id); if(el) el.value='0';
    });
    ['pd-land','pd-house','pd-year'].forEach(function(id){
      var el = document.getElementById(id); if(el) el.value='';
    });
    dynCosts=[]; renderDynCosts();
    renoItems=[]; renderRenoItems();
    keyDates=[]; renderKeyDates();
    commsLog=[]; renderCommsLog();
    var browsingBtn = document.querySelector('[data-status="browsing"]');
    if(browsingBtn) setStatus('browsing', browsingBtn);
    clearPropPhoto();
    var houseBtn = document.querySelector('.prop-type-btn');
    if(houseBtn) setPropType(houseBtn,'House');
    _lastSavedAddr = null; _isDirty = false;
    lsDel(DRAFT_KEY);
    var propTabBtn = document.querySelector('.tab[onclick*="property"]');
    if(propTabBtn) showTab('property', propTabBtn);
    updateUnsavedBadge(); recalc();
    showToast('‚ú® New scenario ready');
  }

  // ‚îÄ‚îÄ WELCOME SPLASH ‚îÄ‚îÄ
  function showWelcomeSplash(){
    var splash = document.getElementById('welcome-splash');
    if(splash) splash.style.display = 'flex';
  }
  function hideSplash(){
    var splash = document.getElementById('welcome-splash');
    if(!splash) return;
    splash.classList.add('hiding');
    setTimeout(function(){ splash.style.display='none'; splash.classList.remove('hiding'); }, 420);
    lsSet(SPLASH_SEEN_KEY,'1');
  }
  function splashNewScenario(){ hideSplash(); }
  function splashOpenLibrary(){
    hideSplash();
    setTimeout(openScenariosModal, 300);
  }
</script>

<!-- ‚ïê‚ïê USER PROFILE PANEL ‚ïê‚ïê -->
<div id="profile-overlay" onclick="closeProfile()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:4999;backdrop-filter:blur(2px);"></div>
<div id="profile-panel" style="position:fixed;top:0;right:-340px;width:320px;height:100vh;background:var(--charcoal);z-index:5000;box-shadow:-8px 0 40px rgba(0,0,0,0.5);transition:right 0.3s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;overflow-y:auto;">
  <button class="pp-close" onclick="closeProfile()">‚úï</button>
  <div class="pp-header">
    <div class="pp-avatar-wrap">
      <div class="pp-avatar" id="pp-avatar-display">?</div>
      <label class="pp-avatar-edit" title="Change photo">üì∑<input type="file" accept="image/*" style="display:none" onchange="handleProfilePhoto(this)"></label>
    </div>
    <div class="pp-name" id="pp-name-display">Your Name</div>
    <div class="pp-role">Property Investor</div>
  </div>
  <div class="pp-section">
    <div class="pp-section-title">Profile Details</div>
    <div class="pp-field">
      <label class="pp-label">Display Name</label>
      <input class="pp-input" id="pp-name-input" type="text" placeholder="e.g. Jamie Smith" oninput="previewProfileName(this.value)">
    </div>
    <div class="pp-field">
      <label class="pp-label">Email (for future login)</label>
      <input class="pp-input" id="pp-email-input" type="email" placeholder="you@email.com">
    </div>
  </div>
  <div class="pp-section">
    <div class="pp-section-title">Your Activity</div>
    <div class="pp-stat"><span class="pp-stat-lbl">Properties saved</span><span class="pp-stat-val" id="pp-stat-saved">‚Äî</span></div>
    <div class="pp-stat"><span class="pp-stat-lbl">Last active</span><span class="pp-stat-val" id="pp-stat-last">‚Äî</span></div>
    <div class="pp-stat"><span class="pp-stat-lbl">Storage</span><span class="pp-stat-val" id="pp-stat-storage">Local</span></div>
  </div>
  <div class="pp-section">
    <div class="pp-section-title">Avatar Colour</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button onclick="setProfileColor('#C9A84C')" style="width:28px;height:28px;border-radius:50%;background:#C9A84C;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#5B8FAB')" style="width:28px;height:28px;border-radius:50%;background:#5B8FAB;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#7B9E87')" style="width:28px;height:28px;border-radius:50%;background:#7B9E87;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#C4704A')" style="width:28px;height:28px;border-radius:50%;background:#C4704A;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#9B7EC8')" style="width:28px;height:28px;border-radius:50%;background:#9B7EC8;border:2px solid transparent;cursor:pointer;"></button>
    </div>
  </div>
  <button class="pp-save-btn" onclick="saveProfile()">Save Profile</button>
  <div class="pp-login-note"><strong>Coming soon:</strong> Full login with personal property libraries. For now, profile is saved in your browser.</div>
</div>
<!-- ‚ïê‚ïê WELCOME SPLASH ‚ïê‚ïê -->
<div id="welcome-splash" style="display:none;">
  <div class="splash-inner">
    <div class="splash-logo">Property Finance Calculator</div>
    <div class="splash-title">Where would you<br>like to start?</div>
    <div class="splash-deco"></div>
    <div class="splash-sub">Track, analyse and compare properties<br>with the Shared Equity Scheme</div>
    <div class="splash-btns">
      <button class="splash-btn splash-btn-primary" onclick="splashNewScenario()">Ôºã New Scenario</button>
      <button class="splash-btn splash-btn-secondary" onclick="splashOpenLibrary()">üìÅ My Library</button>
    </div>
    <div style="margin-top:28px;border-top:1px solid rgba(255,255,255,0.08);padding-top:20px;">
      <button onclick="hideSplash();openLoginModal();" style="background:none;border:none;color:rgba(245,240,232,0.35);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;cursor:pointer;text-decoration:underline;">
        Sign in to your account
      </button>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê LOGIN MODAL ‚ïê‚ïê -->
<div id="login-modal">
  <div class="lm-box">
    <div class="lm-header">
      <div class="lm-tag">Property Finance Calculator</div>
      <div class="lm-title" id="lm-title">Sign in to your account</div>
    </div>
    <div class="lm-body">
      <div class="lm-tabs">
        <button class="lm-tab active" onclick="setLoginTab('signin')" id="lm-tab-signin">Sign In</button>
        <button class="lm-tab" onclick="setLoginTab('signup')" id="lm-tab-signup">Create Account</button>
      </div>
      <div id="lm-signin-form">
        <div class="lm-field">
          <label class="lm-label">Email</label>
          <input class="lm-input" id="lm-email" type="email" placeholder="you@email.com" autocomplete="email">
        </div>
        <div class="lm-field">
          <label class="lm-label">Password</label>
          <input class="lm-input" id="lm-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
        <div class="lm-error" id="lm-error"></div>
        <button class="lm-submit" onclick="handleLogin()" id="lm-submit-btn">Sign In ‚Üí</button>
      </div>
      <div id="lm-signup-form" style="display:none;">
        <div class="lm-field">
          <label class="lm-label">Your Name</label>
          <input class="lm-input" id="lm-name" type="text" placeholder="Jamie Smith" autocomplete="name">
        </div>
        <div class="lm-field">
          <label class="lm-label">Email</label>
          <input class="lm-input" id="lm-email2" type="email" placeholder="you@email.com" autocomplete="email">
        </div>
        <div class="lm-field">
          <label class="lm-label">Password</label>
          <input class="lm-input" id="lm-password2" type="password" placeholder="Min 8 characters" autocomplete="new-password">
        </div>
        <div class="lm-error" id="lm-error2"></div>
        <button class="lm-submit" onclick="handleSignup()" id="lm-submit-btn2">Create Account ‚Üí</button>
      </div>
      <div class="lm-divider">or continue without account</div>
      <button class="lm-guest" onclick="continueAsGuest()">Continue as Guest</button>
    </div>
  </div>
</div>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Property Finance Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream:#F5F0E8;--warm-white:#FAF7F2;--charcoal:#1C1C1E;--charcoal-soft:#2C2C2E;
    --slate:#4A4A52;--sage:#7B9E87;--sage-light:#A8C4B0;--terracotta:#C4704A;
    --terracotta-light:#E8A882;--gold:#C9A84C;--sky:#5B8FAB;--risk-red:#C45A5A;--reward-green:#5A9E7B;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--cream);font-family:'DM Sans',sans-serif;color:var(--charcoal);min-height:100vh;overflow-x:hidden;font-size:17px;}

  header{background:var(--charcoal);color:var(--cream);padding:0;position:relative;overflow:hidden;}
  header::before{content:'';position:absolute;top:-60px;left:-40px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(201,168,76,0.12) 0%,transparent 70%);pointer-events:none;}
  .header-inner{display:flex;align-items:stretch;min-height:150px;}
  .header-text{flex:1;padding:28px 36px;display:flex;flex-direction:column;justify-content:center;position:relative;z-index:1;}
  .header-tag{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:6px;}
  h1{font-family:'Playfair Display',serif;font-size:clamp(24px,3.5vw,40px);font-weight:900;line-height:1.1;margin-bottom:4px;}
  .header-sub{font-size:13px;color:rgba(245,240,232,0.45);font-weight:300;margin-bottom:14px;}
  .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .header-badge{background:var(--gold);color:var(--charcoal);font-family:'DM Mono',monospace;font-size:12px;font-weight:500;letter-spacing:1px;padding:5px 12px;border-radius:2px;}
  .export-btn{display:flex;align-items:center;gap:6px;padding:6px 13px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.18);border-radius:2px;font-family:'DM Mono',monospace;font-size:12px;color:var(--cream);cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
  .export-btn:hover{background:rgba(255,255,255,0.18);border-color:rgba(255,255,255,0.35);}
  .header-photo-wrap{width:280px;flex-shrink:0;position:relative;overflow:hidden;}
  .header-photo{width:100%;height:100%;object-fit:cover;display:block;opacity:0.88;}
  .photo-caption{position:absolute;bottom:0;left:0;right:0;padding:6px 10px;background:linear-gradient(transparent,rgba(0,0,0,0.65));font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.7);}
  .upload-zone{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04);border-left:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:background 0.2s;text-align:center;}
  .upload-zone:hover,.upload-zone.drag-over{background:rgba(201,168,76,0.13);border-left-color:rgba(201,168,76,0.5);}
  .upload-inner{padding:16px;}
  /* ‚îÄ‚îÄ PROPERTY DETAILS TAB ‚îÄ‚îÄ */
  .pd-field{display:flex;flex-direction:column;gap:4px;}
  .pd-label{font-size:12px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:0.5px;text-transform:uppercase;}
  .pd-field input[type="text"],.pd-field input[type="number"]{background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);color:var(--charcoal);padding:9px 11px;font-size:14px;}
  .pd-field input[type="text"]:focus,.pd-field input[type="number"]:focus{border-color:var(--gold);background:white;}
  .pd-stepper{display:flex;align-items:center;gap:0;}
  .pd-stepper button{width:34px;height:36px;background:rgba(28,28,30,0.07);border:1px solid rgba(28,28,30,0.12);color:var(--charcoal);font-size:17px;cursor:pointer;transition:background 0.15s;flex-shrink:0;}
  .pd-stepper button:first-child{border-radius:3px 0 0 3px;}
  .pd-stepper button:last-child{border-radius:0 3px 3px 0;}
  .pd-stepper button:hover{background:rgba(201,168,76,0.15);}
  .pd-stepper input{flex:1;text-align:center;border-left:none;border-right:none;border-radius:0;padding:8px 4px;}
  .prop-type-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px;}
  .prop-type-btn{padding:11px 8px;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.1);border-radius:3px;font-size:13px;cursor:pointer;transition:all 0.2s;color:var(--slate);}
  .prop-type-btn:hover{background:rgba(201,168,76,0.1);border-color:var(--gold);color:var(--charcoal);}
  .prop-type-btn.active{background:rgba(201,168,76,0.15);border-color:var(--gold);color:var(--charcoal);font-weight:500;}
  .pd-stat-chip{display:inline-flex;align-items:center;gap:5px;font-family:'DM Mono',monospace;font-size:12px;color:rgba(245,240,232,0.6);background:rgba(255,255,255,0.08);padding:4px 10px;border-radius:12px;}
  #prop-photo-big-wrap.pd-drag{outline:2px dashed var(--gold);}
  @media print{
    *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
    @page{margin:8mm 10mm;size:A4;}

    body{background:#fff!important;font-size:10px!important;line-height:1.4!important;}

    /* Hide chrome */
    .sidebar{display:none!important;}
    .export-btn,.header-badge,.header-actions button,#saved-btn,nav,#scenarios-modal,#confirm-modal{display:none!important;}

    /* Compact header */
    header{min-height:auto!important;break-inside:avoid;}
    .header-inner{min-height:60px!important;}
    .header-text{padding:10px 16px!important;}
    h1{font-size:18px!important;margin-bottom:2px!important;}
    .header-sub{font-size:10px!important;margin-bottom:6px!important;}
    .header-photo-wrap{width:140px!important;}
    .header-actions{margin-top:0!important;}

    /* Layout */
    .app-body{display:block!important;height:auto!important;overflow:visible!important;}
    .content{overflow:visible!important;height:auto!important;display:block!important;}
    main{padding:8px 12px!important;overflow:visible!important;}

    /* Show all tabs at once, each starting on new page except property tab */
    .section{display:block!important;animation:none!important;}
    #property{page-break-after:avoid;}
    #costs,#reno,#repay,#overlap,#time,#risks{page-break-before:always;}

    /* Cards: tight, no breaks inside */
    .card{break-inside:avoid!important;page-break-inside:avoid!important;margin-bottom:6px!important;padding:10px 12px!important;border:1px solid #ddd!important;}
    h3{font-size:12px!important;margin-bottom:6px!important;}
    .sl{margin-bottom:8px!important;font-size:9px!important;}
    .section-label{margin-bottom:8px!important;}

    /* Grids: use 2-col side by side */
    .g2{grid-template-columns:1fr 1fr!important;gap:6px!important;}
    .g2 > .card{margin-bottom:0!important;}

    /* Summary tiles: 4 across */
    .tiles{grid-template-columns:repeat(4,1fr)!important;gap:5px!important;margin-bottom:6px!important;}
    .tile{padding:8px 10px!important;}
    .tile-val{font-size:13px!important;}
    .tile-lbl{font-size:9px!important;}
    .tile-dot{margin-bottom:5px!important;width:12px!important;height:2px!important;}

    /* Cash banner */
    .cb{padding:8px 12px!important;margin-bottom:6px!important;flex-wrap:nowrap!important;}
    .cv{font-size:13px!important;}
    .clbl{font-size:8px!important;}

    /* Repayment grid */
    .rg{grid-template-columns:repeat(3,1fr)!important;gap:5px!important;margin-top:6px!important;}
    .rc{padding:7px 8px!important;}
    .rv{font-size:13px!important;}
    .rl,.rs{font-size:8px!important;}

    /* Overlap tiles */
    .overlap-tiles{grid-template-columns:repeat(3,1fr)!important;gap:5px!important;margin-bottom:6px!important;}

    /* Hide heavy visuals that don't print well */
    #cal-grid{display:none!important;}
    #overlap-scenarios{font-size:9px!important;}

    /* Reno notes: show them */
    .reno-note-wrap{padding:2px 0 4px 24px!important;}
    .reno-note{border:none!important;background:none!important;resize:none!important;font-size:9px!important;color:#555!important;padding:0!important;min-height:auto!important;}

    /* Risk/reward */
    .rr-grid{grid-template-columns:1fr 1fr!important;gap:10px!important;}
    .mt{height:6px!important;margin-bottom:6px!important;}

    /* Stress table */
    #stress-table{font-size:9px!important;}

    /* Donut */
    .dw{flex-wrap:nowrap!important;}

    /* Timeline compact */
    .tl-item,.tli{margin-bottom:10px!important;}
    .tl-desc,.tldesc{font-size:9px!important;}

    /* Property tab: show 2-col */
    #property .g2{grid-template-columns:200px 1fr!important;}
    #prop-photo-big-wrap{min-height:160px!important;}
    .prop-type-grid{grid-template-columns:repeat(4,1fr)!important;}
    #pd-notes{height:50px!important;font-size:9px!important;}
    #pd-preview-stats{display:none!important;}

    /* Bar charts */
    .bi{margin-bottom:5px!important;}
    .bm{font-size:9px!important;}
    .bt{height:4px!important;}

    /* Donut SVG */
    .dw svg{width:80px!important;height:80px!important;}
  }



  .app-body{display:grid;grid-template-columns:340px 1fr;overflow:hidden;height:calc(100vh - 150px - 44px);}

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar{background:var(--charcoal-soft);color:var(--cream);padding:24px 20px;overflow-y:auto;border-right:1px solid rgba(255,255,255,0.05);height:100%;}
  
  .sidebar-title{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.08);}
  .s-head{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(245,240,232,0.28);margin-bottom:10px;}
  .ig{margin-bottom:12px;}
  .il{font-size:14px;color:rgba(245,240,232,0.48);margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;}
  .il span{font-family:'DM Mono',monospace;color:var(--gold);font-size:14px;}
  .iw{position:relative;}
  .ipfx{position:absolute;left:9px;top:50%;transform:translateY(-50%);font-family:'DM Mono',monospace;font-size:13px;color:rgba(245,240,232,0.3);pointer-events:none;}
  .isfx{position:absolute;right:9px;top:50%;transform:translateY(-50%);font-family:'DM Mono',monospace;font-size:12px;color:rgba(245,240,232,0.3);pointer-events:none;}
  input[type="number"],input[type="text"]{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:10px 8px 10px 26px;font-family:'DM Mono',monospace;font-size:15px;color:var(--cream);outline:none;transition:border-color 0.2s;-moz-appearance:textfield;}
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;}
  input[type="number"]:focus,input[type="text"]:focus{border-color:var(--gold);}
  input.pct{padding-left:8px;padding-right:24px;}
  input[type="range"]{width:100%;accent-color:var(--gold);cursor:pointer;margin-top:4px;}
  hr.div{border:none;border-top:1px solid rgba(255,255,255,0.07);margin:14px 0;}

  .preset-bar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:14px;}
  .preset-btn{padding:6px 10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:2px;font-family:'DM Mono',monospace;font-size:11px;color:rgba(245,240,232,0.5);cursor:pointer;transition:all 0.2s;white-space:nowrap;}
  .preset-btn:hover{background:rgba(201,168,76,0.15);border-color:var(--gold);color:var(--gold);}

  /* dynamic cost items */
  .cost-items-list{margin-bottom:8px;}
  .dyn-cost-row{display:flex;gap:5px;align-items:center;margin-bottom:6px;}
  .dyn-cost-row input[type="text"]{flex:1.4;padding:7px 7px;}
  .dyn-cost-row input[type="number"]{flex:1;padding:7px 7px 7px 20px;}
  .dyn-del{width:24px;height:24px;border-radius:2px;background:rgba(196,90,90,0.2);border:1px solid rgba(196,90,90,0.3);color:var(--terracotta-light);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;}
  .dyn-del:hover{background:rgba(196,90,90,0.4);}
  .add-cost-btn{display:flex;align-items:center;gap:6px;padding:7px 10px;background:rgba(201,168,76,0.1);border:1px dashed rgba(201,168,76,0.3);border-radius:3px;font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);cursor:pointer;transition:all 0.2s;width:100%;}
  .add-cost-btn:hover{background:rgba(201,168,76,0.2);}

  .alert{padding:10px 12px;border-radius:3px;font-size:14px;line-height:1.5;margin-top:12px;}
  .alert-warn{background:rgba(196,112,74,0.15);border:1px solid rgba(196,112,74,0.3);color:var(--terracotta-light);}
  .alert-ok{background:rgba(90,158,123,0.15);border:1px solid rgba(90,158,123,0.3);color:var(--sage-light);}

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .content{overflow:hidden;display:flex;flex-direction:column;height:100%;}
  nav{background:var(--charcoal);display:flex;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;}
  nav::-webkit-scrollbar{display:none;}
  .tab{flex:1;min-width:110px;padding:14px 10px;font-family:'DM Mono',monospace;font-size:14px;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;color:rgba(245,240,232,0.4);cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s;text-align:center;white-space:nowrap;border:none;background:none;}
  .tab:hover{color:rgba(245,240,232,0.85);}
  .tab.active{color:var(--gold);border-bottom:3px solid var(--gold);}

  main{padding:26px 32px;flex:1;overflow-y:auto;}
  .section{display:none;animation:fadeUp 0.3s ease;}
  .section.active{display:block;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .spinner{display:inline-block;flex-shrink:0;width:18px;height:18px;border-radius:50%;border:2.5px solid rgba(201,168,76,0.25);border-top-color:var(--gold);-webkit-animation:spin 0.75s linear infinite;animation:spin 0.75s linear infinite;}
  .spinner-sm{display:inline-block;vertical-align:middle;width:13px;height:13px;border-radius:50%;border:2px solid rgba(255,255,255,0.25);border-top-color:#fff;-webkit-animation:spin 0.75s linear infinite;animation:spin 0.75s linear infinite;}

  .sl{font-family:'DM Mono',monospace;font-size:13px;letter-spacing:3px;text-transform:uppercase;color:var(--slate);margin-bottom:20px;display:flex;align-items:center;gap:12px;}
  .sl::after{content:'';flex:1;height:1px;background:rgba(28,28,30,0.12);}
  .card{background:var(--warm-white);border-radius:4px;padding:26px;border:1px solid rgba(28,28,30,0.08);position:relative;margin-bottom:18px;font-size:15px;}
  .ca{position:absolute;top:0;left:0;width:4px;height:100%;border-radius:4px 0 0 4px;}
  .g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  h3{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;margin-bottom:16px;}

  .tiles{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
  .tile{background:var(--charcoal);color:var(--cream);border-radius:4px;padding:18px;position:relative;overflow:hidden;}
  .tile::after{content:'';position:absolute;bottom:-14px;right:-14px;width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.04);}
  .tile-val{font-family:'DM Mono',monospace;font-size:26px;font-weight:500;margin-bottom:3px;}
  .tile-lbl{font-size:13px;color:rgba(245,240,232,0.38);}
  .tile-dot{width:16px;height:3px;border-radius:2px;margin-bottom:9px;}

  .cr{display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid rgba(28,28,30,0.07);font-size:16px;}
  .cr .nm{color:var(--slate);}
  .cr .am{font-family:'DM Mono',monospace;font-size:16px;}
  .cr.tot{border-top:2px solid var(--charcoal);border-bottom:none;margin-top:4px;padding-top:10px;}
  .cr.tot .nm{color:var(--charcoal);font-weight:500;}

  .bi{margin-bottom:10px;}
  .bm{display:flex;justify-content:space-between;font-size:15px;margin-bottom:4px;color:var(--slate);}
  .bm span:last-child{font-family:'DM Mono',monospace;color:var(--charcoal);}
  .bt{height:6px;background:rgba(28,28,30,0.08);border-radius:3px;overflow:hidden;}
  .bf{height:100%;border-radius:3px;transition:width 0.6s cubic-bezier(0.16,1,0.3,1);}

  .dw{display:flex;align-items:center;gap:18px;flex-wrap:wrap;}
  .li{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:16px;}
  .ld{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .lv{font-family:'DM Mono',monospace;font-size:15px;margin-left:auto;padding-left:12px;color:var(--slate);}

  .cb{background:var(--charcoal);color:var(--cream);border-radius:4px;padding:18px 22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:14px;}
  .cs{text-align:center;}
  .cv{font-family:'DM Mono',monospace;font-size:30px;}
  .clbl{font-size:13px;color:rgba(245,240,232,0.38);margin-top:2px;}

  .rg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;}
  .rc{background:var(--charcoal);color:var(--cream);border-radius:3px;padding:13px;text-align:center;}
  .rv{font-family:'DM Mono',monospace;font-size:22px;margin-bottom:2px;}
  .rl{font-size:12px;color:rgba(245,240,232,0.38);}
  .rs{font-size:12px;color:var(--gold);margin-top:1px;font-family:'DM Mono',monospace;}

  .reno-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid rgba(28,28,30,0.06);gap:10px;font-size:16px;}
  .ri{font-size:15px;width:20px;text-align:center;}
  .rn{flex:1;color:var(--slate);}
  .ra{font-family:'DM Mono',monospace;font-size:13px;min-width:52px;text-align:right;}
  .rbt{flex:1;max-width:66px;height:4px;background:rgba(28,28,30,0.08);border-radius:2px;overflow:hidden;}
  .rbf{height:100%;border-radius:2px;background:var(--sage);transition:width 0.5s;}
  .reno-note-wrap{padding:0 0 8px 27px;border-bottom:1px dashed rgba(28,28,30,0.1);}
  .reno-note{width:100%;background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.08);border-radius:3px;padding:6px 8px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--slate);resize:none;outline:none;line-height:1.5;min-height:28px;max-height:80px;overflow-y:auto;transition:border-color 0.2s,min-height 0.2s;}
  .reno-note:focus{border-color:var(--sage);background:white;min-height:48px;}
  .reno-note::placeholder{color:rgba(74,74,82,0.4);font-style:italic;}

  .tl{position:relative;padding-left:24px;}
  .tl::before{content:'';position:absolute;left:6px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,var(--gold),var(--sage));}
  .tli{position:relative;margin-bottom:20px;}
  .tld{position:absolute;left:-20px;top:4px;width:9px;height:9px;border-radius:50%;border:2px solid var(--warm-white);box-shadow:0 0 0 2px currentColor;}
  .tlp{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;}
  .tlt{font-size:17px;font-weight:500;margin-bottom:2px;}
  .tldesc{font-size:12px;color:var(--slate);line-height:1.6;}
  .tldr{display:inline-block;background:var(--charcoal);color:var(--cream);font-family:'DM Mono',monospace;font-size:10px;padding:2px 7px;border-radius:2px;margin-top:4px;}

  .rr-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
  .rri{display:flex;align-items:flex-start;gap:9px;padding:10px 0;border-bottom:1px solid rgba(28,28,30,0.07);font-size:12px;line-height:1.6;}
  .rric{width:25px;height:25px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
  .risk .rric{background:rgba(196,90,90,0.1);}
  .reward .rric{background:rgba(90,158,123,0.1);}
  .rrt{font-weight:500;margin-bottom:1px;font-size:13px;}
  .rrb{color:var(--slate);}
  .mt{height:8px;background:rgba(28,28,30,0.08);border-radius:4px;overflow:hidden;margin-bottom:9px;}
  .mf{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1);}

  /* ‚îÄ‚îÄ RENT OVERLAP TAB ‚îÄ‚îÄ */
  .overlap-tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
  .week-slider-wrap{margin:16px 0;}
  .week-slider-wrap label{font-family:'DM Mono',monospace;font-size:11px;color:var(--slate);display:flex;justify-content:space-between;margin-bottom:6px;}
  .week-slider-wrap label span{color:var(--gold);font-weight:500;}
  .dual-breakdown{display:flex;flex-direction:column;gap:0;}
  .dual-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(28,28,30,0.07);font-size:12px;}
  .dual-row .dnm{color:var(--slate);}
  .dual-row .dam{font-family:'DM Mono',monospace;font-size:12px;}
  .dual-row.dtot{border-top:2px solid var(--charcoal);border-bottom:none;margin-top:4px;padding-top:10px;}
  .dual-row.dtot .dnm{font-weight:600;color:var(--charcoal);}
  .overlap-visual{display:flex;gap:0;border-radius:4px;overflow:hidden;height:36px;margin:16px 0;}
  .ov-seg{display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;transition:flex 0.5s;}
  .calendar-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;margin-top:12px;}
  .cal-cell{border-radius:2px;padding:6px 4px;text-align:center;font-family:'DM Mono',monospace;font-size:9px;font-weight:500;}
  .cal-header{font-size:9px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;text-align:center;padding:4px;}
  .cal-both{background:var(--terracotta);color:white;}
  .cal-mortgage{background:var(--sky);color:white;}
  .cal-free{background:rgba(28,28,30,0.06);color:var(--slate);}

  /* ‚îÄ‚îÄ LIBRARY FILTER BUTTONS ‚îÄ‚îÄ */
  .lib-filter{padding:4px 10px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);border-radius:12px;font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.5);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
  .lib-filter:hover{background:rgba(255,255,255,0.12);color:rgba(245,240,232,0.8);}
  .lib-filter.active{background:rgba(201,168,76,0.2);border-color:var(--gold);color:var(--gold);}
  /* ‚îÄ‚îÄ LIBRARY LIST ROW ‚îÄ‚îÄ */
  .lib-row{display:flex;align-items:center;gap:14px;padding:13px 14px;background:white;border:1px solid rgba(28,28,30,0.08);border-radius:5px;margin-bottom:8px;cursor:pointer;transition:all 0.15s;}
  .lib-row:hover{box-shadow:0 3px 14px rgba(0,0,0,0.1);border-color:rgba(28,28,30,0.16);transform:translateY(-1px);}
  .lib-thumb{width:62px;height:62px;border-radius:4px;flex-shrink:0;background:var(--charcoal-soft);display:flex;align-items:center;justify-content:center;font-size:26px;overflow:hidden;}
  .lib-thumb img{width:100%;height:100%;object-fit:cover;}
  .lib-info{flex:1;min-width:0;}
  .lib-info{flex:1;min-width:0;}
  .lib-addr{font-family:'Playfair Display',serif;font-size:15px;font-weight:700;color:var(--charcoal);margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .lib-meta{font-size:12px;color:var(--slate);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .lib-price{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--sage);flex-shrink:0;}
  .lib-meta{font-size:12px;color:var(--slate);}
  .lib-price{font-family:'DM Mono',monospace;font-size:16px;font-weight:600;color:var(--sage);flex-shrink:0;}
  .lib-ts{font-family:'DM Mono',monospace;font-size:10px;color:rgba(28,28,30,0.3);flex-shrink:0;}
  .lib-del{background:none;border:none;color:rgba(196,90,90,0.4);cursor:pointer;font-size:16px;padding:4px 6px;flex-shrink:0;line-height:1;border-radius:3px;transition:all 0.15s;}
  .lib-del:hover{color:var(--risk-red);background:rgba(196,90,90,0.1);}
  .lib-badge{font-family:'DM Mono',monospace;font-size:10px;padding:3px 9px;border-radius:10px;flex-shrink:0;white-space:nowrap;}
  .lib-del{background:none;border:none;color:rgba(196,90,90,0.4);cursor:pointer;font-size:16px;padding:4px;flex-shrink:0;}
  .lib-del:hover{color:var(--risk-red);}
  .lib-ts{font-family:'DM Mono',monospace;font-size:10px;color:rgba(28,28,30,0.3);flex-shrink:0;white-space:nowrap;}

  /* ‚îÄ‚îÄ STATUS BADGES (item 2) ‚îÄ‚îÄ */
  .status-btn{padding:7px 12px;border-radius:20px;border:2px solid rgba(28,28,30,0.12);background:rgba(28,28,30,0.04);font-size:12px;cursor:pointer;transition:all 0.2s;color:var(--slate);font-family:'DM Sans',sans-serif;}
  .status-btn:hover{border-color:var(--gold);color:var(--charcoal);}
  .status-btn.active[data-status="browsing"]{background:rgba(91,143,171,0.15);border-color:var(--sky);color:var(--sky);}
  .status-btn.active[data-status="auction"]{background:rgba(196,112,74,0.15);border-color:var(--terracotta);color:var(--terracotta);}
  .status-btn.active[data-status="for-sale"]{background:rgba(201,168,76,0.15);border-color:var(--gold);color:var(--gold);}
  .status-btn.active[data-status="offered"]{background:rgba(123,158,135,0.2);border-color:var(--sage);color:var(--sage);}
  .status-btn.active[data-status="under-offer"]{background:rgba(232,168,130,0.2);border-color:var(--terracotta-light);color:var(--terracotta);}
  .status-btn.active[data-status="unconditional"]{background:rgba(90,158,123,0.2);border-color:var(--reward-green);color:var(--reward-green);}
  .status-btn.active[data-status="sold"]{background:rgba(196,90,90,0.12);border-color:var(--risk-red);color:var(--risk-red);}

  /* ‚îÄ‚îÄ KEY DATES (item 3) ‚îÄ‚îÄ */
  .kd-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px dashed rgba(28,28,30,0.1);}
  .kd-row input[type="date"]{background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.1);border-radius:3px;padding:5px 8px;font-family:'DM Mono',monospace;font-size:11px;color:var(--charcoal);}
  .kd-row input[type="text"]{flex:1;background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.1);border-radius:3px;padding:5px 8px;font-size:12px;color:var(--charcoal);}
  .kd-row input[type="date"]:focus,.kd-row input[type="text"]:focus{border-color:var(--sky);outline:none;background:white;}
  .kd-del{background:none;border:none;color:rgba(196,90,90,0.5);cursor:pointer;font-size:15px;padding:0 4px;flex-shrink:0;}
  .kd-del:hover{color:var(--risk-red);}

  /* ‚îÄ‚îÄ COMMS LOG (item 1) ‚îÄ‚îÄ */
  .comms-entry{padding:10px 0;border-bottom:1px solid rgba(28,28,30,0.07);}
  .comms-entry:last-child{border-bottom:none;}
  .comms-meta{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
  .comms-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--slate);}
  .comms-type{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;background:rgba(28,28,30,0.08);padding:2px 7px;border-radius:10px;color:var(--slate);}
  .comms-del{background:none;border:none;color:rgba(196,90,90,0.4);cursor:pointer;font-size:13px;margin-left:auto;padding:0 2px;}
  .comms-text{font-size:12px;color:var(--charcoal);line-height:1.6;}

  /* ‚îÄ‚îÄ COMMS ADD FORM ‚îÄ‚îÄ */
  #comms-add-form{background:rgba(28,28,30,0.04);border-radius:4px;padding:12px;border:1px solid rgba(28,28,30,0.1);margin-top:10px;}

  /* ‚îÄ‚îÄ ADDRESS AUTOCOMPLETE ‚îÄ‚îÄ */
  .addr-wrap{position:relative;}
  .addr-suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid rgba(28,28,30,0.15);border-radius:0 0 4px 4px;box-shadow:0 4px 16px rgba(0,0,0,0.1);z-index:500;max-height:220px;overflow-y:auto;display:none;}
  .addr-suggestion{padding:9px 12px;font-size:13px;color:var(--charcoal);cursor:pointer;border-bottom:1px solid rgba(28,28,30,0.06);line-height:1.4;}
  .addr-suggestion:last-child{border-bottom:none;}
  .addr-suggestion:hover{background:rgba(201,168,76,0.08);}
  .addr-suggestion strong{color:var(--charcoal);font-weight:600;}
  .addr-suggestion span{font-size:11px;color:var(--slate);}

  /* ‚îÄ‚îÄ MOBILE OVERHAUL ‚îÄ‚îÄ */
  @media(max-width:600px){
    /* Sidebar */
    #sidebar-close-btn{display:block!important;}
    .sidebar{display:none;position:fixed;inset:0;z-index:200;overflow-y:auto;border-radius:0;}
    .sidebar.mobile-open{display:block!important;}
    #mobile-sidebar-btn{display:flex!important;}

    /* Header ‚Äî compact but clear */
    header{position:sticky;top:0;z-index:100;}
    .header-inner{min-height:auto!important;flex-wrap:wrap;}
    .header-text{padding:10px 14px!important;flex:1 1 100%;}
    h1{font-size:17px!important;line-height:1.2!important;}
    #header-status-badge{font-size:10px!important;}
    .header-sub{font-size:11px!important;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100vw - 28px);}
    .header-actions{gap:5px!important;flex-wrap:nowrap!important;overflow-x:auto;}
    .export-btn{padding:5px 8px!important;font-size:10px!important;white-space:nowrap;flex-shrink:0;}
    .header-badge{font-size:10px!important;padding:4px 8px!important;}
    .header-photo-wrap{display:none!important;}

    /* Layout */
    .app-body{grid-template-columns:1fr!important;height:auto!important;overflow:visible!important;}
    .content{height:auto!important;overflow:visible!important;display:flex;flex-direction:column;}
    body{overflow-x:hidden;}

    /* Tabs ‚Äî scrollable row */
    nav{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap!important;padding-bottom:1px;}
    .tab{padding:12px 14px!important;font-size:12px!important;white-space:nowrap!important;flex-shrink:0!important;min-width:auto!important;}

    /* Main content */
    main{padding:14px 12px!important;overflow:visible!important;flex:1;}
    .g2{grid-template-columns:1fr!important;gap:10px!important;}
    .rr-grid{grid-template-columns:1fr!important;}
    .tiles{grid-template-columns:1fr 1fr!important;gap:8px!important;}
    .rg{grid-template-columns:1fr 1fr!important;}
    .overlap-tiles{grid-template-columns:1fr 1fr!important;}
    .prop-type-grid{grid-template-columns:1fr 1fr!important;}
    .proj-controls{flex-direction:column!important;gap:10px!important;}
    .card{padding:14px 12px!important;margin-bottom:10px!important;}
    h3{font-size:17px!important;}
    .sl{font-size:11px!important;letter-spacing:2px!important;}

    /* Inputs ‚Äî 16px prevents iOS zoom-in on focus */
    input[type="number"],input[type="text"],input[type="date"],textarea,select{font-size:16px!important;}
    input[type="number"],input[type="text"]{padding:12px 8px 12px 26px!important;}
    input[type="range"]{height:28px!important;margin-top:6px!important;}
    .il{font-size:15px!important;}
    .il span{font-size:15px!important;}
    .dyn-cost-row input{font-size:14px!important;}

    /* Status buttons ‚Äî wrap nicely */
    .status-btn{font-size:11px!important;padding:6px 10px!important;}

    /* Tiles */
    .tile{padding:14px 12px!important;}
    .tile-val{font-size:22px!important;}
    .tile-lbl{font-size:12px!important;}

    /* Cost/list rows */
    .cr{font-size:14px!important;padding:10px 0!important;}
    .cr .am{font-size:14px!important;}
    .li{font-size:14px!important;}
    .bm{font-size:13px!important;}

    /* Library modal full screen */
    #scenarios-modal > div{width:100%!important;max-height:100%!important;top:0!important;left:0!important;transform:none!important;border-radius:0!important;height:100%!important;}
    .lib-row{padding:14px 12px!important;}
    .lib-addr{font-size:15px!important;line-height:1.3!important;}
    .lib-meta{font-size:12px!important;}
    .lib-ts{display:none!important;}
    .lib-price{font-size:15px!important;}

    /* Address suggestions */
    .addr-suggestion{padding:12px!important;font-size:15px!important;}
    .addr-suggestions{z-index:600;}

    /* Timeline */
    .tlt{font-size:15px!important;}
    .tl-date,.tldesc{font-size:13px!important;}

    /* Charts ‚Äî allow horizontal scroll */
    .chart-wrap{overflow-x:auto!important;-webkit-overflow-scrolling:touch!important;}
    #proj-svg-wrap,#projection-chart{min-width:320px;}
  }
  #mobile-sidebar-btn{display:none;align-items:center;justify-content:center;width:36px;height:36px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.18);border-radius:3px;color:var(--cream);cursor:pointer;font-size:16px;flex-shrink:0;}
  #mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:190;}
  #mobile-overlay.open{display:block;}

  @media(max-width:820px){
    .app-body{grid-template-columns:1fr;height:auto!important;}
    .sidebar{height:auto;overflow-y:auto;}
    .header-photo-wrap{width:120px;}
    h1{font-size:20px;}
    main{padding:18px 14px;}
    .g2{grid-template-columns:1fr;}
    .rr-grid{grid-template-columns:1fr;}
    .rg{grid-template-columns:1fr 1fr;}
    .overlap-tiles{grid-template-columns:1fr 1fr;}
  }


  /* ‚îÄ‚îÄ WELCOME SPLASH ‚îÄ‚îÄ */
  #welcome-splash{position:fixed;inset:0;z-index:8000;background:var(--charcoal);display:flex;align-items:center;justify-content:center;opacity:1;transition:opacity 0.4s;}
  #welcome-splash.hiding{opacity:0;pointer-events:none;}
  .splash-inner{text-align:center;padding:40px 24px;max-width:480px;}
  .splash-logo{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--gold);margin-bottom:20px;opacity:0.7;}
  .splash-title{font-family:'Playfair Display',serif;font-size:36px;font-weight:700;color:var(--cream);line-height:1.2;margin-bottom:10px;}
  .splash-sub{font-size:15px;color:rgba(245,240,232,0.45);margin-bottom:40px;line-height:1.6;}
  .splash-btns{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}
  .splash-btn{padding:14px 28px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;cursor:pointer;transition:transform 0.15s,opacity 0.15s;border:none;}
  .splash-btn:hover{transform:translateY(-2px);opacity:0.9;}
  .splash-btn-primary{background:var(--gold);color:var(--charcoal);font-weight:600;}
  .splash-btn-secondary{background:rgba(255,255,255,0.07);color:var(--cream);border:1px solid rgba(255,255,255,0.18)!important;}
  .splash-deco{width:60px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:0 auto 28px;}
</style>
</head>
<body>
<div id="mobile-overlay" onclick="toggleMobileSidebar()"></div>

<header>
  <div class="header-inner">
    <div class="header-text">
      <div class="header-tag">Property Finance Calculator</div>
      <h1 id="page-title">New Property</h1>
      <p class="header-sub" id="header-sub-text">Add property details in the Property tab to get started</p>
      <div class="header-actions">
        <button id="mobile-sidebar-btn" onclick="toggleMobileSidebar()" title="Open calculator">‚öô</button>
        <button id="profile-btn" onclick="openProfile()" title="User Profile"></button>
        <div id="unsaved-badge" style="display:none;align-items:center;gap:5px;background:rgba(196,112,74,0.25);border:1px solid rgba(196,112,74,0.5);border-radius:10px;padding:3px 9px;font-family:'DM Mono',monospace;font-size:10px;color:#E8956A;white-space:nowrap;cursor:default;" title="Unsaved changes">‚óè Unsaved</div>
        <button class="export-btn" onclick="saveScenario()" title="Save scenario to library">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save
        </button>
        <button class="export-btn" onclick="newScenario()" title="Start fresh new scenario" style="background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.2);">
          Ôºã New
        </button>
        <button class="export-btn" id="open-saved-btn" onclick="openScenariosModal()" title="Browse saved scenarios">
          üìÅ Library <span id="saved-count" style="display:none;background:var(--gold);color:var(--charcoal);border-radius:10px;padding:1px 6px;font-size:9px;margin-left:3px;vertical-align:middle;">0</span>
        </button>
        <button class="export-btn" onclick="exportPDF()" title="Export to PDF">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export PDF
        </button>
      </div>
    </div>
    <div class="header-photo-wrap" id="photo-wrap">
      <img id="prop-img" src="" alt="" class="header-photo" style="display:none;">
      <div id="upload-zone" class="upload-zone"
           onclick="document.getElementById('pd-file-input').click()"
           ondragover="event.preventDefault();this.classList.add('drag-over')"
           ondragleave="this.classList.remove('drag-over')"
           ondrop="handlePhotoDrop(event)">
        <input type="file" id="photo-file-input" accept="image/*" style="display:none" onchange="handlePhotoFile(this.files[0])">
        <div class="upload-inner">
          <div style="font-size:22px;margin-bottom:6px;">üì∑</div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:rgba(245,240,232,0.7);">ADD PHOTO</div>
          <div style="font-size:10px;color:rgba(245,240,232,0.4);margin-top:3px;">Click or drag & drop</div>
        </div>
      </div>
      <div class="photo-caption" id="photo-caption"></div>
    </div>
  </div>
</header>

  <nav>
    <button class="tab active" onclick="showTab('property',this)">00 ¬∑ Property</button>
    <button class="tab" onclick="showTab('costs',this)">01 ¬∑ Costs</button>
    <button class="tab" id="tab-reno-btn" onclick="showTab('reno',this)">02 ¬∑ Reno</button>
    <button class="tab" onclick="showTab('repay',this)">03 ¬∑ Repayments</button>
    <button class="tab" onclick="showTab('overlap',this)">04 ¬∑ Rent Overlap</button>
    <button class="tab" onclick="showTab('time',this)">05 ¬∑ Timeline</button>
    <button class="tab" id="tab-risks-btn" onclick="showTab('risks',this)">06 ¬∑ Risks</button>
    <button class="tab" onclick="showTab('projection',this)">07 ¬∑ Projection</button>
  </nav>
<div class="app-body">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sidebar">
  <div class="sidebar-title" style="display:flex;align-items:center;justify-content:space-between;">
    <span>‚öô Scenario Calculator</span>
    <button onclick="toggleMobileSidebar()" style="display:none;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:3px;color:var(--cream);font-size:18px;cursor:pointer;padding:2px 8px;line-height:1;" id="sidebar-close-btn">‚úï</button>
  </div>

  <hr class="div">
  <div class="s-head">Purchase Price & Savings</div>
  <input type="hidden" id="inp-address" value="">

  <div class="ig">
    <div class="il">Purchase Price <span id="lbl-price">‚Äî</span></div>
    <div class="iw"><span class="ipfx">$</span><input type="number" id="inp-price" value="650000" min="100000" max="700000" step="1000" placeholder="650000" oninput="syncRange('price');recalc()"></div>
    <input type="range" id="rng-price" min="300000" max="700000" step="5000" value="650000" oninput="syncInput('price');recalc()">
  </div>
  <div class="ig">
    <div class="il">Your Savings <span id="lbl-savings">‚Äî</span></div>
    <div class="iw"><span class="ipfx">$</span><input type="number" id="inp-savings" value="40000" min="0" step="1000" placeholder="40000" oninput="syncRange('savings');recalc()"></div>
    <input type="range" id="rng-savings" min="0" max="200000" step="1000" value="40000" oninput="syncInput('savings');recalc()">
  </div>

  <hr class="div">
  <div class="s-head">Loan & Scheme</div>

  <div class="ig">
    <div class="il">Deposit % <span id="lbl-depp">2.0%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-depp" value="2" min="2" max="20" step="0.5" oninput="syncRange('depp');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-depp" min="2" max="20" step="0.5" value="2" oninput="syncInput('depp');recalc()">
  </div>
  <div class="ig">
    <div class="il">Govt Scheme % <span id="lbl-govt">28.7%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-govt" value="28.7" min="0" max="40" step="0.1" oninput="syncRange('govt');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-govt" min="0" max="40" step="0.1" value="28.7" oninput="syncInput('govt');recalc()">
  </div>
  <div class="ig">
    <div class="il">Interest Rate <span id="lbl-rate">6.2%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-rate" value="6.2" min="1" max="15" step="0.1" oninput="syncRange('rate');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-rate" min="1" max="15" step="0.1" value="6.2" oninput="syncInput('rate');recalc()">
  </div>
  <div class="ig">
    <div class="il">Loan Term <span id="lbl-term">30 yrs</span></div>
    <div class="iw"><input type="number" id="inp-term" value="30" min="5" max="30" step="1" oninput="syncRange('term');recalc()"></div>
    <input type="range" id="rng-term" min="5" max="30" step="1" value="30" oninput="syncInput('term');recalc()">
  </div>

  <hr class="div">
  <!-- PURCHASE COSTS ‚Äî dynamic -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <div class="s-head" style="margin-bottom:0">Purchase Costs</div>
    <button class="add-cost-btn" style="width:auto;padding:4px 9px;font-size:9px;" onclick="addCostItem()">Ôºã Add Item</button>
  </div>

  <div class="cost-items-list" id="cost-items-list">
    <!-- All costs are now fully dynamic (item 14) ‚Äî seeded in JS initPage() -->
  </div>

  <div id="reno-sidebar-section" style="display:none;">
  <div class="ig" style="pointer-events:none;opacity:0.7;display:none;">
    <div class="il">Reno Total <span id="lbl-reno-total">$21,000</span></div>
  </div>
  <div class="ig" style="display:none;">
    <div class="il">Contingency % <span id="lbl-cont">15%</span></div>
    <div class="iw"><input type="number" class="pct" id="inp-cont" value="15" min="0" max="50" step="1" oninput="syncRange('cont');recalc()"><span class="isfx">%</span></div>
    <input type="range" id="rng-cont" min="0" max="50" step="1" value="15" oninput="syncInput('cont');recalc()">
  </div>
  </div>

  <div id="rent-sidebar-section">
  <div class="ig">
    <div class="il">Current Rent/wk <span id="lbl-rent">$450</span></div>
    <div class="iw"><span class="ipfx">$</span><input type="number" id="inp-rent" value="450" min="0" step="10" oninput="syncRange('rent');recalc()"></div>
    <input type="range" id="rng-rent" min="0" max="2000" step="10" value="450" oninput="syncInput('rent');recalc()">
  </div>
  <div class="ig">
    <div class="il">Overlap Weeks <span id="lbl-weeks">4</span></div>
    <div class="iw"><input type="number" id="inp-weeks" value="4" min="0" max="26" step="1" oninput="syncRange('weeks');recalc()"></div>
    <input type="range" id="rng-weeks" min="0" max="26" step="1" value="4" oninput="syncInput('weeks');recalc()">
  </div>
  </div>

  <hr class="div">
  <div style="display:flex;flex-direction:column;gap:10px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="s-head" style="margin-bottom:0;">üî® Reno Tab</div>
      <div style="display:flex;align-items:center;gap:7px;">
        <div id="reno-toggle" onclick="toggleReno()" style="width:38px;height:20px;background:var(--sage);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;">
          <div id="reno-toggle-knob" style="position:absolute;top:2px;left:20px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="s-head" style="margin-bottom:0;">üè† Rent Overlap Tab</div>
      <div id="rent-toggle" onclick="toggleRent()" style="width:38px;height:20px;background:var(--sky);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;">
        <div id="rent-toggle-knob" style="position:absolute;top:2px;left:20px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="s-head" style="margin-bottom:0;">‚ö†Ô∏è Risk Tab</div>
      <div id="risk-toggle" onclick="toggleRisk()" style="width:38px;height:20px;background:var(--terracotta);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;">
        <div id="risk-toggle-knob" style="position:absolute;top:2px;left:20px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>
      </div>
    </div>
  </div>
  <div id="sidebar-alert"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="content">

  <!-- ‚ïê‚ïê SCENARIOS MODAL ‚ïê‚ïê -->
  <div id="scenarios-modal" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);" onclick="if(event.target===this)closeScenariosModal()">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(760px,96vw);max-height:90vh;background:var(--warm-white);border-radius:6px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.5);">

      <!-- Header -->
      <div style="background:var(--charcoal);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:12px;">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:2px;">SAVED SCENARIOS</div>
          <div style="font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:var(--cream);">Property Library <span id="lib-count" style="font-family:'DM Mono',monospace;font-size:12px;font-weight:400;color:rgba(245,240,232,0.4);margin-left:6px;"></span></div>
        </div>
        <button onclick="closeScenariosModal()" style="width:32px;height:32px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:3px;color:var(--cream);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">‚úï</button>
      </div>

      <!-- Filter bar -->
      <div style="background:var(--charcoal-soft);padding:10px 20px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,0.06);">
        <span style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.4);letter-spacing:1px;margin-right:2px;">FILTER:</span>
        <button class="lib-filter active" data-filter="all" onclick="setLibFilter('all',this)">All</button>
        <button class="lib-filter" data-filter="browsing" onclick="setLibFilter('browsing',this)">üëÄ Browsing</button>
        <button class="lib-filter" data-filter="for-sale" onclick="setLibFilter('for-sale',this)">üè∑ For Sale</button>
        <button class="lib-filter" data-filter="auction" onclick="setLibFilter('auction',this)">üî® Auction</button>
        <button class="lib-filter" data-filter="offered" onclick="setLibFilter('offered',this)">üìù Offered</button>
        <button class="lib-filter" data-filter="under-offer" onclick="setLibFilter('under-offer',this)">‚è≥ Under Offer</button>
        <button class="lib-filter" data-filter="unconditional" onclick="setLibFilter('unconditional',this)">‚úÖ Unconditional</button>
        <button class="lib-filter" data-filter="sold" onclick="setLibFilter('sold',this)">üî¥ Sold</button>
      </div>

      <!-- List -->
      <div id="scenarios-list" style="overflow-y:auto;flex:1;padding:12px 20px;">
        <div id="scenarios-empty" style="display:none;text-align:center;padding:48px 20px;color:var(--slate);">
          <div style="font-size:40px;margin-bottom:10px;">üè†</div>
          <div style="font-family:'Playfair Display',serif;font-size:17px;margin-bottom:6px;">No saved scenarios yet</div>
          <div style="font-size:13px;line-height:1.6;">Fill in your property details and click <strong>Save</strong> to save your first property.</div>
        </div>
        <div id="scenarios-grid"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CONFIRM LOAD MODAL ‚ïê‚ïê -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.7);">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(420px,90vw);background:var(--warm-white);border-radius:6px;overflow:hidden;box-shadow:0 16px 60px rgba(0,0,0,0.4);">
      <div style="background:var(--terracotta);padding:16px 20px;">
        <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:rgba(255,255,255,0.7);margin-bottom:3px;">CONFIRM LOAD</div>
        <div style="font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:white;">Replace current scenario?</div>
      </div>
      <div style="padding:20px;">
        <p style="font-size:13px;color:var(--slate);line-height:1.7;margin-bottom:16px;">Loading <strong id="confirm-name" style="color:var(--charcoal);">this scenario</strong> will replace all your current values. Any unsaved changes will be lost.</p>
        <div style="display:flex;gap:10px;">
          <button onclick="confirmLoad()" style="flex:1;padding:10px;background:var(--charcoal);color:var(--cream);border:none;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;font-weight:500;cursor:pointer;letter-spacing:0.5px;">‚úì Yes, Load It</button>
          <button onclick="closeConfirmModal()" style="flex:1;padding:10px;background:rgba(28,28,30,0.07);color:var(--slate);border:1px solid rgba(28,28,30,0.12);border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <main>

    <!-- TAB 0: PROPERTY DETAILS -->
    <div class="section active" id="property">
      <div class="sl">Property Details</div>

      <!-- Photo upload + address card -->
      <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:20px;margin-bottom:14px;align-items:start;">

        <!-- Photo upload big zone -->
        <div class="card" style="padding:0;overflow:hidden;">
          <div class="ca" style="background:var(--terracotta)"></div>
          <div id="prop-photo-big-wrap" style="position:relative;aspect-ratio:4/3;background:var(--charcoal);cursor:pointer;"
               onclick="document.getElementById('pd-file-input').click()"
               ondragover="event.preventDefault();this.classList.add('pd-drag')"
               ondragleave="this.classList.remove('pd-drag')"
               ondrop="handlePropPhotoDrop(event)">
            <input type="file" id="pd-file-input" accept="image/*" style="display:none" onchange="handlePropPhotoFile(this.files[0])">
            <img id="pd-photo-big" src="" alt="" style="width:100%;height:100%;object-fit:cover;display:none;position:absolute;top:0;left:0;">
            <div id="pd-upload-prompt" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:rgba(245,240,232,0.5);transition:background 0.2s;">
              <div style="font-size:36px;">üì∑</div>
              <div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--gold)">Upload Photo</div>
              <div style="font-size:11px;">Click or drag & drop your property image</div>
              <div style="font-size:10px;opacity:0.5;">JPG, PNG, WEBP supported</div>
            </div>
            <div id="pd-photo-overlay" style="display:none;position:absolute;bottom:0;left:0;right:0;padding:8px 12px;background:linear-gradient(transparent,rgba(0,0,0,0.7));font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.7);display:flex;justify-content:space-between;align-items:center;">
              <span id="pd-photo-label"></span>
              <button onclick="event.stopPropagation();clearPropPhoto()" style="background:rgba(255,255,255,0.15);border:none;color:white;font-size:11px;padding:3px 8px;border-radius:2px;cursor:pointer;font-family:'DM Mono',monospace;">‚úï Remove</button>
            </div>
          </div>
          <div style="padding:10px 14px 12px;background:var(--warm-white);">
            <div style="font-size:10px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin-bottom:7px;">Property Photo</div>
            <div style="display:flex;gap:6px;align-items:center;">
              <input type="text" id="pd-photo-url" placeholder="Or paste image URL here‚Ä¶" style="flex:1;font-size:11px;padding:5px 8px;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);border-radius:3px;color:var(--charcoal);font-family:'DM Sans',sans-serif;outline:none;" oninput="handlePhotoUrlInput(this.value)">
              <button onclick="applyPhotoUrl()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:5px 10px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;white-space:nowrap;">Use URL</button>
            </div>
          </div>
        </div>

        <!-- Property details form -->
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div class="card">
            <div class="ca" style="background:var(--gold)"></div>
            <h3>Address & Listing</h3>
            <div class="pd-field">
              <label class="pd-label">Street Address</label>
              <div class="addr-wrap">
                <input type="text" id="pd-address" value="" autocomplete="off" oninput="updatePropertyDetails();addrAutocomplete(this.value)" onblur="setTimeout(()=>hideAddrSuggestions(),200)" placeholder="e.g. 54 Southampton St">
                <div id="addr-suggestions" class="addr-suggestions"></div>
              </div>
            </div>
            <div class="g2" style="gap:10px;margin-top:10px;">
              <div class="pd-field">
                <label class="pd-label">Suburb</label>
                <input type="text" id="pd-suburb" value="" oninput="updatePropertyDetails()" placeholder="e.g. Kedron">
              </div>
              <div class="pd-field">
                <label class="pd-label">State</label>
                <input type="text" id="pd-state" value="" oninput="updatePropertyDetails()" placeholder="QLD">
              </div>
            </div>
            <div class="pd-field" style="margin-top:10px;">
              <label class="pd-label">Listing URL (for your reference)</label>
              <input type="text" id="pd-url" value="" oninput="updatePropertyDetails()" placeholder="https://www.realestate.com.au/...">
            </div>
            <div id="pd-url-link" style="display:none;margin-top:6px;">
              <a id="pd-url-anchor" href="#" target="_blank" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--sky);text-decoration:none;">üîó Open listing ‚Üí</a>
            </div>
          </div>

          <div class="card">
            <div class="ca" style="background:var(--sky)"></div>
            <h3>Property Stats</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="pd-field">
                <label class="pd-label">Bedrooms</label>
                <div class="pd-stepper">
                  <button onclick="stepStat('pd-bed',-1)">‚àí</button>
                  <input type="number" id="pd-bed" value="0" min="0" max="10" oninput="updatePropertyDetails()">
                  <button onclick="stepStat('pd-bed',1)">Ôºã</button>
                </div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Bathrooms</label>
                <div class="pd-stepper">
                  <button onclick="stepStat('pd-bath',-1)">‚àí</button>
                  <input type="number" id="pd-bath" value="0" min="0" max="10" oninput="updatePropertyDetails()">
                  <button onclick="stepStat('pd-bath',1)">Ôºã</button>
                </div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Car Spaces</label>
                <div class="pd-stepper">
                  <button onclick="stepStat('pd-car',-1)">‚àí</button>
                  <input type="number" id="pd-car" value="0" min="0" max="10" oninput="updatePropertyDetails()">
                  <button onclick="stepStat('pd-car',1)">Ôºã</button>
                </div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Land Size (m¬≤)</label>
                <div class="iw" style="position:relative;"><input type="number" id="pd-land" value="" oninput="updatePropertyDetails()" placeholder="e.g. 405" style="padding-left:8px;"></div>
              </div>
              <div class="pd-field">
                <label class="pd-label">House Size (m¬≤)</label>
                <div class="iw" style="position:relative;"><input type="number" id="pd-house" value="" oninput="updatePropertyDetails()" placeholder="e.g. 120" style="padding-left:8px;"></div>
              </div>
              <div class="pd-field">
                <label class="pd-label">Year Built</label>
                <div class="iw" style="position:relative;"><input type="number" id="pd-year" value="" oninput="updatePropertyDetails()" placeholder="e.g. 1985" style="padding-left:8px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Property type & notes -->
      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--sage)"></div>
          <h3>Property Type</h3>
          <div class="prop-type-grid">
            <button class="prop-type-btn active" onclick="setPropType(this,'House')">üè† House</button>
            <button class="prop-type-btn" onclick="setPropType(this,'Townhouse')">üèò Townhouse</button>
            <button class="prop-type-btn" onclick="setPropType(this,'Unit/Apt')">üè¢ Unit/Apt</button>
            <button class="prop-type-btn" onclick="setPropType(this,'Duplex')">üèó Duplex</button>
          </div>
          <input type="hidden" id="pd-type" value="House">
        </div>
        <div class="card">
          <div class="ca" style="background:var(--slate)"></div>
          <h3>Notes</h3>
          <textarea id="pd-notes" oninput="updatePropertyDetails()" placeholder="Key observations, things to check, deal-breakers, pros/cons..." style="width:100%;height:120px;background:rgba(28,28,30,0.04);border:1px solid rgba(28,28,30,0.1);border-radius:3px;padding:10px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--charcoal);resize:vertical;outline:none;line-height:1.6;"></textarea>
        </div>
      </div>

      <!-- Property Status + Agent + Key Dates (items 1,2,3) -->
      <div class="g2" style="margin-bottom:14px;">

        <!-- Property Status Card (item 2) -->
        <div class="card">
          <div class="ca" style="background:var(--terracotta-light)"></div>
          <h3>Property Status</h3>
          <div id="status-badges" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;">
            <button class="status-btn active" data-status="browsing" onclick="setStatus('browsing',this)">üëÄ Browsing</button>
            <button class="status-btn" data-status="auction" onclick="setStatus('auction',this)">üî® Auction</button>
            <button class="status-btn" data-status="for-sale" onclick="setStatus('for-sale',this)">üè∑ For Sale</button>
            <button class="status-btn" data-status="offered" onclick="setStatus('offered',this)">üìù Offer Sent</button>
            <button class="status-btn" data-status="under-offer" onclick="setStatus('under-offer',this)">‚è≥ Under Offer</button>
            <button class="status-btn" data-status="unconditional" onclick="setStatus('unconditional',this)">‚úÖ Unconditional</button>
            <button class="status-btn" data-status="sold" onclick="setStatus('sold',this)">üî¥ Sold/Passed</button>
          </div>
          <input type="hidden" id="pd-status" value="browsing">
          <div id="status-note-wrap" style="display:none;">
            <div class="pd-field">
              <label class="pd-label">Auction / Offer date</label>
              <input type="date" id="pd-status-date" style="background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);padding:8px 10px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;" oninput="syncKeyDatesFromStatus();document.getElementById('pd-status-date-display').textContent=this.value?formatDate(this.value):'';"><span id="pd-status-date-display" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--slate);margin-left:6px;"></span>
            </div>
          </div>
        </div>

        <!-- Key Dates Card (item 3) -->
        <div class="card">
          <div class="ca" style="background:var(--sky)"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin-bottom:0;">Key Dates</h3>
            <button onclick="addKeyDate()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:5px 11px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;">Ôºã Add Event</button>
          </div>
          <div id="key-dates-list" style="display:flex;flex-direction:column;gap:8px;"></div>
          <div id="key-dates-empty" style="font-size:12px;color:var(--slate);font-style:italic;padding:8px 0;">No key dates yet ‚Äî add inspections, auction dates, settlement, etc.</div>
        </div>
      </div>

      <!-- Agent Details + Comms (item 1) -->
      <div class="g2" style="margin-bottom:14px;">
        <div class="card">
          <div class="ca" style="background:var(--sage)"></div>
          <h3>Real Estate Agent</h3>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div class="pd-field">
              <label class="pd-label">Agency Name</label>
              <input type="text" id="ag-agency" placeholder="e.g. Ray White Kedron" oninput="markAgentDirty()">
            </div>
            <div class="pd-field">
              <label class="pd-label">Agent Name</label>
              <input type="text" id="ag-name" placeholder="e.g. Jane Smith" oninput="markAgentDirty()">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="pd-field">
                <label class="pd-label">Phone</label>
                <input type="tel" id="ag-phone" placeholder="04xx xxx xxx" oninput="markAgentDirty()">
              </div>
              <div class="pd-field">
                <label class="pd-label">Email</label>
                <input type="email" id="ag-email" placeholder="agent@agency.com" oninput="markAgentDirty()">
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <a id="ag-call-link" href="#" style="display:none;background:var(--sage);color:white;padding:6px 12px;border-radius:3px;font-family:'DM Mono',monospace;font-size:10px;text-decoration:none;letter-spacing:0.5px;">üìû Call</a>
              <a id="ag-email-link" href="#" style="display:none;background:var(--sky);color:white;padding:6px 12px;border-radius:3px;font-family:'DM Mono',monospace;font-size:10px;text-decoration:none;letter-spacing:0.5px;">‚úâ Email</a>
            </div>
          </div>
        </div>

        <!-- Comms history -->
        <div class="card">
          <div class="ca" style="background:var(--gold)"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin-bottom:0;">Communication Log</h3>
            <button onclick="addCommsEntry()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:5px 11px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;">Ôºã Log Entry</button>
          </div>
          <div id="comms-list" style="display:flex;flex-direction:column;gap:0;max-height:260px;overflow-y:auto;"></div>
          <div id="comms-empty" style="font-size:12px;color:var(--slate);font-style:italic;padding:8px 0;">No communications logged yet.</div>
        </div>
      </div>

      <!-- Live preview of header -->
      <div class="card" style="background:var(--charcoal);color:var(--cream);">
        <div class="ca" style="background:var(--gold)"></div>
        <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:12px;">HEADER PREVIEW ‚Äî updates live as you type</div>
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
          <div id="pd-preview-photo" style="width:80px;height:56px;border-radius:3px;background:rgba(255,255,255,0.06);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;">üì∑</div>
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:rgba(245,240,232,0.4);text-transform:uppercase;margin-bottom:4px;">Property Finance Calculator</div>
            <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:900;" id="pd-preview-title">New Property</div>
            <div style="display:flex;gap:12px;margin-top:6px;flex-wrap:wrap;" id="pd-preview-stats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 1: COSTS -->
    <div class="section" id="costs">
      <div class="sl">Financial Snapshot</div>
      <div class="tiles">
        <div class="tile"><div class="tile-dot" style="background:var(--gold)"></div><div class="tile-val" id="t-price">$650,000</div><div class="tile-lbl">Purchase Price</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--terracotta)"></div><div class="tile-val" id="t-deposit">$13,000</div><div class="tile-lbl">Your Deposit</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sage)"></div><div class="tile-val" id="t-govt">$187,000</div><div class="tile-lbl">Govt. Contribution</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sky)"></div><div class="tile-val" id="t-remaining">$24,000</div><div class="tile-lbl">Remaining Cash</div></div>
      </div>

      <div class="cb">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:5px">YOUR CASH PICTURE</div>
          <p style="font-size:12px;color:rgba(245,240,232,0.48);line-height:1.6;max-width:280px">Cash after deposit + all fees. Remainder available for renovation or emergency buffer.</p>
        </div>
        <div style="display:flex;gap:18px;flex-wrap:wrap">
          <div class="cs"><div class="cv" id="cb-savings">$40,000</div><div class="clbl">Your Savings</div></div>
          <div class="cs"><div class="cv" style="color:var(--terracotta-light)" id="cb-out">‚àí$16,100</div><div class="clbl">Out-of-Pocket</div></div>
          <div class="cs"><div class="cv" id="cb-remaining" style="color:var(--sage-light)">$23,900</div><div class="clbl">Remaining Cash</div></div>
        </div>
      </div>

      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--gold)"></div>
          <h3>Upfront Cost Breakdown</h3>
          <div class="cr"><span class="nm">Deposit</span><span class="am" id="cr-deposit">$13,000</span></div>
          <div id="cost-rows-display"></div>
          <div class="cr tot"><span class="nm">Total Required</span><span class="am" id="cr-total">$16,100</span></div>
          <div id="cost-note" style="margin-top:10px;padding:8px 10px;border-radius:3px;font-size:11px;line-height:1.6;"></div>
        </div>
        <div class="card">
          <div class="ca" style="background:var(--sky)"></div>
          <h3>Funding Structure</h3>
          <div class="dw">
            <svg width="116" height="116" viewBox="0 0 116 116">
              <circle cx="58" cy="58" r="42" fill="none" stroke="#E8E3D8" stroke-width="17"/>
              <circle id="d-bank" cx="58" cy="58" r="42" fill="none" stroke="#5B8FAB" stroke-width="17" stroke-dasharray="0 263.9" stroke-dashoffset="0" transform="rotate(-90 58 58)"/>
              <circle id="d-govt" cx="58" cy="58" r="42" fill="none" stroke="#7B9E87" stroke-width="17" stroke-dasharray="0 263.9" stroke-dashoffset="0" transform="rotate(-90 58 58)"/>
              <circle id="d-you"  cx="58" cy="58" r="42" fill="none" stroke="#C9A84C" stroke-width="17" stroke-dasharray="0 263.9" stroke-dashoffset="0" transform="rotate(-90 58 58)"/>
              <text id="d-centre" x="58" y="55" text-anchor="middle" font-family="Playfair Display" font-size="11" fill="#1C1C1E" font-weight="700">$650k</text>
              <text x="58" y="68" text-anchor="middle" font-family="DM Mono" font-size="7" fill="#6B6B72">PURCHASE</text>
            </svg>
            <div style="flex:1">
              <div class="li"><div class="ld" style="background:var(--sky)"></div><span>Bank Loan</span><span class="lv" id="leg-bank">$450k</span></div>
              <div class="li"><div class="ld" style="background:var(--sage)"></div><span>Government</span><span class="lv" id="leg-govt">$187k</span></div>
              <div class="li"><div class="ld" style="background:var(--gold)"></div><span>Your Deposit</span><span class="lv" id="leg-you">$13k</span></div>
            </div>
          </div>
          <div style="margin-top:16px">
            <div class="bi"><div class="bm"><span>Bank Loan</span><span id="bp-bank">69.2%</span></div><div class="bt"><div class="bf" id="bf-bank" style="background:var(--sky)"></div></div></div>
            <div class="bi"><div class="bm"><span>Government</span><span id="bp-govt">28.7%</span></div><div class="bt"><div class="bf" id="bf-govt" style="background:var(--sage)"></div></div></div>
            <div class="bi"><div class="bm"><span>Your Deposit</span><span id="bp-dep">2.0%</span></div><div class="bt"><div class="bf" id="bf-dep" style="background:var(--gold)"></div></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 2: RENO -->
    <div class="section" id="reno">
      <div class="sl">Renovation Budget</div>
      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--sage)"></div>
          <h3>Available Pool</h3>
          <div style="text-align:center;padding:10px 0 4px">
            <div style="font-size:10px;font-family:'DM Mono',monospace;letter-spacing:2px;color:var(--slate);margin-bottom:2px;">CASH AVAILABLE</div>
            <div style="font-family:'DM Mono',monospace;font-size:36px;font-weight:500;" id="reno-pool-val">$24k</div>
            <div style="font-size:11px;color:var(--slate);margin-bottom:14px;">After deposit &amp; all upfront costs</div>
            <div style="border-top:1px solid rgba(28,28,30,0.08);padding-top:12px;">
              <div style="font-size:10px;font-family:'DM Mono',monospace;letter-spacing:2px;color:var(--slate);margin-bottom:2px;">UNSPENT BUDGET</div>
              <div style="font-family:'DM Mono',monospace;font-size:36px;font-weight:500;color:var(--reward-green);" id="reno-unspent-val">$0k</div>
              <div style="font-size:11px;color:var(--slate);">Remaining after planned reno</div>
            </div>
          </div>
          <div id="reno-pool-alert"></div>
        </div>
        <div class="card">
          <div class="ca" style="background:var(--terracotta)"></div>
          <h3>Spend vs Budget</h3>
          <div style="margin-bottom:8px">
            <div class="bm"><span>Reno Spend</span><span id="reno-spend-pct">100%</span></div>
            <div class="bt" style="height:10px"><div class="bf" id="reno-spend-bar" style="background:var(--sage)"></div></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--slate);margin-bottom:12px">
            <span>Planned: <strong id="reno-planned" style="color:var(--charcoal)">$0</strong></span>
            <span>Pool: <strong id="reno-pool-cap" style="color:var(--charcoal)">$0</strong></span>
          </div>
          <!-- Dynamic reno items list -->
          <div id="reno-items-list"></div>
          <div style="display:flex;justify-content:space-between;padding-top:9px;border-top:2px solid var(--charcoal);margin-top:5px;font-family:'DM Mono',monospace;font-size:12px">
            <span>Total</span><strong id="reno-total">$0</strong>
          </div>
        </div>
      </div>
      <!-- Add item button -->
      <div style="text-align:center;margin-top:4px;">
        <button onclick="addRenoItem()" style="background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:9px 22px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:0.5px;">Ôºã Add Reno Item</button>
      </div>
    </div>

    <!-- TAB 3: REPAYMENTS -->
    <div class="section" id="repay">
      <div class="sl">Loan Repayments</div>
      <div class="card">
        <div class="ca" style="background:var(--sky)"></div>
        <h3>Monthly Repayment</h3>
        <p style="font-size:12px;color:var(--slate);line-height:1.6;margin-bottom:2px">Principal & Interest on bank loan. Adjust rate and term in the sidebar.</p>
        <div class="rg">
          <div class="rc"><div class="rv" id="rp-monthly">$2,741</div><div class="rl">Monthly</div><div class="rs" id="rp-rate-lbl">@ 6.2%</div></div>
          <div class="rc"><div class="rv" id="rp-weekly">$633</div><div class="rl">Weekly</div><div class="rs" id="rp-term-lbl">30yr term</div></div>
          <div class="rc"><div class="rv" id="rp-annual">$32,892</div><div class="rl">Annual</div><div class="rs" id="rp-loan-lbl">$450k loan</div></div>
        </div>
      </div>
      <div class="card">
        <div class="ca" style="background:var(--terracotta)"></div>
        <h3>Rate Stress Test</h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:12px;line-height:1.6">How does your repayment change if rates rise?</p>
        <div id="stress-table"></div>
      </div>
      <div class="card">
        <div class="ca" style="background:var(--sage)"></div>
        <h3>Total Loan Cost</h3>
        <div style="display:flex;gap:22px;flex-wrap:wrap;margin-top:4px">
          <div><div style="font-family:'DM Mono',monospace;font-size:24px;color:var(--risk-red)" id="rp-interest">$536k</div><div style="font-size:11px;color:var(--slate);margin-top:2px">Total Interest Paid</div></div>
          <div><div style="font-family:'DM Mono',monospace;font-size:24px" id="rp-total-paid">$987k</div><div style="font-size:11px;color:var(--slate);margin-top:2px">Total Amount Paid</div></div>
          <div><div style="font-family:'DM Mono',monospace;font-size:24px;color:var(--sage)" id="rp-loan-show">$450k</div><div style="font-size:11px;color:var(--slate);margin-top:2px">Principal</div></div>
        </div>
      </div>
    </div>

    <!-- TAB 4: RENT OVERLAP -->
    <div class="section" id="overlap">
      <div class="sl">Rent + Mortgage Overlap Period</div>

      <div style="background:var(--charcoal);color:var(--cream);border-radius:4px;padding:18px 22px;margin-bottom:14px;font-size:12px;line-height:1.7;color:rgba(245,240,232,0.65)">
        <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:8px">WHAT IS THIS?</div>
        After settlement you may continue renting your current place for a few weeks while renovating before you move in. During this period you're paying <strong style="color:var(--cream)">both</strong> rent and your mortgage ‚Äî this calculator shows the exact cost of that overlap and how it affects your remaining cash buffer.
      </div>

      <div class="overlap-tiles">
        <div class="tile"><div class="tile-dot" style="background:var(--terracotta)"></div><div class="tile-val" id="ov-weekly-total">$1,083</div><div class="tile-lbl">Weekly (both costs)</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--gold)"></div><div class="tile-val" id="ov-total-cost">$4,332</div><div class="tile-lbl">Total Overlap Cost</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sage)"></div><div class="tile-val" id="ov-remaining-after">$19,568</div><div class="tile-lbl">Cash Left After</div></div>
      </div>

      <!-- Visual week bar -->
      <div class="card">
        <div class="ca" style="background:var(--terracotta)"></div>
        <h3>Weekly Cost Breakdown During Overlap</h3>

        <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:6px;font-size:12px"><div style="width:12px;height:12px;border-radius:2px;background:var(--terracotta)"></div>Rent/wk: <strong id="ov-rent-wk">$450</strong></div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px"><div style="width:12px;height:12px;border-radius:2px;background:var(--sky)"></div>Mortgage/wk: <strong id="ov-mort-wk">$633</strong></div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px"><div style="width:12px;height:12px;border-radius:2px;background:rgba(28,28,30,0.12)"></div>After overlap: mortgage only</div>
        </div>

        <!-- Calendar view -->
        <div id="cal-grid"></div>

        <!-- Bar chart of overlap -->
        <div style="margin-top:20px">
          <div class="bm"><span>Rent portion</span><span id="ov-rent-pct">41%</span></div>
          <div class="bt" style="height:8px;margin-bottom:10px"><div class="bf" id="ov-rent-bar" style="background:var(--terracotta)"></div></div>
          <div class="bm"><span>Mortgage portion</span><span id="ov-mort-pct">59%</span></div>
          <div class="bt" style="height:8px"><div class="bf" id="ov-mort-bar" style="background:var(--sky)"></div></div>
        </div>
      </div>

      <div class="g2">
        <div class="card">
          <div class="ca" style="background:var(--gold)"></div>
          <h3>Overlap Cost Summary</h3>
          <div class="dual-breakdown">
            <div class="dual-row"><span class="dnm">Rent per week</span><span class="dam" id="ov-s-rent">$450</span></div>
            <div class="dual-row"><span class="dnm">Mortgage per week</span><span class="dam" id="ov-s-mort">$633</span></div>
            <div class="dual-row"><span class="dnm">Combined per week</span><span class="dam" id="ov-s-combined">$1,083</span></div>
            <div class="dual-row"><span class="dnm">Number of weeks</span><span class="dam" id="ov-s-weeks">4</span></div>
            <div class="dual-row dtot"><span class="dnm">Total Overlap Cost</span><span class="dam" id="ov-s-total">$4,332</span></div>
          </div>
        </div>

        <div class="card">
          <div class="ca" style="background:var(--sky)"></div>
          <h3>Impact on Cash Buffer</h3>
          <div class="dual-breakdown">
            <div class="dual-row"><span class="dnm">Cash after settlement</span><span class="dam" id="ov-buf-start">$23,900</span></div>
            <div class="dual-row"><span class="dnm">Overlap cost</span><span class="dam" style="color:var(--risk-red)" id="ov-buf-overlap">‚àí$4,332</span></div>
            <div class="dual-row dtot"><span class="dnm">Cash remaining for reno</span><span class="dam" id="ov-buf-final">$19,568</span></div>
          </div>
          <div id="ov-advice" style="margin-top:12px;padding:9px 11px;border-radius:3px;font-size:11px;line-height:1.6;"></div>
        </div>
      </div>

      <!-- Scenarios -->
      <div class="card">
        <div class="ca" style="background:var(--sage)"></div>
        <h3>Overlap Scenarios ‚Äî Cash Remaining for Reno</h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:14px;line-height:1.6">How much renovation budget you'd have left depending on how long the overlap lasts.</p>
        <div id="overlap-scenarios"></div>
      </div>
    </div>

    <!-- TAB 5: TIMELINE -->
    <div class="section" id="time">
      <div class="sl">Time Commitment</div>

      <!-- Key dates from property tab (item 5) -->
      <div class="card" id="tl-key-dates-card" style="display:none;">
        <div class="ca" style="background:var(--sky)"></div>
        <h3>üìÖ Your Key Dates</h3>
        <div class="tl" id="tl-key-dates-list" style="margin-top:12px;"></div>
      </div>

      <div class="card">
        <div class="ca" style="background:var(--gold)"></div>
        <h3>Purchase to Move-In ‚Äî <span id="tl-address">your property</span></h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:22px;line-height:1.6">Estimated timeframes from offer accepted through to settled and living in your new home.</p>
        <div class="tl">
          <div class="tli"><div class="tld" style="color:var(--gold)"></div><div class="tlp" style="color:var(--gold)">Phase 01</div><div class="tlt">Offer Accepted & Contracts Exchanged</div><div class="tldesc">You sign contracts, pay your deposit, and the property is taken off market. Cooling-off period applies (typically 5 business days in QLD).</div><div class="tldr">Week 1‚Äì2</div></div>
          <div class="tli"><div class="tld" style="color:var(--terracotta)"></div><div class="tlp" style="color:var(--terracotta)">Phase 02</div><div class="tlt">Building & Pest Inspection</div><div class="tldesc">Book a licensed inspector within the first week. Results typically returned within 24‚Äì48 hours. Address any findings before settlement.</div><div class="tldr">Week 1‚Äì3</div></div>
          <div class="tli"><div class="tld" style="color:var(--sky)"></div><div class="tlp" style="color:var(--sky)">Phase 03</div><div class="tlt">Finance & Loan Finalisation</div><div class="tldesc">Your bank formally approves the loan. Government scheme contribution confirmed. Solicitor prepares for settlement.</div><div class="tldr">Week 2‚Äì5</div></div>
          <div class="tli"><div class="tld" style="color:var(--sage)"></div><div class="tlp" style="color:var(--sage)">Phase 04</div><div class="tlt">Settlement Day</div><div class="tldesc">Title transfers to your name. Final balance paid. Keys handed over. You are now a homeowner.</div><div class="tldr">Week 4‚Äì12</div></div>
          <div class="tli"><div class="tld" style="color:var(--terracotta-light)"></div><div class="tlp" style="color:var(--terracotta-light)">Phase 05</div><div class="tlt">Overlap Period <span id="tl-overlap-badge" style="font-family:'DM Mono',monospace;font-size:10px;background:var(--terracotta);color:white;padding:2px 7px;border-radius:2px;margin-left:6px;vertical-align:middle;"></span></div><div class="tldesc" id="tl-overlap-desc">You continue renting while renovations begin. Both rent and mortgage repayments are active during this window.</div><div class="tldr" id="tl-overlap-dur">Weeks 1‚Äì4 post-settlement</div></div>
          <div class="tli"><div class="tld" style="color:var(--terracotta-light)"></div><div class="tlp" style="color:var(--terracotta-light)">Phase 06</div><div class="tlt">Renovations Complete</div><div class="tldesc">Tradies finish, final inspections done. Property ready to move in.</div><div class="tldr">Month 3‚Äì5</div></div>
          <div class="tli"><div class="tld" style="color:var(--reward-green)"></div><div class="tlp" style="color:var(--reward-green)">Phase 07</div><div class="tlt">Move In & Rent Ends üéâ</div><div class="tldesc">You move in, give notice to your landlord, and your rent obligation ends. Single housing cost from here.</div><div class="tldr">Month 4‚Äì6</div></div>
        </div>
      </div>
    </div>

    <!-- TAB 6: RISKS -->
    <div class="section" id="risks">
      <div class="sl">Risk & Reward Assessment</div>
      <div class="g2" style="margin-bottom:14px">
        <div class="card"><div class="ca" style="background:var(--risk-red)"></div><h3>Risk Level</h3><div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--slate);margin-bottom:5px">OVERALL RISK</div><div class="mt"><div class="mf" id="risk-meter" style="background:linear-gradient(to right,var(--gold),var(--terracotta))"></div></div><p style="font-size:11px;color:var(--slate);line-height:1.6" id="risk-desc"></p></div>
        <div class="card"><div class="ca" style="background:var(--reward-green)"></div><h3>Reward Potential</h3><div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--slate);margin-bottom:5px">UPSIDE SCORE</div><div class="mt"><div class="mf" id="reward-meter" style="background:linear-gradient(to right,var(--sage),var(--reward-green))"></div></div><p style="font-size:11px;color:var(--slate);line-height:1.6" id="reward-desc"></p></div>
      </div>
      <div class="rr-grid">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--risk-red);margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--risk-red)">‚ö† Risks</div>
          <div class="rri risk"><div class="rric">üí∏</div><div><div class="rrt">Interest Rate Sensitivity</div><div class="rrb">A 2% rate rise would add <strong id="rr-rate-delta">$xxx</strong>/month to repayments.</div></div></div>
          <div class="rri risk"><div class="rric">üèö</div><div><div class="rrt">Hidden Structural Issues</div><div class="rrb">Unforeseen defects can blow the renovation budget. B&P inspection is essential.</div></div></div>
          <div class="rri risk"><div class="rric">üìâ</div><div><div class="rrt">Low Equity Buffer</div><div class="rrb">With <span id="rr-dep-pct">2%</span> personal deposit, any market correction leaves little buffer.</div></div></div>
          <div class="rri risk"><div class="rric">üî®</div><div><div class="rrt">Reno Cost Blowouts</div><div class="rrb">Reno pool is <span id="rr-pool-val">$24k</span>. Scope creep and tradie delays can rapidly eat through this.</div></div></div>
          <div class="rri risk"><div class="rric">üè†</div><div><div class="rrt">Dual Housing Costs</div><div class="rrb">Paying <span id="rr-overlap-cost">$4k</span> in combined rent + mortgage during your <span id="rr-overlap-weeks">4</span>-week overlap reduces your reno buffer.</div></div></div>
        </div>
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--reward-green);margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--reward-green)">‚ú¶ Rewards</div>
          <div class="rri reward"><div class="rric">üè†</div><div><div class="rrt">Into the Market Now</div><div class="rrb">With <span id="rr-dep-show">$13k</span> deposit you stop rent leakage and start building equity immediately.</div></div></div>
          <div class="rri reward"><div class="rric">üìà</div><div><div class="rrt">Renovation-Driven Equity</div><div class="rrb">A targeted <span id="rr-reno-show">$24k</span> reno on a <span id="rr-price-show">$650k</span> property can unlock $40k‚Äì$80k+ in uplift.</div></div></div>
          <div class="rri reward"><div class="rric">ü§ù</div><div><div class="rrt">Government Co-Invests</div><div class="rrb">The scheme absorbs <span id="rr-govt-show">28.7%</span> of the purchase, reducing your LVR and preserving cash.</div></div></div>
          <div class="rri reward"><div class="rric">üõ°</div><div><div class="rrt">No LMI Required</div><div class="rrb">Avoiding Lenders Mortgage Insurance saves thousands in sunk costs.</div></div></div>
          <div class="rri reward"><div class="rric">üí∞</div><div><div class="rrt">Long-Term Capital Growth</div><div class="rrb">Your <span id="rr-dep-ltg">$13k</span> deposit on a <span id="rr-price-ltg">$650k</span> asset gives leveraged exposure to property appreciation.</div></div></div>
        </div>
      </div>
    </div>

    <!-- TAB 7: PROJECTION -->
    <div class="section" id="projection">
      <div class="sl">Long-Term Projection</div>

      <!-- Controls (item 8: removed years slider, item 7: suburb growth) -->
      <div class="card proj-controls" style="padding:16px 22px;margin-bottom:14px;display:flex;gap:22px;flex-wrap:wrap;align-items:flex-end;">
        <div class="ca" style="background:var(--gold)"></div>
        <div>
          <div style="font-size:11px;color:var(--slate);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">Annual Growth Rate</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <input type="range" id="proj-growth" min="1" max="12" step="0.5" value="5" oninput="document.getElementById('proj-growth-lbl').textContent=parseFloat(this.value).toFixed(1)+'%';drawProjection()" style="width:110px;accent-color:var(--gold);">
            <span id="proj-growth-lbl" style="font-family:'DM Mono',monospace;font-size:13px;color:var(--gold);min-width:38px;">5.0%</span>
          </div>
          <div id="suburb-growth-hint" style="font-size:10px;color:var(--slate);margin-top:4px;font-style:italic;max-width:200px;"></div>
        </div>
<!-- reno uplift removed (item 9) -->
        <div>
          <button id="fetch-growth-btn" onclick="fetchSuburbGrowth()" style="background:var(--charcoal);color:var(--gold);border:1px solid rgba(201,168,76,0.4);padding:7px 14px;border-radius:3px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:0.5px;">üîç Look Up Suburb Growth</button>
          <div style="font-size:10px;color:var(--slate);margin-top:4px;font-style:italic;">Uses suburb from Property tab</div>
        </div>
      </div>

      <!-- Milestone tiles (item 9) -->
      <div class="tiles" style="grid-template-columns:repeat(2,1fr);margin-bottom:14px;" id="proj-tiles">
        <div class="tile"><div class="tile-dot" style="background:var(--sky)"></div><div class="tile-val" id="proj-payoff-yr">‚Äî</div><div class="tile-lbl">Loan Paid Off</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--sage)"></div><div class="tile-val" id="proj-buyout-yr">‚Äî</div><div class="tile-lbl">Can Buy Out Govt</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--gold)"></div><div class="tile-val" id="proj-val-5">‚Äî</div><div class="tile-lbl">Property Value @ Yr 5</div></div>
        <div class="tile"><div class="tile-dot" style="background:var(--terracotta)"></div><div class="tile-val" id="proj-govt-5">‚Äî</div><div class="tile-lbl">Govt Equity Owed @ Yr 5</div></div>
      </div>

      <!-- SVG Chart with click tooltip (items 6, 9) -->
      <div class="card">
        <div class="ca" style="background:var(--sky)"></div>
        <h3>30-Year Property Projection</h3>
        <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:14px;font-size:11px;">
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:#C9A84C;display:inline-block;border-radius:2px;"></span>Property Value</span>
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;border-top:3px dashed #5B8FAB;display:inline-block;"></span>Loan Balance</span>
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:#C4704A;display:inline-block;border-radius:2px;"></span>Govt Equity Owed</span>
          <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:#5A9E7B;display:inline-block;border-radius:2px;opacity:0.4;"></span>Your Equity</span>
        </div>
        <div style="font-size:11px;color:var(--slate);margin-bottom:8px;font-style:italic;">Click on chart to see values at that year</div>
        <div style="overflow-x:auto;position:relative;">
          <svg id="proj-chart" width="100%" height="320" viewBox="0 0 800 320" style="display:block;min-width:440px;cursor:crosshair;"></svg>
          <!-- Click tooltip (item 6) -->
          <div id="proj-tooltip" style="display:none;position:absolute;background:var(--charcoal);color:var(--cream);border-radius:4px;padding:10px 14px;font-family:'DM Mono',monospace;font-size:11px;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,0.35);border:1px solid rgba(201,168,76,0.3);min-width:180px;z-index:10;"></div>
        </div>
      </div>

      <!-- Milestones card (item 9) -->
      <div class="card">
        <div class="ca" style="background:var(--reward-green)"></div>
        <h3>Key Milestones</h3>
        <div id="proj-milestones" class="tl" style="margin-top:10px;"></div>
      </div>

      <!-- Year-by-year table -->
      <div class="card">
        <div class="ca" style="background:var(--terracotta)"></div>
        <h3>Year-by-Year Breakdown</h3>
        <p style="font-size:12px;color:var(--slate);margin-bottom:14px;line-height:1.6;">Govt equity owed = their % share of the property value at that year. Pay this amount to exit the scheme.</p>
        <div style="overflow-x:auto;"><div id="proj-table"></div></div>
      </div>
    </div>

  </main>
</div>
</div>

<script>
  const CIRC = 263.89; // 2*pi*42

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
  function fmt(n){const a=Math.abs(n),s=n<0?'-':'';if(a>=1e6)return s+'$'+(a/1e6).toFixed(2)+'M';if(a>=1000)return s+'$'+Math.round(a).toLocaleString();return s+'$'+Math.round(a);}
  function fmtK(n){const a=Math.abs(n),s=n<0?'-':'';if(a>=1e6)return s+'$'+(a/1e6).toFixed(1)+'M';if(a>=1000)return s+'$'+Math.round(a/1000)+'k';return s+'$'+Math.round(a);}
  function pctS(n){return n.toFixed(1)+'%';}
  function v(id){return parseFloat(document.getElementById(id).value)||0;}
  function set(id,val){const el=document.getElementById(id);if(el)el.textContent=val;}
  function css(id,prop,val){const el=document.getElementById(id);if(el)el.style[prop]=val;}
  function attr(id,a,val){const el=document.getElementById(id);if(el)el.setAttribute(a,val);}

  function syncRange(key){const i=document.getElementById('inp-'+key),r=document.getElementById('rng-'+key);if(r)r.value=i.value;rl(key,parseFloat(i.value));}
  function syncInput(key){const i=document.getElementById('inp-'+key),r=document.getElementById('rng-'+key);if(i)i.value=r.value;rl(key,parseFloat(r.value));}
  function rl(key,val){
    const el=document.getElementById('lbl-'+key);if(!el)return;
    if(['price','savings','bank','conv','pest','r1','r2','r3','r4','r5','r6','rent'].includes(key))el.textContent=fmt(val);
    else if(key==='term')el.textContent=val+' yrs';
    else if(key==='weeks')el.textContent=val;
    else el.textContent=val.toFixed(key==='cont'?0:1)+'%';
  }

  function calcMonthly(principal,annualRate,years){
    if(principal<=0)return 0;if(annualRate===0)return principal/(years*12);
    const r=annualRate/100/12,n=years*12;
    return principal*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
  }

  // ‚îÄ‚îÄ DYNAMIC COST ITEMS ‚îÄ‚îÄ
  let dynCosts=[];
  let dynId=0;

  // ‚îÄ‚îÄ ALL PURCHASE COSTS ARE NOW DYNAMIC (item 14) ‚îÄ‚îÄ
  // Seeded with defaults in initPage()
  function addCostItem(){
    const id='dyn-'+dynId++;
    dynCosts.push({id,name:'New Item',amount:0});
    renderDynCosts();
    recalc();
  }

  function removeCostItem(id){
    dynCosts=dynCosts.filter(c=>c.id!==id);
    renderDynCosts();
    recalc();
  }

  function renderDynCosts(){
    const list=document.getElementById('cost-items-list');
    if(!list) return;
    list.innerHTML='';
    dynCosts.forEach(cost=>{
      const row=document.createElement('div');
      row.className='dyn-cost-row';
      row.innerHTML=`
        <input type="text" value="${(cost.name||'').replace(/"/g,'&quot;')}" placeholder="Item name" style="flex:1.4" oninput="updateDynCost('${cost.id}','name',this.value)">
        <div class="iw" style="flex:1;position:relative;"><span class="ipfx">$</span><input type="number" value="${cost.amount||0}" min="0" step="50" oninput="updateDynCost('${cost.id}','amount',parseFloat(this.value)||0);recalc()"></div>
        <button class="dyn-del" onclick="removeCostItem('${cost.id}')" title="Remove">‚àí</button>
      `;
      list.appendChild(row);
    });
  }

  function updateDynCost(id,field,val){
    const c=dynCosts.find(x=>x.id===id);
    if(c){c[field]=val;if(field==='amount')recalc();}
  }

  function getExtraCosts(){
    return dynCosts.reduce((s,c)=>s+(parseFloat(c.amount)||0),0);
  }

  // ‚îÄ‚îÄ RENO ITEMS ‚Äî dynamic custom items (item 13) ‚îÄ‚îÄ
  let renoItems=[]; // [{id, emoji, name, amount, note}]
  let renoItemId=0;

  const RENO_EMOJIS=['üé®','üç≥','üöø','ü™µ','üí°','üåø','ü™ü','üö™','üß±','üõÅ','‚ùÑÔ∏è','üîß','üèó','üè†','‚ö°','üíß','üî®','ü™¥','‚ú®','‚ö†Ô∏è'];

  function addRenoItem(name='New Item', amount=0, emoji='üî®', note=''){
    const id='ri-'+renoItemId++;
    renoItems.push({id, emoji, name, amount, note});
    renderRenoItems();
    recalc();
    // Scroll to the new item
    setTimeout(()=>{
      const el=document.querySelector(`[data-reno="${id}"]`);
      if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
    },100);
  }

  function removeRenoItem(id){
    renoItems=renoItems.filter(r=>r.id!==id);
    renderRenoItems();
    recalc();
  }

  function updateRenoItem(id,field,val){
    const r=renoItems.find(x=>x.id===id);
    if(r){r[field]=val;if(field==='amount')recalc();}
  }

  function getRenoTotal(){
    return renoItems.reduce((s,r)=>s+(parseFloat(r.amount)||0),0);
  }

  function renderRenoItems(){
    const list=document.getElementById('reno-items-list');
    if(!list) return;
    const total = getRenoTotal();
    const maxAmt = Math.max(...renoItems.map(r=>parseFloat(r.amount)||0), 1);
    list.innerHTML = renoItems.map(r=>{
      const pct = maxAmt>0 ? Math.min((parseFloat(r.amount)||0)/maxAmt*100,100) : 0;
      const emojiOpts = RENO_EMOJIS.map(e=>`<option value="${e}" ${e===r.emoji?'selected':''}>${e}</option>`).join('');
      return `<div data-reno="${r.id}" style="border-bottom:1px solid rgba(28,28,30,0.07);padding-bottom:10px;margin-bottom:10px;">
        <div class="reno-row">
          <select style="width:38px;flex-shrink:0;background:none;border:none;font-size:16px;cursor:pointer;padding:0;" onchange="updateRenoItem('${r.id}','emoji',this.value);renderRenoItems()">${emojiOpts}</select>
          <input type="text" value="${(r.name||'').replace(/"/g,'&quot;')}" placeholder="Item name" style="flex:1;background:none;border:none;border-bottom:1px solid rgba(28,28,30,0.1);padding:3px 4px;font-size:13px;font-weight:500;color:var(--charcoal);outline:none;" oninput="updateRenoItem('${r.id}','name',this.value)" onfocus="this.style.borderColor='var(--sage)'" onblur="this.style.borderColor='rgba(28,28,30,0.1)'">
          <div class="rbt" style="max-width:60px;"><div class="rbf" style="width:${pct}%"></div></div>
          <div style="display:flex;align-items:center;gap:2px;min-width:90px;">
            <span style="font-size:14px;color:var(--slate);">$</span><input type="number" value="${r.amount||0}" min="0" step="100" style="width:90px;background:none;border:none;border-bottom:1px solid rgba(28,28,30,0.1);padding:4px 2px;font-family:'DM Mono',monospace;font-size:16px;color:var(--charcoal);outline:none;text-align:right;font-weight:500;" oninput="updateRenoItem('${r.id}','amount',parseFloat(this.value)||0);recalc();renderRenoItems()" onfocus="this.style.borderColor='var(--sage)'" onblur="this.style.borderColor='rgba(28,28,30,0.1)'">
          </div>
          <button class="kd-del" onclick="removeRenoItem('${r.id}')" title="Remove" style="flex-shrink:0;">‚úï</button>
        </div>
        <div class="reno-note-wrap" style="padding-left:44px;">
          <textarea class="reno-note" placeholder="Notes, quotes, scope of work‚Ä¶" rows="1" oninput="updateRenoItem('${r.id}','note',this.value);this.style.height='auto';this.style.height=this.scrollHeight+'px'">${r.note||''}</textarea>
        </div>
      </div>`;
    }).join('');
    // sidebar total
    const stEl=document.getElementById('lbl-reno-total');
    if(stEl){ const ct=v('inp-cont'); stEl.textContent=fmtK(total*(1+ct/100)); }
  }

  // ‚îÄ‚îÄ MAIN RECALC ‚îÄ‚îÄ
  const DRAFT_KEY = 'propCalc_draft_v1';
  let _draftTimer = null;
  function autosaveDraft(){
    if(_restoringDraft) return;
    clearTimeout(_draftTimer);
    _draftTimer = setTimeout(()=>{
      try{
        const state = collectCurrentState();
        lsSet(DRAFT_KEY, JSON.stringify({state, photo: propPhotoDataUrl||'', thumb: propThumbDataUrl||'', savedId: _lastSavedAddr||''}));
        _isDirty = true;
        updateUnsavedBadge();
      }catch(e){}
    }, 800);
  }
  function restoreDraft(){
    try{
      const raw = lsGet(DRAFT_KEY);
      if(!raw) return false;
      const draft = JSON.parse(raw);
      if(!draft || !draft.state) return false;
      _restoringDraft = true;
      // Restore photo ‚Äî only if it fits (skip silently if corrupt)
      if(draft.photo && draft.photo.startsWith('data:')){
        try{ propPhotoDataUrl = draft.photo; propThumbDataUrl = draft.thumb||''; applyPropPhoto(draft.photo); }catch(pe){}
      } else if(draft.photo && draft.photo.startsWith('http')){
        try{ propPhotoDataUrl = draft.photo; propThumbDataUrl = draft.photo; applyPropPhoto(draft.photo); }catch(pe){}
      }
      applyScenarioState(draft.state, null);
      // Always land on property tab after restore
      const propTabBtn = document.querySelector('.tab[onclick*="property"]');
      if(propTabBtn) showTab('property', propTabBtn);
      // Restore saved address so unsaved badge doesn't fire
      if(draft.savedId) _lastSavedAddr = draft.savedId;
      _restoringDraft = false;
      _isDirty = false;
      return true;
    }catch(e){ console.warn('restoreDraft failed:', e); _restoringDraft = false; return false; }
  }
  function recalc(){
    autosaveDraft();
    const price   = v('inp-price');
    const savings = v('inp-savings');
    const depPct  = v('inp-depp');
    const govtPct = v('inp-govt');
    const rate    = v('inp-rate');
    const term    = v('inp-term');
    const contPct = v('inp-cont');
    const address = document.getElementById('inp-address').value||'your property';

    const deposit  = price*depPct/100;
    const govtAmt  = price*govtPct/100;
    const loanAmt  = Math.max(0,price-deposit-govtAmt);
    const extraCosts = getExtraCosts();
    const upfront  = deposit+extraCosts;
    const remaining = savings-upfront;

    const monthly = calcMonthly(loanAmt,rate,term);
    const weekly  = monthly*12/52;
    const totalPaid = monthly*term*12;
    const totalInterest = totalPaid-loanAmt;

    // Use dynamic reno items system (item 13)
    const renoBase=getRenoTotal();
    const contingency=renoBase*contPct/100;
    const renoTotal=renoBase+contingency;

    // overlap (may be disabled by item 12 rent toggle)
    const rentEnabled = document.getElementById('rent-sidebar-section')?.style.display !== 'none';
    const rent  = rentEnabled ? v('inp-rent') : 0;
    const weeks = rentEnabled ? v('inp-weeks') : 0;
    const overlapCost = (rent+weekly)*weeks;
    const cashAfterOverlap = remaining-overlapCost;

    // ‚îÄ‚îÄ‚îÄ sidebar labels ‚îÄ‚îÄ‚îÄ
    ['price','savings','depp','govt','rate','term','cont','rent','weeks'].forEach(k=>{
      const el=document.getElementById('inp-'+k);if(el)rl(k,parseFloat(el.value)||0);
    });
    // sidebar reno total
    const stEl2=document.getElementById('lbl-reno-total');
    if(stEl2) stEl2.textContent=fmtK(renoTotal);

    document.getElementById('page-title').textContent=address;

    // ‚îÄ‚îÄ‚îÄ TAB 1: COSTS ‚îÄ‚îÄ‚îÄ
    set('t-price',fmtK(price));
    set('t-deposit',fmtK(deposit));
    set('t-govt',fmtK(govtAmt));
    const remEl=document.getElementById('t-remaining');if(remEl){remEl.textContent=fmtK(remaining);remEl.style.color=remaining<0?'var(--risk-red)':'';}

    set('cb-savings',fmt(savings));
    set('cb-out','‚àí'+fmt(upfront));
    const cbR=document.getElementById('cb-remaining');
    if(cbR){cbR.textContent=fmt(remaining);cbR.style.color=remaining<0?'var(--risk-red)':'var(--sage-light)';}

    set('cr-deposit',fmt(deposit));

    // dynamic cost rows display (all costs now dynamic, item 14)
    const display=document.getElementById('cost-rows-display');
    if(display){
      let html='';
      dynCosts.forEach(c=>{
        html+=`<div class="cr"><span class="nm">${(c.name||'Item').replace(/</g,'&lt;')}</span><span class="am">${fmt(parseFloat(c.amount)||0)}</span></div>`;
      });
      display.innerHTML=html;
    }
    set('cr-total',fmt(upfront));

    const noteEl=document.getElementById('cost-note');
    if(noteEl){
      if(remaining<0){noteEl.textContent=`‚ö†Ô∏è Shortfall of ${fmt(Math.abs(remaining))} ‚Äî increase savings or reduce costs.`;noteEl.style.cssText='margin-top:10px;padding:8px 10px;border-radius:3px;font-size:11px;line-height:1.6;background:rgba(196,90,90,0.1);color:var(--risk-red)';}
      else{noteEl.textContent=`üí° ${fmt(remaining)} remaining after settlement ‚Äî available for renovations or emergency buffer.`;noteEl.style.cssText='margin-top:10px;padding:8px 10px;border-radius:3px;font-size:11px;line-height:1.6;background:rgba(201,168,76,0.1);color:var(--slate)';}
    }

    // donut
    const tp=price,bP=tp>0?loanAmt/tp:0,gP=tp>0?govtAmt/tp:0,dP=tp>0?deposit/tp:0;
    const bD=bP*CIRC,gD=gP*CIRC,dD=dP*CIRC;
    attr('d-bank','stroke-dasharray',`${bD} ${CIRC}`);
    attr('d-govt','stroke-dasharray',`${gD} ${CIRC}`);attr('d-govt','stroke-dashoffset',`-${bD}`);
    attr('d-you','stroke-dasharray',`${dD} ${CIRC}`);attr('d-you','stroke-dashoffset',`-${bD+gD}`);
    set('d-centre',fmtK(price));
    set('leg-bank',fmtK(loanAmt));set('leg-govt',fmtK(govtAmt));set('leg-you',fmtK(deposit));
    set('bp-bank',pctS(bP*100));css('bf-bank','width',pctS(bP*100));
    set('bp-govt',pctS(gP*100));css('bf-govt','width',pctS(gP*100));
    set('bp-dep',pctS(dP*100));css('bf-dep','width',pctS(dP*100));

    // sidebar alert
    const sa=document.getElementById('sidebar-alert');
    if(sa){
      if(remaining<0)sa.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è Savings shortfall of ${fmt(Math.abs(remaining))}.</div>`;
      else if(cashAfterOverlap<5000&&weeks>0)sa.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è After overlap, only ${fmt(cashAfterOverlap)} left for reno.</div>`;
      else sa.innerHTML=`<div class="alert alert-ok">‚úì Cash position viable. ${fmt(remaining)} after settlement.</div>`;
    }

    // ‚îÄ‚îÄ‚îÄ TAB 2: RENO ‚îÄ‚îÄ‚îÄ
    const rpEl=document.getElementById('reno-pool-val');
    if(rpEl){rpEl.textContent=fmtK(remaining);rpEl.style.color=remaining<0?'var(--risk-red)':'var(--sage)';}
    const unspent = remaining - renoTotal;
    const ruEl=document.getElementById('reno-unspent-val');
    if(ruEl){ruEl.textContent=fmtK(unspent);ruEl.style.color=unspent<0?'var(--risk-red)':unspent<5000?'var(--terracotta)':'var(--reward-green)';}
    set('reno-planned',fmt(renoTotal));set('reno-pool-cap',fmt(remaining));set('reno-total',fmt(renoTotal));
    const rpct=remaining>0?Math.min(renoTotal/remaining*100,200):100;
    css('reno-spend-bar','width',Math.min(rpct,100)+'%');
    css('reno-spend-bar','background',rpct>100?'var(--risk-red)':'var(--sage)');
    set('reno-spend-pct',Math.round(rpct)+'%');
    const rpaEl=document.getElementById('reno-pool-alert');
    if(rpaEl){
      if(!renoEnabled){rpaEl.innerHTML='';}
      else if(remaining<0)rpaEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è No reno budget ‚Äî savings don't cover upfront costs.</div>`;
      else if(renoTotal>remaining)rpaEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è Reno plan (${fmt(renoTotal)}) exceeds pool (${fmt(remaining)}). Trim items or increase savings.</div>`;
      else rpaEl.innerHTML=`<div class="alert alert-ok">‚úì Fits budget ‚Äî ${fmt(remaining-renoTotal)} to spare after reno.</div>`;
    }

    // ‚îÄ‚îÄ‚îÄ TAB 3: REPAYMENTS ‚îÄ‚îÄ‚îÄ
    set('rp-monthly',fmt(monthly));set('rp-weekly',fmt(weekly));set('rp-annual',fmt(monthly*12));
    set('rp-rate-lbl','@ '+rate+'%');set('rp-term-lbl',term+'yr term');set('rp-loan-lbl',fmtK(loanAmt)+' loan');
    set('rp-interest',fmt(totalInterest));set('rp-total-paid',fmt(totalPaid));set('rp-loan-show',fmt(loanAmt));

    const stEl=document.getElementById('stress-table');
    if(stEl){
      const rates=[rate,rate+0.5,rate+1,rate+2,rate+3];
      let html=`<div style="font-family:'DM Mono',monospace;font-size:11px"><div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;margin-bottom:6px;color:var(--slate);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding-bottom:5px;border-bottom:1px solid rgba(28,28,30,0.1)"><span>Rate</span><span>Monthly</span><span>Annual</span><span>Change</span></div>`;
      rates.forEach((r,i)=>{
        const m=calcMonthly(loanAmt,r,term),d=m-monthly,cur=i===0;
        html+=`<div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;padding:6px 0;border-top:1px solid rgba(28,28,30,0.06)${cur?';background:rgba(201,168,76,0.06);border-radius:2px':''}"><span style="color:${cur?'var(--gold)':'var(--slate)'}">${r.toFixed(1)}%${cur?' ‚Üê':''}</span><span>${fmt(m)}</span><span>${fmt(m*12)}</span><span style="color:${i===0?'var(--slate)':d>600?'var(--risk-red)':'var(--terracotta)'}">${i===0?'current':'+'+fmt(d)+'/mo'}</span></div>`;
      });
      stEl.innerHTML=html+'</div>';
    }

    // ‚îÄ‚îÄ‚îÄ TAB 4: RENT OVERLAP ‚îÄ‚îÄ‚îÄ
    const weeklyMort=weekly;
    const combinedWeekly=rent+weeklyMort;
    const totalOverlap=combinedWeekly*weeks;
    const cashAfter=remaining-totalOverlap;

    set('ov-weekly-total',fmt(combinedWeekly));
    set('ov-total-cost',fmt(totalOverlap));
    const ovR=document.getElementById('ov-remaining-after');
    if(ovR){ovR.textContent=fmt(cashAfter);ovR.style.color=cashAfter<0?'var(--risk-red)':'';}

    set('ov-rent-wk',fmt(rent));set('ov-mort-wk',fmt(weeklyMort));
    set('ov-rent-pct',combinedWeekly>0?Math.round(rent/combinedWeekly*100)+'%':'0%');
    set('ov-mort-pct',combinedWeekly>0?Math.round(weeklyMort/combinedWeekly*100)+'%':'0%');
    css('ov-rent-bar','width',combinedWeekly>0?(rent/combinedWeekly*100)+'%':'0%');
    css('ov-mort-bar','width',combinedWeekly>0?(weeklyMort/combinedWeekly*100)+'%':'0%');

    set('ov-s-rent',fmt(rent));set('ov-s-mort',fmt(weeklyMort));
    set('ov-s-combined',fmt(combinedWeekly));
    set('ov-s-weeks',weeks);set('ov-s-total',fmt(totalOverlap));
    set('ov-buf-start',fmt(remaining));
    set('ov-buf-overlap','‚àí'+fmt(totalOverlap));
    const ovFinal=document.getElementById('ov-buf-final');
    if(ovFinal){ovFinal.textContent=fmt(cashAfter);ovFinal.style.color=cashAfter<0?'var(--risk-red)':cashAfter<10000?'var(--terracotta)':'var(--reward-green)';}

    const advEl=document.getElementById('ov-advice');
    if(advEl){
      if(weeks===0)advEl.innerHTML=`<div class="alert alert-ok">‚úì No overlap period ‚Äî you move in straight after renovation. Maximum cash preserved.</div>`;
      else if(cashAfter<0)advEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è The overlap cost (${fmt(totalOverlap)}) exceeds your remaining cash. You'll need extra funds or to reduce the overlap period.</div>`;
      else if(cashAfter<8000)advEl.innerHTML=`<div class="alert alert-warn">‚ö†Ô∏è Tight ‚Äî only ${fmt(cashAfter)} left for reno. Consider reducing overlap weeks or the reno scope.</div>`;
      else advEl.innerHTML=`<div class="alert alert-ok">‚úì Manageable ‚Äî ${fmt(cashAfter)} still available for renovations after the ${weeks}-week overlap.</div>`;
    }

    // calendar grid
    const calEl=document.getElementById('cal-grid');
    if(calEl&&weeks>=0){
      const totalW=Math.max(8,weeks+4);
      let html=`<div style="display:grid;grid-template-columns:repeat(${Math.min(totalW,12)},1fr);gap:3px;margin-bottom:4px">`;
      for(let i=0;i<Math.min(totalW,12);i++){
        const label='Wk '+(i+1);
        const cls=i<weeks?'cal-both':'cal-mortgage';
        html+=`<div class="cal-cell ${cls}" title="${i<weeks?'Rent + Mortgage':'Mortgage only'}">${i+1}</div>`;
      }
      html+='</div>';
      html+=`<div style="font-size:11px;color:var(--slate);margin-top:6px">`;
      html+=`<span style="display:inline-flex;align-items:center;gap:5px;margin-right:12px"><span style="width:10px;height:10px;border-radius:2px;background:var(--terracotta);display:inline-block"></span>Paying rent + mortgage</span>`;
      html+=`<span style="display:inline-flex;align-items:center;gap:5px"><span style="width:10px;height:10px;border-radius:2px;background:var(--sky);display:inline-block"></span>Mortgage only</span>`;
      html+='</div>';
      calEl.innerHTML=html;
    }

    // overlap scenarios
    const scEl=document.getElementById('overlap-scenarios');
    if(scEl){
      const scenWeeks=[0,2,4,6,8,12];
      let html=`<div style="font-family:'DM Mono',monospace;font-size:11px"><div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;margin-bottom:6px;color:var(--slate);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding-bottom:5px;border-bottom:1px solid rgba(28,28,30,0.1)"><span>Weeks</span><span>Overlap Cost</span><span>Reno Budget Left</span><span>Status</span></div>`;
      scenWeeks.forEach(w=>{
        const cost=combinedWeekly*w;
        const left=remaining-cost;
        const isCur=w===weeks;
        const status=left<0?'‚ö† Shortfall':left<8000?'‚ö° Tight':'‚úì OK';
        const sc=left<0?'var(--risk-red)':left<8000?'var(--terracotta)':'var(--reward-green)';
        html+=`<div style="display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;padding:6px 0;border-top:1px solid rgba(28,28,30,0.06)${isCur?';background:rgba(201,168,76,0.06);border-radius:2px':''}">
          <span style="color:${isCur?'var(--gold)':'var(--slate)'}">${w}wk${isCur?' ‚Üê':''}</span>
          <span>${fmt(cost)}</span>
          <span style="color:${sc}">${fmt(left)}</span>
          <span style="color:${sc}">${status}</span>
        </div>`;
      });
      scEl.innerHTML=html+'</div>';
    }

    // ‚îÄ‚îÄ‚îÄ TAB 5: TIMELINE ‚îÄ‚îÄ‚îÄ
    set('tl-address',address);
    const ob=document.getElementById('tl-overlap-badge');
    if(ob)ob.textContent=weeks>0?weeks+' wks':'Optional';
    const od=document.getElementById('tl-overlap-desc');
    if(od)od.textContent=weeks>0?`You continue renting for ${weeks} weeks while renovations begin ‚Äî paying ${fmt(combinedWeekly)}/wk (rent + mortgage) for a total of ${fmt(totalOverlap)}.`:'No overlap planned ‚Äî you move in immediately after renovations.';
    const olDur=document.getElementById('tl-overlap-dur');
    if(olDur)olDur.textContent=weeks>0?`Weeks 1‚Äì${weeks} post-settlement`:'Immediate move-in';

    // ‚îÄ‚îÄ‚îÄ TAB 6: RISKS ‚îÄ‚îÄ‚îÄ
    const riskScore=Math.min(90,Math.max(15,
      20+(depPct<5?20:depPct<10?10:0)+(rate>7?15:rate>6?5:0)+(govtPct>20?-8:0)
        +(remaining<5000?25:remaining<15000?10:0)+(weeks>8?10:weeks>4?5:0)
    ));
    const rewardScore=Math.min(95,Math.max(25,
      35+(govtPct>0?20:0)+(remaining>20000?15:remaining>10000?8:0)+(renoTotal>10000?10:5)+(price<650000?5:0)
    ));
    css('risk-meter','width',riskScore+'%');css('reward-meter','width',rewardScore+'%');
    set('risk-desc',riskScore<30?'Low risk ‚Äî strong equity and healthy cash buffer.':riskScore<50?'Moderate risk ‚Äî manageable with the government scheme reducing LVR.':riskScore<70?'Medium-high risk ‚Äî consider increasing deposit or savings buffer.':'Higher risk ‚Äî savings are tight. Build a larger buffer before proceeding.');
    set('reward-desc',rewardScore>70?'High reward potential ‚Äî strong equity uplift through renovation and capital growth.':rewardScore>50?'Good reward potential ‚Äî renovation and scheme create solid upside.':'Modest reward potential ‚Äî consider a higher reno budget or larger govt scheme.');
    const m2=calcMonthly(loanAmt,rate+2,term);
    set('rr-rate-delta',fmt(m2-monthly));
    set('rr-dep-pct',pctS(depPct));set('rr-pool-val',fmtK(remaining));
    set('rr-overlap-cost',fmt(totalOverlap));set('rr-overlap-weeks',weeks);
    set('rr-dep-show',fmtK(deposit));set('rr-reno-show',fmtK(renoTotal));
    set('rr-price-show',fmtK(price));set('rr-govt-show',pctS(govtPct));
    set('rr-dep-ltg',fmtK(deposit));set('rr-price-ltg',fmtK(price));
  }

  function showTab(id,btn){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
  }

  const PRESETS={
    base:        {price:650000,savings:40000,depp:2,  govt:28.7,rate:6.2,term:30,bank:800,conv:1600,pest:700,r1:3500,r2:5000,r3:4500,r4:4000,r5:2000,r6:2000,cont:15,rent:450,weeks:4},
    max:         {price:700000,savings:60000,depp:5,  govt:28.7,rate:6.2,term:30,bank:800,conv:1800,pest:700,r1:5000,r2:8000,r3:6000,r4:5000,r5:3000,r6:3000,cont:15,rent:450,weeks:4},
    conservative:{price:600000,savings:50000,depp:10, govt:28.7,rate:7.0,term:25,bank:800,conv:1600,pest:700,r1:2000,r2:3000,r3:2500,r4:2000,r5:1000,r6:1000,cont:20,rent:400,weeks:6},
    nodep:       {price:650000,savings:40000,depp:20, govt:0,   rate:6.5,term:30,bank:800,conv:1600,pest:700,r1:2000,r2:3000,r3:2000,r4:2000,r5:1000,r6:500, cont:10,rent:450,weeks:2},
  };

  function loadPreset(key){
    const p=PRESETS[key];
    Object.entries(p).forEach(([k,val])=>{
      const inp=document.getElementById('inp-'+k),rng=document.getElementById('rng-'+k);
      if(inp)inp.value=val;if(rng)rng.value=val;rl(k,val);
    });
    dynCosts=[];renderDynCosts();
    recalc();
  }

  function handlePhotoDrop(e){
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const file=e.dataTransfer.files[0];
    if(file&&file.type.startsWith('image/'))handlePropPhotoFile(file);
  }

  function handlePhotoFile(file){
    if(!file)return;
    handlePropPhotoFile(file);
  }

  // ‚îÄ‚îÄ PROPERTY DETAILS ‚îÄ‚îÄ
  let propPhotoDataUrl = '';
  let _lastSavedAddr = null;
  let _isDirty = false;
  let _restoringDraft = false; // suppresses autosaveDraft during restore
  let propThumbDataUrl = ''; // small thumbnail for library

  function handlePropPhotoDrop(e){
    e.preventDefault();
    e.currentTarget.classList.remove('pd-drag');
    const file = e.dataTransfer.files[0];
    if(file && file.type.startsWith('image/')) handlePropPhotoFile(file);
  }

  function handlePropPhotoFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const img = new Image();
      img.onload = function(){
        // Resize to max 900px wide for storage (reduces from ~3MB to ~80-150KB)
        const MAX = 900;
        const ratio = Math.min(1, MAX / Math.max(img.width, img.height));
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        propPhotoDataUrl = c.toDataURL('image/jpeg', 0.82);
        // Also store a small thumbnail (200px) for the library grid
        const THUMB = 200;
        const tr = Math.min(1, THUMB / Math.max(img.width, img.height));
        const tw = Math.round(img.width * tr);
        const th = Math.round(img.height * tr);
        const tc = document.createElement('canvas');
        tc.width = tw; tc.height = th;
        tc.getContext('2d').drawImage(img, 0, 0, tw, th);
        propThumbDataUrl = tc.toDataURL('image/jpeg', 0.72);
        applyPropPhoto(propPhotoDataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function applyPropPhoto(src){
    // big preview in details tab
    const big = document.getElementById('pd-photo-big');
    const prompt = document.getElementById('pd-upload-prompt');
    const overlay = document.getElementById('pd-photo-overlay');
    if(big){ big.src = src; big.style.display = 'block'; }
    if(prompt) prompt.style.display = 'none';
    if(overlay) overlay.style.display = 'flex';
    // header thumbnail
    const hImg = document.getElementById('prop-img');
    const hZone = document.getElementById('upload-zone');
    if(hImg){ hImg.src = src; hImg.style.display = 'block'; }
    if(hZone) hZone.style.display = 'none';
    // preview thumb in details tab
    const prevPhoto = document.getElementById('pd-preview-photo');
    if(prevPhoto) prevPhoto.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover;">`;
    updatePropertyDetails();
  }

  function clearPropPhoto(){
    propPhotoDataUrl = '';
    propThumbDataUrl = '';
    const big = document.getElementById('pd-photo-big');
    const prompt = document.getElementById('pd-upload-prompt');
    const overlay = document.getElementById('pd-photo-overlay');
    if(big){ big.src=''; big.style.display='none'; }
    if(prompt) prompt.style.display = 'flex';
    if(overlay) overlay.style.display = 'none';
    const hImg = document.getElementById('prop-img');
    const hZone = document.getElementById('upload-zone');
    if(hImg){ hImg.src=''; hImg.style.display='none'; }
    if(hZone) hZone.style.display = 'flex';
    const prevPhoto = document.getElementById('pd-preview-photo');
    if(prevPhoto) prevPhoto.innerHTML = 'üì∑';
    updatePropertyDetails();
  }

  // ‚îÄ‚îÄ PHOTO URL PASTE (item 11) ‚îÄ‚îÄ
  function handlePhotoUrlInput(val){
    // Real-time preview while typing a URL (debounced via existing input handler)
  }
  function applyPhotoUrl(){
    const urlEl = document.getElementById('pd-photo-url');
    const url   = urlEl?.value?.trim();
    if(!url){ showToast('‚ö†Ô∏è Paste an image URL first'); return; }
    propPhotoDataUrl = url;
    applyPropPhoto(url);
    showToast('üñºÔ∏è Photo loaded from URL');
  }

  function stepStat(id, delta){
    const el = document.getElementById(id);
    if(!el) return;
    const val = (parseInt(el.value) || 0) + delta;
    el.value = Math.max(0, val);
    updatePropertyDetails();
  }

  function setPropType(btn, type){
    document.querySelectorAll('.prop-type-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('pd-type').value = type;
    updatePropertyDetails();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ADDRESS AUTOCOMPLETE ‚Äî QLD Open Data CKAN API
  // Free, no sign-up, no API key required.
  // Falls back gracefully if unavailable.
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let _addrTimer = null;
  let _lastAddrQuery = '';

  async function addrAutocomplete(val){
    val = val.trim();
    if(val.length < 4){ hideAddrSuggestions(); return; }
    if(val === _lastAddrQuery) return;
    _lastAddrQuery = val;
    clearTimeout(_addrTimer);
    _addrTimer = setTimeout(async () => {
      try {
        // Nominatim (OpenStreetMap) ‚Äî free, no auth, covers all of Australia
        const url = 'https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=au&limit=6&q=' + encodeURIComponent(val);
        const r = await fetch(url, {
          headers: {'Accept-Language':'en', 'User-Agent':'PropertyCalc/1.0'},
          signal: AbortSignal.timeout(4000)
        });
        if(!r.ok) throw new Error('no response');
        const j = await r.json();
        if(!j.length){ hideAddrSuggestions(); return; }
        const results = j.map(item => {
          const a = item.address || {};
          const road    = a.road || a.pedestrian || a.path || '';
          const houseNo = a.house_number || '';
          const street  = houseNo ? houseNo + ' ' + road : road;
          const suburb  = a.suburb || a.neighbourhood || a.city_district || a.town || a.village || a.hamlet || '';
          const state   = a.state_code || a.state || '';
          const postcode = a.postcode || '';
          // Use display_name if we couldn't parse well
          const display = street || item.display_name.split(',')[0];
          return { address: display, suburb, state: ({'queensland':'QLD','new south wales':'NSW','victoria':'VIC','western australia':'WA','south australia':'SA','tasmania':'TAS','northern territory':'NT','australian capital territory':'ACT'}[((a.state_code||a.state||'')).toLowerCase().replace(/^state of /,'')] || 'QLD'), postcode };
        }).filter(r => r.address);
        if(!results.length){ hideAddrSuggestions(); return; }
        showAddrSuggestions(results);
      } catch(e) {
        hideAddrSuggestions();
      }
    }, 400);
  }

  function showAddrSuggestions(results){
    const box = document.getElementById('addr-suggestions');
    if(!box || !results.length){ hideAddrSuggestions(); return; }
    box.innerHTML = results.map(r =>
      `<div class="addr-suggestion" onmousedown="selectAddress(${JSON.stringify(r).replace(/"/g,'&quot;')})">
        <strong>${r.address}</strong><br><span>${r.suburb}${r.postcode ? ', '+r.postcode : ''} ${r.state}</span>
      </div>`
    ).join('');
    box.style.display = 'block';
  }

  function hideAddrSuggestions(){
    const box = document.getElementById('addr-suggestions');
    if(box) box.style.display = 'none';
  }

  function selectAddress(r){
    const addrEl   = document.getElementById('pd-address');
    const suburbEl = document.getElementById('pd-suburb');
    const stateEl  = document.getElementById('pd-state');
    if(addrEl)   addrEl.value   = r.address || '';
    if(suburbEl) suburbEl.value = r.suburb  || '';
    if(stateEl)  stateEl.value  = r.state   || 'QLD';
    hideAddrSuggestions();
    updatePropertyDetails();
  }

  function updatePropertyDetails(){
    autosaveDraft();
    const address = document.getElementById('pd-address').value;
    const suburb  = document.getElementById('pd-suburb').value;
    const state   = document.getElementById('pd-state').value;
    const bed     = parseInt(document.getElementById('pd-bed').value) || 0;
    const bath    = parseInt(document.getElementById('pd-bath').value) || 0;
    const car     = parseInt(document.getElementById('pd-car').value) || 0;
    const land    = document.getElementById('pd-land').value;
    const house   = document.getElementById('pd-house').value;
    const year    = document.getElementById('pd-year').value;
    const type    = document.getElementById('pd-type').value;
    const url     = document.getElementById('pd-url').value;

    const fullAddr = [address, suburb, state].filter(Boolean).join(', ') || 'New Property';

    // update header title
    const pageTitle = document.getElementById('page-title');
    if(pageTitle) pageTitle.textContent = fullAddr;

    // update header subtitle with stats or fallback
    const statParts = [
      type && type !== 'House' ? type : (address ? 'House' : null),
      bed  ? bed+' bed'  : null,
      bath ? bath+' bath': null,
      car  ? car+' car'  : null,
      land ? land+'m¬≤ land' : null
    ].filter(Boolean);
    const headerSubEl = document.getElementById('header-sub-text');
    if(headerSubEl) headerSubEl.textContent = statParts.length ? statParts.join('  ¬∑  ') : (address ? 'Edit values on the left ‚Äî everything updates live' : 'Add property details in the Property tab to get started');
    // Status badge in header
    const statusVal = document.getElementById('pd-status')?.value || 'browsing';
    const STATUS_BADGE_COLORS = {'browsing':'#5B8FAB','auction':'#C4704A','for-sale':'#C9A84C','offered':'#7B9E87','under-offer':'#E8A882','unconditional':'#5A9E7B','sold':'#C45A5A'};
    const STATUS_BADGE_LABELS = {'browsing':'üëÄ Browsing','auction':'üî® Auction','for-sale':'üè∑ For Sale','offered':'üìù Offer Sent','under-offer':'‚è≥ Under Offer','unconditional':'‚úÖ Unconditional','sold':'üî¥ Sold'};
    let statusBadge = document.getElementById('header-status-badge');
    if(!statusBadge){ statusBadge = document.createElement('div'); statusBadge.id='header-status-badge'; statusBadge.style.cssText='display:inline-block;padding:2px 10px;border-radius:10px;font-family:\'DM Mono\',monospace;font-size:10px;letter-spacing:0.5px;font-weight:500;white-space:nowrap;width:auto;max-width:none;align-self:flex-start;margin-top:4px;'; const h1=document.getElementById('page-title'); if(h1&&h1.parentNode) h1.parentNode.insertBefore(statusBadge, h1.nextSibling); }
    statusBadge.textContent = STATUS_BADGE_LABELS[statusVal] || statusVal;
    statusBadge.style.background = (STATUS_BADGE_COLORS[statusVal]||'#888') + '33';
    statusBadge.style.color = STATUS_BADGE_COLORS[statusVal] || '#888';
    statusBadge.style.border = '1px solid ' + (STATUS_BADGE_COLORS[statusVal]||'#888') + '66';

    const photoCap = document.getElementById('photo-caption');
    if(photoCap) photoCap.textContent = fullAddr;

    // sync address to sidebar
    const sideAddr = document.getElementById('inp-address');
    if(sideAddr && sideAddr.value !== address) sideAddr.value = address;

    // listing URL link
    const urlLink = document.getElementById('pd-url-link');
    const urlAnchor = document.getElementById('pd-url-anchor');
    if(url && url.startsWith('http')){ urlLink.style.display='block'; urlAnchor.href=url; }
    else if(urlLink) urlLink.style.display='none';

    // photo label
    const photoLabel = document.getElementById('pd-photo-label');
    if(photoLabel) photoLabel.textContent = fullAddr;

    // live preview
    const prevTitle = document.getElementById('pd-preview-title');
    if(prevTitle) prevTitle.textContent = fullAddr;

    const statsEl = document.getElementById('pd-preview-stats');
    if(statsEl){
      const chips = [];
      if(type) chips.push(`üè† ${type}`);
      if(bed)  chips.push(`üõè ${bed} bed`);
      if(bath) chips.push(`üöø ${bath} bath`);
      if(car)  chips.push(`üöó ${car} car`);
      if(land) chips.push(`üìê ${land}m¬≤`);
      if(house)chips.push(`üèó ${house}m¬≤ house`);
      if(year) chips.push(`üìÖ Built ${year}`);
      statsEl.innerHTML = chips.map(c=>`<span class="pd-stat-chip">${c}</span>`).join('') || '<span style="font-size:11px;color:rgba(245,240,232,0.3);font-family:\'DM Mono\',monospace;">Fill in details above to see preview</span>';
    }

    recalc();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENO NOTES ‚Äî legacy placeholder (reno items now fully dynamic, item 13)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const renoNotes = {}; // kept for backward compat during load
  function saveRenoNote(i, val){ renoNotes[i] = val; }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHARED STORAGE ‚Äî Netlify Functions + Blobs
  // All visitors to the site share the same data.
  // Falls back to localStorage when running locally.
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const STORAGE_KEY = 'propCalc_v5_index';
  const PHOTO_PFX   = 'propCalc_v5_ph_';
  let scenariosView = 'grid';
  let pendingLoadId = null;
  let _scenariosCache = null;

  function lsGet(k){ try{return localStorage.getItem(k);}catch(e){return null;} }
  function lsSet(k,v){ try{localStorage.setItem(k,v);}catch(e){} }
  function lsDel(k){ try{localStorage.removeItem(k);}catch(e){} }

  // Are we running on Netlify (not a local file)?
  const ON_NETLIFY = window.location.protocol !== 'file:';

  async function getAllScenarios(){
    if(ON_NETLIFY){
      try{
        const r = await fetch('/.netlify/functions/scenarios');
        if(r.ok){
          const data = await r.json();
          // Mirror to localStorage ‚Äî survives Netlify rebuilds as a fallback
          if(data.length) lsSet(STORAGE_KEY, JSON.stringify(data));
          return data;
        }
        console.error('[storage] GET failed:', r.status, await r.text());
      }catch(e){ console.error('[storage] GET exception:', e.message); }
    }
    // Fallback: localStorage (browser-side, survives all rebuilds)
    try{ return JSON.parse(lsGet(STORAGE_KEY)||'[]'); }catch(e){ return []; }
  }

  async function saveScenarioToBackend(record, photoSrc){
    if(ON_NETLIFY){
      try{
        // Send record first (fast ‚Äî no photo payload). Photo uploads in background.
        const r = await fetch('/.netlify/functions/scenarios', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ record, photoSrc: null }) // no photo in main call
        });
        console.log('[storage] POST scenarios status:', r.status);
        if(r.ok){
          // Mirror updated list to localStorage immediately (belt-and-suspenders)
          getAllScenarios().then(latest => { if(latest.length) lsSet(STORAGE_KEY, JSON.stringify(latest)); }).catch(()=>{});
          // Upload full photo separately in background (don't await ‚Äî user sees success immediately)
          if(photoSrc){
            fetch('/.netlify/functions/scenarios', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ record: {id: record.id}, photoSrc })
            }).then(pr => console.log('[storage] photo upload:', pr.status))
              .catch(e => console.warn('[storage] photo upload failed:', e.message));
          }
          return true;
        }
        const txt = await r.text();
        console.error('[storage] POST failed:', r.status, txt);
      }catch(e){ console.error('[storage] POST exception:', e.message); }
    }
    if(photoSrc) lsSet(PHOTO_PFX+record.id, photoSrc);
    let arr=[]; try{ arr=JSON.parse(lsGet(STORAGE_KEY)||'[]'); }catch(e){}
    const i=arr.findIndex(s=>s.id===record.id);
    if(i>=0) arr[i]=record; else arr.unshift(record);
    lsSet(STORAGE_KEY, JSON.stringify(arr));
    return false;
  }

  async function deleteScenarioFromBackend(id){
    if(ON_NETLIFY){
      try{ await fetch('/.netlify/functions/scenarios?id='+id, {method:'DELETE'}); }catch(e){}
    }
    lsDel(PHOTO_PFX+id);
    try{
      const arr=JSON.parse(lsGet(STORAGE_KEY)||'[]').filter(s=>s.id!==id);
      lsSet(STORAGE_KEY, JSON.stringify(arr));
    }catch(e){}
  }

  const _photoCache = {};
  async function getPhoto(id){
    if(_photoCache[id]) return _photoCache[id];
    if(ON_NETLIFY){
      try{
        const r = await fetch('/.netlify/functions/photo?id='+id);
        if(r.ok){ const d=await r.json(); if(d.photoSrc){ _photoCache[id]=d.photoSrc; return d.photoSrc; } return null; }
      }catch(e){}
    }
    const local = lsGet(PHOTO_PFX+id);
    if(local) _photoCache[id] = local;
    return local;
  }

  function showStorageStatus(){
    const el = document.getElementById('storage-status');
    if(!el) return;
    if(ON_NETLIFY){
      el.innerHTML = '<span style="color:var(--sage-light)">‚òÅ shared</span>';
      el.title = 'Netlify shared storage ‚Äî all visitors see the same properties';
    }
  }

  function collectCurrentState(){
    const fields = [
      'inp-price','inp-savings','inp-depp','inp-govt','inp-rate','inp-term',
      'inp-cont','inp-rent','inp-weeks',
      'pd-address','pd-suburb','pd-state','pd-bed','pd-bath','pd-car',
      'pd-land','pd-house','pd-year','pd-type','pd-url','pd-notes',
      'pd-status','pd-status-date','ag-agency','ag-name','ag-phone','ag-email'
    ];
    const values = {};
    fields.forEach(id => { const el=document.getElementById(id); if(el) values[id]=el.value||''; });
    const activePropType = document.querySelector('.prop-type-btn.active');
    values['pd-type-label'] = activePropType ? activePropType.textContent.trim() : 'üè† House';
    values['renoEnabled'] = renoEnabled;
    values['rentEnabled'] = document.getElementById('rent-sidebar-section')?.style.display !== 'none';
    return {
      values,
      dynCostData: dynCosts.map(c=>({name:c.name,amount:c.amount})),
      renoItemData: renoItems.map(r=>({emoji:r.emoji,name:r.name,amount:r.amount,note:r.note})),
      keyDates: typeof keyDates !== 'undefined' ? [...keyDates] : [],
      commsLog:  typeof commsLog  !== 'undefined' ? [...commsLog]  : []
    };
  }

  async function saveScenario(){
    const state    = collectCurrentState();
    const addr     = state.values['pd-address'] || '';
    if(!addr.trim()){
      showToast('‚ö†Ô∏è Please enter a property address before saving');
      const addrEl = document.getElementById('pd-address');
      if(addrEl){ addrEl.focus(); addrEl.style.borderColor='var(--terracotta)'; setTimeout(()=>addrEl.style.borderColor='',2500); }
      showTab('property', document.querySelector('.tab'));
      return;
    }
    const suburb   = state.values['pd-suburb']  || '';
    const stateV   = state.values['pd-state']   || '';
    const fullAddr = [addr, suburb, stateV].filter(Boolean).join(', ') || 'Unnamed Property';
    const now      = new Date();
    const dd = String(now.getDate()).padStart(2,'0');
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const yyyy = now.getFullYear();
    const hh = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const timestamp = `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    const scenarios = await getAllScenarios();
    const addrKey  = fullAddr.toLowerCase().trim();
    const existIdx = scenarios.findIndex(s => (s.addrKey||'') === addrKey);
    const id       = existIdx >= 0 ? scenarios[existIdx].id : ('sc_' + Date.now());
    const status   = state.values['pd-status'] || 'browsing';
    const record   = {
      id, addrKey, fullAddr, timestamp, status,
      bed:  state.values['pd-bed']  || '',
      bath: state.values['pd-bath'] || '',
      car:  state.values['pd-car']  || '',
      type: state.values['pd-type'] || 'House',
      price: state.values['inp-price'] || '',
      hasPhoto: !!propPhotoDataUrl,
      thumb: propThumbDataUrl || null,
      state,
    };
    const saveBtns = document.querySelectorAll('button[onclick*="saveScenario"]');
    saveBtns.forEach(b=>{b._ot=b.innerHTML;b.innerHTML='<div class="spinner-sm"></div>';b.disabled=true;});
    _scenariosCache = null;
    const usedCloud = await saveScenarioToBackend(record, propPhotoDataUrl||null);
    saveBtns.forEach(b=>{if(b._ot)b.innerHTML=b._ot;b.disabled=false;});
    _lastSavedAddr = fullAddr; _isDirty = false; updateUnsavedBadge();
    const action = existIdx>=0 ? 'Updated' : 'Saved';
    if(usedCloud){
      showToast(`‚òÅÔ∏è ${action} to cloud ‚Äî visible on all devices`);
    } else if(ON_NETLIFY){
      showToast(`‚ö†Ô∏è Cloud save failed ‚Äî saved locally only. Check Netlify Functions.`);
    } else {
      showToast(`üíæ ${action} locally (open via Netlify for shared sync)`);
    }
    updateSavedCount();
  }

  async function updateSavedCount(){
    // Warm the scenarios cache in the background so library opens instantly
    const arr = await getAllScenarios();
    if(arr.length) _scenariosCache = arr; // cache so library opens without re-fetching
    const ct = document.getElementById('saved-count');
    if(!ct) return;
    if(arr.length > 0){ ct.textContent = arr.length; ct.style.display='inline'; }
    else ct.style.display='none';
  }

  function setScenariosView(mode){ /* grid view removed ‚Äî list only */ }

  function openScenariosModal(){
    document.getElementById('scenarios-modal').style.display='block';
    document.body.style.overflow='hidden';
    renderScenariosList();
  }
  function closeScenariosModal(){
    document.getElementById('scenarios-modal').style.display='none';
    document.body.style.overflow='';
  }
  function closeConfirmModal(){
    document.getElementById('confirm-modal').style.display='none';
    pendingLoadId = null;
  }

  const STATUS_COLORS = {
    'browsing':'#5B8FAB','auction':'#C4704A','for-sale':'#C9A84C',
    'offered':'#7B9E87','under-offer':'#E8A882','unconditional':'#5A9E7B','sold':'#C45A5A'
  };
  const STATUS_LABELS = {
    'browsing':'üëÄ Browsing','auction':'üî® Auction','for-sale':'üè∑ For Sale',
    'offered':'üìù Offer Sent','under-offer':'‚è≥ Under Offer',
    'unconditional':'‚úÖ Unconditional','sold':'üî¥ Sold/Passed'
  };

  let _libFilter = 'all';

  function setLibFilter(f, btn){
    _libFilter = f;
    document.querySelectorAll('.lib-filter').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    _renderScenariosToDOM(_scenariosCache || []);
  }

  async function renderScenariosList(){
    const grid = document.getElementById('scenarios-grid');
    if(!grid) return;
    grid.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:40px 20px;color:var(--slate);font-family:\'DM Mono\',monospace;font-size:12px;"><div class="spinner"></div>Loading properties‚Ä¶</div>';
    _scenariosCache = await getAllScenarios();
    _renderScenariosToDOM(_scenariosCache);
  }

  async function _renderScenariosToDOM(all){
    const grid  = document.getElementById('scenarios-grid');
    const empty = document.getElementById('scenarios-empty');
    if(!grid) return;

    const scenarios = _libFilter === 'all' ? all : all.filter(s => (s.status||'browsing') === _libFilter);

    if(!all || all.length === 0){
      if(empty) empty.style.display = 'block';
      grid.innerHTML = ''; return;
    }
    if(empty) empty.style.display = 'none';
    const libCount = document.getElementById('lib-count');
    if(libCount) libCount.textContent = all.length > 0 ? `(${all.length})` : '';

    if(scenarios.length === 0){
      grid.innerHTML = '<div style="text-align:center;padding:32px;color:var(--slate);font-size:13px;">No properties match this filter.</div>';
      return;
    }

    // Render rows immediately without waiting for photos
    const rows = scenarios.map(s => {
      const price  = s.price ? '$' + parseInt(s.price).toLocaleString() : '‚Äî';
      const stats  = [s.type||'House', s.bed?s.bed+' bed':null, s.bath?s.bath+' bath':null, s.car?s.car+' car':null].filter(Boolean).join(' ¬∑ ');
      const status = s.status || 'browsing';
      const sColor = STATUS_COLORS[status] || '#999';
      const sLabel = STATUS_LABELS[status] || 'üëÄ';
      return `
        <div class="lib-row" onclick="promptLoadScenario('${s.id}')">
          <div class="lib-thumb" id="thumb-${s.id}"><span style="font-size:24px;">üè†</span></div>
          <div class="lib-info">
            <div class="lib-addr">${s.fullAddr}</div>
            <div class="lib-meta">${stats}</div>
          </div>
          <div class="lib-price">${price}</div>
          <div class="lib-badge" style="background:${sColor}22;color:${sColor};border:1px solid ${sColor}55;">${sLabel}</div>
          <div class="lib-ts">${(s.timestamp||'').replace(/(\d+)\s([A-Za-z]+)\s(\d{4})/,(_,d,mo,y)=>{const mn={Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};return String(d).padStart(2,'0')+'/'+(mn[mo]||'01')+'/'+y;})}</div>
          <button class="lib-del" onclick="event.stopPropagation();deleteScenario('${s.id}')" title="Delete">‚úï</button>
        </div>`;
    });
    grid.innerHTML = rows.join('');

    // Load photos lazily ‚Äî use thumb from record if available, else fetch
    scenarios.forEach(async s => {
      if(!s.hasPhoto) return;
      const thumb = document.getElementById('thumb-'+s.id);
      if(!thumb) return;
      // Use embedded thumb if we have it (no network call needed)
      if(s.thumb){ thumb.innerHTML = `<img src="${s.thumb}" style="width:100%;height:100%;object-fit:cover;border-radius:3px;" loading="lazy">`; return; }
      const photo = await getPhoto(s.id);
      if(photo && thumb) thumb.innerHTML = `<img src="${photo}" style="width:100%;height:100%;object-fit:cover;border-radius:3px;" loading="lazy">`;
    });
  }

  async function promptLoadScenario(id){
    const scenarios = _scenariosCache || await getAllScenarios();
    const sc = scenarios.find(s => s.id === id);
    if(!sc) return;
    pendingLoadId = id;
    document.getElementById('confirm-name').textContent = sc.fullAddr;
    document.getElementById('confirm-modal').style.display='block';
  }

  async function confirmLoad(){
    if(!pendingLoadId) return;
    const scenarios = _scenariosCache || await getAllScenarios();
    const sc = scenarios.find(s => s.id === pendingLoadId);
    if(!sc || !sc.state){ pendingLoadId=null; closeConfirmModal(); return; }
    closeConfirmModal();
    closeScenariosModal();
    const photo = sc.hasPhoto ? await getPhoto(sc.id) : null;
    applyScenarioState(sc.state, photo);
    _lastSavedAddr = sc.fullAddr; _isDirty = false; updateUnsavedBadge();
    showToast('‚úì Loaded: ' + sc.fullAddr);
    pendingLoadId = null;
  }

  function applyScenarioState(state, photoSrc){
    const {values, dynCostData, renoItemData, keyDates:kd, commsLog:cl} = state;
    const skipFields = new Set(['pd-type','pd-type-label','renoEnabled','rentEnabled']);
    Object.entries(values||{}).forEach(([id, val]) => {
      if(skipFields.has(id) || id.startsWith('rn-')) return;
      const el = document.getElementById(id);
      if(el) el.value = val;
    });
    if(values?.['pd-type-label']){
      document.querySelectorAll('.prop-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.trim() === values['pd-type-label']);
      });
    }
    // Restore status
    if(values?.['pd-status']) setStatus(values['pd-status'], null, true);
    // Agent links
    updateAgentLinks();
    // Key dates
    if(typeof keyDates !== 'undefined'){ keyDates = Array.isArray(kd)?[...kd]:[]; renderKeyDates(); }
    // Comms log
    if(typeof commsLog !== 'undefined'){ commsLog = Array.isArray(cl)?[...cl]:[]; renderCommsLog(); }
    // Reno items (item 13)
    renoItems = [];
    if(renoItemData && renoItemData.length>0){
      renoItemData.forEach(r=>renoItems.push({id:'ri-'+renoItemId++, emoji:r.emoji||'üî®', name:r.name||'', amount:r.amount||0, note:r.note||''}));
    } else if(dynCostData && !renoItemData) {
      // legacy: old saved data had reno in dynCostData ‚Äî skip (can't distinguish)
    }
    renderRenoItems();
    // Purchase costs (item 14) ‚Äî all dynamic now
    dynCosts = [];
    if(dynCostData) dynCostData.forEach(c => dynCosts.push({id:'dyn-'+dynId++, name:c.name||'', amount:c.amount||0}));
    renderDynCosts();
    // Reno/rent toggles
    if(typeof renoEnabled !== 'undefined'){
      const newReno = values?.['renoEnabled'] !== false;
      if(newReno !== renoEnabled){ renoEnabled=newReno; applyRenoToggle(); }
    }
    const newRent = values?.['rentEnabled'] !== false;
    applyRentToggle(newRent);

    if(photoSrc) applyPropPhoto(photoSrc); else clearPropPhoto();
    ['price','savings','depp','govt','rate','term','cont','rent','weeks'].forEach(k => {
      const inp = document.getElementById('inp-'+k), rng = document.getElementById('rng-'+k);
      if(inp && rng) rng.value = inp.value;
    });
    updatePropertyDetails();
    recalc();
  }

  async function deleteScenario(id){
    if(!confirm('Delete this scenario? This cannot be undone.')) return;
    _scenariosCache = null;
    await deleteScenarioFromBackend(id);
    updateSavedCount();
    renderScenariosList();
  }

  function updateUnsavedBadge(){
    const badge = document.getElementById('unsaved-badge');
    if(!badge) return;
    const price = v('inp-price');
    const addr  = document.getElementById('pd-address')?.value?.trim() || '';
    const hasContent = price > 0 || addr.length > 0;
    if(hasContent && _isDirty){
      badge.style.display = 'inline-flex';
      badge.title = 'You have unsaved changes ‚Äî click Save to preserve them';
    } else {
      badge.style.display = 'none';
    }
  }

  // Warn before closing/refreshing with unsaved address data
  window.addEventListener('beforeunload', function(e){
    const price = v('inp-price');
    const addr  = document.getElementById('pd-address')?.value?.trim() || '';
    if((price > 0 || addr) && _isDirty){
      e.preventDefault();
      e.returnValue = 'You have unsaved changes. Refresh anyway?';
    }
  });

  function showToast(msg){
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--charcoal);color:var(--gold);font-family:"DM Mono",monospace;font-size:11px;padding:10px 16px;border-radius:3px;border:1px solid rgba(201,168,76,0.3);z-index:9999;letter-spacing:0.5px;box-shadow:0 4px 20px rgba(0,0,0,0.3);transition:opacity 0.8s;';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 800); }, 3500);
  }

  // ‚îÄ‚îÄ RENO TOGGLE ‚îÄ‚îÄ
  let renoEnabled = true;
  function toggleReno(){
    renoEnabled = !renoEnabled;
    applyRenoToggle();
    recalc();
  }
  function applyRenoToggle(){
    const knob = document.getElementById('reno-toggle-knob');
    const track = document.getElementById('reno-toggle');
    const section = document.getElementById('reno-sidebar-section');
    const tab = document.getElementById('tab-reno-btn');
    if(renoEnabled){
      if(knob) knob.style.left = '20px';
      if(track) track.style.background = 'var(--sage)';
      if(section) section.style.display = '';
      if(tab) tab.style.display = '';
    } else {
      if(knob) knob.style.left = '2px';
      if(track) track.style.background = 'rgba(255,255,255,0.15)';
      if(section) section.style.display = 'none';
      if(tab){ tab.style.display = 'none'; showTab('costs', document.querySelector('.tab')); }
    }
  }

  // ‚îÄ‚îÄ RENT OVERLAP TOGGLE (item 12) ‚îÄ‚îÄ
  let rentEnabled = true;
  let riskEnabled = true;
  function toggleRisk(){
    riskEnabled = !riskEnabled;
    const tog = document.getElementById('risk-toggle');
    const knob = document.getElementById('risk-toggle-knob');
    const tabBtn = document.getElementById('tab-risks-btn');
    if(tog) tog.style.background = riskEnabled ? 'var(--terracotta)' : 'rgba(255,255,255,0.15)';
    if(knob) knob.style.left = riskEnabled ? '20px' : '2px';
    if(tabBtn) tabBtn.style.display = riskEnabled ? '' : 'none';
    if(!riskEnabled){ const active = document.querySelector('.tab.active'); if(active && active.id==='tab-risks-btn') showTab('property', document.querySelector('.tab')); }
  }
  function toggleRent(){
    rentEnabled = !rentEnabled;
    applyRentToggle(rentEnabled);
    recalc();
  }
  function applyRentToggle(enabled){
    rentEnabled = enabled;
    const knob = document.getElementById('rent-toggle-knob');
    const track = document.getElementById('rent-toggle');
    const section = document.getElementById('rent-sidebar-section');
    const tab = document.querySelector('.tab[onclick*="overlap"]');
    if(enabled){
      if(knob) knob.style.left = '20px';
      if(track) track.style.background = 'var(--sky)';
      if(section) section.style.display = '';
      if(tab) tab.style.display = '';
    } else {
      if(knob) knob.style.left = '2px';
      if(track) track.style.background = 'rgba(255,255,255,0.15)';
      if(section) section.style.display = 'none';
      if(tab){ tab.style.display = 'none'; }
    }
  }

  // ‚îÄ‚îÄ PROJECTION (items 6,7,8,9) ‚îÄ‚îÄ
  let projData = []; // shared so tooltip can read it

  function drawProjection(){
    const price   = v('inp-price'); if(!price) return;
    const loanAmt = Math.max(0, price - price*v('inp-depp')/100 - price*v('inp-govt')/100);
    const rate    = v('inp-rate');
    const term    = v('inp-term');
    const govtPct = v('inp-govt') / 100;
    const growthPct = parseFloat(document.getElementById('proj-growth').value) / 100;
    const upliftPct = parseFloat(document.getElementById('proj-uplift')?.value || '0') / 100;
    const years   = 30; // item 8: fixed at 30
    const monthly = calcMonthly(loanAmt, rate, term);

    // Build year-by-year data
    projData = [];
    let loanBal = loanAmt;
    const mRate = rate/100/12;
    for(let yr=0; yr<=years; yr++){
      const baseVal   = price * Math.pow(1+growthPct, yr);
      const renoVal   = yr===0 ? price : price * Math.pow(1+growthPct, yr); // reno uplift removed
      const govtOwed  = baseVal * govtPct;
      if(yr>0){
        for(let m=0;m<12;m++){
          const interest = loanBal * mRate;
          loanBal = Math.max(0, loanBal - (monthly - interest));
        }
      }
      projData.push({ yr, baseVal, renoVal, loanBal:Math.max(0,loanBal), govtOwed, yourEquity:baseVal-loanBal-govtOwed });
    }

    // ‚îÄ‚îÄ MILESTONE TILES (item 9) ‚îÄ‚îÄ
    const payoffYr = projData.find(d=>d.loanBal<=0.01)?.yr;
    // "can buy out govt" = your equity >= govtOwed (i.e. net equity without govt ‚â• 0, i.e. property value ‚â• loan + 2*govtOwed roughly)
    const buyoutYr = projData.find(d=>d.yourEquity>=d.govtOwed && d.yr>0)?.yr;

    const payEl = document.getElementById('proj-payoff-yr');
    if(payEl) payEl.textContent = payoffYr ? 'Year '+payoffYr : (term<30?'Year '+term:'30+ yrs');
    const buyEl = document.getElementById('proj-buyout-yr');
    if(buyEl) buyEl.textContent = buyoutYr ? 'Year '+buyoutYr : '30+ yrs';

    const d5 = projData.find(d=>d.yr===5) || projData[projData.length-1];
    set('proj-val-5', fmtK(d5.baseVal));
    set('proj-govt-5', fmtK(d5.govtOwed));

    // ‚îÄ‚îÄ MILESTONES TIMELINE ‚îÄ‚îÄ
    const msEl = document.getElementById('proj-milestones');
    if(msEl){
      const ms = [];
      ms.push({yr:0,color:'var(--gold)',label:'Settlement',desc:`Purchase price ${fmtK(price)} ¬∑ Loan ${fmtK(loanAmt)} ¬∑ Govt equity ${fmtK(price*govtPct)}`});
      if(buyoutYr) ms.push({yr:buyoutYr,color:'var(--sage)',label:'Can Refinance/Buy Out Govt',desc:`Property ~${fmtK(projData[buyoutYr]?.baseVal||0)} ¬∑ Govt owed ~${fmtK(projData[buyoutYr]?.govtOwed||0)} ¬∑ Your equity ~${fmtK(projData[buyoutYr]?.yourEquity||0)}`});
      const halfYr = projData.find(d=>d.loanBal<=loanAmt*0.5 && d.yr>0)?.yr;
      if(halfYr) ms.push({yr:halfYr,color:'var(--sky)',label:'Loan 50% Paid Off',desc:`Loan balance ~${fmtK(projData[halfYr]?.loanBal||0)} ¬∑ Property ~${fmtK(projData[halfYr]?.baseVal||0)}`});
      if(payoffYr&&payoffYr<=30) ms.push({yr:payoffYr,color:'var(--reward-green)',label:'Loan Fully Paid Off üéâ',desc:`Property ~${fmtK(projData[payoffYr]?.baseVal||0)} ¬∑ Full equity achieved`});
      ms.push({yr:30,color:'var(--terracotta)',label:'Year 30 ‚Äî End of Projection',desc:`Est. value ${fmtK(projData[29]?.baseVal||0)} ¬∑ Est. govt equity owed ${fmtK(projData[29]?.govtOwed||0)}`});
      msEl.innerHTML = ms.sort((a,b)=>a.yr-b.yr).map(m=>`
        <div class="tli">
          <div class="tld" style="color:${m.color}"></div>
          <div class="tlp" style="color:${m.color}">Year ${m.yr}</div>
          <div class="tlt">${m.label}</div>
          <div class="tldesc">${m.desc}</div>
        </div>`).join('');
    }

    // ‚îÄ‚îÄ SVG CHART ‚îÄ‚îÄ
    const svg = document.getElementById('proj-chart');
    if(!svg) return;
    const W=800, H=300, padL=72, padR=24, padT=20, padB=40;
    const cW=W-padL-padR, cH=H-padT-padB;
    const maxVal = Math.max(...projData.map(d=>d.renoVal))*1.08;
    const scaleX = yr => padL + (yr/years)*cW;
    const scaleY = val => padT + cH - (val/maxVal)*cH;

    let html = '';
    // Y grid lines
    for(let p=0;p<=4;p++){
      const val=maxVal*p/4, y=scaleY(val);
      html+=`<line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="rgba(28,28,30,0.07)" stroke-width="1"/>`;
      html+=`<text x="${padL-6}" y="${y+4}" text-anchor="end" font-family="DM Mono" font-size="9" fill="#999">${fmtK(val)}</text>`;
    }
    // X axis labels
    [0,5,10,15,20,25,30].forEach(yr=>{
      html+=`<text x="${scaleX(yr)}" y="${H-padB+16}" text-anchor="middle" font-family="DM Mono" font-size="9" fill="#999">Yr ${yr}</text>`;
    });

    // Shaded equity area
    const topPts = projData.map(d=>`${scaleX(d.yr).toFixed(1)},${scaleY(d.baseVal).toFixed(1)}`).join(' ');
    const botPts = [...projData].reverse().map(d=>`${scaleX(d.yr).toFixed(1)},${scaleY(Math.max(d.loanBal+d.govtOwed,0)).toFixed(1)}`).join(' ');
    html+=`<polygon points="${topPts} ${botPts}" fill="rgba(90,158,123,0.09)"/>`;

    const mkPath=(key,color,dash='')=>{
      const pts=projData.map((d,i)=>`${i===0?'M':'L'}${scaleX(d.yr).toFixed(1)},${scaleY(d[key]).toFixed(1)}`).join(' ');
      return `<path d="${pts}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"${dash?` stroke-dasharray="${dash}"`:''}/>`;
    };
    html += mkPath('baseVal','#C9A84C');
    html += mkPath('renoVal','#7B9E87');
    html += mkPath('loanBal','#5B8FAB','6 3');
    html += mkPath('govtOwed','#C4704A');

    // Milestone markers on chart
    if(payoffYr && payoffYr<=30){ const d=projData[payoffYr]; html+=`<circle cx="${scaleX(payoffYr)}" cy="${scaleY(d.loanBal)}" r="5" fill="#5A9E7B" stroke="white" stroke-width="2"/><text x="${scaleX(payoffYr)}" y="${scaleY(d.loanBal)-9}" text-anchor="middle" font-family="DM Mono" font-size="8" fill="#5A9E7B">PAID OFF</text>`; }
    if(buyoutYr && buyoutYr<=30){ const d=projData[buyoutYr]; html+=`<circle cx="${scaleX(buyoutYr)}" cy="${scaleY(d.baseVal)}" r="5" fill="#7B9E87" stroke="white" stroke-width="2"/><text x="${scaleX(buyoutYr)}" y="${scaleY(d.baseVal)-9}" text-anchor="middle" font-family="DM Mono" font-size="8" fill="#7B9E87">BUY OUT</text>`; }

    // Invisible hit overlay for click/hover (item 6)
    html += `<rect id="proj-hit" x="${padL}" y="${padT}" width="${cW}" height="${cH}" fill="transparent" style="cursor:crosshair;" onmousemove="projHover(event,${padL},${padR},${cW},${years})" onmouseleave="document.getElementById('proj-tooltip').style.display='none'" onclick="projHover(event,${padL},${padR},${cW},${years})"/>`;

    // Crosshair line (hidden until hover)
    html += `<line id="proj-crosshair" x1="0" y1="${padT}" x2="0" y2="${H-padB}" stroke="rgba(201,168,76,0.5)" stroke-width="1" stroke-dasharray="3 2" style="display:none;pointer-events:none;"/>`;

    svg.innerHTML = html;

    // ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ
    const tblEl = document.getElementById('proj-table');
    if(tblEl){
      const rows = [1,2,3,5,7,10,15,20,25,30].map(y=>{
        const d=projData[Math.min(y,projData.length-1)];
        const eq=d.yourEquity;
        const isMilestone = y===payoffYr||y===buyoutYr;
        return `<div style="display:grid;grid-template-columns:60px repeat(5,1fr);gap:6px;padding:7px 0;border-top:1px solid rgba(28,28,30,0.06);font-size:10px;font-family:'DM Mono',monospace;${isMilestone?'background:rgba(201,168,76,0.06);border-radius:2px;':''}">`
          +`<span style="color:var(--gold);">Yr ${y}${isMilestone?' ‚òÖ':''}</span>`
          +`<span>${fmtK(d.baseVal)}</span><span style="color:var(--sage)">${fmtK(d.renoVal)}</span>`
          +`<span style="color:var(--sky)">${fmtK(d.loanBal)}</span>`
          +`<span style="color:var(--terracotta)">${fmtK(d.govtOwed)}</span>`
          +`<span style="color:${eq>0?'var(--reward-green)':'var(--risk-red)'};font-weight:600;">${fmtK(eq)}</span></div>`;
      });
      tblEl.innerHTML=`<div style="font-family:'DM Mono',monospace;font-size:10px;"><div style="display:grid;grid-template-columns:60px repeat(5,1fr);gap:6px;padding-bottom:6px;border-bottom:1px solid rgba(28,28,30,0.1);color:var(--slate);font-size:9px;letter-spacing:1px;text-transform:uppercase;"><span>Year</span><span>Value</span><span>+Reno</span><span>Loan Bal</span><span>Govt Owed</span><span>Your Equity</span></div>${rows.join('')}</div>`;
    }
  }

  function projHover(e, padL, padR, cW, years){
    const svg   = document.getElementById('proj-chart');
    const tip   = document.getElementById('proj-tooltip');
    const cross = document.getElementById('proj-crosshair');
    if(!svg||!tip||!projData.length) return;
    const rect  = svg.getBoundingClientRect();
    const svgW  = svg.viewBox.baseVal.width || 800;
    const scale = svgW / rect.width;
    const mx    = (e.clientX - rect.left) * scale;
    const relX  = mx - padL;
    if(relX<0||relX>cW) return;
    const yr    = Math.round((relX/cW)*years);
    const d     = projData[Math.min(yr, projData.length-1)];
    if(!d) return;
    // crosshair
    const cx = padL+(yr/years)*cW;
    if(cross){ cross.setAttribute('x1',cx);cross.setAttribute('x2',cx);cross.style.display=''; }
    // tooltip
    tip.innerHTML=`<div style="font-size:10px;letter-spacing:2px;color:var(--gold);margin-bottom:8px;">YEAR ${d.yr}</div>`
      +`<div style="display:flex;flex-direction:column;gap:4px;font-size:11px;">`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">Value</span><span style="color:#C9A84C;">${fmtK(d.baseVal)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">+Reno</span><span style="color:#7B9E87;">${fmtK(d.renoVal)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">Loan Bal</span><span style="color:#5B8FAB;">${fmtK(d.loanBal)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:rgba(245,240,232,0.5);">Govt Owed</span><span style="color:#C4704A;">${fmtK(d.govtOwed)}</span></div>`
      +`<div style="display:flex;justify-content:space-between;gap:12px;border-top:1px solid rgba(255,255,255,0.1);padding-top:4px;"><span style="color:rgba(245,240,232,0.5);">Your Equity</span><span style="color:${d.yourEquity>0?'#5A9E7B':'#C45A5A'};font-weight:600;">${fmtK(d.yourEquity)}</span></div>`
      +'</div>';
    // position tooltip
    const px = e.clientX - rect.left;
    const py = e.clientY - rect.top;
    tip.style.display='block';
    tip.style.left = (px > rect.width/2 ? (px-tip.offsetWidth-12)+'px' : (px+12)+'px');
    tip.style.top  = Math.max(0,py-tip.offsetHeight/2)+'px';
  }

  // ‚îÄ‚îÄ SUBURB GROWTH LOOKUP (item 7) ‚îÄ‚îÄ
  async function fetchSuburbGrowth(){
    const suburb = document.getElementById('pd-suburb')?.value?.trim();
    const state  = document.getElementById('pd-state')?.value?.trim() || 'QLD';
    if(!suburb){ showToast('‚ö†Ô∏è Enter a suburb in the Property tab first'); return; }
    const btn = document.getElementById('fetch-growth-btn');
    const hint = document.getElementById('suburb-growth-hint');
    btn.textContent = '‚è≥ Looking up...';
    btn.disabled = true;

    // Brisbane/QLD suburb growth rate lookup table (5-yr average % p.a.)
    // Based on CoreLogic/PropTrack historical data for common QLD suburbs
    const qldGrowthTable = {
      'kedron':6.8,'stafford':6.5,'stafford heights':6.2,'chermside':6.0,
      'chermside west':5.8,'everton park':6.3,'nundah':7.1,'wavell heights':6.9,
      'aspley':6.0,'zillmere':5.5,'geebung':5.8,'virginia':5.6,'northgate':6.4,
      'nudgee':5.2,'banyo':5.0,'hendra':7.5,'eagle farm':5.8,'hamilton':7.2,
      'ascot':7.8,'clayfield':7.3,'wooloowin':7.0,'gordon park':6.8,'grange':7.2,
      'newmarket':6.9,'alderley':7.0,'enoggera':5.8,'keperra':5.5,'mitchelton':6.2,
      'gaythorne':6.5,'oxley':5.5,'rocklea':5.0,'moorooka':5.8,'salisbury':5.5,
      'nathan':5.8,'sunnybank':5.5,'sunnybank hills':5.2,'macgregor':5.0,'eight mile plains':5.3,
      'mansfield':5.8,'wishart':5.5,'belmont':5.3,'tingalpa':5.0,'cannon hill':6.5,
      'morningside':6.8,'murarrie':5.8,'hawthorne':7.5,'balmoral':8.0,'bulimba':8.2,
      'new farm':9.0,'newstead':8.5,'teneriffe':9.2,'bowen hills':7.0,'fortitude valley':7.5,
      'spring hill':7.8,'paddington':7.5,'red hill':7.8,'kelvin grove':7.0,'herston':7.5,
      'taringa':7.0,'toowong':7.5,'auchenflower':7.8,'west end':8.5,'south brisbane':8.0,
      'woolloongabba':8.0,'east brisbane':8.2,'coorparoo':7.5,'greenslopes':7.0,'dutton park':7.8,
      'annerley':7.0,'yeronga':6.8,'graceville':7.5,'sherwood':7.0,'corinda':6.5,
      'indooroopilly':7.0,'st lucia':7.5,'fig tree pocket':7.0,'kenmore':6.5,'pullenvale':6.0,
      'chapel hill':6.5,'tarragindi':6.5,'holland park':6.8,'mount gravatt':6.0,'upper mount gravatt':5.8,
      'carindale':5.5,'mount ommaney':6.0,'jindalee':5.8,'westlake':5.5,'seventeen mile rocks':5.5,
      'sinnamon park':6.0,'riverhills':5.3,'middle park':5.5,'darra':4.8,'richlands':4.5,
      'inala':4.2,'durack':4.5,'forest lake':4.8,'ellen grove':4.5,'heathwood':4.8,
      'algester':5.0,'parkinson':5.2,'calamvale':5.5,'drewvale':5.0,'kuraby':5.0,
      'coopers plains':5.5,'acacia ridge':4.5,'pallara':5.2,'willawong':4.8,'larapinta':5.0,
      'springwood':5.0,'slacks creek':4.5,'woodridge':4.0,'logan central':3.8,'loganlea':4.0,
      'meadowbrook':4.5,'marsden':4.5,'kingston':4.0,'waterford west':4.5,'logan reserve':4.8,
      'crestmead':4.5,'berrinba':4.5,'browns plains':4.5,'heritage park':5.0,'regents park':4.8,
      'boronia heights':4.5,'park ridge':5.0,'hillcrest':4.8,'forestdale':4.5,'greenbank':4.8,
      'jimboomba':5.5,'august':5.8,'dakabin':5.0,'mango hill':5.5,'kippa-ring':5.2,
      'redcliffe':5.5,'margate':5.8,'clontarf':5.5,'scarborough':6.0,'woody point':5.8,
      'kallangur':5.0,'murrumba downs':5.2,'griffin':5.5,'narangba':5.2,'caboolture':4.5,
      'morayfield':4.8,'burpengary':4.5,'deception bay':4.5,'north lakes':5.5,'rothwell':5.2,
      'ormiston':6.5,'cleveland':6.8,'thornlands':6.0,'victoria point':6.2,'redland bay':6.0,
      'capalaba':5.8,'alexandra hills':5.5,'wynnum':7.0,'manly':7.5,'lota':6.8,
      'ipswich':5.2,'redbank plains':5.8,'redbank':5.5,'goodna':5.0,'springfield':5.8,
      'springfield lakes':6.0,'collingwood park':5.5,'bellbird park':5.5,'camira':5.8,
      'silkstone':5.2,'leichhardt':5.0,'booval':5.2,'bundamba':5.0,'east ipswich':5.2,
      'north ipswich':5.0,'west ipswich':5.0,'brassall':5.5,'ripley':6.2,'deebing heights':5.8,
      'flinders view':5.5,'brookwater':6.0,'augustine heights':5.8,'raceview':5.2,
      'one mile':5.0,'pine mountain':5.5,'karalee':5.8,'moores pocket':5.0,
      'riverview':5.2,'dinmore':4.8,'gailes':5.0,'blackstone':5.0,'sadliers crossing':5.2,
      'woodend':5.0,'tivoli':5.2,'newtown':5.0,'coalfalls':5.0,'churchill':5.2,
    };

    const key = suburb.toLowerCase().trim();
    const rate = qldGrowthTable[key];

    if(rate){
      document.getElementById('proj-growth').value = rate;
      document.getElementById('proj-growth-lbl').textContent = rate.toFixed(1)+'%';
      if(hint) hint.textContent = `üìç ${suburb} ${state}: ~${rate}% p.a. avg (historical estimate)`;
      drawProjection();
      showToast(`üìà Set growth to ${rate}% for ${suburb}`);
    } else {
      // Try Claude API for unknown suburbs (item 7)
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            model:'claude-sonnet-4-20250514',
            max_tokens:200,
            messages:[{role:'user',content:`What is the typical 5-year average annual capital growth rate (as a single number like 5.2) for residential property in ${suburb}, ${state}, Australia? Reply with only a JSON object like {"rate":5.2,"note":"brief context"} and nothing else.`}]
          })
        });
        const data = await response.json();
        const text = data.content?.find(c=>c.type==='text')?.text||'';
        const match = text.match(/\{[^}]+\}/);
        if(match){
          const parsed = JSON.parse(match[0]);
          const r = Math.min(12, Math.max(1, parseFloat(parsed.rate)||5));
          document.getElementById('proj-growth').value = r;
          document.getElementById('proj-growth-lbl').textContent = r.toFixed(1)+'%';
          if(hint) hint.textContent = `üìç ${suburb}: ~${r}% p.a. ‚Äî ${parsed.note||'AI estimate'}`;
          drawProjection();
          showToast(`üìà Set growth to ${r}% for ${suburb}`);
        } else {
          throw new Error('No rate found');
        }
      } catch(e){
        if(hint) hint.textContent = `No data found for ${suburb}. Try manual entry.`;
        showToast(`‚ö†Ô∏è Could not find data for ${suburb} ‚Äî adjust manually`);
      }
    }
    btn.textContent = 'üîç Look Up Suburb Growth';
    btn.disabled = false;
  }

  // ‚îÄ‚îÄ EXPORT PDF (Fix 2) ‚Äî opens a clean read-only print-optimised view ‚îÄ‚îÄ
  function exportPDF(){
    const addr = document.getElementById('pd-address')?.value || 'Property';
    const suburb = document.getElementById('pd-suburb')?.value || '';
    const stateVal = document.getElementById('pd-state')?.value || '';
    const fullAddr = [addr,suburb,stateVal].filter(Boolean).join(', ') || 'Property Scenario';

    // Gather all display values from current DOM
    const snap = {
      renoOn: renoEnabled,
      rentOn: document.getElementById('rent-sidebar-section')?.style.display !== 'none',
      addr: fullAddr,
      photo: propPhotoDataUrl,
      sub: document.getElementById('header-sub-text')?.textContent || '',
      price: document.getElementById('t-price')?.textContent || '‚Äî',
      deposit: document.getElementById('t-deposit')?.textContent || '‚Äî',
      govt: document.getElementById('t-govt')?.textContent || '‚Äî',
      remaining: document.getElementById('t-remaining')?.textContent || '‚Äî',
      remainingColor: document.getElementById('t-remaining')?.style.color || '',
      savings: document.getElementById('cb-savings')?.textContent || '‚Äî',
      outOfPocket: document.getElementById('cb-out')?.textContent || '‚Äî',
      cashLeft: document.getElementById('cb-remaining')?.textContent || '‚Äî',
      monthly: document.getElementById('rp-monthly')?.textContent || '‚Äî',
      weekly: document.getElementById('rp-weekly')?.textContent || '‚Äî',
      annual: document.getElementById('rp-annual')?.textContent || '‚Äî',
      rateLabel: document.getElementById('rp-rate-lbl')?.textContent || '',
      termLabel: document.getElementById('rp-term-lbl')?.textContent || '',
      loanLabel: document.getElementById('rp-loan-lbl')?.textContent || '',
      totalInterest: document.getElementById('rp-interest')?.textContent || '‚Äî',
      totalPaid: document.getElementById('rp-total-paid')?.textContent || '‚Äî',
      poolVal: document.getElementById('reno-pool-val')?.textContent || '‚Äî',
      unspent: document.getElementById('reno-unspent-val')?.textContent || '‚Äî',
      unspentColor: document.getElementById('reno-unspent-val')?.style.color || 'green',
      renoTotal: document.getElementById('reno-total')?.textContent || '‚Äî',
      renoItems: renoItems.map(r=>({
        icon: r.emoji||'üî®',
        name: r.name||'',
        amt:  fmt(r.amount||0),
        note: r.note||''
      })),
      contingency: fmt(getRenoTotal()*(v('inp-cont')/100)),
      overlapWeekly: document.getElementById('ov-weekly-total')?.textContent || '‚Äî',
      overlapTotal: document.getElementById('ov-total-cost')?.textContent || '‚Äî',
      overlapAfter: document.getElementById('ov-remaining-after')?.textContent || '‚Äî',
      riskScore: document.getElementById('risk-meter')?.style.width || '50%',
      rewardScore: document.getElementById('reward-meter')?.style.width || '50%',
      riskDesc: document.getElementById('risk-desc')?.textContent || '',
      rewardDesc: document.getElementById('reward-desc')?.textContent || '',
      notes: document.getElementById('pd-notes')?.value || '',
      costRows: document.getElementById('cost-rows-display')?.innerHTML || '',
      crDeposit: document.getElementById('cr-deposit')?.textContent || '‚Äî',
      crTotal: document.getElementById('cr-total')?.textContent || '‚Äî',
    };

    const photoHTML = snap.photo
      ? `<img src="${snap.photo}" style="width:100%;height:100%;object-fit:cover;display:block;">`
      : `<div style="width:100%;height:100%;background:#2C2C2E;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.2);font-size:32px;">üè†</div>`;

    const renoRowsHTML = snap.renoItems.map(it=>`
      <tr><td style="padding:7px 10px;border-bottom:1px solid #eee;">${it.icon} ${it.name}</td>
      <td style="padding:7px 10px;border-bottom:1px solid #eee;text-align:right;font-family:monospace;">${it.amt}</td>
      <td style="padding:7px 10px;border-bottom:1px solid #eee;font-size:10px;color:#666;">${it.note}</td></tr>`).join('');

    const html = `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<title>${snap.addr} ‚Äî Finance Scenario</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:#fff;font-family:'DM Sans',sans-serif;color:#1C1C1E;font-size:12px;}
  @page{margin:10mm 12mm;size:A4;}
  @media print{body{font-size:11px;}}
  .page{max-width:900px;margin:0 auto;padding:20px 24px;}
  header{background:#1C1C1E;color:#F5F0E8;padding:0;display:flex;margin-bottom:20px;border-radius:4px;overflow:hidden;}
  .htext{flex:1;padding:20px 24px;}
  .htag{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:#C9A84C;margin-bottom:4px;}
  h1{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;margin-bottom:3px;}
  .hsub{font-size:11px;color:rgba(245,240,232,0.45);margin-bottom:12px;}
  .hstamp{font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.3);}
  .hphoto{width:200px;flex-shrink:0;}
  .section-title{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#888;margin:18px 0 10px;padding-bottom:6px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;}
  .section-title::after{content:'';flex:1;height:1px;background:#eee;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;}
  .card{background:#FAF7F2;border-radius:4px;padding:14px 16px;border:1px solid #eee;}
  .card-accent{width:4px;height:100%;position:absolute;top:0;left:0;border-radius:4px 0 0 4px;}
  .card-rel{position:relative;}
  .kv{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f0f0f0;font-size:11px;}
  .kv:last-child{border-bottom:none;}
  .kv .lbl{color:#666;}
  .kv .val{font-family:'DM Mono',monospace;font-weight:500;}
  .tile{background:#1C1C1E;color:#F5F0E8;border-radius:3px;padding:12px;}
  .tile-val{font-family:'DM Mono',monospace;font-size:22px;margin-bottom:2px;}
  .tile-lbl{font-size:9px;color:rgba(245,240,232,0.5);letter-spacing:1px;text-transform:uppercase;}
  .big-num{font-family:'DM Mono',monospace;font-size:28px;font-weight:500;}
  .meter-wrap{height:8px;background:#eee;border-radius:4px;overflow:hidden;margin:6px 0 4px;}
  .meter-fill{height:100%;border-radius:4px;}
  table{width:100%;border-collapse:collapse;font-size:11px;}
  th{background:#F5F0E8;padding:7px 10px;text-align:left;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#888;}
  th:last-child,td:last-child{text-align:right;}
  .print-btn{position:fixed;top:16px;right:16px;background:#1C1C1E;color:#C9A84C;border:1px solid rgba(201,168,76,0.4);padding:8px 16px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;z-index:100;}
  @media print{.print-btn{display:none;}}


  /* ‚îÄ‚îÄ WELCOME SPLASH ‚îÄ‚îÄ */
  #welcome-splash{position:fixed;inset:0;z-index:8000;background:var(--charcoal);display:flex;align-items:center;justify-content:center;opacity:1;transition:opacity 0.4s;}
  #welcome-splash.hiding{opacity:0;pointer-events:none;}
  .splash-inner{text-align:center;padding:40px 24px;max-width:480px;}
  .splash-logo{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--gold);margin-bottom:20px;opacity:0.7;}
  .splash-title{font-family:'Playfair Display',serif;font-size:36px;font-weight:700;color:var(--cream);line-height:1.2;margin-bottom:10px;}
  .splash-sub{font-size:15px;color:rgba(245,240,232,0.45);margin-bottom:40px;line-height:1.6;}
  .splash-btns{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}
  .splash-btn{padding:14px 28px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;cursor:pointer;transition:transform 0.15s,opacity 0.15s;border:none;}
  .splash-btn:hover{transform:translateY(-2px);opacity:0.9;}
  .splash-btn-primary{background:var(--gold);color:var(--charcoal);font-weight:600;}
  .splash-btn-secondary{background:rgba(255,255,255,0.07);color:var(--cream);border:1px solid rgba(255,255,255,0.18)!important;}
  .splash-deco{width:60px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:0 auto 28px;}
</style>
</head>
<body>
<button class="print-btn" onclick="window.print()">üñ® Print / Save PDF</button>
<div class="page">
  <header>
    <div class="htext">
      <div class="htag">Property Finance Calculator</div>
      <h1>${snap.addr}</h1>
      <div class="hsub">${snap.sub}</div>
      <div class="hstamp">Exported ${(()=>{const n=new Date();return String(n.getDate()).padStart(2,'0')+'/'+String(n.getMonth()+1).padStart(2,'0')+'/'+n.getFullYear();})()}</div>
      ${snap.notes ? `<div style="margin-top:10px;font-size:11px;color:rgba(245,240,232,0.5);font-style:italic;max-width:360px;">"${snap.notes}"</div>` : ''}
    </div>
    <div class="hphoto">${photoHTML}</div>
  </header>

  <div class="section-title">01 ¬∑ Financial Snapshot</div>
  <div class="grid4">
    <div class="tile"><div class="tile-val">${snap.price}</div><div class="tile-lbl">Purchase Price</div></div>
    <div class="tile"><div class="tile-val">${snap.deposit}</div><div class="tile-lbl">Your Deposit</div></div>
    <div class="tile"><div class="tile-val">${snap.govt}</div><div class="tile-lbl">Govt Contribution</div></div>
    <div class="tile"><div class="tile-val" style="color:${snap.remainingColor||'#A8C4B0'}">${snap.remaining}</div><div class="tile-lbl">Remaining Cash</div></div>
  </div>
  <div class="grid2">
    <div class="card card-rel"><div class="card-accent" style="background:#C9A84C;position:absolute;"></div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#C9A84C;margin-bottom:8px;padding-left:10px;">CASH PICTURE</div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Your Savings</span><span class="val">${snap.savings}</span></div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Total Out-of-Pocket</span><span class="val" style="color:#C4704A;">${snap.outOfPocket}</span></div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Remaining Cash</span><span class="val" style="color:#7B9E87;">${snap.cashLeft}</span></div>
    </div>
    <div class="card card-rel"><div class="card-accent" style="background:#5B8FAB;position:absolute;"></div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#5B8FAB;margin-bottom:8px;padding-left:10px;">UPFRONT COSTS</div>
      <div class="kv" style="padding-left:10px;"><span class="lbl">Deposit</span><span class="val">${snap.crDeposit}</span></div>
      ${snap.costRows.replace(/<div class="cr">/g,'<div class="kv" style="padding-left:10px;">').replace(/<span class="nm">/g,'<span class="lbl">').replace(/<span class="am">/g,'<span class="val">').replace(/<\/div>/g,'</div>')}
      <div class="kv" style="padding-left:10px;border-top:2px solid #1C1C1E;padding-top:7px;margin-top:5px;"><span class="lbl" style="font-weight:600;">Total Required</span><span class="val" style="font-weight:600;">${snap.crTotal}</span></div>
    </div>
  </div>

  ${snap.renoOn ? `  <div class="section-title">02 ¬∑ Renovation Budget</div>
  <div class="grid2" style="margin-bottom:12px;">
    <div class="card" style="text-align:center;">
      <div style="font-size:9px;font-family:'DM Mono',monospace;letter-spacing:2px;color:#888;margin-bottom:4px;">POOL</div>
      <div class="big-num" style="color:#7B9E87;">${snap.poolVal}</div>
      <div style="font-size:10px;color:#888;margin-top:2px;">Available for reno</div>
      <div style="border-top:1px solid #eee;margin-top:12px;padding-top:12px;">
      <div style="font-size:9px;font-family:'DM Mono',monospace;letter-spacing:2px;color:#888;margin-bottom:4px;">UNSPENT</div>
      <div class="big-num" style="color:${snap.unspentColor};">${snap.unspent}</div>
      <div style="font-size:10px;color:#888;margin-top:2px;">After planned reno</div>
      </div>
    </div>
    <div class="card">
      <table>
        <tr><th>Item</th><th>Cost</th><th style="text-align:left;">Note</th></tr>
        ${renoRowsHTML}
        <tr><td style="padding:7px 10px;border-bottom:1px solid #eee;">‚ö†Ô∏è Contingency</td><td style="padding:7px 10px;border-bottom:1px solid #eee;text-align:right;font-family:monospace;">${snap.contingency}</td><td></td></tr>
        <tr><td style="padding:7px 10px;font-weight:700;">Total</td><td style="padding:7px 10px;text-align:right;font-family:monospace;font-weight:700;">${snap.renoTotal}</td><td></td></tr>
      </table>
    </div>
  </div>
` : ''}
  <div class="section-title">03 ¬∑ Loan Repayments</div>
  <div class="grid2">
    <div class="card">
      <div style="display:flex;gap:16px;">
        <div style="text-align:center;flex:1;"><div class="big-num">${snap.monthly}</div><div style="font-size:10px;color:#888;margin-top:2px;">Monthly</div><div style="font-size:9px;color:#aaa;">${snap.rateLabel}</div></div>
        <div style="text-align:center;flex:1;"><div class="big-num">${snap.weekly}</div><div style="font-size:10px;color:#888;margin-top:2px;">Weekly</div><div style="font-size:9px;color:#aaa;">${snap.termLabel}</div></div>
        <div style="text-align:center;flex:1;"><div class="big-num">${snap.annual}</div><div style="font-size:10px;color:#888;margin-top:2px;">Annual</div><div style="font-size:9px;color:#aaa;">${snap.loanLabel}</div></div>
      </div>
    </div>
    <div class="card">
      <div class="kv"><span class="lbl">Total Interest Paid</span><span class="val" style="color:#C45A5A;">${snap.totalInterest}</span></div>
      <div class="kv"><span class="lbl">Total Amount Paid</span><span class="val">${snap.totalPaid}</span></div>
    </div>
  </div>
  ${snap.rentOn ? `
  <div class="section-title">04 ¬∑ Rent Overlap</div>
  <div class="grid2">
    <div class="card">
      <div class="kv"><span class="lbl">Weekly Combined Cost</span><span class="val">${snap.overlapWeekly}</span></div>
      <div class="kv"><span class="lbl">Total Overlap Cost</span><span class="val" style="color:#C4704A;">${snap.overlapTotal}</span></div>
      <div class="kv"><span class="lbl">Cash Left After Overlap</span><span class="val" style="color:#5A9E7B;">${snap.overlapAfter}</span></div>
    </div>
    <div class="card">
      <div style="font-size:9px;font-family:'DM Mono',monospace;letter-spacing:2px;color:#888;margin-bottom:10px;">RISK ¬∑ REWARD</div>
      <div style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px;"><span>Risk Level</span><span style="font-family:monospace;">${snap.riskScore}</span></div><div class="meter-wrap"><div class="meter-fill" style="width:${snap.riskScore};background:linear-gradient(to right,#C9A84C,#C4704A);"></div></div><div style="font-size:10px;color:#666;">${snap.riskDesc}</div></div>
      <div><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px;"><span>Reward Potential</span><span style="font-family:monospace;">${snap.rewardScore}</span></div><div class="meter-wrap"><div class="meter-fill" style="width:${snap.rewardScore};background:linear-gradient(to right,#7B9E87,#5A9E7B);"></div></div><div style="font-size:10px;color:#666;">${snap.rewardDesc}</div></div>
    </div>
  ` : ''}</div>
</div>
<script>setTimeout(()=>{if(window.matchMedia&&window.matchMedia('print').matches||navigator.userAgent.match(/print/i))window.print();},300);<\/script>
</body></html>`;

    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const win = window.open(url, '_blank');
    if(!win) showToast('‚ö†Ô∏è Popup blocked ‚Äî allow popups for this site');
    setTimeout(()=>URL.revokeObjectURL(url), 60000);
  }

  function setAppHeight(){
    const header = document.querySelector('header');
    const appBody = document.querySelector('.app-body');
    if(header && appBody){
      appBody.style.height = (window.innerHeight - header.offsetHeight) + 'px';
    }
  }
  window.addEventListener('resize', setAppHeight);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROPERTY STATUS (item 2)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function setStatus(status, btn, silent){
    document.getElementById('pd-status').value = status;
    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else{
      const found = document.querySelector(`.status-btn[data-status="${status}"]`);
      if(found) found.classList.add('active');
    }
    const dateWrap = document.getElementById('status-note-wrap');
    if(dateWrap) dateWrap.style.display = ['auction','offered','under-offer','unconditional'].includes(status) ? '' : 'none';
    if(!silent) syncKeyDatesFromStatus();
  }

  function syncKeyDatesFromStatus(){
    const status = document.getElementById('pd-status')?.value;
    const date   = document.getElementById('pd-status-date')?.value;
    if(!date) return;
    const labels = {
      'auction':'üî® Auction Date','offered':'üìù Offer Date',
      'under-offer':'‚è≥ Under Offer Date','unconditional':'‚úÖ Unconditional Date'
    };
    const label = labels[status]; if(!label) return;
    const existing = keyDates.findIndex(d=>d.label===label);
    if(existing>=0) keyDates[existing].date = date;
    else keyDates.push({id:'kd-status-'+Date.now(), date, label});
    renderKeyDates();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // KEY DATES (items 3 & 5)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let keyDates = [];

  function addKeyDate(date='', label=''){
    keyDates.push({id:'kd-'+Date.now(), date, label});
    renderKeyDates();
  }

  function removeKeyDate(id){
    keyDates = keyDates.filter(d=>d.id!==id);
    renderKeyDates();
  }

  function updateKeyDate(id, field, val){
    const d = keyDates.find(x=>x.id===id);
    if(d){ d[field]=val; syncKeyDatesToTimeline(); }
  }

  function formatDate(iso){
    if(!iso) return '';
    const [y,m,d] = iso.split('-');
    if(!d || !m || !y) return iso;
    return `${d}/${m}/${y.slice(-2)}`; // DD/MM/YY
  }
  function fmtDateFull(iso){ // DD/MM/YYYY for timestamps
    if(!iso) return '';
    const [y,m,d] = iso.split('-');
    if(!d || !m || !y) return iso;
    return `${d}/${m}/${y}`;
  }
  function renderKeyDates(){
    const list  = document.getElementById('key-dates-list');
    const empty = document.getElementById('key-dates-empty');
    if(!list) return;
    if(keyDates.length===0){
      list.innerHTML='';
      if(empty) empty.style.display='block';
    } else {
      if(empty) empty.style.display='none';
      list.innerHTML = [...keyDates].sort((a,b)=>(a.date||'').localeCompare(b.date||'')).map(d=>`
        <div class="kd-row">
          <input type="date" value="${d.date||''}" oninput="updateKeyDate('${d.id}','date',this.value)">
          <input type="text" value="${(d.label||'').replace(/"/g,'&quot;')}" placeholder="Event (e.g. Inspection, Auction)" oninput="updateKeyDate('${d.id}','label',this.value)">
          <button class="kd-del" onclick="removeKeyDate('${d.id}')">‚úï</button>
        </div>`).join('');
    }
    syncKeyDatesToTimeline();
  }

  function syncKeyDatesToTimeline(){
    const card = document.getElementById('tl-key-dates-card');
    const list = document.getElementById('tl-key-dates-list');
    if(!card||!list) return;
    const sorted = [...keyDates].filter(d=>d.date||d.label).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
    card.style.display = sorted.length ? '' : 'none';
    const today = new Date().toISOString().split('T')[0];
    const colors = ['var(--sky)','var(--gold)','var(--sage)','var(--terracotta)','var(--terracotta-light)','var(--reward-green)'];
    list.innerHTML = sorted.map((d,i)=>{
      const isPast  = d.date && d.date < today;
      const isToday = d.date === today;
      const fmt = d.date ? formatDate(d.date) : 'No date';
      return `<div class="tli">
        <div class="tld" style="color:${colors[i%colors.length]}"></div>
        <div class="tlp" style="color:${colors[i%colors.length]}">${fmt}${isPast?' ¬∑ past':isToday?' ¬∑ TODAY':''}</div>
        <div class="tlt">${d.label||'Unnamed Event'}</div>
      </div>`;
    }).join('');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // AGENT DETAILS (item 1)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function markAgentDirty(){ updateAgentLinks(); }

  function updateAgentLinks(){
    const phone = document.getElementById('ag-phone')?.value?.trim();
    const email = document.getElementById('ag-email')?.value?.trim();
    const callLink  = document.getElementById('ag-call-link');
    const emailLink = document.getElementById('ag-email-link');
    if(callLink)  { callLink.href  = phone ? `tel:${phone}` : '#';       callLink.style.display  = phone ? '' : 'none'; }
    if(emailLink) { emailLink.href = email ? `mailto:${email}` : '#';    emailLink.style.display = email ? '' : 'none'; }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // COMMUNICATIONS LOG (item 1)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let commsLog = [];
  let commsFormVisible = false;

  function addCommsEntry(){
    if(commsFormVisible){ closeCommsForm(); return; }
    commsFormVisible = true;
    const list = document.getElementById('comms-list');
    const today = new Date().toISOString().split('T')[0];
    const formDiv = document.createElement('div');
    formDiv.id = 'comms-add-form';
    formDiv.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div><div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--slate);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Date</div>
          <input type="date" id="cf-date" value="${today}" style="width:100%;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);padding:7px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;color:var(--charcoal);"></div>
        <div><div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--slate);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Type</div>
          <select id="cf-type" style="width:100%;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);padding:7px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;color:var(--charcoal);">
            <option>üìû Phone call</option><option>‚úâ Email</option><option>üí¨ Text / SMS</option>
            <option>ü§ù In person</option><option>üìã Inspection note</option><option>üìù Other</option>
          </select></div>
      </div>
      <div style="margin-bottom:8px;"><div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--slate);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Note</div>
        <textarea id="cf-text" rows="3" placeholder="What was discussed? Any key info from the agent?" style="width:100%;background:rgba(28,28,30,0.05);border:1px solid rgba(28,28,30,0.12);border-radius:3px;padding:8px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--charcoal);resize:vertical;outline:none;line-height:1.5;"></textarea></div>
      <div style="display:flex;gap:8px;">
        <button onclick="submitCommsEntry()" style="flex:1;background:var(--charcoal);color:var(--gold);border:none;border-radius:3px;padding:8px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:0.5px;">Ôºã Add Entry</button>
        <button onclick="closeCommsForm()" style="padding:8px 14px;background:rgba(28,28,30,0.06);border:1px solid rgba(28,28,30,0.12);border-radius:3px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;color:var(--slate);">Cancel</button>
      </div>`;
    if(list) list.insertBefore(formDiv, list.firstChild);
  }

  function closeCommsForm(){
    commsFormVisible = false;
    const f = document.getElementById('comms-add-form');
    if(f) f.remove();
  }

  function submitCommsEntry(){
    const date = document.getElementById('cf-date')?.value||'';
    const type = document.getElementById('cf-type')?.value||'';
    const text = document.getElementById('cf-text')?.value?.trim()||'';
    if(!text){ showToast('‚ö†Ô∏è Add a note before submitting'); return; }
    commsLog.unshift({id:'cm-'+Date.now(), date, type, text});
    closeCommsForm();
    renderCommsLog();
  }

  function deleteCommsEntry(id){
    commsLog = commsLog.filter(c=>c.id!==id);
    renderCommsLog();
  }

  function renderCommsLog(){
    const list  = document.getElementById('comms-list');
    const empty = document.getElementById('comms-empty');
    if(!list) return;
    list.querySelectorAll('.comms-entry').forEach(e=>e.remove());
    if(commsLog.length===0){
      if(empty) empty.style.display='block';
    } else {
      if(empty) empty.style.display='none';
      commsLog.forEach(c=>{
        const fmtDate = c.date ? formatDate(c.date) : '';
        const div = document.createElement('div');
        div.className = 'comms-entry';
        div.innerHTML = `
          <div class="comms-meta">
            <span class="comms-date">${fmtDate}</span>
            <span class="comms-type">${c.type||'Note'}</span>
            <button class="comms-del" onclick="deleteCommsEntry('${c.id}')" title="Delete">‚úï</button>
          </div>
          <div class="comms-text">${c.text.replace(/</g,'&lt;')}</div>`;
        list.appendChild(div);
      });
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MOBILE SIDEBAR TOGGLE (item 4)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function toggleMobileSidebar(){
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('mobile-overlay');
    const isOpen  = sidebar?.classList.contains('mobile-open');
    if(isOpen){
      sidebar?.classList.remove('mobile-open');
      overlay?.classList.remove('open');
    } else {
      sidebar?.classList.add('mobile-open');
      overlay?.classList.add('open');
    }
  }

  // ‚îÄ‚îÄ SEED DEFAULT PURCHASE COSTS (item 14 ‚Äî all costs now dynamic) ‚îÄ‚îÄ
  dynCosts = [
    {id:'dyn-'+dynId++, name:'Bank Fees',      amount:800},
    {id:'dyn-'+dynId++, name:'Conveyancing',   amount:1600},
    {id:'dyn-'+dynId++, name:'Building & Pest',amount:700},
  ];
  renderDynCosts();

  // ‚îÄ‚îÄ SEED DEFAULT RENO ITEMS (item 13 ‚Äî now fully dynamic) ‚îÄ‚îÄ
  const defaultReno = [
    {emoji:'üé®', name:'Paint',       amount:3500, note:''},
    {emoji:'üç≥', name:'Kitchen',     amount:5000, note:''},
    {emoji:'üöø', name:'Bathroom',    amount:4500, note:''},
    {emoji:'ü™µ', name:'Flooring',    amount:4000, note:''},
    {emoji:'üí°', name:'Electrical',  amount:2000, note:''},
    {emoji:'üåø', name:'Landscaping', amount:2000, note:''},
  ];
  defaultReno.forEach(r => renoItems.push({id:'ri-'+renoItemId++, ...r}));
  renderRenoItems();

  const _hadDraft = restoreDraft();
  recalc();
  updatePropertyDetails();
  updateSavedCount();
  setAppHeight();
  drawProjection();
  loadProfile();
  if(_hadDraft){
    setTimeout(()=>{
      const addr = document.getElementById('pd-address')?.value?.trim();
      showToast(addr ? '‚Ü©Ô∏è Restored: ' + addr : '‚Ü©Ô∏è Draft restored');
    }, 600);
  } else if(!lsGet(SPLASH_SEEN_KEY)) {
    setTimeout(showWelcomeSplash, 200);
  } else {
    setTimeout(()=>showToast('üëã Fill in your property details to get started'), 900);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // USER PROFILE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const PROFILE_KEY = 'propCalc_profile_v1';
  let _profileData = { name: '', email: '', color: '#C9A84C', photo: '' };

  function loadProfile(){
    try{
      const raw = lsGet(PROFILE_KEY);
      if(raw) _profileData = Object.assign(_profileData, JSON.parse(raw));
    }catch(e){}
    renderProfileBtn();
    renderProfilePanel();
  }

  function renderProfileBtn(){
    const btn = document.getElementById('profile-btn');
    if(!btn) return;
    if(_profileData.photo){
      btn.innerHTML = `<img src="${_profileData.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      btn.style.background = 'transparent';
    } else {
      const initials = _profileData.name
        ? _profileData.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)
        : '?';
      btn.innerHTML = initials;
      btn.style.background = _profileData.color || '#C9A84C';
    }
  }

  function renderProfilePanel(){
    const nameDisplay = document.getElementById('pp-name-display');
    const nameInput   = document.getElementById('pp-name-input');
    const emailInput  = document.getElementById('pp-email-input');
    const avatarDisplay = document.getElementById('pp-avatar-display');
    if(nameDisplay) nameDisplay.textContent = _profileData.name || 'Your Name';
    if(nameInput)   nameInput.value   = _profileData.name || '';
    if(emailInput)  emailInput.value  = _profileData.email || '';
    if(avatarDisplay){
      if(_profileData.photo){
        avatarDisplay.innerHTML = `<img src="${_profileData.photo}">`;
        avatarDisplay.style.background = 'transparent';
      } else {
        const initials = _profileData.name
          ? _profileData.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)
          : '?';
        avatarDisplay.innerHTML = initials;
        avatarDisplay.style.background = _profileData.color || '#C9A84C';
      }
    }
    // Activity stats
    const savedCount = document.getElementById('saved-count')?.textContent || '0';
    const ppSaved = document.getElementById('pp-stat-saved');
    if(ppSaved) ppSaved.textContent = savedCount === '0' ? '‚Äî' : savedCount;
    const ppLast = document.getElementById('pp-stat-last');
    if(ppLast){
      const now = new Date();
      ppLast.textContent = String(now.getDate()).padStart(2,'0')+'/'+String(now.getMonth()+1).padStart(2,'0')+'/'+String(now.getFullYear()).slice(-2);
    }
    const ppStorage = document.getElementById('pp-stat-storage');
    if(ppStorage) ppStorage.textContent = ON_NETLIFY ? '‚òÅ Cloud + Local' : 'üíæ Local';
  }

  function previewProfileName(val){
    const d = document.getElementById('pp-name-display');
    if(d) d.textContent = val || 'Your Name';
    const avd = document.getElementById('pp-avatar-display');
    if(avd && !_profileData.photo){
      const initials = val ? val.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2) : '?';
      avd.innerHTML = initials;
    }
  }

  function setProfileColor(color){
    _profileData.color = color;
    const avd = document.getElementById('pp-avatar-display');
    if(avd && !_profileData.photo) avd.style.background = color;
    renderProfileBtn();
  }

  function handleProfilePhoto(input){
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const img = new Image();
      img.onload = function(){
        const c = document.createElement('canvas');
        c.width = 128; c.height = 128;
        c.getContext('2d').drawImage(img, 0, 0, 128, 128);
        _profileData.photo = c.toDataURL('image/jpeg', 0.85);
        renderProfileBtn();
        renderProfilePanel();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function saveProfile(){
    _profileData.name  = document.getElementById('pp-name-input')?.value?.trim() || '';
    _profileData.email = document.getElementById('pp-email-input')?.value?.trim() || '';
    lsSet(PROFILE_KEY, JSON.stringify(_profileData));
    renderProfileBtn();
    renderProfilePanel();
    closeProfile();
    showToast('‚úì Profile saved');
  }

  function openProfile(){
    renderProfilePanel();
    document.getElementById('profile-panel')?.classList.add('open');
    document.getElementById('profile-overlay')?.classList.add('open');
  }

  function closeProfile(){
    document.getElementById('profile-panel')?.classList.remove('open');
    document.getElementById('profile-overlay')?.classList.remove('open');
  }


  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // NEW SCENARIO + WELCOME SPLASH
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function newScenario(){
    if(_isDirty){
      if(!confirm('Start a new scenario? Any unsaved changes will be lost.')) return;
    }
    const defaults = {
      'inp-price':'650000','inp-savings':'40000','inp-depp':'2',
      'inp-govt':'28.7','inp-rate':'6.2','inp-term':'30',
      'inp-cont':'15','inp-rent':'450','inp-weeks':'4'
    };
    Object.entries(defaults).forEach(([id,val])=>{
      const inp = document.getElementById(id);
      const rng = document.getElementById(id.replace('inp-','rng-'));
      if(inp) inp.value = val;
      if(rng) rng.value = val;
      rl(id.replace('inp-',''), parseFloat(val)||0);
    });
    ['pd-address','pd-suburb','pd-state','pd-url','pd-notes','pd-photo-url',
     'ag-agency','ag-name','ag-phone','ag-email','inp-address'].forEach(id=>{
      const el = document.getElementById(id); if(el) el.value='';
    });
    ['pd-bed','pd-bath','pd-car'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value='0'; });
    ['pd-land','pd-house','pd-year'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    dynCosts=[]; renderDynCosts();
    renoItems=[]; renderRenoItems();
    keyDates=[]; renderKeyDates();
    commsLog=[]; renderCommsLog();
    const browsingBtn = document.querySelector('[data-status="browsing"]');
    if(browsingBtn) setStatus('browsing', browsingBtn);
    clearPropPhoto();
    const houseBtn = document.querySelector('.prop-type-btn[onclick*="House"]');
    if(houseBtn) setPropType(houseBtn,'House');
    _lastSavedAddr = null;
    _isDirty = false;
    lsDel(DRAFT_KEY);
    const propTabBtn = document.querySelector('.tab[onclick*=\'property\']');
    if(propTabBtn) showTab('property', propTabBtn);
    updateUnsavedBadge();
    recalc();
    showToast('‚ú® New scenario ready');
  }

  const SPLASH_SEEN_KEY = 'propCalc_splash_seen';
  function showWelcomeSplash(){
    const splash = document.getElementById('welcome-splash');
    if(!splash) return;
    splash.style.display = 'flex';
  }
  function hideSplash(){
    const splash = document.getElementById('welcome-splash');
    if(!splash) return;
    splash.classList.add('hiding');
    setTimeout(()=>{ splash.style.display='none'; splash.classList.remove('hiding'); }, 420);
    lsSet(SPLASH_SEEN_KEY, '1');
  }
  function splashNewScenario(){
    hideSplash();
    const propTabBtn = document.querySelector('.tab[onclick*=\'property\']');
    if(propTabBtn) showTab('property', propTabBtn);
  }
  function splashOpenLibrary(){
    hideSplash();
    setTimeout(()=>openScenariosModal(), 300);
  }

</script>

<!-- ‚ïê‚ïê USER PROFILE PANEL ‚ïê‚ïê -->
<div id="profile-overlay" onclick="closeProfile()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:4999;backdrop-filter:blur(2px);"></div>
<div id="profile-panel" style="position:fixed;top:0;right:-340px;width:320px;height:100vh;background:var(--charcoal);z-index:5000;box-shadow:-8px 0 40px rgba(0,0,0,0.5);transition:right 0.3s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;overflow-y:auto;">
  <button class="pp-close" onclick="closeProfile()">‚úï</button>
  <div class="pp-header">
    <div class="pp-avatar-wrap">
      <div class="pp-avatar" id="pp-avatar-display">?</div>
      <label class="pp-avatar-edit" title="Change photo">üì∑<input type="file" accept="image/*" style="display:none" onchange="handleProfilePhoto(this)"></label>
    </div>
    <div class="pp-name" id="pp-name-display">Your Name</div>
    <div class="pp-role">Property Investor</div>
  </div>
  <div class="pp-section">
    <div class="pp-section-title">Profile Details</div>
    <div class="pp-field">
      <label class="pp-label">Display Name</label>
      <input class="pp-input" id="pp-name-input" type="text" placeholder="e.g. Jamie Smith" oninput="previewProfileName(this.value)">
    </div>
    <div class="pp-field">
      <label class="pp-label">Email (for future login)</label>
      <input class="pp-input" id="pp-email-input" type="email" placeholder="you@email.com">
    </div>
  </div>
  <div class="pp-section">
    <div class="pp-section-title">Your Activity</div>
    <div class="pp-stat"><span class="pp-stat-lbl">Properties saved</span><span class="pp-stat-val" id="pp-stat-saved">‚Äî</span></div>
    <div class="pp-stat"><span class="pp-stat-lbl">Last active</span><span class="pp-stat-val" id="pp-stat-last">‚Äî</span></div>
    <div class="pp-stat"><span class="pp-stat-lbl">Storage</span><span class="pp-stat-val" id="pp-stat-storage">Local</span></div>
  </div>
  <div class="pp-section">
    <div class="pp-section-title">Avatar Colour</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button onclick="setProfileColor('#C9A84C')" style="width:28px;height:28px;border-radius:50%;background:#C9A84C;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#5B8FAB')" style="width:28px;height:28px;border-radius:50%;background:#5B8FAB;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#7B9E87')" style="width:28px;height:28px;border-radius:50%;background:#7B9E87;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#C4704A')" style="width:28px;height:28px;border-radius:50%;background:#C4704A;border:2px solid transparent;cursor:pointer;"></button>
      <button onclick="setProfileColor('#9B7EC8')" style="width:28px;height:28px;border-radius:50%;background:#9B7EC8;border:2px solid transparent;cursor:pointer;"></button>
    </div>
  </div>
  <button class="pp-save-btn" onclick="saveProfile()">Save Profile</button>
  <div class="pp-login-note"><strong>Coming soon:</strong> Full login with personal property libraries. For now, profile is saved in your browser.</div>
</div>
<!-- ‚ïê‚ïê WELCOME SPLASH ‚ïê‚ïê -->
<div id="welcome-splash" style="display:none;">
  <div class="splash-inner">
    <div class="splash-logo">Property Finance Calculator</div>
    <div class="splash-title">Where would you<br>like to start?</div>
    <div class="splash-deco"></div>
    <div class="splash-sub">Track, analyse and compare properties<br>with the Shared Equity Scheme</div>
    <div class="splash-btns">
      <button class="splash-btn splash-btn-primary" onclick="splashNewScenario()">Ôºã New Scenario</button>
      <button class="splash-btn splash-btn-secondary" onclick="splashOpenLibrary()">üìÅ Open from Library</button>
    </div>
  </div>
</div>
</body>
</html>
